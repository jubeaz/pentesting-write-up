\chapter{La casa de papel}

keywords: \gls{t:cron-privesc} \gls{t:certificate} \gls{vsftpd}
\subsection{Résumé}

on scan la machine et on obtient du \verb+vsftpd+ du \verb+ssh+ du \verb+http+
et du \verb+https+

le \verb+http+ ne donne rien et le \verb+https+ demande une auth par certificat
client.

le \verb+vsftpd+ en version \verb+2.3.4+ contient une
\href{https://www.exploit-db.com/exploits/49757}{backdoor}.

Globalement on fait un telnet sur le port 21 avec un user qui n'existe pas ert
cela ouvre un listener sur le port \verb+6200+.

l'utilisation du module metasploit
(\verb+exploit/unix/ftp/vsftpd_234_backdoor+) retourne une erreur qui indique
que ce n'est pas un shell qui tourne sur le port 6200.

Comme on a fait l'appel pour ouvrir la backdor (on peut le confirmer avec un
nmap sur le port qui répond des truc louches), on peut aller voir directement
avec un \verb+nc $TARGET 6200+.

on tombe effectivement sur sur un truc qui s'appele
\href{https://psysh.org/}{psy shell} qui est un debugger php

en lisant un peut il y a une intgration avec le
\href{https://github.com/bobthecow/psysh/wiki/Shell-integration}{shell} mais
elle est bloquée.

On va devoir utiliser des fonctions php pour fouiller:
\begin{itemize}
    \item \verb+print_r+ 
    \item \verb+scandir()+
    \item \verb+file_get_contents+
\end{itemize}

on va a la peche pour voir si on peut trouver une clé privée ssh.

dans \verb+/home/berlin+ deja on trouve le user flag mais pas lisible pareil pour le
\verb+.ssh+

dans \verb+/home/nairobi+ on trouve un \verb+ca.key+ lisible et c'est un clé
privée.

On va donc pouvoir se crafter un certif pour aller regarder sur le \verb+https+
mais il faut aussi le certif qui va avec la clé que l'on choppe sur le
\verb+https+

\begin{verbatim}
openssl req -newkey rsa:2048 -keyout pwn.key -out pwn.csr -nodes

openssl x509 -req -in pwn.csr -CA ca.pem -CAkey ca.key \
    -set_serial 1 -extensions client -days 365 -outform PEM -out pwn.pem
\end{verbatim}

pour installer le certif de \verb+firefox+ il faut aller dans

\verb+settings/Privacy../certificates/View ../Your certif+

probleme il lui faut un \verb+p12+  donc:
\begin{verbatim}
openssl pkcs12 -export -inkey pwn.key -in pwn.pem -out pwn.p12
\end{verbatim}


Bingo.

paie ton path traversal :
\begin{verbatim}
https://10.10.10.131/?path=../
https://10.10.10.131/?path=../Download
.. .
\end{verbatim}

par contre on ne peut pas choper la clé. Pour les videos on a un url en
\verb+file/XJFH..+

un coup de \verb+base64 -d+ nous permet de savoir qu'il va falloir encoder

\verb+echo -n '../.ssh/id_rsa' | base64+

on essaye les users et on realise que c'est prof le fautif

\verb+ssh i- ./id_rsa professor@10.10.10.131+

avec un \verb+ls -la+ il y a un truc bizare des fichier appartenant à
\verb+root+.

le fichier \verb+.ini+ reférence une commande.

on essaie de regarder dans le crontabs si on voit quelque chose mais on n'a pas
d'accès.

utilisation de \href{https://github.com/DominicBreuker/pspy}{pspy} pour voir
s'il y a du cron derriere

il y a bien un process qui tourne
\begin{verbatim}
UID=65534 PID=15542  | /usr/bin/node /home/professor/memcached.js
\end{verbatim}

en itérant un \verb+ps au |grep mem+ on voit qu'il tourne 30 sec avant de
changer de pid.

on craft un revershell que l'on va demander en execution en remplaçant le
fichier \verb+memcached.ini+

en fait même en créant un nouveau fichier ini et en laissant celui en place
cela fonctionne.


en analyse on a la crontab suivante de root
\begin{verbatim}
# min	hour	day	month	weekday	command
*/1	*	*	*	*	/etc/init.d/supervisord restart
\end{verbatim}

et dans \verb+supervisord.conf+ on a bien:
\begin{verbatim}
[include]
files = /home/professor/*.ini
\end{verbatim}


